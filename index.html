<!DOCTYPE html>
<!--
Leistungsdatenbank
Version 3.10.4
Datum: 2026-02-09


√Ñnderungen in v3.10.4:
- VERBESSERUNG: SB-Diagramm Durchschnittslinien besser sichtbar
  * Transparenz der Durchschnittslinien von 0.4 auf 0.65 erh√∂ht
  * Durchschnitte sind nun deutlich besser erkennbar
- NEU: Checkboxen f√ºr SBs und Durchschnitte im SB-Diagramm
  * Option zum Ein-/Ausblenden von Saisonbestleistungen (SB)
  * Option zum Ein-/Ausblenden von Saisondurchschnitten (√ò)
  * Funktioniert auch im Vergleichsmodus mit zwei Disziplinen
  * Erm√∂glicht fokussierte Ansicht auf gew√ºnschte Datenpunkte

√Ñnderungen in v3.10.3:
- NEU: Minimalistisches Logo im Login-Screen hinzugef√ºgt
  * "LA" in Lila-Gradient mit "Leistungsdatenbank" Text
  * Favicon f√ºr Browser-Tab integriert
  * Professionelles, modernes Design
- VERBESSERUNG: Logout setzt Login-Felder komplett zur√ºck
  * Email und Passwort werden beim Logout geleert
  * "Angemeldet bleiben" wird deaktiviert
  * Passwort-Sichtbarkeit wird zur√ºckgesetzt
- VERBESSERUNG: Passwort-Toggle mit Auge-Icon
  * Ersetzt "SHOW"/"HIDE" Text durch moderne Icons
  * Normales Auge = versteckt, durchgestrichenes Auge = sichtbar

√Ñnderungen in v3.10.2:
- BUG-FIX: Mehrfache Athleten-Eintr√§ge behoben
  * Nur der Supabase-Trigger erstellt Athleten-Profile
  * Alle manuellen INSERT-Statements aus Frontend entfernt
  * Retry-Logik beim Login statt automatischer Erstellung

√Ñnderungen in v3.10.1:
- NEU: L√∂schen-Button im Leistung-Bearbeiten-Modal hinzugef√ºgt
  * Beim Bearbeiten einer Leistung ist nun ein roter "L√∂schen"-Button sichtbar
  * Sicherheitsabfrage vor dem L√∂schen
  * Button ist nur im Bearbeitungsmodus sichtbar, nicht beim Hinzuf√ºgen
  * Nutzt die bestehende RLS DELETE Policy

√Ñnderungen in v3.10.0:
- NEU: Admin-Athletensuche wieder hinzugef√ºgt
  * Admins sehen oben rechts eine kompakte Suchleiste
  * Admins k√∂nnen andere Athleten ausw√§hlen und deren Daten ansehen
  * Normale User sehen keine Suchleiste und nur ihre eigenen Daten
- VERBESSERUNG: Berechtigungen f√ºr Leistungen optimiert
  * Jeder User kann seine eigenen Leistungen hinzuf√ºgen und bearbeiten
  * Admins k√∂nnen Leistungen f√ºr ausgew√§hlte Athleten hinzuf√ºgen
  * Automatische Zuordnung zur richtigen athlete_id
- SICHERHEIT: Normale User k√∂nnen nur ihre eigenen Daten sehen und bearbeiten
  * selectedAthleteId wird korrekt verwendet
  * Keine M√∂glichkeit f√ºr normale User, andere Profile zu sehen


√Ñnderungen in v3.9.8:
- BUG-FIX: Robuste Fehlerbehandlung beim Login
  * Query-Timeout hinzugef√ºgt (10 Sekunden)
  * Automatische Profilerstellung bei fehlenden Profilen
  * Bessere Behandlung von Permissions-Fehlern
  * Fallback auf user_metadata wenn Profil nicht existiert
  * Verhindert h√§ngende Login-Versuche


√Ñnderungen in v3.9.7:
- BUG-FIX: AbortError beim Login behoben
  * App-Initialisierung erfolgt jetzt erst NACH dem Login
  * Datenbankabfragen werden nicht mehr vor der Authentifizierung durchgef√ºhrt
  * Disziplinen und Filter laden nur Daten des eingeloggten Users
  * Verhindert Race-Conditions und Authentifizierungsprobleme
- VERBESSERUNG: Passwort-Toggle modernisiert
  * Statt Emoji-Icons wird jetzt "SHOW"/"HIDE" Text verwendet
  * Professionelleres und klareres Design
  * Bessere Benutzerfreundlichkeit


√Ñnderungen in v3.9.6:
- BUG-FIX: Login-Weiterleitung zur Main-App behoben
  * Main-App wird jetzt korrekt nach dem Login angezeigt
  * Verbesserte Fehlerbehandlung und Logging
  * Athletenprofil wird direkt im Auth-Handler geladen
  * Verhindert Race-Conditions und Doppel-Verarbeitung


√Ñnderungen in v3.9.5:
- ENTFERNT: Athletentabelle/-suche komplett entfernt f√ºr alle Benutzer
  * Jeder Benutzer sieht nur noch seine eigenen Leistungen
  * Athletenauswahl-Sektion wurde entfernt
  * Kompakte Athletensuche im Header wurde entfernt
  * Vereinfachte Benutzeroberfl√§che
- NEU: Passwort anzeigen/verstecken beim Login
  * Auge-Icon (üëÅÔ∏è) zum Ein-/Ausblenden des Passworts
  * Verbesserte Benutzerfreundlichkeit beim Login
- INFO: Registrierung speichert automatisch Name, Vorname und Jahrgang
  * Athletenprofil wird bei Registrierung automatisch angelegt
  * user_id wird korrekt mit Athletenprofil verkn√ºpft
- INFO: Leistungen werden automatisch mit aktueller athlete_id verkn√ºpft
  * Beim Hinzuf√ºgen von Leistungen wird die ID des eingeloggten Users verwendet
  * Keine manuelle Eingabe der Athleten-ID mehr n√∂tig


√Ñnderungen in v3.9.4:
- BUG-FIX: Main App wird nach Login jetzt korrekt angezeigt
  * Auth-Handler zeigt mainApp direkt an statt √ºber showMainApp()
  * loadUserAthlete() √ºbernimmt die Verwaltung der Admin-Features
  * Verhindert Race-Conditions bei der Initialisierung
- VERBESSERUNG: Neuer Icon-basierter Abmelden-Button oben links
  * Ersetzt alten "üö™ Logout" Button durch modernen SVG-Icon
  * Einheitliches Design mit anderen Header-Buttons
- SICHERHEIT: Athleten-Sektion nur noch f√ºr Admins sichtbar
  * Normale Benutzer sehen keine Athleten-Tabelle mehr
  * Suchleiste oben rechts nur f√ºr Admins sichtbar
  * Admins k√∂nnen weiterhin alle Athleten durchsuchen
- INFO: Registrierungsdaten werden korrekt √ºbernommen
  * Vorname, Nachname und Jahrgang werden in la.athlet gespeichert
  * user_id wird korrekt verkn√ºpft
  * Automatische Profilerstellung bei Registrierung


√Ñnderungen in v3.9.3:
- BUG-FIX: Auth-Loop und leerer Bildschirm nach Login behoben
  * lastProcessedUserId verhindert Doppel-Verarbeitung von SIGNED_IN Events
  * Guard-Flag verhindert mehrfache Initialisierung der Athleten-Suche
  * Entfernte duplizierte initAthleteSearch() Aufrufe aus showMainApp()
  * Verbesserte Logging f√ºr besseres Debugging
  * mainApp wird jetzt korrekt angezeigt nach erfolgreichem Login


√Ñnderungen in v3.9.2:
- VERBESSERUNG: Optimierte Y-Achsen-Einteilung f√ºr alle Diagramme
  * Intelligentere Schrittgr√∂√üen-Berechnung f√ºr bessere Lesbarkeit
  * Sch√∂nere und rundere Werte bei einzelner Disziplin und im Vergleichsmodus
  * Erweiterte Bereichsabdeckung (rundeAb/rundeAuf statt einfachem Runden)
  * Zus√§tzliche feinere Abstufungen f√ºr kleine Bereiche
  * Zeitdisziplinen: neue Schritte bei 0.05s, 0.1s, 0.2s, 2s f√ºr pr√§zisere Darstellung
  * Felddisziplinen: neue Schritte bei 0.05m, 1m f√ºr pr√§zisere Darstellung
  * Floating-Point-Fehler werden vermieden durch pr√§zise Rundung
  * Mindestens 3 Ticks garantiert mit automatischer Schrittverkleinerung
  * Gilt f√ºr Leistungsdiagramm, SB-Diagramm und Prognosediagramm
- VERBESSERUNG: Intelligente Wettkampf-Z√§hlung optimiert
  * Wettk√§mpfe mit gleicher Wettkampfbezeichnung innerhalb von 14 Tagen werden als ein Wettkampf gez√§hlt
  * Verhindert Mehrfachz√§hlung von mehrt√§gigen Wettk√§mpfen (z.B. DM, EM, WM)
  * Gilt f√ºr: Wettkampffrequenz, Saisonvergleich und allgemeine Wettkampfstatistiken
  * Bessere Genauigkeit bei der Analyse der Wettkampfaktivit√§t
- BUG-FIX: Wettkampforte-Karte zeigt jetzt korrekte Anzahl der Leistungen
  * Tooltip beim Hovern √ºber Marker zeigt nun die tats√§chliche Anzahl der Leistungen pro Ort
  * Vorher wurden Wettk√§mpfe gez√§hlt, was zu Verwirrung f√ºhrte
  * Marker-Gr√∂√üe basiert weiterhin auf Anzahl der Leistungen f√ºr bessere Visualisierung


√Ñnderungen in v3.9.1:
- VERBESSERUNG: Statistiken und Bestleistungen sind jetzt standardm√§√üig zugeklappt
- VERBESSERUNG: Alle Statistik- und Bestleistungs-Ausgaben sind jetzt mit X-Button schlie√übar
- ANPASSUNG: Finalteilnahmen bei Erfolgsquote entfernt
- ANPASSUNG: Saisonvergleich vereinfacht - nur noch Jahr, Wettk√§mpfe und √ò Platzierung
- ANPASSUNG: Wettkampffrequenz zeigt jetzt aktivstes Jahr statt aktivsten Monat
- ANPASSUNG: PB-Timeline komplett √ºberarbeitet
  * Zeigt nur noch all-time PBs pro Disziplin
  * PBs sind chronologisch nach Datum sortiert (nicht nach Disziplin)
  * Kompaktere, √ºbersichtlichere Darstellung
  * Timeline-Ansicht √ºber alle Disziplinen hinweg


√Ñnderungen in v3.9.0:
- NEU: Erfolgsquote-Statistik hinzugef√ºgt
  * Zeigt Siegquote, Podiumspl√§tze (Top 3), Top-6-Platzierungen und Finalteilnahmen
  * Prozentuale Auswertung mit visuellen Karten
  * Ber√ºcksichtigt alle Filter aus dem Statistik-Bereich
- NEU: Saisonvergleich-Statistik hinzugef√ºgt
  * Vergleicht Durchschnittsleistungen verschiedener Jahre
  * Zeigt Wettkampfanzahl, Durchschnitte und Bestleistungen pro Jahr
  * Markiert die beste Saison automatisch
- NEU: Wettkampffrequenz-Analyse hinzugef√ºgt
  * Analysiert Anzahl und Verteilung der Wettk√§mpfe
  * Zeigt durchschnittliche Tage zwischen Wettk√§mpfen
  * Identifiziert aktivsten Monat und Jahresverteilung
- NEU: PB-Timeline im Bestleistungen-Bereich hinzugef√ºgt
  * Zeigt chronologische √úbersicht aller pers√∂nlichen Rekordverbesserungen
  * Visualisiert Zeitabst√§nde zwischen PB-Verbesserungen
  * Markiert die aktuelle Bestleistung hervorgehoben
  * Zeigt l√§ngste "Durststrecke" ohne PB-Verbesserung


√Ñnderungen in v3.8.3:
- VERBESSERUNG: Filter bei Statistiken sind jetzt permanent sichtbar (nicht mehr einklappbar)
- VERBESSERUNG: Filter bei Bestleistungen sind jetzt permanent sichtbar (nicht mehr einklappbar)
- VERBESSERUNG: Bessere √úbersichtlichkeit durch feste Filter-Anzeige


√Ñnderungen in v3.8.2:
- VERBESSERUNG: Statistiken-Bereich ist jetzt einklappbar (standardm√§√üig ge√∂ffnet)
- VERBESSERUNG: Bestleistungen-Bereich ist jetzt einklappbar (standardm√§√üig ge√∂ffnet)
- VERBESSERUNG: Dynamische Jahr-Auswahl in Statistiken und Bestleistungen
  * Jahre werden automatisch aus der Datenbank geladen
  * Alle Jahre mit Leistungsdaten sind verf√ºgbar
  * Nicht mehr auf 2022-2026 beschr√§nkt
  * Jahre werden in absteigender Reihenfolge angezeigt (neueste zuerst)


√Ñnderungen in v3.8.1:
- NEU: Zeitraum-Filter f√ºr SB-Diagramm hinzugef√ºgt
  * Von/Bis-Datum Felder wie bei Leistungsanalyse
  * Jahr-Auswahl Dropdown
  * Filter werden auf beide Disziplinen im Vergleichsmodus angewandt
  * Reset-Funktionalit√§t f√ºr neue Filter
- BUG-FIX: Prognose-Diagramm Canvas-Fehler behoben
  * Hinzugef√ºgt: Pr√ºfung ob Canvas-Element existiert
  * Verbesserte Fehlerbehandlung mit aussagekr√§ftiger Fehlermeldung
  * Verhindert "Cannot read properties of null" Fehler


√Ñnderungen in v3.8.0:
- BUG-FIX: SB-Diagramm zeigt jetzt korrekte Werte auch im Vergleichsmodus
  * Problem: Bei 2 Disziplinen wurden Leistungen als Scores gespeichert
  * L√∂sung: Datenpunkte enthalten jetzt immer originale Leistungswerte
  * Achsenskalierung verwendet weiterhin Scores f√ºr Vergleichbarkeit
  * Verhindert mehrere Meter zu hohe Werte
- VERBESSERUNG: Leistungsprognose komplett √ºberarbeitet
  * Jetzt im Analyse-Bereich integriert (statt separate Sektion)
  * 12 Monate: Zeigt letzte 12 Monate + monatliche Prognose
  * 5 Jahre: Zeigt letzte 5 Jahre + j√§hrliche Prognose-Punkte
  * Trendlinie wird durch alle historischen Daten gezeichnet
  * Zeitbasierte Regression (statt altersbasiert) f√ºr pr√§zisere Prognosen
  * Prognose-Werte werden in Info-Box angezeigt
  * Historische Leistungen als Punkte, Trend als durchgezogene Linie
- VERBESSERUNG: Prognose-Diagramm visuell optimiert
  * Jahresprognose zeigt deutliche Prognose-Punkte (Quadrate)
  * Monatsprognose zeigt kontinuierliche Trendlinie
  * Nutzt generiereSchoeneLeistungen() f√ºr sch√∂ne Y-Achsen


√Ñnderungen in v3.7.0:
- NEU: Leistungsprognose-Diagramm hinzugef√ºgt
  * Berechnet Prognosen basierend auf Alter und bisherigen Leistungen
  * Lineare Regression zur Trend-Erkennung
  * Wahlweise 12 Monate oder 5 Jahre Prognose
  * Zeigt historische Daten und prognostizierte Werte
  * Info-Box mit Trend, Alter und Prognosezeitraum
- BUG-FIX: Vergleichs-Dropdowns bleiben nach Athletenwechsel sichtbar
  * Nur Werte werden zur√ºckgesetzt, nicht mehr versteckt
  * Erm√∂glicht sofortigen Vergleich nach Athletenwechsel
- BUG-FIX: SB-Diagramm Leistungsberechnung korrigiert
  * Leistungen werden jetzt korrekt normalisiert (cm zu m)
  * Verhindert zu hohe Werte bei Sprung- und Wurfdisziplinen
  * Verwendet normalizeLeistung() f√ºr konsistente Daten


√Ñnderungen in v3.6.0:
- NEU: Vollst√§ndiger Reset aller Einstellungen beim Athletenwechsel
  * Filter (Disziplin, Ort, Jahr, Monat, Wettkampftyp, Wind, Handgestoppt)
  * Spaltenauswahl in Leistungstabelle
  * Analyse-Filter (Disziplin, Zeitraum, Vergleichsmodus)
  * SB-Filter (Disziplin, Vergleichsmodus)
  * Statistik-Filter (Disziplin, Zeitraum, benutzerdefinierte Datumsbereiche)
  * Bestleistungen-Filter (Disziplin, Zeitraum, benutzerdefinierte Datumsbereiche)
  * Alle Diagramme werden zur√ºckgesetzt
- VERBESSERUNG: Sch√∂ne, runde Achseneinteilung bei allen Diagrammen
  * Leistungsdiagramm: Beide Achsen nutzen jetzt generiereSchoeneLeistungen()
  * SB-Diagramm: Beide Achsen nutzen jetzt generiereSchoeneLeistungen()
  * Gilt auch beim Vergleich zweier Disziplinen ohne Score-Skalierung
  * Einheitliche, benutzerfreundliche Achsenbeschriftung in allen Modi

√Ñnderungen in v3.5.0:
- VERBESSERUNG: Alle Header-Buttons auf einheitliche H√∂he (36px) gebracht
- VERBESSERUNG: Suchleiste, Dark Mode und Logout Symbol perfekt ausgerichtet (top: 30px)
- VERBESSERUNG: Suchleiste kompakter - 36px im Kreis-Zustand (statt 44px)
- VERBESSERUNG: Einheitlicher border-radius (18px) f√ºr alle Header-Buttons
- VERBESSERUNG: Input-Feld und Selected-Info auf 28px H√∂he
- VERBESSERUNG: Lupe zentriert mit 36x36px im Kreis-Zustand
- VERBESSERUNG: Padding optimiert - padding: 0 10px beim Expandieren
- VERBESSERUNG: Clear-Button mit definierter H√∂he (28px)

√Ñnderungen in v3.4.9:
- VERBESSERUNG: Suchleiste noch kompakter (220px statt 260px)
- BUG-FIX: overflow: visible damit Suggestions sichtbar werden
- BUG-FIX: z-index: 10000 f√ºr Suggestions (h√∂her als alles andere)
- VERBESSERUNG: Wei√üer Hintergrund f√ºr Suggestions (statt var(--card-bg))
- VERBESSERUNG: Kleinere Schriftgr√∂√üen (0.85em Input, 0.9em Suggestions, 0.8em Selected-Info)
- VERBESSERUNG: Kompakteres Padding √ºberall (7px statt 8px/10px)
- VERBESSERUNG: Kleinere Lupe (1.2em statt 1.3em)
- BUG-FIX: Explizite Farben f√ºr Suggestions (#333 Text, #f5f5f5 Hover)

√Ñnderungen in v3.4.8:
- VERBESSERUNG: Beim Hover wird Hintergrund fast vollst√§ndig wei√ü (opacity: 0.95)
- VERBESSERUNG: Input-Feld hat wei√üen Hintergrund mit border-radius
- VERBESSERUNG: Selected-Info hat ebenfalls wei√üen Hintergrund
- VERBESSERUNG: Lupe wechselt von Wei√ü zu Lila beim Hover (Corporate Color)
- VERBESSERUNG: Minimaler blauer Rand beim Hover (rgba(102, 126, 234, 0.3))
- VERBESSERUNG: Clear-Button mit dunkler Farbe statt wei√ü
- NEU: Ausf√ºhrliches Debug-Logging f√ºr Fehlersuche in der Athletensuche
- VERBESSERUNG: Dark Mode Anpassungen f√ºr Input und Selected-Info

√Ñnderungen in v3.4.7:
- VERBESSERUNG: Lupe hat jetzt perfekte Kreisform (border-radius: 50%, width/height: 44px)
- VERBESSERUNG: Suchleiste kleiner (260px statt 320px) um √úberschrift nicht zu verdecken
- BUG-FIX: Athletensuche funktioniert jetzt korrekt
- BUG-FIX: Autocomplete-Suggestions werden korrekt angezeigt und geschlossen
- VERBESSERUNG: Verwendet show-Klasse statt style.display f√ºr besseres Styling
- VERBESSERUNG: Kleinere Schriftgr√∂√üe (0.9em) und weniger Padding f√ºr kompakteres Design

√Ñnderungen in v3.4.6:
- VERBESSERUNG: Athletensuche jetzt ultra-kompakt - nur Lupensymbol üîç sichtbar
- NEU: Hover-Expansion - Suchleiste expandiert elegant beim √úberfahren
- VERBESSERUNG: Sanfte Animation mit cubic-bezier f√ºr professionelles Gef√ºhl
- VERBESSERUNG: Separate Ansicht f√ºr ausgew√§hlten Athleten (has-selection Klasse)
- VERBESSERUNG: Clear-Button nur bei Hover oder Auswahl sichtbar
- VERBESSERUNG: Mobile-Ansicht immer expandiert f√ºr bessere Usability
- VERBESSERUNG: Intelligentes Ein-/Ausblenden der Input- und Info-Bereiche

√Ñnderungen in v3.4.5:
- VERBESSERUNG: Athletensuche (f√ºr Admins) wurde in den Header integriert
- VERBESSERUNG: Sch√∂neres Design mit Glasmorphismus-Effekt (semi-transparenter Hintergrund mit Blur)
- BUG-FIX: √úberschneidung mit Dark Mode Symbol behoben
- VERBESSERUNG: Bessere Position - jetzt zwischen Titel und Dark Mode Button
- VERBESSERUNG: Responsive Design f√ºr Tablet und Mobile optimiert
- VERBESSERUNG: Dropdown-Vorschl√§ge mit eigenem Styling und besserem Kontrast

√Ñnderungen in v3.4.4:
- VERBESSERUNG: Filterreihenfolge bei Bestleistungen - Zeitraum kommt jetzt als erstes
- BUG-FIX: Hover-Problem im Leistungsdiagramm bei 2. Disziplin behoben (interaction mode auf 'nearest' ge√§ndert)
- VERBESSERUNG: Achsenbeschriftungsfarben vereinheitlicht - alle Achsen haben jetzt schwarze Beschriftungen
- NEU: Kompakte Athletensuche f√ºr Admins - Suchleiste oben rechts statt gro√üer Bereich (nur f√ºr Admins)
- VERBESSERUNG: √úberschrift "Leistungen & Analyse" entfernt
- VERBESSERUNG: Tabs sch√∂ner und pr√§senter gestaltet mit gr√∂√üerem, modernerem Design

√Ñnderungen in v3.4.3:
- VERBESSERUNG: Achsenbeschriftungsfarben im SB-Diagramm an Leistungsdiagramm angeglichen (keine farbigen Ticks mehr)
- VERBESSERUNG: Durchschnittslinien (√ò) im SB-Diagramm transparenter (40% Deckkraft, 1.5px Breite) f√ºr bessere √úbersichtlichkeit
- BUG-FIX: Tooltip-Positionierung im Leistungsdiagramm verbessert (position: "nearest")
- NEU: Zeitraum-Filter f√ºr Statistiken und Bestleistungen:
  * Jahresauswahl (2022-2026)
  * Benutzerdefinierter Zeitraum (Von/Bis Datum)
  * Filter werden in berechneDurchschnitt() und zeigePBs() ber√ºcksichtigt


√Ñnderungen in v3.4.2:
- VERBESSERUNG: Einheiten aus Achsenbeschriftungen im SB-Diagramm entfernt (nur noch Disziplinname wird angezeigt)
- VERBESSERUNG: √úbersichtlichkeit im SB-Diagramm beim Vergleich von 2 Disziplinen deutlich verbessert:
  * Durchschnittslinien (√ò) sind nun transparenter (40% Deckkraft statt 100%)
  * Durchschnittslinien sind d√ºnner (1.5px statt 2px)
  * SB-Linien bleiben prominent und gut sichtbar
- BEST√ÑTIGT: Achseneinteilung verwendet bereits sch√∂ne runde Zahlen durch generiereSchoeneLeistungen()

√Ñnderungen in v3.4.1:
- BUG-FIX: Score-basierte Y-Achsen-Skalierung im SB-Diagramm beim Vergleich zweier Disziplinen
- VERBESSERUNG: Achsenbeschriftungen zeigen jetzt korrekt die Einheiten (m, s, Pkt.) f√ºr beide Disziplinen
- VERBESSERUNG: Tooltips zeigen die tats√§chlichen Leistungswerte statt Score-Werte

√Ñnderungen in v3.4.0:
- NEU: Vergleichsmodus f√ºr SB & Saisondurchschnitte - zwei Disziplinen gleichzeitig vergleichbar
- VERBESSERUNG: √úberschrift "SB & Saisondurchschnitte" (Plural) f√ºr bessere Lesbarkeit
- VERBESSERUNG: Achsenbeschriftung bei Wurf-/Sprungdisziplinen zeigt jetzt korrekt "m" statt "Pkt."
- VERBESSERUNG: Mobile Optimierung - reduzierte Seitenr√§nder f√ºr bessere Lesbarkeit auf kleinen Bildschirmen
- VERBESSERUNG: Responsive Design f√ºr alle Tabs optimiert (8px Seitenabstand auf Mobile)
- VERBESSERUNG: Touch-optimierte Scrolling-Bereiche f√ºr Tabellen und Filter
- VERBESSERUNG: Schriftgr√∂√üen-Optimierung f√ºr sehr kleine Bildschirme (< 480px)

√Ñnderungen in v3.3.1:
- BUG-FIX: Session-Management korrigiert - Athleten-ID wird beim Logout vollst√§ndig zur√ºckgesetzt
- BUG-FIX: Beim erneuten Login mit anderer ID wird die vorherige ID nicht mehr beibehalten
- VERBESSERUNG: Robustere Behandlung der Athleten-Auswahl f√ºr normale User und Admins

√Ñnderungen in v3.3.0:
- NEU: Filter im Analyse-Tab wurden in den Bereich "Leistungsentwicklung" verschoben
- NEU: Vergleichsoption f√ºr 2 Disziplinen direkt in die Filter integriert
- NEU: Neues Diagramm "SBs & Saisondurchschnitt" zur Anzeige von Saisonbestleistungen und Durchschnitten
- NEU: Filter "Disziplin" und "Zeitraum" zu den Statistik-Filtern hinzugef√ºgt
- VERBESSERUNG: "Erweiterte Filter" wurde bei Statistiken und Bestleistungen in "Filter" umbenannt

√Ñnderungen in v3.2.1:
- BUG-FIX: Ziele werden jetzt nach erreichten Prozent sortiert (von h√∂chstem zu niedrigstem Fortschritt)
- VERBESSERUNG: Zielbalken viel schmaler gemacht (120-140px statt 200px)
- VERBESSERUNG: Ausgangswert und Ziel werden auf 2 separate Zeilen angezeigt (Wert bleibt in gleicher Zeile wie Label)
- BUG-FIX: Hover-Effekt zeigt jetzt den blauen Rand korrekt an (overflow:visible f√ºr alle Container hinzugef√ºgt)
- BUG-FIX: NaN-Anzeige bei Zielen vollst√§ndig behoben durch bessere Fehlerbehandlung in beiden Ansichten

√Ñnderungen in v3.2.0:
- BUG-FIX: NaN-Anzeige bei Sprung- und Wurfdisziplinen behoben
- NEU: Ziele k√∂nnen im Tab "Ziele" bearbeitet werden
- VERBESSERUNG: Vertikale Anzeige der Zielbalken im Dashboard (bei >3 Zielen)
- BUG-FIX: Dark Mode - alle wei√üen Boxen werden nun dunkel angezeigt

√Ñnderungen in v3.1.0:
- WICHTIG: Weltrekord-basiertes Scoring System (ersetzt Vergleichsscores)
  * Top 8 Bestleistungen werden jetzt nach prozentualem Anteil am Weltrekord sortiert
  * Diagramm-Vergleichsmodus verwendet nun Weltrekord-Prozente f√ºr faire Vergleiche
  * Beispiel: 8.50m Weitsprung = 95.0% vom WR (8.95m), 11.0s 100m = 87.1% vom WR (9.58s)
  * Erm√∂glicht intuitiveren und transparenteren Vergleich zwischen Disziplinen

√Ñnderungen in v3.0.0:
- KORREKTUR: Stabhochsprung wird nun wie andere Sprung-/Wurfdisziplinen behandelt (Einheit "m", 2 Nachkommastellen)
- VERBESSERUNG: Orts-Tabelle (Karten-Klick) im gleichen Stil wie Leistungen-Tabelle mit sortierbaren Spalten
- BUG-FIX: PB-Highlighting korrigiert - nur echte Personal Bests werden hervorgehoben, auch bei aktiven Filtern

√Ñnderungen in v2.9.0:
- NEU: Interaktive Deutschlandkarte im Dashboard
  * Zeigt alle Wettkampforte mit Punkten an
  * Punktgr√∂√üe variiert nach Anzahl der Wettk√§mpfe (1-2: klein, 3-5: mittel, 6+: gro√ü)
  * Hover-Tooltips zeigen Ortsnamen und Anzahl der Wettk√§mpfe
  * Neue Orte k√∂nnen einfach in der stadtKoordinaten-Variable hinzugef√ºgt werden
  * Unterst√ºtzt automatische Normalisierung von Ortsnamen (Umlaute, Gro√ü-/Kleinschreibung)

√Ñnderungen in v2.7.0:
- NEU: Dashboard-Startseite mit √úbersicht
  * Statistik-Karten mit Gesamt√ºbersicht
  * Top 8 Bestleistungen (sortiert nach Vergleichsscore, Score wird nicht angezeigt)
  * Schnellzugriff auf alle Funktionen
- Farbschema: Gr√ºn/Blau statt Lila/Rot

√Ñnderungen in v2.6.0:
- VERBESSERUNG: Vergleichsscore-basierte Achsen-Skalierung WIEDERHERGESTELLT und optimiert
  * Beide Y-Achsen werden nun nach Vergleichsscores ausgerichtet wenn beide Disziplinen IAAF-Parameter haben
  * Jede Achse zeigt weiterhin die tats√§chlichen Leistungswerte (gerundet und sch√∂n formatiert)
  * Die Verh√§ltnisse zwischen den Achsen sind nun perfekt synchronisiert √ºber Vergleichsscores
  * Beispiel: 8m Weitsprung (~1000 Punkte) wird auf gleicher H√∂he wie 55s 400m H√ºrden (~1000 Punkte) angezeigt
  * Dies erm√∂glicht echten Leistungsvergleich zwischen verschiedenen Disziplinen
- Vergleichsscores werden f√ºr ALLE Leistungen im Hintergrund berechnet und f√ºr die Skalierung verwendet
- Achsenbeschriftung erfolgt mit gerundeten, sch√∂nen Werten der jeweiligen Disziplin

√Ñnderungen in v2.5.0:
- WICHTIGER BUG-FIX: Achsenskalierung im Vergleichsmodus korrigiert
  * Jede Disziplin verwendet nun ihren EIGENEN Leistungsbereich auf der Achse
  * Vorher: 8m Weitsprung wurde auf gleicher H√∂he wie 55s 400m H√ºrden angezeigt (weil gleicher Vergleichsscore)
  * Jetzt: Jede Achse zeigt die tats√§chlichen Leistungswerte der jeweiligen Disziplin korrekt
  * Vergleichsscores werden nur noch f√ºr interne Berechnungen verwendet, nicht f√ºr die Achsenskalierung
- Die Linien im Diagramm zeigen nun die echte Leistungsentwicklung pro Disziplin

√Ñnderungen in v2.4.4:
- Bug-Fix: 60m H√º. zu allen Disziplin-Mappings hinzugef√ºgt (verwendet normale Skalierung, da keine IAAF-Parameter verf√ºgbar)
- Bug-Fix: Konsistenz der Disziplin-Mappings in allen drei Funktionen (berechneIAAFScore, scoreZuLeistung, generiereSchoeneLeistungen) sichergestellt
- Verifikation: Vergleichsscore-Berechnung f√ºr alle Disziplinen getestet und als korrekt best√§tigt
- Verifikation: Achsen-Alignment zwischen zwei Disziplinen getestet und als perfekt synchronisiert best√§tigt
- Verifikation: Achsen-Orientierung f√ºr Zeit- und Felddisziplinen getestet und als korrekt best√§tigt
-->

<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrackUp</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='128' height='128' viewBox='0 0 128 128' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='faviconGrad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23FFD700;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='64' y='90' font-family='Arial, sans-serif' font-size='72' font-weight='bold' fill='url(%23faviconGrad)' text-anchor='middle'%3ETU%3C/text%3E%3C/svg%3E">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    :root {
      /* Unified Color Palette - Lila/Blau Theme */
      --primary-color: #667eea;
      --primary-dark: #5568d3;
      --primary-light: #8b9ef5;
      --secondary-color: #764ba2;
      --secondary-dark: #5d3b82;
      --secondary-light: #9165b8;
      
      /* Background Colors */
      --bg-gradient-start: #667eea;
      --bg-gradient-end: #764ba2;
      --container-bg: white;
      
      /* Text Colors */
      --text-primary: #1a1a1a;
      --text-secondary: #495057;
      --text-muted: #6c757d;
      
      /* Header */
      --header-bg-start: #667eea;
      --header-bg-end: #764ba2;
      
      /* UI Elements */
      --section-bg: #f8f9fa;
      --card-bg: white;
      --border-color: #e0e0e0;
      --border-radius: 8px;
      --input-bg: white;
      --table-header-bg: #f8f9fa;
      --table-hover-bg: #f5f7fa;
      --shadow-color: rgba(0,0,0,0.08);
      --shadow-hover: rgba(102, 126, 234, 0.15);
      
      /* Accent Colors */
      --accent-color: #667eea;
      --accent-secondary: #764ba2;
      --stat-card-bg-start: #e8eeff;
      --stat-card-bg-end: #f3e5f5;
      --map-bg: #f8f9fa;
      
      /* Button Colors */
      --btn-primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --btn-secondary-bg: #6c757d;
      --btn-danger-bg: #dc3545;
    }

    body.dark-mode {
      /* Dark Mode - Unified Purple/Blue */
      --primary-color: #8b9ef5;
      --primary-dark: #667eea;
      --primary-light: #a8b7f7;
      --secondary-color: #9165b8;
      --secondary-dark: #764ba2;
      --secondary-light: #a87dc4;
      
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --container-bg: #1f1f1f;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --text-muted: #888;
      --header-bg-start: #667eea;
      --header-bg-end: #764ba2;
      --section-bg: #2a2a2a;
      --card-bg: #2d2d2d;
      --border-color: #404040;
      --border-radius: 8px;
      --input-bg: #333;
      --table-header-bg: #2a2a2a;
      --table-hover-bg: #383838;
      --shadow-color: rgba(0,0,0,0.5);
      --shadow-hover: rgba(102, 126, 234, 0.25);
      --accent-color: #8b9ef5;
      --accent-secondary: #9165b8;
      --stat-card-bg-start: #1e3a5f;
      --stat-card-bg-end: #2d1b3d;
      --map-bg: #2a2a2a;
      --btn-primary-bg: linear-gradient(135deg, #8b9ef5 0%, #9165b8 100%);
      --btn-secondary-bg: #6c757d;
      --btn-danger-bg: #dc3545;
      background: #1a1a1a;
    }

    /* Dark Mode zus√§tzliche Anpassungen */
    body.dark-mode .tab-btn {
      background: #2a2a2a;
      color: #888;
      border-right: 1px solid #404040;
    }
    
    body.dark-mode .tab-btn:hover {
      background: #333;
      color: #667eea;
    }
    
    body.dark-mode .tab-btn.active {
      background: #1a1a1a;
      color: #667eea;
    
    body.dark-mode .tab-navigation {
      border-bottom: 2px solid #404040;
    }
      border-bottom: 3px solid #667eea;
    }
    
    body.dark-mode .autocomplete-suggestions {
      background: #2d2d2d;
      border-color: #404040;
    }
    
    body.dark-mode .autocomplete-item {
      color: #e0e0e0;
    }
    
    body.dark-mode .autocomplete-item:hover {
      background: #383838;
    }
    
    body.dark-mode .selected-athlete {
      background: #2d2d2d;
      border-color: #404040;
    }
    
    body.dark-mode .selected-athlete-info {
      color: #e0e0e0;
    }
    
    body.dark-mode .clear-athlete-btn {
      background: #d32f2f;
    }
    
    body.dark-mode .clear-athlete-btn:hover {
      background: #b71c1c;
    }
    
    body.dark-mode .dashboard-welcome,
    body.dark-mode .dashboard-stats,
    body.dark-mode .dashboard-top-performances {
      background: #2d2d2d;
    }
    
    body.dark-mode .dashboard-athlete-info {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d1b3d 100%);
    }
    
    body.dark-mode .dashboard-performance-container,
    body.dark-mode .dashboard-map-container,
    body.dark-mode .dashboard-top3-container,
    body.dark-mode .dashboard-goals-container {
      background: #2d2d2d;
    }
    
    body.dark-mode .stat-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d1b3d 100%);
      border-color: #404040;
    }
    
    body.dark-mode .stat-value {
      color: #667eea;
    }
    
    body.dark-mode .performance-card {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .performance-card:hover {
      background: #383838;
      border-color: #667eea;
    }
    
    body.dark-mode .chart-container {
      background: #2d2d2d;
    }
    
    body.dark-mode .filter-group label {
      color: #b0b0b0;
    }
    
    body.dark-mode .disziplin-filter-row select {
      background: #333;
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode .checkbox-label {
      color: #b0b0b0;
    }
    
    body.dark-mode .goal-card {
      background: #2d2d2d;
      border-color: #404040;
    }
    
    body.dark-mode .goal-header {
      color: #e0e0e0;
    }
    
    body.dark-mode .goal-progress {
      background: #404040;
    }
    
    body.dark-mode .progress-fill {
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    body.dark-mode .goal-details {
      color: #b0b0b0;
    }
    
    body.dark-mode .ortDetails {
      background: #2d2d2d;
      border-color: #404040;
    }

    body.dark-mode .ortDetails h3 {
      color: #e0e0e0;
    }

    body.dark-mode .ortDetails .close-btn {
      color: #e0e0e0;
    }

    body.dark-mode .ortDetails .close-btn:hover {
      color: #667eea;
    }

    body.dark-mode .dashboard-goal-card {
      background: #2d2d2d;
      border-color: #404040;
    }

    body.dark-mode .goal-value-number {
      color: #e0e0e0;
    }

    body.dark-mode .goal-value-label {
      color: #b0b0b0;
    }

    body.dark-mode .goal-value-explanation {
      color: #888;
    }

    body.dark-mode .goal-status {
      color: #b0b0b0;
    }

    body.dark-mode .goal-discipline {
      color: #e0e0e0;
    }

    body.dark-mode .dashboard-goal-discipline {
      color: #e0e0e0;
    }

    body.dark-mode .dashboard-goal-percentage {
      color: #667eea;
    }

    body.dark-mode .dashboard-goal-details span {
      color: #b0b0b0;
    }

    body.dark-mode .goal-edit-form {
      background: #2a2a2a;
      border-color: #404040;
    }

    body.dark-mode .goal-edit-form input {
      background: #333;
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode table {
      background: #2d2d2d;
    }
    
    body.dark-mode thead {
      background: #1f1f1f;
    }
    
    body.dark-mode th {
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode td {
      color: #b0b0b0;
      border-color: #333;
    }
    
    body.dark-mode tbody tr:hover {
      background: #383838;
    }
    
    body.dark-mode .pb-highlight {
      background: rgba(102, 126, 234, 0.2) !important;
      box-shadow: inset 3px 0 0 #667eea;
    }
    
    body.dark-mode .export-btn {
      background: #2d5016;
      color: #a5d6a7;
    }
    
    body.dark-mode .export-btn:hover {
      background: #1b5e20;
      color: white;
    }
    
    body.dark-mode option {
      background: #2d2d2d;
      color: #e0e0e0;
    }

    body.dark-mode .stat-card-dashboard {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d1b3d 100%);
      border-color: #404040;
    }
    
    body.dark-mode .stat-card-dashboard .label {
      color: #b0b0b0;
    }
    
    body.dark-mode .stat-card-dashboard .value {
      color: #667eea;
    }
    
    body.dark-mode .dashboard-section-title {
      color: #e0e0e0;
    }
    
    body.dark-mode .dashboard-welcome h3 {
      color: #667eea;
    }
    
    body.dark-mode .dashboard-welcome p {
      color: #b0b0b0;
    }
    
    body.dark-mode .goal-discipline {
      color: #667eea;
    }
    
    body.dark-mode .goal-value-label {
      color: #888;
    }
    
    body.dark-mode .goal-value-number {
      color: #e0e0e0;
    }
    
    body.dark-mode .goal-delete-btn {
      background: rgba(211, 47, 47, 0.2);
      color: #ef5350;
    }
    
    body.dark-mode .goal-delete-btn:hover {
      background: #d32f2f;
      color: white;
    }
    
    body.dark-mode .map-container {
      background: #2a2a2a;
    }
    
    body.dark-mode .map-legend {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    
    body.dark-mode .map-reset-btn {
      background: #2d2d2d;
      color: #667eea;
      border-color: #667eea;
    }
    
    body.dark-mode .map-reset-btn:hover {
      background: #667eea;
      color: white;
    }
    
    body.dark-mode .map-fullscreen-btn {
      background: #2d2d2d;
      color: #667eea;
      border-color: #667eea;
    }
    
    body.dark-mode .map-fullscreen-btn:hover {
      background: #667eea;
      color: white;
    }
    
    body.dark-mode .map-tooltip {
      background: #2d2d2d;
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode .disziplin-dropdown {
      background: #333;
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode textarea {
      background: #333;
      color: #e0e0e0;
      border-color: #404040;
    }

    /* Dark Mode zus√§tzliche Anpassungen */
    body.dark-mode .tab-btn {
      background: #2a2a2a;
      color: #888;
      border-right: 1px solid #404040;
    }
    
    body.dark-mode .tab-btn:hover {
      background: #383838;
      color: #667eea;
    }
    
    body.dark-mode .tab-btn.active {
      background: #1a1a1a;
      color: white;
      border-bottom: 3px solid #667eea;
    }
    
    body.dark-mode .autocomplete-suggestions {
      background: #2d2d2d;
      border-color: #404040;
    }
    
    body.dark-mode .autocomplete-item {
      color: #e0e0e0;
    }
    
    body.dark-mode .autocomplete-item:hover {
      background: #383838;
    }
    
    body.dark-mode .selected-athlete {
      background: #2d2d2d;
      border-color: #404040;
    }
    
    body.dark-mode .selected-athlete-info {
      color: #e0e0e0;
    }
    
    body.dark-mode .clear-athlete-btn {
      background: #d32f2f;
    }
    
    body.dark-mode .clear-athlete-btn:hover {
      background: #b71c1c;
    }
    
    body.dark-mode .dashboard-welcome,
    body.dark-mode .dashboard-stats,
    body.dark-mode .dashboard-top-performances {
      background: #2d2d2d;
    }
    
    body.dark-mode .stat-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d1b3d 100%);
      border-color: #404040;
    }

    /* Zus√§tzliche Dark Mode Fixes f√ºr wei√üe Boxen */
    body.dark-mode .columns-section {
      background: #2d2d2d;
    }
    
    body.dark-mode .columns-section h3 {
      color: #667eea;
    }
    
    body.dark-mode .filter-section {
      background: #2d2d2d;
    }
    
    body.dark-mode .checkbox-label {
      background: #333;
    }
    
    body.dark-mode .checkbox-label:hover {
      background: #3d3d3d;
    }
    
    body.dark-mode #analyseTab .filter-group {
      background: #2a2a2a;
    }
    
    body.dark-mode .filter-group {
      background: #2a2a2a;
      border-left-color: #667eea;
    }
    
    body.dark-mode .goal-form {
      background: #2a2a2a;
      border-color: #404040;
    }
    
    body.dark-mode .dashboard-goal-card {
      background: #2d2d2d;
      border-color: #404040;
    }
    
    body.dark-mode .dashboard-goal-card:hover {
      border-color: #667eea;
    }
    
    body.dark-mode .dashboard-goal-discipline {
      color: #667eea;
    }
    
    body.dark-mode .dashboard-goal-percentage {
      color: #e0e0e0;
    }
    
    body.dark-mode .dashboard-goal-details {
      color: #888;
    }
    
    body.dark-mode .dialog-box {
      background: #2d2d2d;
    }
    
    body.dark-mode .dialog-box h3 {
      color: #e0e0e0;
    }
    
    body.dark-mode .dialog-box p {
      color: #b0b0b0;
    }
    
    body.dark-mode #diagrammContainer {
      background: #2d2d2d !important;
    }
    
    body.dark-mode .chart-container canvas {
      background: transparent !important;
    }
      background: linear-gradient(135deg, #1e3a5f 0%, #2d1b3d 100%);
      border-color: #404040;
    }
    
    body.dark-mode .stat-value {
      color: #667eea;
    }
    
    body.dark-mode .performance-card {
      background: #333;
      border-color: #404040;
    }
    
    body.dark-mode .performance-card:hover {
      background: #383838;
      border-color: #667eea;
    }
    
    body.dark-mode .chart-container {
      background: #2d2d2d;
    }
    
    body.dark-mode .filter-group label {
      color: #b0b0b0;
    }
    
    body.dark-mode .disziplin-filter-row select {
      background: #333;
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode .checkbox-label {
      color: #b0b0b0;
    }
    
    body.dark-mode .goal-card {
      background: #2d2d2d;
      border-color: #404040;
    }
    
    body.dark-mode .goal-header {
      color: #e0e0e0;
    }
    
    body.dark-mode .goal-progress {
      background: #404040;
    }
    
    body.dark-mode .progress-fill {
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    body.dark-mode .goal-details {
      color: #b0b0b0;
    }
    
    body.dark-mode table {
      background: #2d2d2d;
    }
    
    body.dark-mode thead {
      background: #1f1f1f;
    }
    
    body.dark-mode th {
      color: #e0e0e0;
      border-color: #404040;
    }
    
    body.dark-mode td {
      color: #b0b0b0;
      border-color: #333;
    }
    
    body.dark-mode tbody tr:hover {
      background: #383838;
    }
    
    body.dark-mode .pb-highlight {
      background: rgba(102, 126, 234, 0.2) !important;
      box-shadow: inset 3px 0 0 #667eea;
    }
    
    body.dark-mode .export-btn {
      background: #2d5016;
      color: #a5d6a7;
    }
    
    body.dark-mode .export-btn:hover {
      background: #1b5e20;
      color: white;
    }
    
    body.dark-mode option {
      background: #2d2d2d;
      color: #e0e0e0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      padding: 0;
      margin: 0;
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
      font-size: 15px;
      line-height: 1.6;
      letter-spacing: -0.01em;
    }

    /* Typography Hierarchy */
    h1 { 
      font-size: 2em; 
      font-weight: 600; 
      line-height: 1.2; 
      letter-spacing: -0.02em;
      margin-bottom: 0.5em;
    }
    h2 { 
      font-size: 1.5em; 
      font-weight: 600; 
      line-height: 1.3; 
      letter-spacing: -0.015em;
      margin-bottom: 0.75em;
    }
    h3 { 
      font-size: 1.25em; 
      font-weight: 600; 
      line-height: 1.4; 
      letter-spacing: -0.01em;
      margin-bottom: 0.5em;
    }
    h4 { 
      font-size: 1.1em; 
      font-weight: 600; 
      line-height: 1.4;
      margin-bottom: 0.5em;
    }

    .container {
      max-width: 100%;
      margin: 0;
      background: var(--container-bg);
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      transition: background 0.3s ease;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--header-bg-start) 0%, var(--header-bg-end) 100%);
      color: white;
      padding: 20px 40px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }

    .dark-mode-toggle {
      position: absolute;
      top: 20px;
      right: 40px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 14px;
      height: 36px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .dark-mode-toggle:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 15px;
      font-weight: 300;
      letter-spacing: 1px;
    }

    .header-links {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .header-links a {
      color: #fff;
      text-decoration: none;
      padding: 8px 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 0.9em;
      transition: all 0.3s;
    }

    .header-links a:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    /* Kompakte Athletensuche in der Ecke (nur f√ºr Admins) */
    .compact-athlete-search {
      position: absolute;
      top: 20px;
      right: 110px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 18px;
      padding: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      display: none;
      align-items: center;
      gap: 0;
      width: 36px;
      height: 36px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: visible;
      cursor: pointer;
    }

    .compact-athlete-search:hover,
    .compact-athlete-search:focus-within {
      width: 220px;
      border-radius: 18px;
      gap: 6px;
      padding: 0 10px;
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(102, 126, 234, 0.3);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
      cursor: default;
      overflow: visible;
    }

    .compact-athlete-search.has-selection {
      width: 220px;
      border-radius: 18px;
      gap: 6px;
      padding: 0 10px;
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(102, 126, 234, 0.3);
      overflow: visible;
    }

    .compact-athlete-search .search-icon {
      font-size: 1.1em;
      color: white;
      opacity: 0.95;
      transition: all 0.3s;
      flex-shrink: 0;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .compact-athlete-search:hover .search-icon,
    .compact-athlete-search:focus-within .search-icon {
      opacity: 1;
      color: #667eea;
      filter: none;
      width: auto;
      height: auto;
    }

    .compact-athlete-search.has-selection .search-icon {
      color: #667eea;
      opacity: 1;
      filter: none;
      width: auto;
      height: auto;
    }

    .compact-athlete-search input {
      border: none;
      background: white;
      padding: 0 8px;
      height: 28px;
      font-size: 0.85em;
      flex: 1;
      min-width: 0;
      color: #333;
      opacity: 0;
      width: 0;
      transition: opacity 0.3s ease 0.1s;
      border-radius: 5px;
    }

    .compact-athlete-search:hover input,
    .compact-athlete-search:focus-within input {
      opacity: 1;
      width: auto;
      background: white;
    }

    .compact-athlete-search.has-selection input {
      display: none;
    }

    .compact-athlete-search input::placeholder {
      color: rgba(0, 0, 0, 0.4);
      font-size: 0.95em;
    }

    .compact-athlete-search input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .compact-athlete-search .autocomplete-suggestions {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      left: 0;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      max-height: 300px;
      overflow-y: auto;
      z-index: 10000;
      border: 1px solid #e0e0e0;
      display: none;
    }

    body.dark-mode .compact-athlete-search .autocomplete-suggestions {
      background: var(--card-bg);
      border-color: var(--border-color);
    }

    .compact-athlete-search .autocomplete-suggestions.show {
      display: block;
    }

    .compact-athlete-search .autocomplete-suggestions .suggestion-item {
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.2s;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.9em;
    }

    body.dark-mode .compact-athlete-search .autocomplete-suggestions .suggestion-item {
      color: var(--text-primary);
      border-bottom-color: var(--border-color);
    }

    .compact-athlete-search .autocomplete-suggestions .suggestion-item:last-child {
      border-bottom: none;
    }

    .compact-athlete-search .autocomplete-suggestions .suggestion-item:hover {
      background: #f5f5f5;
    }

    body.dark-mode .compact-athlete-search .autocomplete-suggestions .suggestion-item:hover {
      background: var(--table-hover-bg);
    }

    .compact-athlete-search .selected-info {
      font-size: 0.8em;
      color: #333;
      display: none;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      padding: 0 8px;
      height: 28px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      background: white;
      border-radius: 5px;
      font-weight: 500;
    }

    .compact-athlete-search.has-selection .selected-info {
      display: flex;
    }

    .compact-athlete-search .clear-btn {
      cursor: pointer;
      color: rgba(0, 0, 0, 0.4);
      font-size: 1em;
      padding: 0 5px;
      border-radius: 50%;
      transition: all 0.2s;
      line-height: 1;
      flex-shrink: 0;
      opacity: 0;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .compact-athlete-search.has-selection .clear-btn,
    .compact-athlete-search:hover .clear-btn {
      opacity: 1;
    }

    .compact-athlete-search .clear-btn:hover {
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
    }

    .content {
      padding: 0px 40px 40px 40px;
    }

    .section {
      margin-bottom: 0px;
      background: transparent;
      border-radius: 0px;
      padding: 0px;
      box-shadow: none;
      transition: background 0.3s ease;
    }

    .section h2 {
      color: var(--accent-color);
      font-size: 1.8em;
      margin-bottom: 15px;
      font-weight: 500;
      border-bottom: 3px solid var(--accent-color);
      padding-bottom: 10px;
    }

    /* Kompakte Athletensuche in der Ecke (nur f√ºr Admins) */
    .compact-athlete-search {
      position: absolute;
      top: 20px;
      right: 110px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 18px;
      padding: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      display: none;
      align-items: center;
      gap: 0;
      width: 36px;
      height: 36px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: visible;
      cursor: pointer;
    }

    .compact-athlete-search.active {
      display: flex;
    }

    .compact-athlete-search:hover,
    .compact-athlete-search:focus-within {
      width: 220px;
      border-radius: 18px;
      gap: 6px;
      padding: 0 10px;
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(102, 126, 234, 0.3);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
      cursor: default;
      overflow: visible;
    }

    .compact-athlete-search.has-selection {
      width: 220px;
      border-radius: 18px;
      gap: 6px;
      padding: 0 10px;
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(102, 126, 234, 0.3);
      overflow: visible;
    }

    .compact-athlete-search .search-icon {
      font-size: 1.1em;
      color: white;
      opacity: 0.95;
      transition: all 0.3s;
      flex-shrink: 0;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .compact-athlete-search:hover .search-icon,
    .compact-athlete-search:focus-within .search-icon {
      opacity: 1;
      color: #667eea;
      filter: none;
      width: auto;
      height: auto;
    }

    .compact-athlete-search.has-selection .search-icon {
      color: #667eea;
      opacity: 1;
      filter: none;
      width: auto;
      height: auto;
    }

    .compact-athlete-search input {
      border: none;
      background: white;
      padding: 0 8px;
      height: 28px;
      font-size: 0.85em;
      flex: 1;
      min-width: 0;
      color: #333;
      opacity: 0;
      width: 0;
      transition: opacity 0.3s ease 0.1s;
      border-radius: 5px;
    }

    .compact-athlete-search:hover input,
    .compact-athlete-search:focus-within input {
      opacity: 1;
      width: auto;
      background: white;
    }

    .compact-athlete-search.has-selection input {
      display: none;
    }

    .compact-athlete-search input::placeholder {
      color: rgba(0, 0, 0, 0.4);
      font-size: 0.95em;
    }

    .compact-athlete-search input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .compact-athlete-search .autocomplete-suggestions {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      left: 0;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      max-height: 300px;
      overflow-y: auto;
      z-index: 10000;
      border: 1px solid #e0e0e0;
      display: none;
    }

    body.dark-mode .compact-athlete-search .autocomplete-suggestions {
      background: var(--card-bg);
      border-color: var(--border-color);
    }

    .compact-athlete-search .autocomplete-suggestions.show {
      display: block;
    }

    .compact-athlete-search .autocomplete-suggestions .suggestion-item {
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.2s;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.9em;
    }

    body.dark-mode .compact-athlete-search .autocomplete-suggestions .suggestion-item {
      color: var(--text-primary);
      border-bottom-color: var(--border-color);
    }

    .compact-athlete-search .autocomplete-suggestions .suggestion-item:last-child {
      border-bottom: none;
    }

    .compact-athlete-search .autocomplete-suggestions .suggestion-item:hover {
      background: #f5f5f5;
    }

    body.dark-mode .compact-athlete-search .autocomplete-suggestions .suggestion-item:hover {
      background: var(--table-hover-bg);
    }

    .compact-athlete-search .selected-info {
      font-size: 0.8em;
      color: #333;
      display: none;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      padding: 0 8px;
      height: 28px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      background: white;
      border-radius: 5px;
      font-weight: 500;
    }

    .compact-athlete-search.has-selection .selected-info {
      display: flex;
    }

    .compact-athlete-search .clear-btn {
      cursor: pointer;
      color: rgba(0, 0, 0, 0.4);
      font-size: 1em;
      padding: 0 5px;
      border-radius: 50%;
      transition: all 0.2s;
      line-height: 1;
      flex-shrink: 0;
      opacity: 0;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .compact-athlete-search.has-selection .clear-btn,
    .compact-athlete-search:hover .clear-btn {
      opacity: 1;
    }

    .compact-athlete-search .clear-btn:hover {
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
    }

    /* Dark Mode Anpassungen */
    body.dark-mode .compact-athlete-search {
      background: rgba(30, 30, 30, 0.6);
      border-color: rgba(255, 255, 255, 0.2);
    }

    body.dark-mode .compact-athlete-search:hover,
    body.dark-mode .compact-athlete-search:focus-within,
    body.dark-mode .compact-athlete-search.has-selection {
      background: rgba(45, 45, 45, 0.95);
      border-color: rgba(102, 126, 234, 0.4);
    }

    body.dark-mode .compact-athlete-search input {
      background: rgba(60, 60, 60, 0.8);
      color: #e0e0e0;
    }

    body.dark-mode .compact-athlete-search input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    body.dark-mode .compact-athlete-search .selected-info {
      background: rgba(60, 60, 60, 0.8);
      color: #e0e0e0;
    }

    body.dark-mode .compact-athlete-search .clear-btn {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Tablet Anpassungen */
    @media (max-width: 1024px) {
      .compact-athlete-search {
        right: 120px;
      }
      
      .compact-athlete-search:hover,
      .compact-athlete-search:focus-within,
      .compact-athlete-search.has-selection {
        width: 200px;
      }
      
      .dark-mode-toggle {
        right: 30px;
      }
    }

    /* Reduziere unteren Abstand in Athleten-Box */
    .section:has(#athletSuche) {
      padding-bottom: 8px;
    }


    .search-box {
      background: var(--card-bg);
      padding: 12px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px var(--shadow-color);
      margin-bottom: 12px;
      transition: background 0.3s ease;
    }

    .search-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.9em;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95em;
      transition: all 0.3s;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Entferne Pfeile bei number inputs */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
    }

    /* Unified Button Styles */
    button {
      background: var(--btn-primary-bg);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: var(--border-radius);
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px var(--shadow-color);
      font-family: inherit;
      letter-spacing: -0.01em;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px var(--shadow-color);
    }

    .export-btn {
      background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
      margin-left: 10px;
    }

    .export-btn:hover {
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .reset-btn {
      background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
      margin-left: 10px;
    }

    .reset-btn:hover {
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
    }

    .results-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      font-weight: 500;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }

    .results-count {
      font-size: 1.1em;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .avg-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 10px 20px;
      font-size: 0.9em;
    }

    .avg-btn:hover {
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }

    .avg-buttons {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .columns-section {
      background: white;
      padding: 12px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .columns-section h3 {
      color: #2a5298;
      margin-bottom: 12px;
      font-size: 1.1em;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .checkbox-label:hover {
      background: #e9ecef;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .checkbox-label.all-columns {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      grid-column: 1 / -1;
    }

    .checkbox-label.all-columns input[type="checkbox"] {
      accent-color: white;
    }

    .filter-section {
      background: white;
      padding: 12px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 15px;
    }
    
    /* Sehr kleine Abst√§nde zwischen Filtern im Leistungen-Bereich */
    #leistungenTab .filter-section {
      margin-bottom: 5px;
    }
    
    #leistungenTab .columns-section {
      margin-bottom: 5px;
    }
    
    /* Reduziere padding innerhalb der Filter-Boxen im Leistungen-Bereich */
    #leistungenTab .filter-section,
    #leistungenTab .columns-section {
      padding: 8px 10px;
    }
    
    /* Reduziere Abst√§nde innerhalb der Filterboxen */
    #leistungenTab .filter-section h3,
    #leistungenTab .columns-section h3 {
      margin-bottom: 8px;
    }
    
    #leistungenTab .filter-group {
      margin-bottom: 5px;
    }
    
    #leistungenTab .filter-group:last-child {
      margin-bottom: 0;
    }
    
    /* Gr√∂√üerer Abstand √ºber den Buttons im Leistungen-Bereich */
    #leistungenTab .button-group {
      margin-top: 20px;
    }
    
    /* Graue Boxen um Filter-Gruppen im Analyse-Bereich */
    #analyseTab .filter-group {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      min-width: 0;
      overflow: hidden;
    }
    
    /* Responsive: Analyse-Filter auf mobil untereinander */
    @media (max-width: 768px) {
      #analyseTab .filter-section > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
    }


    /* Reduzierte Abst√§nde zwischen Filtern im Leistungen-Tab */
    #leistungenTab .columns-section {
      margin-bottom: 8px;
    }
    
    #leistungenTab .filter-section {
      margin-bottom: 8px;
    }

    .filter-section h3 {
      color: #2a5298;
      margin-bottom: 12px;
      font-size: 1.1em;
    }

    .filter-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .filter-group {
      margin-bottom: 12px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .filter-group strong {
      display: block;
      margin-bottom: 10px;
      color: #2a5298;
      font-size: 0.95em;
    }

    .filter-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-controls input,
    .filter-controls select {
      min-width: 150px;
    }

    .filter-controls select {
      flex: 0 0 auto;
      width: 150px;
      min-width: 150px;
      max-width: 150px;
    }

    .filter-controls input[type="text"],
    .filter-controls input[type="number"] {
      flex: 1;
      min-width: 200px;
    }

    .filter-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
      color: #495057;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 10px;
    }

    /* Modern Table Styles */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 1px 3px var(--shadow-color);
      transition: background 0.3s ease;
      table-layout: auto;
      border: 1px solid var(--border-color);
    }

    thead {
      z-index: 10;
    }


    th {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 14px 16px;
      text-align: center;
      font-weight: 600;
      font-size: 0.8em;
      transition: all 0.2s ease;
      white-space: nowrap;
      min-width: 80px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* Resizable columns */
    th:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 3px;
      height: 100%;
      cursor: col-resize;
      user-select: none;
      background: rgba(255, 255, 255, 0.2);
      transition: background 0.2s;
    }
    
    th:not(:last-child):hover::after {
      background: rgba(255, 255, 255, 0.4);
    }

    th:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
      text-align: center;
      transition: all 0.15s ease;
      font-size: 0.9em;
    }

    /* Subtle zebra stripes */
    tbody tr:nth-child(even) {
      background: rgba(102, 126, 234, 0.02);
    }
    
    body.dark-mode tbody tr:nth-child(even) {
      background: rgba(102, 126, 234, 0.05);
    }

    /* Improved hover effect */
    tbody tr:hover {
      background: var(--table-hover-bg) !important;
      transform: scale(1.001);
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    tbody tr {
      transition: all 0.15s ease;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* PB Row highlighting */
    tr.pb-row {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(102, 126, 234, 0.02) 100%) !important;
      border-left: 3px solid var(--primary-color);
    }

    body.dark-mode tr.pb-row {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.15) 0%, rgba(102, 126, 234, 0.05) 100%) !important;
    }

    tr.pb-row:hover td {
      background: linear-gradient(90deg, #ffeccc 0%, #f8f9fa 100%) !important;
    }

    tr.pb-row td:first-child::before {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>');
      background-size: contain;
      background-repeat: no-repeat;
      vertical-align: middle;
      margin-right: 6px;
    }
      filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.4));

    tr.year-separator {
      height: 4px;
      background: transparent;
    }

    tr.year-separator td {
      padding: 0;
      border-top: 2px solid #667eea;
      border-bottom: none;
      background: linear-gradient(90deg, transparent 0%, #667eea 50%, transparent 100%);
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }

    .dialog-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .dialog-overlay.show {
      display: flex;
    }

    .dialog-box {
      background: white;
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
    }

    .dialog-box h3 {
      color: #2a5298;
      margin-bottom: 12px;
      font-size: 1.3em;
    }

    .dialog-box label {
      display: block;
      margin-bottom: 8px;
      color: #495057;
      font-weight: 500;
    }

    .dialog-box select {
      width: 100%;
      margin-bottom: 20px;
    }

    .dialog-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .dialog-buttons button {
      padding: 10px 20px;
    }

    .cancel-btn {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 0px;
      margin-bottom: 25px;
      margin-top: 0px;
      padding-bottom: 0;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
      background: transparent;
    }

    .tab-btn {
      background: #f5f5f5;
      color: #6c757d;
      border: none;
      padding: 12px 28px;
      border-radius: 0px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: none;
      border-bottom: 3px solid transparent;
      position: relative;
      border-right: 1px solid #e0e0e0;
    }

    .tab-btn:last-child {
      border-right: none;
    }

    .tab-btn:hover {
      background: #e8e8e8;
      color: #495057;
      transform: none;
      box-shadow: none;
    }

    .tab-btn.active {
      background: white;
      color: #667eea;
      border-bottom: 3px solid #667eea;
      border-top: 1px solid #e0e0e0;
      border-left: 1px solid #e0e0e0;
      border-right: 1px solid #e0e0e0;
      box-shadow: none;
      transform: none;
      font-weight: 700;
    }

    .tab-btn.active::after {
      display: none;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Chart Container */
    .chart-container {
      background: white;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-top: 20px;
    }

    .chart-wrapper {
      width: 100%;
      height: 400px;
      position: relative;
    }

    #leistungsChart {
      width: 100% !important;
      height: 100% !important;
    }


    /* Autocomplete Suggestions */
    .autocomplete-suggestions {
      position: absolute;
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      width: calc(100% - 4px);
      box-shadow: 0 4px 12px var(--shadow-color);
      display: none;
    }

    .autocomplete-suggestions.active {
      display: block;
    }

    .autocomplete-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
      color: var(--text-primary);
    }

    .autocomplete-item:hover {
      background: var(--table-hover-bg);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item strong {
      color: var(--accent-color);
    }

    .selected-athlete {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      margin-top: 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
    }

    .selected-athlete.active {
      display: flex;
    }

    .selected-athlete-info {
      font-size: 1.1em;
      font-weight: 500;
    }

    .clear-athlete-btn {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .clear-athlete-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .content {
        padding: 15px;
      }

      .section {
        padding: 15px;
        margin-bottom: 20px;
      }

      .section h2 {
        font-size: 1.4em;
        margin-bottom: 15px;
        padding-bottom: 8px;
      }

      .header {
        padding: 20px 15px 25px;
      }

      .header h1 {
        font-size: 1.5em;
        margin-bottom: 10px;
      }

      .header-links {
        gap: 10px;
      }

      .header-links a {
        font-size: 0.8em;
        padding: 6px 12px;
      }
      
      .logout-btn {
        top: 15px !important;
        left: 15px !important;
        padding: 6px 12px !important;
        font-size: 0.8em !important;
      }

      .search-box {
        padding: 15px;
      }

      .columns-section {
        padding: 15px;
      }

      .columns-section h3 {
        font-size: 1em;
        margin-bottom: 12px;
      }

      .checkbox-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .checkbox-label {
        padding: 8px 12px;
      }

      .filter-section {
        padding: 15px;
      }

      .filter-section h3 {
        font-size: 1em;
        margin-bottom: 12px;
      }

      .filter-container {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .filter-group {
        margin-bottom: 8px;
        padding: 10px;
      }

      .filter-group strong {
        font-size: 0.85em;
        margin-bottom: 6px;
      }

      .filter-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .filter-controls input,
      .filter-controls select {
        width: 100%;
        min-width: auto;
        max-width: none;
        padding: 10px 12px;
        font-size: 0.9em;
      }

      .filter-controls label {
        width: 100%;
      }

      .filter-controls label input {
        width: 100%;
      }

      .disziplin-filter-row {
        flex-direction: column !important;
        align-items: stretch !important;
      }

      .disziplin-filter-row select,
      .disziplin-filter-row input {
        min-width: auto !important;
      }

      .disziplin-filter-row span {
        text-align: center;
        margin: 4px 0;
      }

      .button-group {
        flex-direction: column;
        gap: 8px;
      }

      .button-group button {
        width: 100%;
        margin-left: 0 !important;
      }

      .avg-buttons {
        flex-direction: column;
        gap: 8px;
      }

      .avg-buttons button {
        width: 100%;
      }

      .results-info {
        flex-direction: column;
        gap: 10px;
        padding: 12px 15px;
      }

      .results-count {
        font-size: 1em;
      }

      table {
        font-size: 0.75em;
        min-width: 600px;
      }

      th, td {
        padding: 6px 4px;
        white-space: nowrap;
      }

      .table-wrapper {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }

      .dialog-box {
        padding: 20px;
        width: 95%;
      }

      .dialog-box h3 {
        font-size: 1.1em;
        margin-bottom: 15px;
      }

      .tab-navigation {
        gap: 8px;
        margin-bottom: 20px;
      }

      .tab-btn {
        padding: 12px 24px;
        font-size: 0.95em;
      }

      .chart-wrapper {
        height: 300px;
      }
    }
  
    /* ========== DASHBOARD STYLES ========== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .stat-card-dashboard {
      background: linear-gradient(135deg, var(--stat-card-bg-start) 0%, var(--stat-card-bg-end) 100%);
      border-left: 4px solid var(--accent-color);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: 0 3px 10px var(--shadow-color);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .stat-card-dashboard:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
    }

    .stat-card-dashboard .label {
      font-size: 0.9em;
      color: #764ba2;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .stat-card-dashboard .value {
      font-size: 3em;
      font-weight: 700;
      color: #1e3c72;
      line-height: 1;
    }

    .pb-grid-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .pb-grid-dashboard-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .pb-card-dashboard {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 15px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    .pb-card-dashboard:hover {
      border-color: var(--accent-color);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .pb-card-dashboard::before {
      content: 'üèÖ';
      position: absolute;
      bottom: -10px;
      right: -10px;
      font-size: 5em;
      opacity: 0.08;
      transform: rotate(-15deg);
    }

    .pb-card-dashboard .rank {
      position: absolute;
      top: 20px;
      right: 15px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1em;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .pb-card-dashboard .discipline {
      font-size: 0.95em;
      color: #616161;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .pb-card-dashboard .performance {
      font-size: 2em;
      font-weight: 700;
      color: #1e3c72;
      margin-bottom: 6px;
      line-height: 1;
    }

    .pb-card-dashboard .date {
      font-size: 0.85em;
      color: #757575;
    }

    .dashboard-section-title {
      font-size: 1.5em;
      font-weight: 600;
      color: #1e3c72;
      margin: 10px 0 15px;
      padding-left: 15px;
      border-left: 4px solid #667eea;
    }
    
    .dashboard-goals-subtitle {
      font-size: 1.1em;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 12px 0;
      padding: 0;
    }

    .no-data-message {
      text-align: center;
      padding: 40px;
      color: #757575;
      font-size: 1.1em;
    }

    .dashboard-welcome {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
      text-align: center;
    }

    .dashboard-welcome h3 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .dashboard-welcome p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    /* Ziel-Tracker Styles */
    .goal-card {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px var(--shadow-color);
    }

    .goal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-color);
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .goal-discipline {
      font-size: 1.2em;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .goal-type-label {
      font-size: 0.85em;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .goal-delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.3s;
    }

    .goal-delete-btn:hover {
      background: #c82333;
      transform: scale(1.05);
    }

    .goal-values {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }

    .goal-value-item {
      text-align: center;
    }

    .goal-value-label {
      font-size: 0.8em;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .goal-value-number {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .goal-value-explanation {
      font-size: 0.7em;
      color: var(--text-muted);
      margin-top: 3px;
      font-style: italic;
    }

    .goal-value-number.current {
      color: #667eea;
    }

    .goal-value-number.target {
      color: #28a745;
    }

    .goal-value-number.remaining {
      color: #ffc107;
    }

    .goal-progress-bar {
      width: 100%;
      height: 30px;
      background: var(--section-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      position: relative;
      margin-bottom: 10px;
    }

    .goal-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary));
      border-radius: var(--border-radius);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9em;
    }

    .goal-progress-fill.complete {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    .goal-status {
      text-align: center;
      font-size: 0.9em;
      color: var(--text-muted);
      font-style: italic;
    }

    .goal-form {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      border: 2px dashed var(--border-color);
    }

    .goal-form-row {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 15px;
      align-items: end;
    }

    .no-goals-message {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 1.1em;
    }
    
    .dashboard-goal-card {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px var(--shadow-color);
      overflow: visible;
    }
    
    .dashboard-goal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-color);
      border-color: var(--accent-color);
    }
    
    .dashboard-goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .dashboard-goal-discipline {
      font-size: 1em;
      font-weight: 600;
      color: var(--accent-color);
    }
    
    .dashboard-goal-percentage {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .dashboard-goal-progress-bar {
      width: 100%;
      height: 20px;
      background: var(--section-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      position: relative;
      margin-bottom: 8px;
    }
    
    .dashboard-goal-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary));
      border-radius: var(--border-radius);
      transition: width 0.5s ease;
    }
    
    .dashboard-goal-progress-fill.complete {
      background: linear-gradient(90deg, #28a745, #20c997);
    }
    
    .dashboard-goal-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85em;
      color: var(--text-muted);
    }

    /* Vertikale Anzeige f√ºr mehr als 3 Ziele */
    #dashboardGoalsList.vertical-layout,
    #dashboardSeasonGoalsList.vertical-layout,
    #dashboardCareerGoalsList.vertical-layout {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      overflow-y: visible;
      padding-bottom: 10px;
    }

    #dashboardGoalsList.vertical-layout .dashboard-goal-card,
    #dashboardSeasonGoalsList.vertical-layout .dashboard-goal-card,
    #dashboardCareerGoalsList.vertical-layout .dashboard-goal-card {
      min-width: 120px;
      max-width: 140px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      margin-bottom: 0;
    }

    /* Vertikaler Fortschrittsbalken */
    .dashboard-goal-progress-bar.vertical {
      width: 100%;
      height: 200px;
      background: var(--section-bg);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px var(--shadow-color);
      position: relative;
      display: flex;
      flex-direction: column-reverse;
      margin: 15px 0;
    }

    .dashboard-goal-progress-fill.vertical {
      width: 100%;
      background: linear-gradient(180deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9em;
      transition: height 0.5s ease;
      border-radius: 20px;
      min-height: 30px;
    }

    .dashboard-goal-progress-fill.vertical.complete {
      background: linear-gradient(180deg, #28a745 0%, #20c997 100%);
    }

    /* Bearbeitungsformular */
    .goal-edit-form {
      background: var(--section-bg);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }

    .goal-edit-form .form-grid {
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .goal-edit-form .form-group {
      margin-bottom: 0;
    }

    .goal-edit-form label {
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .goal-edit-form input {
      padding: 8px;
      font-size: 0.95em;
    }

    .goal-edit-form .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .goal-edit-form button {
      flex: 1;
      padding: 10px;
      font-size: 0.9em;
    }

    .goal-save-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .goal-cancel-btn {
      background: #6c757d;
    }

    .goal-cancel-btn:hover {
      background: #5a6268;
    }

    .goal-edit-btn {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      padding: 6px 12px;
      font-size: 0.85em;
      border-radius: 6px;
      margin-right: 8px;
    }

    .goal-edit-btn:hover {
      background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
    }

    @media (max-width: 768px) {
      .goal-values {
        grid-template-columns: 1fr;
      }

      .goal-form-row {
        grid-template-columns: 1fr;
      }
    }
    
    /* Dashboard Container Styles */
    .dashboard-athlete-info {
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-radius: var(--border-radius);
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .dashboard-performance-container {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
    }
    
    .dashboard-map-container {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .dashboard-top3-container {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .dashboard-goals-container {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    /* Fixe overflow f√ºr Hover-Effekt */
    #dashboardGoalsSection {
      overflow: visible !important;
    }
    
    .dashboard-goals-container {
      overflow: visible !important;
    }
    
    #dashboardGoalsList {
      overflow: visible !important;
    }
    
    
    /* Top 3 Disziplinen Hover-Effekt */
    .dashboard-top3-item {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .dashboard-top3-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
    }
    /* Map Elemente */
    .map-legend {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.85em;
    }
    
    .map-reset-btn {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: var(--card-bg);
      color: #2a5298;
      border: 1.5px solid #2a5298;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .map-reset-btn:hover {
      background: #667eea;
      color: white;
      transform: none;
    }
    
    .map-fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 15px;
      background: var(--card-bg);
      color: #2a5298;
      border: 1.5px solid #2a5298;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    
    .map-fullscreen-btn:hover {
      background: #667eea;
      color: white;
      transform: scale(1.05);
    }
    
    .map-fullscreen-btn svg {
      display: block;
    }
    
    /* Vollbild-Modus */
    #mapContainer.fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999 !important;
      border-radius: 0 !important;
      margin: 0 !important;
    }
    
    .map-tooltip {
      display: none;
      position: absolute;
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 0.9em;
      pointer-events: none;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .pb-grid-dashboard {
        grid-template-columns: 1fr;
      }
      
      #dashboardGoalsList {
        display: block !important;
      }
      
      /* Header Anpassungen f√ºr Mobile */
      .header {
        padding: 20px 15px;
      }
      
      .header h1 {
        font-size: 1.5em;
      }
      
      .dark-mode-toggle {
        top: 20px;
        right: 15px;
        padding: 8px 12px;
        font-size: 1em;
      }
      
      .logout-btn {
        top: 20px !important;
        left: 15px !important;
        padding: 8px 12px !important;
        font-size: 0.85em !important;
      }
      
      /* Dashboard f√ºr Mobile */
      .stat-card-dashboard {
        padding: 20px;
      }
      
      .stat-card-dashboard .value {
        font-size: 2.5em;
      }
      
      /* Top Bestleistungen und Karte untereinander auf Mobile */
      #dashboardMapGrid {
        grid-template-columns: 1fr !important;
      }
      
      /* Bestleistungen Container H√∂he reduzieren auf Mobile */
      #dashboardMapGrid > div > div[style*="height: 640px"] {
        height: 500px !important;
      }
      
      /* Karten-Container H√∂he anpassen */
      #mapContainer {
        height: 400px !important;
      }
      
      /* Login Box f√ºr Mobile */
      .login-box {
        padding: 30px 20px;
        max-width: 100%;
      }
      
      .login-box h1 {
        font-size: 1.8em;
      }
      
      /* Tab Navigation f√ºr Mobile */
      .tab-navigation {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .tab-btn {
        flex: 1 1 45%;
        min-width: 140px;
        font-size: 0.85em;
        padding: 10px 12px;
      }
      
      /* Kompakte Athletensuche f√ºr Mobile */
      .compact-athlete-search {
        position: relative;
        top: auto;
        right: auto;
        transform: none;
        margin: 15px auto 0;
        width: calc(100% - 40px) !important;
        padding: 8px 15px !important;
        gap: 12px !important;
      }
      
      .compact-athlete-search input {
        font-size: 0.9em;
        opacity: 1 !important;
        width: auto !important;
      }
      
      .compact-athlete-search .selected-info {
        font-size: 0.8em;
      }
      
      .dark-mode-toggle {
        top: 20px;
        right: 20px;
        padding: 8px 12px;
        font-size: 1em;
      }
      
      /* Ziel-Tracker f√ºr Mobile */
      .goal-values {
        grid-template-columns: 1fr !important;
        gap: 10px;
      }
      
      .goal-form-row {
        grid-template-columns: 1fr !important;
      }
      
      /* Chart Container */
      #diagrammContainer {
        height: 300px !important;
      }
      
      /* Filter-Container auf Mobile gestapelt */
      .filter-container {
        grid-template-columns: 1fr !important;
      }
      
      /* Buttons volle Breite auf Mobile */
      .button-group {
        flex-direction: column;
      }
      
      .button-group button {
        width: 100%;
      }
      
      /* NEUE MOBILE-OPTIMIERUNGEN */
      
      /* Logo kleiner auf Mobile */
      .header img[alt="TrackUp Logo"] {
        width: 180px !important;
        max-width: 50vw;
      }
      
      /* Logo-Container Padding auf Mobile reduzieren */
      .header > div[style*="padding: 20px 0"] {
        padding: 10px 0 5px 0 !important;
      }
      
      /* Icon-Button (Logout) f√ºr Mobile */
      .icon-button {
        top: 20px !important;
        left: 15px !important;
      }
      
      /* WICHTIG: Orte-Tabelle unter Top 3 Disziplinen auf Mobile */
      #bottomSection {
        grid-template-columns: 1fr !important;
      }
      
      /* Tabellen-Optimierung f√ºr Mobile: Spalten nur so breit wie Inhalt */
      table {
        table-layout: auto !important;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      th, td {
        padding: 10px 8px !important;
        font-size: 0.9em !important;
        white-space: nowrap;
      }
      
      /* Erste Spalte (Datum) etwas breiter */
      th:first-child, td:first-child {
        min-width: 80px;
      }
      
      /* Disziplin Spalte */
      th:nth-child(2), td:nth-child(2) {
        min-width: 70px;
      }
      
      /* Leistung Spalte */
      th:nth-child(3), td:nth-child(3) {
        min-width: 60px;
      }
      
      /* Zus√§tzliche Spalten kompakter */
      th:nth-child(n+4), td:nth-child(n+4) {
        min-width: 80px;
      }
      
      /* Top 3 Disziplinen auf Mobile eingeklappt halten */
      #topDisziplinenSection {
        display: none !important;
      }
      
      /* Orts-Tabelle auf Mobile unter der Karte anzeigen */
      #ortTableMobileContainer {
        display: block !important;
      }
    }
    
    /* Tablet Optimierungen */
    @media (min-width: 769px) and (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .pb-grid-dashboard {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .container {
        max-width: 95%;
      }
      
      .tab-btn {
        font-size: 0.9em;
      }
    }
    
    /* Mobile-spezifische Optimierungen f√ºr alle Tabs */
    @media (max-width: 768px) {
      /* Reduziere Seitenr√§nder im gesamten Container */
      .container {
        margin: 0 8px;
        border-radius: var(--border-radius);
      }
      
      /* Reduziere Header-Padding */
      .header {
        padding: 20px 15px;
      }
      
      /* Dark Mode Toggle auf Mobile */
      .dark-mode-toggle {
        top: 20px;
        right: 15px;
        padding: 8px 12px;
      }
      
      /* Tab-Navigation */
      .tabs {
        padding: 0 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .tab-btn {
        padding: 12px 15px;
        font-size: 0.85em;
        white-space: nowrap;
      }
      
      /* Content-Bereiche */
      .section {
        padding: 15px 10px;
      }
      
      .filter-section {
        padding: 15px 10px;
      }
      
      /* Filter-Groups */
      .filter-group {
        padding: 12px;
        margin-bottom: 10px;
      }
      
      /* Charts */
      .chart-container {
        padding: 10px;
      }
      
      #diagrammContainer,
      #sbDiagrammContainer {
        padding: 8px !important;
      }
      
      /* Buttons */
      button {
        padding: 10px 15px;
        font-size: 0.9em;
      }
      
      /* Tabellen */
      table {
        font-size: 0.85em;
      }
      
      /* Dashboard-Grid */
      .dashboard-grid {
        padding: 0 8px;
      }
      
      .stat-card {
        padding: 12px;
      }
      
      /* Performance Cards */
      .performance-card {
        padding: 12px;
      }
      
      /* Inputs und Selects */
      input,
      select,
      textarea {
        font-size: 16px !important; /* Verhindert Zoom auf iOS */
      }
      
      /* Filter-Container */
      .filter-container {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 0 5px;
      }
      
      /* Ziele-Container */
      .goals-grid {
        grid-template-columns: 1fr;
      }
      
      /* Map-Container */
      .map-container {
        padding: 10px;
      }
      
      /* Ausgabe-Bereiche */
      #leistungenAusgabe,
      #statistikAusgabe,
      #pbsAusgabe {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Scrollbare Tabellen */
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -10px;
        padding: 0 10px;
      }
    }
    
    /* Sehr kleine Bildschirme (< 480px) */
    @media (max-width: 480px) {
      .container {
        margin: 0 5px;
      }
      
      .header {
        padding: 15px 10px;
      }
      
      h1 {
        font-size: 1.3em;
      }
      
      h2 {
        font-size: 1.1em;
      }
      
      h3 {
        font-size: 1em;
      }
      
      .tab-btn {
        padding: 10px 12px;
        font-size: 0.8em;
      }
      
      .section {
        padding: 10px 5px;
      }
      
      button {
        padding: 8px 12px;
        font-size: 0.85em;
      }
    }
    
    /* Gro√üe Bildschirme */
    @media (min-width: 1400px) {
      .container {
        max-width: 1600px;
      }
      
      .dashboard-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Login Screen Styles */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .login-box {
      background: var(--container-bg);
      border-radius: 16px;
      box-shadow: 0 20px 60px var(--shadow-color);
      padding: 40px;
      max-width: 450px;
      width: 100%;
      text-align: center;
    }

    .login-box h1 {
      color: var(--text-primary);
      margin-bottom: 10px;
      font-size: 2em;
    }

    .login-box p {
      color: var(--text-muted);
      margin-bottom: 30px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .login-input-group {
      text-align: left;
    }

    .login-input-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.9em;
    }

    .login-input-group input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    .login-input-group input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .login-btn {
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .login-error {
      background: #ffe6e6;
      color: #d32f2f;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
      font-size: 0.9em;
    }

    body.dark-mode .login-error {
      background: #4a1f1f;
      color: #ff6b6b;
    }

    .login-error.show {
      display: block;
    }
    
    /* Passwort anzeigen Toggle */
    .password-wrapper {
      position: relative;
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: color 0.3s;
      box-shadow: none;
    }
    
    .password-toggle:hover {
      color: var(--accent-color);
      transform: translateY(-50%);
      box-shadow: none;
    }
    
    .password-toggle svg {
      width: 20px;
      height: 20px;
    }
    
    .password-wrapper input {
      padding-right: 45px;
    }

    .main-app {
      display: none;
    }

    .main-app.logged-in {
      display: block;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 14px;
      height: 36px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s;
      margin-left: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

  </style>
</head>
<body>
<!-- ============================================
     EMAIL LOGIN SCREEN
     ============================================ -->
<div id="loginScreen" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 10px;">
  <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 450px; width: 100%;">
    
    <!-- Logo -->
    <div style="text-align: center; margin-bottom: 0px;">
      <img src="transparent-logo.svg" alt="TrackUp Logo" style="width: 140px; height: auto; margin: 0 auto; display: block;">
    </div>
    
    <p><h1 style="color: #2a5298; margin-bottom: 20px; text-align: center; font-size: 2em;">Login</h1></p>
    
    <div id="authMessage" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em;"></div>
    
    <div id="authContainer">
      <div style="display: flex; gap: 10px; margin-bottom: 30px;">
        <button id="loginTabBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 600;">Anmelden</button>
        <button id="registerTabBtn" style="flex: 1; padding: 12px; background: #f0f0f0; color: #666; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 600;">Registrieren</button>
      </div>
      
      <!-- Login Form -->
      <form id="loginForm">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">E-Mail</label>
          <input type="email" id="loginEmail" required placeholder="deine@email.de" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Passwort</label>
          <div style="position: relative;">
            <input type="password" id="loginPassword" required placeholder="Passwort" style="width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
            <button type="button" id="togglePasswordBtn" onclick="toggleLoginPassword()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; color: #666; display: flex; align-items: center; justify-content: center;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="rememberMe" style="width: 18px; height: 18px; cursor: pointer;">
            <span style="color: #666; font-size: 0.9em;">Angemeldet bleiben</span>
          </label>
        </div>
        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: var(--border-radius); font-size: 1.1em; font-weight: 600; cursor: pointer;">Anmelden</button>
      </form>
      
      <!-- Register Form -->
      <form id="registerForm" style="display: none;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Vorname</label>
          <input type="text" id="registerVorname" required placeholder="Vorname" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Nachname</label>
          <input type="text" id="registerNachname" required placeholder="Nachname" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Jahrgang</label>
          <input type="number" id="registerJahrgang" required placeholder="z.B. 2005" min="1900" max="2030" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">E-Mail</label>
          <input type="email" id="registerEmail" required placeholder="deine@email.de" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Passwort</label>
          <input type="password" id="registerPassword" required placeholder="Mindestens 6 Zeichen" minlength="6" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Passwort best√§tigen</label>
          <input type="password" id="registerPasswordConfirm" required placeholder="Passwort wiederholen" minlength="6" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: var(--border-radius); font-size: 1em;">
        </div>
        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: var(--border-radius); font-size: 1.1em; font-weight: 600; cursor: pointer;">Registrieren</button>
      </form>
    </div>
  </div>
</div>


<!-- Login Screen -->

<!-- Main Application (hidden until logged in) -->
<div id="mainApp" class="main-app" style="display: none;">

<div class="container">
  <div class="header">
    <button class="icon-button" onclick="handleLogout()" title="Abmelden" style="position: absolute; top: 20px; left: 40px; margin-left: 0;">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    </button>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Dark Mode umschalten">
      <span id="darkModeIcon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </span>
    </button>
    
    <!-- Logo -->
    <div style="display: flex; justify-content: center; align-items: center; padding: 0px 0;">
      <img src="transparent-logo.svg" alt="TrackUp Logo" style="width: 250px; height: auto;">
    </div>
    
    <!-- Kompakte Athletensuche (nur f√ºr Admins) - im Header integriert -->
    <div id="compactAthleteSearch" class="compact-athlete-search" style="display: none;">
      <span class="search-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </span>
      <input type="text" id="compactAthletSuche" placeholder="Athlet suchen..." autocomplete="off">
      <div id="compactAthletVorschlaege" class="autocomplete-suggestions"></div>
      <div id="compactSelectedInfo" class="selected-info" style="display: none;">
        <span id="compactAthletName"></span>
        <span class="clear-btn" onclick="clearCompactAthlete()">‚úï</span>
      </div>
    </div>
    
  </div>

  <div class="content">

    <!-- ================= LEISTUNGEN ================= -->
    <div class="section">
      
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('dashboard')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          Dashboard
        </button>
        <button class="tab-btn" onclick="switchTab('leistungen')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          Leistungen
        </button>
        <button class="tab-btn" onclick="switchTab('analyse')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <line x1="18" y1="20" x2="18" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="16"></line>
          </svg>
          Analyse
        </button>
        <button class="tab-btn" onclick="switchTab('ziele')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="6"></circle>
            <circle cx="12" cy="12" r="2"></circle>
          </svg>
          Ziele
        </button>
      </div>

      <!-- ============================================ -->
      <!-- DASHBOARD TAB -->
      <!-- ============================================ -->
      <div id="dashboardTab" class="tab-content active">
        
        <!-- Welcome Message -->
        <div class="dashboard-welcome" id="dashboardWelcome" style="display:none;">
          <h3>Willkommen auf dem Profil von <span id="dashboardAthletName"></span>!</h3>
        </div>
        
        <!-- Athleten Informationen -->
        <div id="athletenInfos" class="dashboard-athlete-info" style="display: none;">
            <p style="margin: 8px 0;"><strong>Name:</strong> <span id="athletVollerName"></span></p>
            <p style="margin: 8px 0;"><strong>Jahrgang:</strong> <span id="athletJahrgang"></span></p>
            <p style="margin: 8px 0;"><strong>Erste Leistung:</strong> <span id="athletErsteLeistung"></span></p>
            <p style="margin: 8px 0;"><strong>Letzte Leistung:</strong> <span id="athletLetzteLeistung"></span></p>
        </div>

        <!-- Stats Overview -->
        <div class="dashboard-grid">
          <div class="stat-card-dashboard" onclick="switchTab('leistungen')">
            <div class="label">Gesamte Leistungen</div>
            <div class="value" id="statTotalLeistungen">-</div>
          </div>

          <div class="stat-card-dashboard" onclick="switchTab('leistungen')">
            <div class="label">Wettk√§mpfe</div>
            <div class="value" id="statTotalWettkaempfe">-</div>
          </div>

          <div class="stat-card-dashboard" onclick="switchTab('leistungen')">
            <div class="label">Disziplinen</div>
            <div class="value" id="statTotalDisziplinen">-</div>
          </div>

          <div class="stat-card-dashboard" onclick="switchTab('leistungen')">
            <div class="label">Aktiv seit</div>
            <div class="value" id="statCurrentYear">2025</div>
          </div>
        </div>

        <!-- Ziele Bereich -->
        <div id="dashboardGoalsSection" style="display: none; margin-bottom: 30px; overflow: visible;">
          <h3 class="dashboard-section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="6"></circle>
              <circle cx="12" cy="12" r="2"></circle>
            </svg>
            Aktuelle Ziele
          </h3>
          <div style="background: var(--section-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em; color: var(--text-secondary); border-left: 3px solid var(--accent-color); overflow: visible;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <strong>Hinweis:</strong> Saisonziele: Baseline = SB + letzte 3 Leistungen | Karriereziele: Baseline = PB + letzte 3 Leistungen
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; overflow: visible;">
            <!-- Saisonziele -->
            <div>
              <h4 class="dashboard-goals-subtitle">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                Saisonziele
              </h4>
              <div class="dashboard-goals-container" style="overflow: visible;">
                <div id="dashboardSeasonGoalsList">
                  <div class="no-data-message">Keine Saisonziele definiert</div>
                </div>
              </div>
            </div>
            <!-- Karriereziele -->
            <div>
              <h4 class="dashboard-goals-subtitle">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;">
                  <circle cx="12" cy="8" r="7"></circle>
                  <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                </svg>
                Karriereziele
              </h4>
              <div class="dashboard-goals-container" style="overflow: visible;">
                <div id="dashboardCareerGoalsList">
                  <div class="no-data-message">Keine Karriereziele definiert</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Bestleistungen und Wettkampforte Karte nebeneinander -->
        <div id="dashboardMapGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
          
          <!-- Top Bestleistungen (JETZT LINKS) -->
          <div>
            <h3 class="dashboard-section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
              </svg>
              Top Bestleistungen
            </h3>
            <div class="dashboard-performance-container" style="height: 640px;">
              <div class="pb-grid-dashboard-2col" id="topBestleistungenGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex: 1; overflow-y: auto; overflow-x: visible; padding-top: 5px;">
                <div class="no-data-message" style="grid-column: 1 / -1;">
                  W√§hle einen Athleten aus, um Bestleistungen zu sehen
                </div>
              </div>
            </div>
          </div>

          <!-- Wettkampforte Karte (JETZT RECHTS) -->
          <div>
            <h3 class="dashboard-section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              Wettkampforte
            </h3>
            <div class="dashboard-map-container" style="height: 640px;">
              <div id="mapContainer" style="position: relative; height: 600px; background: #f8f9fa; border-radius: 8px; overflow: hidden; cursor: grab;" onmousedown="startMapDrag(event)" onwheel="zoomMap(event)">
                <svg id="germanyMap" viewBox="-100 0 600 650" style="width: 100%; height: 100%; transform-origin: 0 0;">
                  <!-- Hintergrund -->
                  <rect x="-100" y="0" width="600" height="650" fill="#f8f9fa" opacity="1"/>
                  
                  <!-- Deutschlandkarte - korrekte Grenze -->
                  <g id="germanyBorder"></g>
                  
                  <!-- Orte werden hier dynamisch eingef√ºgt -->
                  <g id="locationMarkers"></g>
                </svg>
                <div id="mapLegend" class="map-legend">
                  <div style="margin-bottom: 8px; font-weight: bold; color: #2a5298;">Leistungen:</div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 3px;">
                    <div style="width: 8px; height: 8px; background: #b3d9ff; border: 1.5px solid #66a3d2; border-radius: 50%;"></div>
                    <span>1-2</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 3px;">
                    <div style="width: 11px; height: 11px; background: #80bfff; border: 1.5px solid #4d94d9; border-radius: 50%;"></div>
                    <span>3-5</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 3px;">
                    <div style="width: 14px; height: 14px; background: #4da6ff; border: 1.5px solid #3385d6; border-radius: 50%;"></div>
                    <span>6-10</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 3px;">
                    <div style="width: 17px; height: 17px; background: #1a8cff; border: 1.5px solid #1a75d2; border-radius: 50%;"></div>
                    <span>11-20</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 20px; background: #0066cc; border: 1.5px solid #004d99; border-radius: 50%;"></div>
                    <span>20+</span>
                  </div>
                </div>
                <!-- Reset Button -->
                <button onclick="resetMapView()" class="map-reset-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                  <span>Zoom zur√ºcksetzen</span>
                </button>
                <!-- Vollbild Button -->
                <button onclick="toggleMapFullscreen()" class="map-fullscreen-btn" title="Vollbild">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                  </svg>
                </button>
                <!-- Tooltip -->
                <div id="mapTooltip" class="map-tooltip"></div>
              </div>
            </div>
          </div>
          
        </div>
        </div>

        <!-- Orts-Tabelle Container (auf Mobile unter der Karte, auf Desktop neben Top 3 Disziplinen) -->
        <div id="ortTableMobileContainer" style="display: none; margin-bottom: 30px;"></div>

        <!-- Top 3 h√§ufigste Disziplinen (LINKS) und Orts-Tabelle (RECHTS wenn ge√∂ffnet) -->
        <!-- Top 3 h√§ufigste Disziplinen (LINKS) und Orts-Tabelle (RECHTS wenn ge√∂ffnet) -->
        <div id="bottomSection" style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px;">
          
          <!-- Top 3 Disziplinen - immer links -->
          <div id="topDisziplinenSection">
            <h3 class="dashboard-section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
              </svg>
              Top 3 Disziplinen
            </h3>
            <div class="dashboard-top3-container">
              <div id="topDisziplinen" style="display: flex; gap: 0; flex-direction: column;">
                <div class="no-data-message">W√§hle einen Athleten aus</div>
              </div>
            </div>
          </div>

          <!-- Platzhalter f√ºr Orts-Tabelle (wird dynamisch rechts eingef√ºgt) -->
          
        </div>

        <!-- Alter Bestleistungen-Bereich wurde oben integriert -->

      </div>

      <!-- ============================================ -->
      <!-- ZIELE TAB -->
      <!-- ============================================ -->
      <div id="zieleTab" class="tab-content">
        
        <div id="zieleNoAthlete" style="text-align: center; padding: 60px 20px; display: block;">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 20px; color: var(--accent-color);">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="6"></circle>
            <circle cx="12" cy="12" r="2"></circle>
          </svg>
          <h3 style="color: var(--text-primary); margin-bottom: 10px;">Keine Athleten ausgew√§hlt</h3>
          <p style="color: var(--text-muted);">W√§hle einen Athleten aus, um Ziele zu verwalten</p>
        </div>

        <div id="zieleContent" style="display: none;">
          <h3 style="color: var(--text-primary); margin-bottom: 20px; font-size: 1.5em;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="6"></circle>
              <circle cx="12" cy="12" r="2"></circle>
            </svg>
            Ziele f√ºr <span id="zieleAthletName"></span>
          </h3>

          <!-- Neues Ziel hinzuf√ºgen -->
          <div class="goal-form">
            <h4 style="color: var(--text-primary); margin-bottom: 15px;">Neues Ziel hinzuf√ºgen</h4>
            <div style="background: var(--section-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; color: var(--text-secondary); border-left: 3px solid var(--accent-color);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              <strong>Hinweis:</strong> Der Ausgangswert berechnet sich aus der Personal Best (50%) und den letzten 3 Leistungen (25%, 16,5%, 8,5%).
            </div>
            <div class="goal-form-row">
              <div class="form-group">
                <label>Disziplin</label>
                <select id="goalDisziplin">
                  <option value="">-- Disziplin w√§hlen --</option>
                </select>
              </div>
              <div class="form-group">
                <label>Zieltyp</label>
                <select id="goalType">
                  <option value="season">Saisonziel</option>
                  <option value="career">Karriereziel</option>
                </select>
              </div>
              <div class="form-group">
                <label>Ziel</label>
                <input type="text" id="goalTarget" placeholder="z.B. 11.00">
              </div>
              <button onclick="addGoal()" style="white-space: nowrap;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Hinzuf√ºgen
              </button>
            </div>
          </div>

          <!-- Ziele Liste -->
          <div id="goalsList"></div>
          
        </div>
      </div>

      <!-- ============================================ -->
      <!-- LEISTUNGEN TAB -->
      <!-- ============================================ -->
      <div id="leistungenTab" class="tab-content">
        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;" id="leistungenActions">
          <button onclick="openAddLeistungModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Leistung hinzuf√ºgen
          </button>
          <button onclick="openImportModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            CSV Import
          </button>
        </div>
        
        <div class="columns-section">
          <h3>Spalten ausw√§hlen</h3>
          <div class="checkbox-grid">
            <label class="checkbox-label all-columns">
              <input type="checkbox" id="alleSpalten" onchange="toggleAlleSpalten(this)">
              Alle Spalten
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="datum" checked> Datum
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="disziplin" checked> Disziplin
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="leistung" checked> Leistung
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="platzierung"> Platzierung
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="ort"> Ort
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="wk_bz"> Wettkampfbezeichnung
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="ak"> AK
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="typ"> Freiluft/Halle
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="ms"> Meisterschaft
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="runde"> Runde
            </label>
            <label class="checkbox-label">
              <input type="checkbox" class="spalte" value="score"> Score
            </label>
          </div>
        </div>

        <div class="filter-section">
          <h3>üîß Filter</h3>

          <div id="filterContainer"></div>
          <div class="button-group">
            <button onclick="ladeLeistungen()">Anzeigen</button>
            <button class="reset-btn" onclick="alleFilterZuruecksetzen()">üîÑ Alle Filter zur√ºcksetzen</button>
            <button class="export-btn" onclick="exportiereCSV()" id="exportBtn" style="display:none;">üíæ Als CSV exportieren</button>
          </div>
        </div>
        
        <div id="leistungenAusgabe"></div>
      </div>

      <!-- ANALYSE TAB -->
      <div id="analyseTab" class="tab-content">

        <div class="filter-section">
          <details open>
      <summary style="cursor: pointer; font-size: 1.1em; font-weight: 600; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
        üìà Leistungsentwicklung
      </summary>
    
          <!-- Filter -->
          <div style="display: grid; grid-template-columns: minmax(0, 40%) minmax(0, 60%); gap: 12px; margin-bottom: 15px;">
      <div class="filter-group">
        <strong>Disziplin:</strong>
        <select id="analyseDisziplin">
          <option value="">‚Äì alle Disziplinen ‚Äì</option>
        </select>
      </div>
      
      <div class="filter-group">
        <strong>Zeitraum:</strong>
        <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; align-items: center;">
          <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap; flex: 1; min-width: 0;">
            von <input type="date" id="analyseFilterFrom" style="flex: 1; min-width: 0;">
          </label>
          <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap; flex: 1; min-width: 0;">
            bis <input type="date" id="analyseFilterTo" style="flex: 1; min-width: 0;">
          </label>
          <select id="analyseFilterJahr" style="flex: 0.8; min-width: 100px; max-width: 100%;">
            <option value="">‚Äì Jahr w√§hlen ‚Äì</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
          </select>
        </div>
      </div>
          </div>
    
          <!-- Vergleichsmodus -->
          <div style="margin-bottom: 15px;">
      <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" id="vergleichsModus" onchange="toggleVergleichsModus()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
        <span style="font-weight: 500;">Zwei Disziplinen vergleichen</span>
      </label>
      <div id="vergleichsDisziplinContainer" style="display: none; margin-top: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
        <label style="font-weight: 500; display: block; margin-bottom: 5px;">Zweite Disziplin:</label>
        <select id="vergleichsDisziplin" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
          <option value="">‚Äì Disziplin w√§hlen ‚Äì</option>
        </select>
      </div>
          </div>
    
          <!-- Leistungsentwicklung Diagramm -->
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button id="diagrammAnzeigenBtn" onclick="zeigeDiagramm()">Leistungsentwicklung anzeigen</button>
      <button id="diagrammAktualisierenBtn" onclick="zeigeDiagramm()" style="display: none;">üîÑ Aktualisieren</button>
      <button id="diagrammSchlie√üenBtn" onclick="schlie√üeDiagramm()" style="display: none;">Einklappen</button>
      <button id="diagrammAusklappenBtn" onclick="klappeAusDiagramm()" style="display: none;">Ausklappen</button>
          </div>
          <div id="diagrammContainer" style="display:none; margin-top: 20px; background: white; padding: 10px; border-radius: 8px;">
      <h4 style="margin: 0 0 10px 0; color: #2a5298;">Leistungsdiagramm</h4>
      <div style="height: 400px;">
        <canvas id="leistungsChart"></canvas>
      </div>
          </div>
          </details>
        </div>

        <div class="filter-section">
          <details>
      <summary style="cursor: pointer; font-size: 1.1em; font-weight: 600; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
        üìä SB & Saisondurchschnitte
      </summary>
    
          <!-- SB-Diagramm -->
    
          <!-- Filter -->
          <div style="display: grid; grid-template-columns: minmax(0, 40%) minmax(0, 60%); gap: 12px; margin-bottom: 15px;">
      <div class="filter-group">
        <strong>Disziplin f√ºr SB-Ansicht:</strong>
        <select id="sbDisziplin" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
          <option value="">‚Äì Disziplin w√§hlen ‚Äì</option>
        </select>
      </div>
      
      <div class="filter-group">
        <strong>Zeitraum:</strong>
        <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; align-items: center;">
          <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap; flex: 1; min-width: 0;">
            von <input type="date" id="sbFilterFrom" style="flex: 1; min-width: 0;">
          </label>
          <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap; flex: 1; min-width: 0;">
            bis <input type="date" id="sbFilterTo" style="flex: 1; min-width: 0;">
          </label>
          <select id="sbFilterJahr" style="flex: 0.8; min-width: 100px; max-width: 100%;">
            <option value="">‚Äì Jahr w√§hlen ‚Äì</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
          </select>
        </div>
      </div>
          </div>
      
      <!-- Vergleichsmodus f√ºr SB-Diagramm -->
      <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="sbVergleichsModus" onchange="toggleSBVergleichsModus()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
          <span style="font-weight: 500;">Zwei Disziplinen vergleichen</span>
        </label>
        <div id="sbVergleichsDisziplinContainer" style="display: none; margin-top: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
          <label style="font-weight: 500; display: block; margin-bottom: 5px;">Zweite Disziplin:</label>
          <select id="sbVergleichsDisziplin" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
            <option value="">‚Äì Disziplin w√§hlen ‚Äì</option>
          </select>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="sbDiagrammAnzeigenBtn" onclick="zeigeSBDiagramm()">SB-Diagramm anzeigen</button>
        <button id="sbDiagrammAktualisierenBtn" onclick="zeigeSBDiagramm()" style="display: none;">üîÑ Aktualisieren</button>
        <button id="sbDiagrammSchlie√üenBtn" onclick="schlie√üeSBDiagramm()" style="display: none;">Einklappen</button>
        <button id="sbDiagrammAusklappenBtn" onclick="klappeAusSBDiagramm()" style="display: none;">Ausklappen</button>
      </div>
      
      <!-- Checkboxen f√ºr SBs und Durchschnitte -->
      <div id="sbDiagrammOptionsContainer" style="display:none; margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
        <div style="display: flex; gap: 20px; align-items: center;">
          <strong style="color: #2a5298;">Anzeigen:</strong>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="sbShowSBs" checked onchange="zeigeSBDiagramm()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
            <span style="font-weight: 500;">Saisonbestleistungen (SB)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="sbShowAverages" checked onchange="zeigeSBDiagramm()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
            <span style="font-weight: 500;">Saisondurchschnitte (√ò)</span>
          </label>
        </div>
      </div>
      <div id="sbDiagrammContainer" style="display:none; margin-top: 20px; background: white; padding: 10px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #2a5298;">SB & Saisondurchschnitte</h4>
        <div style="height: 400px;">
          <canvas id="sbChart"></canvas>
        </div>
      </div>
          </details>
        </div>
    
        <div class="filter-section">
          <details>
      <summary style="cursor: pointer; font-size: 1.1em; font-weight: 600; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
        üîÆ Leistungsprognose
      </summary>
    
          <!-- PROGNOSE-DIAGRAMM -->
      
      <div class="filter-group" style="margin-bottom: 15px;">
        <strong>Disziplin f√ºr Prognose:</strong>
        <select id="prognoseDisziplin" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
          <option value="">‚Äì Disziplin w√§hlen ‚Äì</option>
        </select>
      </div>
      
      <div style="margin-bottom: 15px;">
        <strong>Prognosezeitraum:</strong>
        <div style="display: flex; gap: 15px; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="radio" name="prognoseZeitraum" value="12" checked style="cursor: pointer; accent-color: #667eea;">
            <span>12 Monate</span>
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="radio" name="prognoseZeitraum" value="60" style="cursor: pointer; accent-color: #667eea;">
            <span>5 Jahre</span>
          </label>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="prognoseDiagrammAnzeigenBtn" onclick="zeigePrognoseDiagramm()">Prognose anzeigen</button>
        <button id="prognoseDiagrammAktualisierenBtn" onclick="zeigePrognoseDiagramm()" style="display: none;">üîÑ Aktualisieren</button>
        <button id="prognoseDiagrammSchlie√üenBtn" onclick="schlie√üePrognoseDiagramm()" style="display: none;">Einklappen</button>
        <button id="prognoseDiagrammAusklappenBtn" onclick="klappeAusPrognoseDiagramm()" style="display: none;">Ausklappen</button>
      </div>
      <div id="prognoseDiagrammContainer" style="display:none; margin-top: 20px; background: white; padding: 10px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #2a5298;">Leistungsprognose</h4>
        <div id="prognoseInfo" style="background: #f0f8ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.95em; line-height: 1.6;"></div>
        <div style="height: 400px;">
          <canvas id="prognoseChart"></canvas>
        </div>
      </div>
          </details>
        </div>


        <div class="filter-section">
          <details>
      <summary style="cursor: pointer; font-size: 1.1em; font-weight: 600; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
        üìä Statistiken
      </summary>
    
          <!-- Filter -->
          <div style="margin-bottom: 15px;">
      <h4 style="margin: 0 0 10px 0; font-weight: 500; color: #2a5298;">Filter</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Disziplin:</label>
          <select id="statistikFilterDisziplin" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
          </select>
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Zeitraum:</label>
          <select id="statistikFilterZeitraum" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
            <option value="custom">Benutzerdefiniert</option>
          </select>
        <div id="statistikCustomDateRange" style="display: none;">
          <label style="font-size: 0.9em; font-weight: 500;">Von:</label>
          <input type="date" id="statistikFilterVon" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;">
          <label style="font-size: 0.9em; font-weight: 500;">Bis:</label>
          <input type="date" id="statistikFilterBis" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Ort:</label>
          <input type="text" id="statistikFilterOrt" placeholder="Suche Ort..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Wettkampf:</label>
          <input type="text" id="statistikFilterWK" placeholder="Suche Wettkampf..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Altersklasse:</label>
          <input type="text" id="statistikFilterAK" placeholder="Suche Altersklasse..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Freiluft/Halle</label>
          <select id="statistikFilterTyp" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
            <option value="h">Halle</option>
            <option value="f">Freiluft</option>
          </select>
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Meisterschaft:</label>
          <select id="statistikFilterMS" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
          </select>
        </div>
        <div style="text-align: right; grid-column: 1 / -1; margin-top: 10px;">
          <button class="reset-btn" onclick="statistikFilterZuruecksetzen()" style="padding: 8px 20px; font-size: 0.9em;">üîÑ Filter zur√ºcksetzen</button>
        </div>
      </div>
          </div>
    
          <div class="avg-buttons">
      <button class="avg-btn" onclick="zeigeLeistungsTabelle()">Score</button>
      <button class="avg-btn" onclick="berechneDurchschnitt('leistung')">√ò Leistung</button>
      <button class="avg-btn" onclick="berechneDurchschnitt('platzierung')">üèÖ √ò Platzierung</button>
      <button class="avg-btn" onclick="berechneErfolgsquote()">Erfolgsquote</button>
      <button class="avg-btn" onclick="zeigeSaisonvergleich()">üìÖ Saisonvergleich</button>
      <button class="avg-btn" onclick="zeigeWettkampffrequenz()">üóìÔ∏è Wettkampffrequenz</button>
      <button class="export-btn" onclick="exportiereAnalyseCSV()" id="analyseExportBtn" style="display:none;">üíæ Als CSV exportieren</button>
          </div>
          <div id="analyseAusgabe" style="margin-top: 20px;"></div>
          </details>
        </div>

        <div class="filter-section">
          <details>
      <summary style="cursor: pointer; font-size: 1.1em; font-weight: 600; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 15px;">
        üèÜ Bestleistungen
      </summary>
    
          <!-- Filter -->
          <div style="margin-bottom: 15px;">
      <h4 style="margin: 0 0 10px 0; font-weight: 500; color: #2a5298;">Filter</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Disziplin:</label>
          <select id="bestleistungenFilterDisziplin" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
          </select>
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Zeitraum:</label>
          <select id="bestleistungenFilterZeitraum" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
            <option value="custom">Benutzerdefiniert</option>
          </select>
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Ort:</label>
          <input type="text" id="bestleistungenFilterOrt" placeholder="Suche Ort..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Wettkampf:</label>
          <input type="text" id="bestleistungenFilterWK" placeholder="Suche Wettkampf..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Altersklasse:</label>
          <input type="text" id="bestleistungenFilterAK" placeholder="Suche Altersklasse..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Freiluft/Halle</label>
          <select id="bestleistungenFilterTyp" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
            <option value="h">Halle</option>
            <option value="f">Freiluft</option>
          </select>
        </div>
        <div>
          <label style="font-size: 0.9em; font-weight: 500;">Meisterschaft:</label>
          <select id="bestleistungenFilterMS" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">‚Äì Alle ‚Äì</option>
          </select>
        </div>
        <div id="bestleistungenCustomDateRange" style="display: none;">
          <label style="font-size: 0.9em; font-weight: 500;">Von:</label>
          <input type="date" id="bestleistungenFilterVon" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;">
          <label style="font-size: 0.9em; font-weight: 500;">Bis:</label>
          <input type="date" id="bestleistungenFilterBis" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="text-align: right; grid-column: 1 / -1; margin-top: 10px;">
          <button class="reset-btn" onclick="bestleistungenFilterZuruecksetzen()" style="padding: 8px 20px; font-size: 0.9em;">üîÑ Filter zur√ºcksetzen</button>
        </div>
      </div>
          </div>
    
          <div class="avg-buttons">
      <button class="avg-btn" style="background:#FFD700" onclick="zeigePBs()">PBs</button>
      <button class="avg-btn" style="background:#4facfe; color:white;" onclick="zeigeSBMenu()">‚≠ê SBs</button>
      <button class="avg-btn" style="background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);" onclick="zeigePBTimeline()">üèÖ PB-Timeline</button>
      <button class="export-btn" onclick="exportiereBestleistungenCSV()" id="bestleistungenExportBtn" style="display:none;">üíæ Als CSV exportieren</button>
          </div>
          <div id="bestleistungenAusgabe" style="margin-top: 20px;"></div>
          </details>
        </div>
</div>
      </div> <!-- Close analyseTab -->
    
    </div> <!-- Close section -->

<!-- Dialog f√ºr SB-Jahr-Auswahl -->
<div id="sbDialog" class="dialog-overlay">
  <div class="dialog-box">
    <h3>‚≠ê Saisonbestleistungen</h3>
    <label>
      <input type="radio" name="sbOption" value="single" checked onchange="toggleSBJahrAuswahl()"> Bestimmtes Jahr
    </label>
    <label style="display: block; margin-top: 10px;">
      <input type="radio" name="sbOption" value="all" onchange="toggleSBJahrAuswahl()"> Alle Jahre
    </label>
    <div id="sbJahrContainer" style="margin-top: 20px;">
      <label for="sbJahr">Jahr ausw√§hlen:</label>
      <select id="sbJahr"></select>
    </div>
    <div class="dialog-buttons">
      <button class="cancel-btn" onclick="schliesseSBDialog()">Abbrechen</button>
      <button onclick="zeigeSBsAuswahl()">SBs anzeigen</button>
    </div>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = 'https://npxdgtaadtelvxoyowkk.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5weGRndGFhZHRlbHZ4b3lvd2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNjY3MDIsImV4cCI6MjA4NDY0MjcwMn0.KTM0rN5qQU0P830I6EhaKUwNo1TM-H9XPDFD79EbJr0';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= AUTHENTICATION ================= */
let currentUser = null;
let currentAthlete = null;
let isAdmin = false;

// Show/Hide Messages
function showMessage(message, type = 'success') {
  const msgDiv = document.getElementById('authMessage');
  msgDiv.textContent = message;
  msgDiv.style.display = 'block';
  msgDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
  msgDiv.style.color = type === 'success' ? '#155724' : '#721c24';
  msgDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
}

function hideMessage() {
  document.getElementById('authMessage').style.display = 'none';
}

// Show/Hide Screens
function showLoginScreen() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
}

function showMainApp() {
  console.log('showMainApp called - displaying main app');
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  console.log('mainApp display set to block');
}

// Load User's Athlete Profile
// Check Session on Load
async function checkSession() {
  console.log('Checking session on page load...');
  
  // Wait a bit for auth state listener to initialize
  await new Promise(resolve => setTimeout(resolve, 100));
  
  // If auth is already being handled, don't interfere
  if (isHandlingAuth) {
    console.log('Auth already being handled, skipping checkSession');
    return;
  }
  
  // If auth was initialized by onAuthStateChange, skip
  if (isAuthInitialized) {
    console.log('Auth already initialized by onAuthStateChange');
    return;
  }
  
  const { data: { session }, error } = await supabaseClient.auth.getSession();
  
  if (error) {
    console.error('Session check error:', error);
    showLoginScreen();
    return;
  }
  
  console.log('Session found:', session?.user?.email);
  
  if (session && session.user) {
    // Let onAuthStateChange handle the session
    console.log('Session found, waiting for onAuthStateChange to handle it...');
  } else {
    console.log('No session found, showing login screen');
    showLoginScreen();
  }
}

// Tab Switching
window.addEventListener('DOMContentLoaded', function() {
  const loginTabBtn = document.getElementById('loginTabBtn');
  const registerTabBtn = document.getElementById('registerTabBtn');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  
  if (loginTabBtn && registerTabBtn && loginForm && registerForm) {
    loginTabBtn.addEventListener('click', () => {
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
      loginTabBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      loginTabBtn.style.color = 'white';
      registerTabBtn.style.background = '#f0f0f0';
      registerTabBtn.style.color = '#666';
      hideMessage();
    });

    registerTabBtn.addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      registerTabBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      registerTabBtn.style.color = 'white';
      loginTabBtn.style.background = '#f0f0f0';
      loginTabBtn.style.color = '#666';
      hideMessage();
    });
  }
});

// Handle Login with Password
window.addEventListener('DOMContentLoaded', function() {
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    let isSubmitting = false;
    
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Prevent multiple submissions
      if (isSubmitting) {
        console.log('Already submitting, ignoring duplicate request');
        return;
      }
      
      isSubmitting = true;
      hideMessage();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Wird angemeldet...';
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        console.log("üîê Login-Versuch:", { email, loginSuccessful: !error });
        if (error) {
          if (error.message.includes('Invalid login credentials')) {
            showMessage('‚ùå Falsche E-Mail oder Passwort.', 'error');
          } else {
            showMessage('Fehler: ' + error.message, 'error');
          }
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          isSubmitting = false;
          return;
        }
        
        // Store remember me preference
        if (rememberMe) {
          localStorage.setItem('rememberMe', 'true');
        } else {
          localStorage.removeItem('rememberMe');
        }
        
        showMessage('‚úÖ Erfolgreich angemeldet!', 'success');
        
        console.log("‚úÖ Login erfolgreich, Session:", data.session ? "vorhanden" : "nicht vorhanden");
        // The onAuthStateChange handler will take care of the rest
        
      } catch (err) {
        console.error('Login error:', err);
        showMessage('Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        isSubmitting = false;
      }
    });
  }
});

// Handle Registration with Password
window.addEventListener('DOMContentLoaded', function() {
  const registerForm = document.getElementById('registerForm');
  if (registerForm) {
    let isSubmitting = false;
    
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Prevent multiple submissions
      if (isSubmitting) {
        console.log('Already submitting, ignoring duplicate request');
        return;
      }
      
      isSubmitting = true;
      hideMessage();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Wird registriert...';
      
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
      const vorname = document.getElementById('registerVorname').value;
      const nachname = document.getElementById('registerNachname').value;
      const jahrgang = parseInt(document.getElementById('registerJahrgang').value);
      
      console.log("üìù Registrierungsdaten:", { email, vorname, nachname, jahrgang });
      
      // Validate passwords match
      if (password !== passwordConfirm) {
        showMessage('‚ùå Die Passw√∂rter stimmen nicht √ºberein.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        isSubmitting = false;
        return;
      }
      
      // Validate password length
      if (password.length < 6) {
        showMessage('‚ùå Das Passwort muss mindestens 6 Zeichen lang sein.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        isSubmitting = false;
        return;
      }
      
      try {
        // 1. Register user with email and password
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              vorname: vorname,
              name: nachname,
              jahrgang: jahrgang
            }
          }
        });
        
        if (authError) {
          if (authError.message.includes('already registered') || authError.message.includes('User already registered')) {
            showMessage('‚ùå Diese Email ist bereits registriert. Bitte melde dich stattdessen an.', 'error');
          } else {
            showMessage('Fehler: ' + authError.message, 'error');
          }
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          isSubmitting = false;
          return;
        }
        
        console.log('SignUp response:', authData);
        
        // Check if user was created successfully
        if (authData.user) {
          console.log('‚úÖ User created, database trigger will create athlete profile automatically');
          
          // Check if email confirmation is required
          if (authData.session) {
            // User is logged in immediately (no email confirmation required)
            showMessage('‚úÖ Registrierung erfolgreich! Du wirst automatisch angemeldet...', 'success');
            // The onAuthStateChange will load the user data
          } else {
            // Email confirmation required
            showMessage('‚úÖ Registrierung erfolgreich! Bitte best√§tige deine E-Mail-Adresse, um dich anzumelden.', 'success');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            isSubmitting = false;
          }
        } else {
          showMessage('‚ö†Ô∏è Unerwarteter Fehler bei der Registrierung.', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          isSubmitting = false;
        }
        
      } catch (err) {
        console.error('Registration error:', err);
        showMessage('Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        isSubmitting = false;
      }
    });
  }
});

// Handle Auth State Change (when user clicks magic link)
let isAuthInitialized = false;
let isHandlingAuth = false;
let lastProcessedUserId = null; // Track which user was last processed

supabaseClient.auth.onAuthStateChange(async (event, session) => {
  console.log('üîê Auth event:', event, 'Session:', session?.user?.email);
  
  // Prevent concurrent handling
  if (isHandlingAuth) {
    console.log('‚ö†Ô∏è Already handling auth, skipping...');
    return;
  }
  
  if (event === 'INITIAL_SESSION') {
    isAuthInitialized = true;
    if (!session) {
      console.log('‚ùå No initial session, showing login screen');
      showLoginScreen();
      return;
    }
    console.log('‚úÖ Initial session found, will process...');
    // Fall through to handle session
  }
  
  if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && session) {
    // Skip if we already processed this user
    if (lastProcessedUserId === session.user.id && event === 'SIGNED_IN') {
      console.log('‚è≠Ô∏è User already processed, skipping duplicate SIGNED_IN event');
      return;
    }
    
    isHandlingAuth = true;
    currentUser = session.user;
    console.log('üë§ User signed in:', currentUser.id, currentUser.email);
    console.log("üîç Starte Athlet-Suche f√ºr user_id:", currentUser.id);
    
    try {
      console.log("üì° Sende Query an Supabase...");
      
      // Add timeout to prevent hanging
      const queryPromise = supabaseClient
        .schema('la').from('athlet')
        .select('*')
        .eq('user_id', currentUser.id)
        .maybeSingle();
      
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Query timeout after 10 seconds')), 10000)
      );
      
      const { data: existingAthlete, error: fetchError } = await Promise.race([
        queryPromise,
        timeoutPromise.then(() => ({ data: null, error: { message: 'Timeout' } }))
      ]);
      
      console.log("üì¶ Query-Ergebnis erhalten");
      console.log('üìä Existing athlete:', existingAthlete);
      console.log('‚ùó Fetch error:', fetchError);
      
      if (fetchError) {
        console.error('‚ùå Database error:', fetchError);
        showMessage('‚ö†Ô∏è Fehler beim Laden des Profils: ' + fetchError.message, 'error');
        await supabaseClient.auth.signOut();
        isHandlingAuth = false;
        lastProcessedUserId = null;
        return;
      } else if (!existingAthlete) {
        console.log('‚ùå No athlete profile found for existing user');
        console.log('‚ö†Ô∏è Waiting for database trigger to create profile...');
        
        // Wait a moment for the trigger to execute (in case it's delayed)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Try to fetch again
        const { data: retryAthlete, error: retryError } = await supabaseClient
          .schema('la').from('athlet')
          .select('*')
          .eq('user_id', currentUser.id)
          .maybeSingle();
        
        if (retryError || !retryAthlete) {
          console.error('‚ùå Still no athlete profile found after retry');
          showMessage('‚ö†Ô∏è Kein Athleten-Profil gefunden. Bitte kontaktiere den Administrator.', 'error');
          await supabaseClient.auth.signOut();
          isHandlingAuth = false;
          lastProcessedUserId = null;
          return;
        }
        
        console.log('‚úÖ Athlete profile found after retry:', retryAthlete);
        currentAthlete = retryAthlete;
        selectedAthleteId = retryAthlete.id;
        isAdmin = retryAthlete.ist_admin || false;
        selectedAthleteName = `${retryAthlete.vorname || ''} ${retryAthlete.name || ''}`.trim();
      } else {
        console.log('‚úÖ Athlete profile found:', existingAthlete.vorname, existingAthlete.name);
        currentAthlete = existingAthlete;
        selectedAthleteId = existingAthlete.id;
        isAdmin = existingAthlete.ist_admin || false;
        selectedAthleteName = `${existingAthlete.vorname || ''} ${existingAthlete.name || ''}`.trim();
      }
      
      console.log('üé® Showing main app...');
      // Show main app
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      
      // Show admin features if user is admin
      if (isAdmin) {
        console.log('üëë User is admin - showing admin features');
        const compactAthleteSearch = document.getElementById('compactAthleteSearch');
        if (compactAthleteSearch) {
          compactAthleteSearch.style.display = 'flex';
        }
      }
      
      console.log('üîß Initializing app...');
      await initializeApp();
      
      // Initialize compact athlete search for admins
      if (isAdmin) {
        initCompactAthleteSearch();
      }
      
      console.log('üìã Loading leistungen...');
      await ladeLeistungen();
      
      console.log('üìä Loading dashboard data...');
      await ladeDashboardDaten();
      
      // Mark this user as processed
      lastProcessedUserId = session.user.id;
      console.log('‚úÖ‚úÖ‚úÖ Auth handling complete, mainApp is now visible');
      
    } catch (error) {
      console.error('‚ùå Error in auth handler:', error);
      console.error('‚ùå Error stack:', error.stack);
      showMessage('Ein Fehler ist aufgetreten: ' + error.message, 'error');
      showLoginScreen();
      lastProcessedUserId = null;
    } finally {
      isHandlingAuth = false;
    }
    
  } else if (event === 'SIGNED_OUT') {
    console.log('üö™ User signed out');
    currentUser = null;
    currentAthlete = null;
    isAdmin = false;
    selectedAthleteId = null;
    isHandlingAuth = false;
    lastProcessedUserId = null;
    showLoginScreen();
  }
});

// Handle Logout
// Toggle password visibility in login form
function toggleLoginPassword() {
  const passwordInput = document.getElementById('loginPassword');
  const button = document.getElementById('togglePasswordBtn');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    // Eye with slash (hidden/crossed out)
    button.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
  } else {
    passwordInput.type = 'password';
    // Normal eye (visible)
    button.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
  }
}

async function handleLogout() {
  const { error } = await supabaseClient.auth.signOut();
  if (error) {
    console.error('Logout error:', error);
    return;
  }
  
  currentUser = null;
  currentAthlete = null;
  isAdmin = false;
  selectedAthleteId = null;
  
  // Clear login form fields
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('rememberMe').checked = false;
  
  // Reset password visibility to hidden
  const passwordInput = document.getElementById('loginPassword');
  const toggleBtn = document.getElementById('togglePasswordBtn');
  if (passwordInput.type === 'text') {
    passwordInput.type = 'password';
    toggleBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
  }
  
  showLoginScreen();
}


// ========== PROTECTION: Ensure non-admin users can only see their own data ==========
function ensureOwnAthleteSelected() {
  if (!isAdmin && currentAthlete && selectedAthleteId !== currentAthlete.id) {
    console.warn('Non-admin user tried to access other athlete data, resetting to own athlete');
    selectedAthleteId = currentAthlete.id;
    selectedAthleteName = `${currentAthlete.vorname || ''} ${currentAthlete.name || ''}`.trim();
  }
}

// Wrap any function that loads data to ensure protection
const originalLadeLeistungen = ladeLeistungen;
ladeLeistungen = async function() {
  ensureOwnAthleteSelected();
  return originalLadeLeistungen.apply(this, arguments);
};

// Warn if running from file:// protocol
if (window.location.protocol === 'file:') {
  console.warn('‚ö†Ô∏è WARNUNG: Die Anwendung wird lokal ge√∂ffnet (file://).');
  console.warn('‚ö†Ô∏è Email-Login funktioniert NUR mit einem Webserver (http:// oder https://).');
  console.warn('‚ö†Ô∏è Bitte verwende einen lokalen Webserver, z.B.:');
  console.warn('   python -m http.server 8000');
  console.warn('   Dann √∂ffne: http://localhost:8000/index.html');
  
  // Show warning to user
  setTimeout(() => {
    const warning = document.createElement('div');
    warning.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff6b6b; color: white; padding: 15px; text-align: center; z-index: 99999; font-weight: bold;';
    warning.innerHTML = '‚ö†Ô∏è WARNUNG: Email-Login funktioniert nur mit Webserver! √ñffne die Datei mit "python -m http.server 8000" oder Live Server.';
    document.body.appendChild(warning);
  }, 1000);
}

// ========== RATE LIMIT TRACKER ==========
function checkRateLimitStatus() {
  const lastAttempt = localStorage.getItem('lastOTPAttempt');
  if (!lastAttempt) return true;
  
  const lastTime = new Date(lastAttempt);
  const now = new Date();
  const hoursSince = (now - lastTime) / (1000 * 60 * 60);
  
  if (hoursSince < 1) {
    const minutesLeft = Math.ceil((1 - hoursSince) * 60);
    return { blocked: true, minutesLeft };
  }
  
  return { blocked: false };
}

function recordOTPAttempt() {
  localStorage.setItem('lastOTPAttempt', new Date().toISOString());
}

function showRateLimitWarning() {
  const status = checkRateLimitStatus();
  if (status.blocked) {
    const warning = document.createElement('div');
    warning.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 12px; border-radius: 8px; margin: 15px 0; text-align: center;';
    warning.innerHTML = `‚è∞ Rate Limit aktiv. Bitte warte noch ca. ${status.minutesLeft} Minuten bevor du es erneut versuchst.`;
    
    const authContainer = document.getElementById('authContainer');
    if (authContainer) {
      authContainer.insertBefore(warning, authContainer.firstChild);
    }
  }
}

// Check on page load
window.addEventListener('DOMContentLoaded', showRateLimitWarning);

// Handle URL hash/fragment for magic link redirect
window.addEventListener('DOMContentLoaded', () => {
  console.log('Checking URL for auth tokens...');
  
  // Supabase uses URL hash for auth tokens
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  const access_token = hashParams.get('access_token');
  const refresh_token = hashParams.get('refresh_token');
  const type = hashParams.get('type');
  
  if (access_token && type === 'magiclink') {
    console.log('Magic link detected in URL, Supabase will handle authentication...');
    
    // Show loading message
    const authMessage = document.getElementById('authMessage');
    if (authMessage) {
      authMessage.style.display = 'block';
      authMessage.style.background = '#d1ecf1';
      authMessage.style.color = '#0c5460';
      authMessage.textContent = 'üîÑ Anmeldung wird verarbeitet...';
    }
    
    // Clean URL after a short delay
    setTimeout(() => {

// Debug Panel (nur in Development)
if (window.location.hostname === 'localhost' || window.location.hostname.includes('netlify')) {
  window.addEventListener('DOMContentLoaded', () => {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = 'üêõ Debug';
    debugBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 99999; padding: 10px 15px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;';
    
    debugBtn.onclick = async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      
      let athleteInfo = 'Nicht geladen';
      if (currentAthlete) {
        athleteInfo = `ID: ${currentAthlete.id}, Name: ${currentAthlete.vorname} ${currentAthlete.name}`;
      }
      
      const info = `
üêõ DEBUG INFO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Session: ${session ? '‚úÖ Aktiv' : '‚ùå Keine'}
User Email: ${session?.user?.email || 'Keine'}
User ID: ${session?.user?.id || 'Keine'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Current User: ${currentUser ? '‚úÖ' : '‚ùå'}
Current Athlete: ${currentAthlete ? '‚úÖ' : '‚ùå'}
${athleteInfo}
Selected Athlete ID: ${selectedAthleteId || 'Keine'}
Is Admin: ${isAdmin ? '‚úÖ' : '‚ùå'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Auth Initialized: ${isAuthInitialized}
Handling Auth: ${isHandlingAuth}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
URL Hash: ${window.location.hash || 'Leer'}
      `.trim();
      
      alert(info);
      console.log(info);
    };
    
    document.body.appendChild(debugBtn);
  });
}
      window.history.replaceState({}, document.title, window.location.pathname);
    }, 2000);
  }
});
// Initialize on page load
window.addEventListener('DOMContentLoaded', () => {
  checkSession();
});

// Override selectAthlete to only work for admins
const originalSelectAthlete = selectAthlete;
selectAthlete = function(id, vorname, name, jahrgang) {
  if (!isAdmin) {
    alert('Nur Administratoren k√∂nnen andere Athleten ausw√§hlen.');
    return;
  }
  originalSelectAthlete(id, vorname, name, jahrgang);
};



/* ================= GLOBALE DATEN ================= */
let sortSpalte = null;
let sortAsc = true;
let sortSpalteAthleten = null;
let sortAscAthleten = true;
let disziplinenListe = [];
let alleAK = [];
let alleRunden = [];
let alleMS = [];
let aktuelleLeistungsdaten = null;
let alleLeistungenFuerPBs = []; // Alle Leistungen f√ºr PB-Berechnung (ungefiltert)
let verfuegbareJahre = [];
let alleAthleten = []; // Alle Athleten f√ºr den Ziele-Tab

const RUNDEN_ANZEIGE = {
  "vl": "Vorlauf",
  "hf": "Halbfinale",
  "zl": "Zeitlauf",
  "af": "A-Finale",
  "bf": "B-Finale",
  "f":  "Finale"
};

const TYP_ANZEIGE = {
  "h": "Halle",
  "f": "Freiluft"
};

/* ================= WETTKAMPF-HILFSFUNKTIONEN ================= */
// Definition: Ein Wettkampf = gleiche wk_bz im selben Jahr
function z√§hleWettk√§mpfe(leistungen) {
  if (!leistungen || leistungen.length === 0) return 0;
  
  // Sammle alle Wettk√§mpfe mit wk_bz und Datum
  const wettkampfListe = [];
  leistungen.forEach(l => {
    if (l.wk_bz && l.datum) {
      wettkampfListe.push({
        wk_bz: l.wk_bz,
        datum: new Date(l.datum)
      });
    }
  });
  
  if (wettkampfListe.length === 0) return 0;
  
  // Sortiere nach Wettkampfbezeichnung und dann nach Datum
  wettkampfListe.sort((a, b) => {
    if (a.wk_bz !== b.wk_bz) {
      return a.wk_bz.localeCompare(b.wk_bz);
    }
    return a.datum - b.datum;
  });
  
  // Gruppiere Wettk√§mpfe: gleiche wk_bz innerhalb von 14 Tagen = ein Wettkampf
  const wettk√§mpfeSet = new Set();
  let letzterWK = null;
  let letztesDatum = null;
  let wettkampfCounter = 0;
  
  wettkampfListe.forEach(wk => {
    if (letzterWK === null || wk.wk_bz !== letzterWK) {
      // Neuer Wettkampf (andere Bezeichnung)
      wettk√§mpfeSet.add(`${wk.wk_bz}_${wettkampfCounter++}`);
      letzterWK = wk.wk_bz;
      letztesDatum = wk.datum;
    } else {
      // Gleiche Wettkampfbezeichnung - pr√ºfe Zeitdifferenz
      const diffTage = (wk.datum - letztesDatum) / (1000 * 60 * 60 * 24);
      
      if (diffTage > 14) {
        // Mehr als 14 Tage Unterschied = neuer Wettkampf
        wettk√§mpfeSet.add(`${wk.wk_bz}_${wettkampfCounter++}`);
        letztesDatum = wk.datum;
      }
      // Sonst: Geh√∂rt zum gleichen Wettkampf, nichts hinzuf√ºgen
    }
  });
  
  return wettk√§mpfeSet.size;
}

// Gruppiere Leistungen nach Wettk√§mpfen
function gruppiereNachWettk√§mpfen(leistungen) {
  if (!leistungen || leistungen.length === 0) return [];
  
  // Filtere nur Eintr√§ge mit wk_bz und Datum
  const relevanteLeistungen = leistungen.filter(l => l.wk_bz && l.datum);
  
  if (relevanteLeistungen.length === 0) return [];
  
  // Sortiere nach Wettkampfbezeichnung und dann nach Datum
  relevanteLeistungen.sort((a, b) => {
    if (a.wk_bz !== b.wk_bz) {
      return a.wk_bz.localeCompare(b.wk_bz);
    }
    return new Date(a.datum) - new Date(b.datum);
  });
  
  // Gruppiere Wettk√§mpfe: gleiche wk_bz innerhalb von 14 Tagen = ein Wettkampf
  const wettk√§mpfe = [];
  let aktuellerWettkampf = null;
  
  relevanteLeistungen.forEach(l => {
    const datum = new Date(l.datum);
    
    if (aktuellerWettkampf === null) {
      // Erster Wettkampf
      aktuellerWettkampf = {
        wk_bz: l.wk_bz,
        jahr: datum.getFullYear(),
        datum: l.datum,
        ort: l.ort,
        leistungen: [l]
      };
    } else if (l.wk_bz !== aktuellerWettkampf.wk_bz) {
      // Neue Wettkampfbezeichnung - speichere aktuellen und starte neuen
      wettk√§mpfe.push(aktuellerWettkampf);
      aktuellerWettkampf = {
        wk_bz: l.wk_bz,
        jahr: datum.getFullYear(),
        datum: l.datum,
        ort: l.ort,
        leistungen: [l]
      };
    } else {
      // Gleiche Wettkampfbezeichnung - pr√ºfe Zeitdifferenz
      const letztesDatum = new Date(aktuellerWettkampf.datum);
      const diffTage = (datum - letztesDatum) / (1000 * 60 * 60 * 24);
      
      if (diffTage > 14) {
        // Mehr als 14 Tage Unterschied = neuer Wettkampf
        wettk√§mpfe.push(aktuellerWettkampf);
        aktuellerWettkampf = {
          wk_bz: l.wk_bz,
          jahr: datum.getFullYear(),
          datum: l.datum,
          ort: l.ort,
          leistungen: [l]
        };
      } else {
        // Innerhalb von 14 Tagen = geh√∂rt zum gleichen Wettkampf
        aktuellerWettkampf.leistungen.push(l);
        // Aktualisiere Datum auf das sp√§teste
        if (datum > letztesDatum) {
          aktuellerWettkampf.datum = l.datum;
        }
      }
    }
  });
  
  // F√ºge den letzten Wettkampf hinzu
  if (aktuellerWettkampf !== null) {
    wettk√§mpfe.push(aktuellerWettkampf);
  }
  
  return wettk√§mpfe;
}

/* ================= SPALTEN ================= */
function toggleAlleSpalten(master) {
  const leistungenTab = document.getElementById("leistungenTab");
  if(leistungenTab) {
    leistungenTab.querySelectorAll(".spalte").forEach(cb => {
      cb.checked = master.checked;
    });
    // Baue Filter neu nach dem √Ñndern der Checkboxen
    baueFilter();
  }
}

const SPALTEN = {
  datum: { type: "date" },
  disziplin: { type: "select" },
  leistung: { type: "number" },
  platzierung: { type: "number" },
  ort: { type: "text" },
  wk_bz: { type: "text" },
  ak: { type: "text" },
  typ: { type: "fixed-select", options: [{ value: "h", label: "Halle" }, { value: "f", label: "Freiluft" }] },
  ms: { type: "text" },
  runde: { type: "text" },
  score: { type: "number" }
};

/* ================= SPALTENANZEIGE ================= */
const SPALTEN_ANZEIGE = {
  datum: "Datum",
  disziplin: "Disziplin",
  leistung: "Leistung",
  platzierung: "Platz",
  ort: "Ort",
  wk_bz: "Wettkampfbezeichnung",
  ak: "Altersklasse",
  typ: "Freiluft/Halle",
  ms: "Meisterschaft",
  runde: "Runde",
  score: "Score",
  zeitraum: "Zeitraum",
  name: "Nachname",
  vorname: "Vorname",
  athlet_id: "Athlet-ID",
  jahrgang: "Jahrgang"
};

/* ================= ATHLETEN ================= */
// Globale Variable f√ºr ausgew√§hlten Athleten
let selectedAthleteId = null;
let selectedAthleteName = '';

// Initialisiere Athleten-Suche nach dem Laden
// Guard to prevent multiple initializations
let isAthleteSearchInitialized = false;

function initAthleteSearch() {
  const searchInput = document.getElementById('athletSuche');
  const suggestionsDiv = document.getElementById('athletVorschlaege');
  
  console.log('=== initAthleteSearch gestartet ===');
  console.log('searchInput gefunden:', !!searchInput);
  console.log('suggestionsDiv gefunden:', !!suggestionsDiv);
  
  if (!searchInput || !suggestionsDiv) {
    console.error('FEHLER: Athleten-Suche Elemente nicht gefunden!');
    return;
  }
  
  // Prevent multiple initializations
  if (isAthleteSearchInitialized) {
    console.log('Athleten-Suche bereits initialisiert, √ºberspringe...');
    return;
  }
  isAthleteSearchInitialized = true;
  
  searchInput.addEventListener('input', async function() {
    const searchTerm = this.value.trim();
    console.log('Input Event - Suchwort:', searchTerm, 'L√§nge:', searchTerm.length);
    
    if (searchTerm.length < 2) {
      suggestionsDiv.classList.remove('active');
      suggestionsDiv.innerHTML = '';
      return;
    }
    
    try {
      console.log('Starte Supabase-Abfrage f√ºr:', searchTerm);
      
      const { data: allAthletes, error } = await supabaseClient
        .schema('la').from('athlet')
        .select('id, vorname, name, jahrgang')
        .order('name');
      
      console.log('Supabase Response - Error:', error);
      console.log('Supabase Response - Data:', allAthletes ? allAthletes.length + ' Athleten' : 'null');
      
      if (error) {
        console.error('FEHLER beim Laden der Athleten:', error);
        suggestionsDiv.innerHTML = `<div class="autocomplete-item" style="color: red;"><strong>‚ö†Ô∏è Datenbankfehler</strong><br>${error.message || 'Unbekannter Fehler'}</div>`;
        suggestionsDiv.classList.add('active');
        return;
      }
      
      if (!allAthletes || allAthletes.length === 0) {
        console.warn('Keine Athleten in der Datenbank');
        suggestionsDiv.innerHTML = '<div class="autocomplete-item">‚ö†Ô∏è Keine Athleten in der Datenbank gefunden</div>';
        suggestionsDiv.classList.add('active');
        return;
      }
      
      const searchLower = searchTerm.toLowerCase();
      const data = allAthletes.filter(athlete => {
        const vornameMatch = athlete.vorname && athlete.vorname.toLowerCase().includes(searchLower);
        const nameMatch = athlete.name && athlete.name.toLowerCase().includes(searchLower);
        return vornameMatch || nameMatch;
      }).slice(0, 10);
      
      console.log('Gefundene Athleten nach Filter:', data.length);
      
      if (data && data.length > 0) {
        suggestionsDiv.innerHTML = data.map(athlete => {
          const vorname = (athlete.vorname || '').replace(/'/g, "&apos;");
          const name = (athlete.name || '').replace(/'/g, "&apos;");
          const displayVorname = athlete.vorname || '';
          const displayName = athlete.name || '';
          return `
            <div class="autocomplete-item" onclick="selectAthlete(${athlete.id}, '${vorname}', '${name}', ${athlete.jahrgang || 'null'})">
              <strong>${displayVorname} ${displayName}</strong> ${athlete.jahrgang ? '(' + athlete.jahrgang + ')' : ''} <span style="color: #999;">ID: ${athlete.id}</span>
            </div>
          `;
        }).join('');
        suggestionsDiv.classList.add('active');
        console.log('Vorschl√§ge angezeigt');
      } else {
        suggestionsDiv.innerHTML = '<div class="autocomplete-item">‚ùå Keine passenden Athleten gefunden</div>';
        suggestionsDiv.classList.add('active');
      }
    } catch (e) {
      console.error('EXCEPTION beim Athleten-Suchen:', e);
      suggestionsDiv.innerHTML = `<div class="autocomplete-item" style="color: red;"><strong>‚ö†Ô∏è Fehler</strong><br>${e.message}</div>`;
      suggestionsDiv.classList.add('active');
    }
  });
  
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.classList.remove('active');
    }
  });
  
  console.log('=== Athleten-Suche erfolgreich initialisiert ===');
}

// Hilfsfunktion: Dekodiert HTML-Entities
function decodeHtmlEntities(text) {
  const textarea = document.createElement('textarea');
  textarea.innerHTML = text;
  return textarea.value;
}

// Funktion zum Ausw√§hlen eines Athleten
function selectAthlete(id, vorname, name, jahrgang) {
  selectedAthleteId = id;
  
  // Dekodiere HTML-Entities zur√ºck zu normalen Zeichen
  const decodedVorname = decodeHtmlEntities(vorname);
  const decodedName = decodeHtmlEntities(name);
  
  // Speichere vollst√§ndigen Namen f√ºr Dashboard
  selectedAthleteName = `${decodedVorname} ${decodedName}`;
  
  // Zeige ausgew√§hlten Athleten an
  const jahrgangText = jahrgang ? ` (${jahrgang})` : '';
  document.getElementById('athletSuche').value = `${decodedVorname} ${decodedName}${jahrgangText}`;
  document.getElementById('athletVorschlaege').classList.remove('active');
  
  document.getElementById('athletName').textContent = `${decodedVorname} ${decodedName}${jahrgangText}`;
  document.getElementById('athletId').textContent = id;
  document.getElementById('ausgewaehlterAthlet').classList.add('active');
  
  console.log('Athlet ausgew√§hlt:', id, decodedVorname, decodedName, jahrgang);
  
  // Lade Dashboard-Daten wenn Dashboard-Tab aktiv ist
  const dashboardTab = document.getElementById('dashboardTab');
  if(dashboardTab && dashboardTab.classList.contains('active')) {
    ladeDashboardDaten();
  }
  
  // Aktualisiere Ziele-Tab wenn Ziele-Tab aktiv ist
  const zieleTab = document.getElementById('zieleTab');
  if(zieleTab && zieleTab.classList.contains('active')) {
    updateGoalsTab();
  }
}

// Funktion zum L√∂schen der Athleten-Auswahl
function clearSelectedAthlete() {
  selectedAthleteId = null;
  selectedAthleteName = '';
  document.getElementById('athletSuche').value = '';
  document.getElementById('ausgewaehlterAthlet').classList.remove('active');
  console.log('Athleten-Auswahl aufgehoben');
  
  // Aktualisiere Ziele-Tab wenn Ziele-Tab aktiv ist
  const zieleTab = document.getElementById('zieleTab');
  if(zieleTab && zieleTab.classList.contains('active')) {
    updateGoalsTab();
  }
}

// Funktion zum Laden aller Athleten (f√ºr Ziele-Tab)
async function ladeAlleAthleten() {
  try {
    const { data, error } = await supabaseClient
      .schema('la').from('athlet')
      .select('id, vorname, name, jahrgang')
      .order('name');
    
    if (error) {
      console.error('Fehler beim Laden der Athleten:', error);
      alleAthleten = [];
      return;
    }
    
    // Konvertiere zu altem Format f√ºr Kompatibilit√§t
    alleAthleten = data.map(a => ({
      Athlet_ID: a.id,
      Vorname: a.vorname,
      Nachname: a.name,
      Jahrgang: a.jahrgang
    }));
    
    console.log('‚úÖ Athleten geladen:', alleAthleten.length);
  } catch (err) {
    console.error('Fehler beim Laden der Athleten:', err);
    alleAthleten = [];
  }
}



/* ================= DISZIPLINEN ================= */
async function ladeDisziplinen() {
  if (!selectedAthleteId) {
    console.log('Keine Athlet-ID verf√ºgbar, √ºberspringe Disziplinen-Laden');
    return;
  }
  
  const { data, error } = await supabaseClient
    .schema("la")
    .from("leistung")
    .select("disziplin")
    .eq("athlet_id", selectedAthleteId);
    
  if (!error && data) {
    const uniqueDisziplinen = [...new Set(data.map(d => d.disziplin))].filter(Boolean);
    // Sortiere nach Disziplintyp (wie bei SBs)
    disziplinenListe = uniqueDisziplinen.map(d => ({ disziplin: d })).sort(sortiereNachDisziplinTyp).map(item => item.disziplin);
  } else if (error) {
    console.error('Fehler beim Laden der Disziplinen:', error);
  }
}

/* ================= FILTER OPTIONEN ================= */
async function ladeFilterOptionen() {
  if (!selectedAthleteId) {
    console.log('Keine Athlet-ID verf√ºgbar, √ºberspringe Filter-Optionen-Laden');
    return;
  }
  
  const { data: akData, error: akError } = await supabaseClient
    .schema("la").from("leistung")
    .select("ak")
    .eq("athlet_id", selectedAthleteId)
    .not("ak", "is", null);
  if(!akError) alleAK = [...new Set(akData.map(d => d.ak))].sort();

  const { data: rundeData, error: rundeError } = await supabaseClient
    .schema("la").from("leistung")
    .select("runde")
    .eq("athlet_id", selectedAthleteId)
    .not("runde", "is", null);
  if(!rundeError) {
    alleRunden = [...new Set(rundeData.map(d => d.runde))].sort();
  }

  const { data: msData, error: msError } = await supabaseClient
    .schema("la").from("leistung")
    .select("ms")
    .eq("athlet_id", selectedAthleteId)
    .not("ms", "is", null);
  if(!msError) alleMS = [...new Set(msData.map(d => d.ms))].sort();

  // Bef√ºlle Meisterschafts-Dropdowns
  befuelleMeisterschaftsDropdowns();

  // Lade verf√ºgbare Jahre
  const { data: jahrData, error: jahrError } = await supabaseClient
    .schema("la").from("leistung")
    .select("datum")
    .eq("athlet_id", selectedAthleteId)
    .not("datum", "is", null);
  if(!jahrError && jahrData) {
    const jahre = [...new Set(jahrData.map(d => {
      if(d.datum) {
        return new Date(d.datum).getFullYear();
      }
      return null;
    }))].filter(j => j !== null).sort((a, b) => b - a); // Neueste zuerst
    verfuegbareJahre = jahre;
    console.log("Verf√ºgbare Jahre geladen:", verfuegbareJahre);
    
    // Bef√ºlle die Jahr-Dropdowns
    befuelleJahrDropdowns();
  } else if(jahrError) {
    console.error("Fehler beim Laden der Jahre:", jahrError);
  }
}

/* ================= BEF√úLLE MEISTERSCHAFTS-DROPDOWNS ================= */
function befuelleMeisterschaftsDropdowns() {
  // Bef√ºlle Statistik-Dropdown
  const statistikMS = document.getElementById('statistikFilterMS');
  if(statistikMS && alleMS.length > 0) {
    statistikMS.innerHTML = '<option value="">‚Äì Alle ‚Äì</option>' + 
      alleMS.map(m => `<option value="${m}">${m}</option>`).join('');
  }
  
  // Bef√ºlle Bestleistungen-Dropdown
  const bestleistungenMS = document.getElementById('bestleistungenFilterMS');
  if(bestleistungenMS && alleMS.length > 0) {
    bestleistungenMS.innerHTML = '<option value="">‚Äì Alle ‚Äì</option>' + 
      alleMS.map(m => `<option value="${m}">${m}</option>`).join('');
  }
}

/* ================= BEF√úLLE JAHR-DROPDOWNS ================= */
function befuelleJahrDropdowns() {
  if (!verfuegbareJahre || verfuegbareJahre.length === 0) {
    console.log("Keine Jahre verf√ºgbar zum Bef√ºllen der Dropdowns");
    return;
  }
  
  console.log("Bef√ºlle Jahr-Dropdowns mit:", verfuegbareJahre);
  
  // Bef√ºlle Statistik-Dropdown
  const statistikZeitraum = document.getElementById('statistikFilterZeitraum');
  if(statistikZeitraum) {
    // Behalte die ersten beiden Optionen, f√ºge Jahre hinzu
    const aktuellerWert = statistikZeitraum.value;
    statistikZeitraum.innerHTML = '<option value="">‚Äì Alle ‚Äì</option>' +
      '<option value="custom">Benutzerdefiniert</option>' +
      verfuegbareJahre.map(j => `<option value="${j}">${j}</option>`).join('');
    // Setze den Wert zur√ºck falls er vorher gesetzt war
    if (aktuellerWert) statistikZeitraum.value = aktuellerWert;
  }
  
  // Bef√ºlle Bestleistungen-Dropdown
  const bestleistungenZeitraum = document.getElementById('bestleistungenFilterZeitraum');
  if(bestleistungenZeitraum) {
    const aktuellerWert = bestleistungenZeitraum.value;
    bestleistungenZeitraum.innerHTML = '<option value="">‚Äì Alle ‚Äì</option>' +
      '<option value="custom">Benutzerdefiniert</option>' +
      verfuegbareJahre.map(j => `<option value="${j}">${j}</option>`).join('');
    if (aktuellerWert) bestleistungenZeitraum.value = aktuellerWert;
  }
}

/* ================= FILTER BAUEN ================= */
function baueFilter() {
  const container = document.getElementById("filterContainer");
  if(!container) {
    console.error("filterContainer nicht gefunden!");
    return;
  }
  container.innerHTML = "";
  
  const filterHTML = [];

  // Nur Checkboxen im Leistungen-Tab ber√ºcksichtigen
  const leistungenTab = document.getElementById("leistungenTab");
  if(!leistungenTab) {
    console.error("leistungenTab nicht gefunden!");
    return;
  }
  
  leistungenTab.querySelectorAll("input[type=checkbox].spalte:checked").forEach(cb => {
    const spalte = cb.value;
    const meta = SPALTEN[spalte];
    if(!meta) return;
    
    let html = `<div class="filter-group"><strong>${SPALTEN_ANZEIGE[spalte] || spalte}</strong><div class="filter-controls">`;

    if(meta.type === "number"){
      html += `<select data-op="${spalte}">
               <option value="gte">‚â•</option>
               <option value="lte">‚â§</option>
             </select>
             <input type="number" step="0.01" data-filter="${spalte}" placeholder="Suche Wert...">`;
    }
    else if(meta.type==="date"){
      console.log("Baue Datum-Filter, verf√ºgbare Jahre:", verfuegbareJahre);
      html += `<label>von <input type="date" data-filter-from="${spalte}"></label>
               <label>bis <input type="date" data-filter-to="${spalte}"></label>
               <select data-filter-jahr="${spalte}">
                 <option value="">‚Äì alle Jahre ‚Äì</option>
                 ${verfuegbareJahre.map(j => `<option value="${j}">${j}</option>`).join("")}
               </select>`;
    }
    else if(spalte==="disziplin"){
      html += `<div id="disziplinFilterContainer" style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
                 <div class="disziplin-filter-row" style="display: flex; gap: 10px; align-items: center;">
                   <select class="disziplin-dropdown" data-filter-dropdown="disziplin" onchange="handleDisziplinChange()" style="flex: 1; min-width: 150px;">
                     <option value="">‚Äì alle ‚Äì</option>
                     ${disziplinenListe.map(d=>`<option value="${d}">${d}</option>`).join("")}
                   </select>
                   <span style="color: #6c757d; font-weight: 500;">oder</span>
                   <input type="text" class="disziplin-suche" placeholder="Suche Disziplin..." oninput="handleDisziplinChange()" style="flex: 1; min-width: 150px;">
                 </div>
               </div>`;
    }
    else if(spalte==="typ" && meta.type==="fixed-select"){
      html += `<select data-filter-dropdown="typ">
                 <option value="">‚Äì alle ‚Äì</option>
                 ${meta.options.map(o => `<option value="${o.value}">${o.label}</option>`).join("")}
               </select>`;
    }
    else if(spalte==="ak"){
      html += `<select data-filter-dropdown="ak">
                 <option value="">‚Äì alle ‚Äì</option>
                 ${alleAK.map(a => `<option value="${a}">${a}</option>`).join("")}
               </select>
               <input type="text" placeholder="Suche Altersklasse..." data-filter="ak">`;
    }
    else if(spalte === "runde") {
      html += `<select data-filter-dropdown="runde">
                 <option value="">‚Äì alle ‚Äì</option>
                 ${alleRunden.map(r => `<option value="${r}">${RUNDEN_ANZEIGE[r] || r}</option>`).join("")}
               </select>
               <input type="text" placeholder="Suche Runde..." data-filter="runde">`;
    }
    else if(spalte==="ms"){
      html += `<select data-filter-dropdown="ms">
                 <option value="">‚Äì alle ‚Äì</option>
                 ${alleMS.map(m => `<option value="${m}">${m}</option>`).join("")}
               </select>
               <input type="text" placeholder="Suche Meisterschaft..." data-filter="ms">`;
    }
    else{
      html += `<input type="text" data-filter="${spalte}" placeholder="Suche ${SPALTEN_ANZEIGE[spalte] || spalte}...">`;
    }

    html += `</div></div>`;
    filterHTML.push(html);
  });
  
  // Erstelle Grid-Container und f√ºge alle Filter hinzu
  if(filterHTML.length > 0) {
    container.innerHTML = '<div class="filter-container">' + filterHTML.join('') + '</div>';
  }
}

/* ================= DISZIPLIN MULTI-SELECT HANDLING ================= */
function handleDisziplinChange() {
  const container = document.getElementById('disziplinFilterContainer');
  const rows = container.querySelectorAll('.disziplin-filter-row');
  const letzteRow = rows[rows.length - 1];
  
  const letzterDropdown = letzteRow.querySelector('.disziplin-dropdown');
  
  // Nur wenn im letzten Dropdown eine Disziplin ausgew√§hlt wurde
  const hatDropdownWert = letzterDropdown.value !== "";
  
  if(hatDropdownWert) {
    // Pr√ºfe ob bereits eine leere Zeile existiert
    let hatLeereZeile = false;
    rows.forEach((row, index) => {
      if(index !== rows.length - 1) { // Nicht die letzte Zeile
        const dd = row.querySelector('.disziplin-dropdown');
        if(dd.value === "") {
          hatLeereZeile = true;
        }
      }
    });
    
    if(!hatLeereZeile) {
      // F√ºge neue Zeile hinzu (nur Dropdown, kein Suchfeld)
      const neueRow = document.createElement('div');
      neueRow.className = 'disziplin-filter-row';
      neueRow.style.cssText = 'display: flex; gap: 10px; align-items: center;';
      neueRow.innerHTML = `
        <select class="disziplin-dropdown" data-filter-dropdown="disziplin" onchange="handleDisziplinChange()" style="flex: 1; min-width: 150px;">
          <option value="">‚Äì alle ‚Äì</option>
          ${disziplinenListe.map(d=>`<option value="${d}">${d}</option>`).join("")}
        </select>
        <button type="button" onclick="entferneDisziplinFilter(this)" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">‚úï</button>
      `;
      container.appendChild(neueRow);
    }
  }
  
  // Entferne komplett leere Zeilen (au√üer der ersten und letzten)
  const allRows = container.querySelectorAll('.disziplin-filter-row');
  allRows.forEach((row, index) => {
    const dd = row.querySelector('.disziplin-dropdown');
    if(dd.value === "" && index !== 0 && index !== allRows.length - 1) {
      row.remove();
    }
  });
}

function entferneDisziplinFilter(button) {
  const row = button.parentElement;
  const container = document.getElementById('disziplinFilterContainer');
  
  // Nicht entfernen wenn es die einzige Zeile ist
  if(container.querySelectorAll('.disziplin-filter-row').length > 1) {
    row.remove();
  }
}

/* ================= ALLE FILTER ZUR√úCKSETZEN ================= */
function alleFilterZuruecksetzen() {
  // Athlet-ID zur√ºcksetzen
  // Athlet-ID wird durch Auswahl gesetzt
  
  // Alle Filter-Inputs zur√ºcksetzen
  document.querySelectorAll("[data-filter], [data-filter-from], [data-filter-to], [data-filter-dropdown], [data-filter-jahr]").forEach(input => {
    input.value = "";
  });
  
  // Disziplin-Dropdowns zur√ºcksetzen
  const disziplinContainer = document.getElementById('disziplinFilterContainer');
  if(disziplinContainer) {
    // Entferne alle au√üer dem ersten
    const rows = disziplinContainer.querySelectorAll('.disziplin-filter-row');
    rows.forEach((row, index) => {
      if(index === 0) {
        row.querySelector('.disziplin-dropdown').value = "";
        row.querySelector('.disziplin-suche').value = "";
      } else {
        row.remove();
      }
    });
  }
  
  // Sortierung zur√ºcksetzen
  sortSpalte = null;
  sortAsc = true;
  
  // Tabelle leeren
  document.getElementById("leistungenAusgabe").innerHTML = "";
  document.getElementById("exportBtn").style.display = "none";
  aktuelleLeistungsdaten = null;
  
  alert("‚úÖ Alle Filter wurden zur√ºckgesetzt!");
}

/* ================= LEISTUNGEN ================= */
async function ladeLeistungen() {
  const leistungenTab = document.getElementById("leistungenTab");
  if(!leistungenTab) {
    console.error("leistungenTab nicht gefunden!");
    return;
  }
  
  const cols = Array.from(leistungenTab.querySelectorAll(".spalte:checked")).map(c => c.value);
  
  // F√ºge athlet_id und disziplin hinzu falls nicht vorhanden (f√ºr PB-Erkennung)
  const colsForQuery = [...cols];
  if(!colsForQuery.includes('athlet_id')) colsForQuery.push('athlet_id');
  if(!colsForQuery.includes('disziplin')) colsForQuery.push('disziplin');
  if(!colsForQuery.includes('leistung')) colsForQuery.push('leistung');
  if(!colsForQuery.includes('id')) colsForQuery.push('id');
  
  let query = supabaseClient.schema("la").from("leistung").select(colsForQuery.join(",") + ",score");

  // Verwende ausgew√§hlten Athleten
  if(selectedAthleteId) query = query.eq("athlet_id", selectedAthleteId);

  // Standard-Sortierung nach Datum (neueste zuerst), wenn keine andere Sortierung aktiv
  // ABER: Sortierung wird jetzt manuell gemacht (siehe unten)
  let manuellesSortieren = false;
  if(sortSpalte === "leistung") {
    manuellesSortieren = true;
    // Keine Supabase-Sortierung f√ºr Leistung, da wir null-Werte manuell ans Ende packen
  } else if(sortSpalte) {
    query = query.order(sortSpalte, { ascending: sortAsc });
  } else if(cols.includes("datum")) {
    query = query.order("datum", { ascending: false });
    sortSpalte = "datum";
    sortAsc = false;
  }

  const filterInputs = Array.from(document.querySelectorAll("[data-filter],[data-filter-from],[data-filter-to],[data-filter-dropdown],[data-filter-jahr]"));

  // Sammle Disziplinen separat
  const ausgewaehlteDisziplinen = [];
  const disziplinSuchtexte = [];
  
  // Sammle alle Disziplin-Zeilen
  const disziplinRows = document.querySelectorAll('.disziplin-filter-row');
  disziplinRows.forEach(row => {
    const dropdown = row.querySelector('.disziplin-dropdown');
    const suchfeld = row.querySelector('.disziplin-suche');
    
    if(dropdown && dropdown.value) {
      ausgewaehlteDisziplinen.push(dropdown.value);
    }
    if(suchfeld && suchfeld.value.trim()) {
      disziplinSuchtexte.push(suchfeld.value.trim());
    }
  });
  
  for(const input of filterInputs){
    const wert = input.value;
    if(!wert) continue;

    // √úberspringe Disziplin-Filter (werden oben verarbeitet)
    if(input.classList && input.classList.contains('disziplin-dropdown')) continue;
    if(input.classList && input.classList.contains('disziplin-suche')) continue;

    if(input.dataset.filter){
      const spalte = input.dataset.filter;
      const meta = SPALTEN[spalte];

      if(meta && meta.type === "number"){
        const op = document.querySelector(`select[data-op="${spalte}"]`)?.value;
        if(op==="gte") query = query.gte(spalte, wert);
        else if(op==="lte") query = query.lte(spalte, wert);
      } else {
        query = query.ilike(spalte, `%${wert}%`);
      }
    }
    else if(input.dataset.filterDropdown){
      const spalte = input.dataset.filterDropdown;
      if(wert) query = query.eq(spalte, wert);
    }
    else if(input.dataset.filterJahr){
      const jahr = wert;
      const spalte = input.dataset.filterJahr;
      // Filtere alle Datumswerte aus diesem Jahr
      query = query.gte(spalte, `${jahr}-01-01`).lte(spalte, `${jahr}-12-31`);
    }
    else if(input.dataset.filterFrom) query = query.gte(input.dataset.filterFrom, wert);
    else if(input.dataset.filterTo) query = query.lte(input.dataset.filterTo, wert);
  }

  // Wende Disziplin-Filter an
  if(ausgewaehlteDisziplinen.length > 0 || disziplinSuchtexte.length > 0) {
    let disziplinQuery = [];
    
    // F√ºge exakte Disziplinen hinzu
    if(ausgewaehlteDisziplinen.length > 0) {
      disziplinQuery = [...ausgewaehlteDisziplinen];
    }
    
    // Bei Suchtexten: m√ºssen wir die Daten sp√§ter client-seitig filtern
    // da Supabase kein OR mit ILIKE in einem Query unterst√ºtzt
    if(disziplinSuchtexte.length > 0 && ausgewaehlteDisziplinen.length === 0) {
      // Nur Suchtexte: Verwende den ersten als ILIKE
      query = query.ilike('disziplin', `%${disziplinSuchtexte[0]}%`);
    } else if(ausgewaehlteDisziplinen.length > 0) {
      // Dropdowns verwenden
      query = query.in('disziplin', disziplinQuery);
    }
  }

  const { data, error } = await query;
  if(error){
    console.error('Fehler beim Laden der Leistungen:', error);
    if (error.code === 'PGRST116' || error.message.includes('0 rows')) {
      console.log('Keine Leistungen vorhanden f√ºr diesen Athleten');
      document.getElementById("leistungenAusgabe").innerHTML = `<div class="no-data">Noch keine Leistungen erfasst</div>`;
      document.getElementById("exportBtn").style.display = "none";
      return;
    }
    document.getElementById("leistungenAusgabe").innerHTML = `<div class="no-data">‚ùå ${error.message}</div>`;
    document.getElementById("exportBtn").style.display = "none";
    return;
  }
  
  if (!data || data.length === 0) {
    console.log('Keine Leistungen gefunden');
    document.getElementById("leistungenAusgabe").innerHTML = `<div class="no-data">Noch keine Leistungen erfasst</div>`;
    document.getElementById("exportBtn").style.display = "none";
    return;
  }

  // Lade ALLE Leistungen f√ºr PB-Berechnung (ohne Filter, nur mit Athlet-ID)
  if(selectedAthleteId && (alleLeistungenFuerPBs.length === 0 || alleLeistungenFuerPBs[0]?.athlet_id !== selectedAthleteId)) {
    const { data: allData } = await supabaseClient
      .schema("la").from("leistung")
      .select("athlet_id, disziplin, leistung, datum")
      .eq("athlet_id", selectedAthleteId);
    alleLeistungenFuerPBs = allData || [];
  }

  // Manuelle Sortierung f√ºr Leistung (null-Werte ans Ende)
  let sortierteDaten = data;
  if(manuellesSortieren) {
    sortierteDaten = [...data].sort((a, b) => {
      const aLeistung = a.leistung;
      const bLeistung = b.leistung;
      
      // null-Werte immer ans Ende
      if(aLeistung === null && bLeistung === null) return 0;
      if(aLeistung === null) return 1;
      if(bLeistung === null) return -1;
      
      // Normale Sortierung
      if(sortAsc) {
        return aLeistung - bLeistung;
      } else {
        return bLeistung - aLeistung;
      }
    });
  }

  // Filtere die Daten auf nur die vom Benutzer ausgew√§hlten Spalten f√ºr die Anzeige
  const angezeigteDaten = sortierteDaten.map(row => {
    const filtered = {};
    cols.forEach(col => {
      if(row.hasOwnProperty(col)) {
        filtered[col] = row[col];
      }
    });
    return filtered;
  });

  aktuelleLeistungsdaten = angezeigteDaten;
  
  // √úbergebe gefilterte Daten + ALLE Leistungen f√ºr echte PB-Erkennung
  zeigeTabelleMitPBs(angezeigteDaten, sortierteDaten, "leistungenAusgabe", true);
  
  document.getElementById("exportBtn").style.display = data && data.length > 0 ? "inline-block" : "none";
}

/* ================= DURCHSCHNITT BERECHNEN ================= */

/* ================= LEISTUNGS-TABELLE ================= */
async function zeigeLeistungsTabelle() {
  // Verstecke Export-Button zun√§chst
  document.getElementById("analyseExportBtn").style.display = "none";
  
  const athletId = selectedAthleteId; // Verwende ausgew√§hlten Athleten
  
  if (!athletId) {
    alert("‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!");
    return;
  }
  
  // Hole alle Filter unter Statistiken
  const filterDisziplin = document.getElementById("statistikFilterDisziplin").value;
  const filterZeitraum = document.getElementById("statistikFilterZeitraum").value;
  const ort = document.getElementById("statistikFilterOrt").value;
  const wk = document.getElementById("statistikFilterWK").value;
  const ak = document.getElementById("statistikFilterAK").value;
  const filterTyp = document.getElementById("statistikFilterTyp").value;
  const ms = document.getElementById("statistikFilterMS").value;

  // Baue Query mit allen Filtern - WICHTIG: score aus der Datenbank holen
  let query = supabaseClient.schema("la").from("leistung")
    .select("datum, disziplin, leistung, ort, score")
    .eq("athlet_id", athletId)
    .not("leistung", "is", null)
    .not("score", "is", null); // Nur Leistungen mit Score
  
  // Filter anwenden
  if (filterDisziplin) query = query.eq("disziplin", filterDisziplin);
  if (ort) query = query.ilike("ort", `%${ort}%`);
  if (wk) query = query.ilike("wk_bz", `%${wk}%`);
  if (ak) query = query.ilike("ak", `%${ak}%`);
  if (filterTyp) query = query.eq("typ", filterTyp);
  if (ms) query = query.eq("ms", ms);

  // Zeitraum-Filter anwenden
  if (filterZeitraum === 'custom') {
    const von = document.getElementById("statistikFilterVon").value;
    const bis = document.getElementById("statistikFilterBis").value;
    
    if (von) query = query.gte("datum", von);
    if (bis) query = query.lte("datum", bis);
  } else if (filterZeitraum) {
    query = query.gte("datum", `${filterZeitraum}-01-01`).lte("datum", `${filterZeitraum}-12-31`);
  }

  const { data, error } = await query;
  
  if (error) {
    console.error("Fehler beim Laden der Daten:", error);
    alert("‚ùå Fehler beim Laden der Daten: " + error.message);
    return;
  }
  
  if (!data || data.length === 0) {
    alert("üì≠ Keine Daten f√ºr diese Auswahl gefunden");
    return;
  }

  // Sortiere nach Score aus der Datenbank (h√∂chster zuerst)
  data.sort((a, b) => b.score - a.score);

  // Speichere Daten f√ºr Sortierung
  window.scoreTableData = data;
  window.scoreTableSortColumn = 'score';
  window.scoreTableSortDirection = 'desc';

  renderScoreTable();
}

// Funktion zum Rendern der Score-Tabelle
function renderScoreTable() {
  const data = window.scoreTableData;
  
  if (!data || data.length === 0) {
    return;
  }

  // Erstelle Tabelle im Stil der Leistungen-Tabelle
  let html = `
    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div></div>
        <button onclick="document.getElementById('analyseAusgabe').innerHTML = ''; enableTableResize();" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">‚úï Schlie√üen</button>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th onclick="sortScoreTable('datum')" style="cursor: pointer;">Datum${getSortArrow('datum')}</th>
              <th onclick="sortScoreTable('disziplin')" style="cursor: pointer;">Disziplin${getSortArrow('disziplin')}</th>
              <th onclick="sortScoreTable('leistung')" style="cursor: pointer;">Leistung${getSortArrow('leistung')}</th>
              <th onclick="sortScoreTable('ort')" style="cursor: pointer;">Ort${getSortArrow('ort')}</th>
              <th onclick="sortScoreTable('score')" style="cursor: pointer;">Score${getSortArrow('score')}</th>
            </tr>
          </thead>
          <tbody>
  `;

  data.forEach((l, index) => {
    const formatierteDatum = formatiereDatum(l.datum);
    const formatierteLeistung = formatiereLeistung(l.leistung, l.disziplin);
    const scoreFormatiert = Math.round(l.score); // Keine Kommastellen
    
    html += `
      <tr>
        <td>${formatierteDatum}</td>
        <td>${l.disziplin}</td>
        <td>${formatierteLeistung}</td>
        <td>${l.ort || '-'}</td>
        <td style="color: #667eea; font-weight: 600;">${scoreFormatiert}</td>
      </tr>
    `;
  });

  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  document.getElementById("analyseAusgabe").innerHTML = html;
  enableTableResize();
  
  // Zeige Export-Button
  document.getElementById("analyseExportBtn").style.display = "inline-block";
}

// Funktion zum Sortieren der Score-Tabelle
function sortScoreTable(column) {
  const data = window.scoreTableData;
  
  if (!data || data.length === 0) return;
  
  // Wenn gleiche Spalte, Toggle Direction
  if (window.scoreTableSortColumn === column) {
    window.scoreTableSortDirection = window.scoreTableSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    // Neue Spalte, standard aufsteigend (au√üer Score, das absteigend startet)
    window.scoreTableSortColumn = column;
    window.scoreTableSortDirection = column === 'score' ? 'desc' : 'asc';
  }
  
  const direction = window.scoreTableSortDirection === 'asc' ? 1 : -1;
  
  data.sort((a, b) => {
    let valA, valB;
    
    if (column === 'datum') {
      valA = a.datum;
      valB = b.datum;
    } else if (column === 'disziplin') {
      valA = (a.disziplin || '').toLowerCase();
      valB = (b.disziplin || '').toLowerCase();
    } else if (column === 'leistung') {
      valA = a.leistung || 0;
      valB = b.leistung || 0;
    } else if (column === 'ort') {
      valA = (a.ort || '').toLowerCase();
      valB = (b.ort || '').toLowerCase();
    } else if (column === 'score') {
      valA = a.score || 0;
      valB = b.score || 0;
    }
    
    if (valA < valB) return -1 * direction;
    if (valA > valB) return 1 * direction;
    return 0;
  });
  
  renderScoreTable();
}

// Funktion zum Anzeigen des Sortier-Pfeils (wie in Leistungen-Tabelle)
function getSortArrow(column) {
  if (window.scoreTableSortColumn !== column) {
    return '';
  }
  return window.scoreTableSortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
}

async function berechneDurchschnitt(typ) {
  // Verstecke Export-Button zun√§chst
  document.getElementById("analyseExportBtn").style.display = "none";
  
  const athletId = selectedAthleteId; // Verwende ausgew√§hlten Athleten
  
  if (!athletId) {
    alert("‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!");
    return;
  }
  
  // Hole NUR die Filter unter Statistiken (NICHT die Analyse-Filter)
  const filterDisziplin = document.getElementById("statistikFilterDisziplin").value;
  const filterZeitraum = document.getElementById("statistikFilterZeitraum").value;
  const ort = document.getElementById("statistikFilterOrt").value;
  const wk = document.getElementById("statistikFilterWK").value;
  const ak = document.getElementById("statistikFilterAK").value;
  const filterTyp = document.getElementById("statistikFilterTyp").value;
  const ms = document.getElementById("statistikFilterMS").value;

  // Disziplin ist ERFORDERLICH
  if (!filterDisziplin) {
    alert("‚ö†Ô∏è Bitte Disziplin im Filter ausw√§hlen");
    return;
  }

  // Baue Query mit allen Filtern
  let query = supabaseClient.schema("la").from("leistung")
    .select(`${typ}, datum, ort, wk_bz, ak, typ, ms, runde`)
    .eq("athlet_id", athletId)
    .eq("disziplin", filterDisziplin)
    .not(typ, "is", null);  // Ignoriere NULL-Werte f√ºr leistung oder platzierung
  
  // Erweiterte Filter anwenden
  if (ort) query = query.ilike("ort", `%${ort}%`);
  if (wk) query = query.ilike("wk_bz", `%${wk}%`);
  if (ak) query = query.ilike("ak", `%${ak}%`);
  if (filterTyp) query = query.eq("typ", filterTyp);
  if (ms) query = query.eq("ms", ms);

  // Zeitraum-Filter anwenden (NUR aus Statistik-Filtern)
  let zeitraumText = "Gesamt";
  
  
  if (filterZeitraum === 'custom') {
    const von = document.getElementById("statistikFilterVon").value;
    const bis = document.getElementById("statistikFilterBis").value;
    
    if (von) {
      query = query.gte("datum", von);
      zeitraumText = von;
    }
    if (bis) {
      query = query.lte("datum", bis);
      zeitraumText = von && bis ? `${von} bis ${bis}` : bis;
    }
    
    if (!von && !bis) {
      zeitraumText = "Gesamt";
    }
  } else if (filterZeitraum) {
    query = query.gte("datum", `${filterZeitraum}-01-01`).lte("datum", `${filterZeitraum}-12-31`);
    zeitraumText = filterZeitraum;
  }

  const { data, error } = await query;
  
  if (error) {
    console.error("Fehler beim Laden der Daten:", error);
    alert("‚ùå Fehler beim Laden der Daten: " + error.message);
    return;
  }
  
  if (!data || data.length === 0) {
    alert("üì≠ Keine Daten f√ºr diese Auswahl gefunden");
    return;
  }

  // Berechne Durchschnitt (zus√§tzliche Filterung f√ºr Sicherheit)
  const werte = data.map(d => d[typ]).filter(v => v !== null && v !== undefined);
  
  if (werte.length === 0) {
    alert("üì≠ Keine g√ºltigen Werte f√ºr die Berechnung vorhanden");
    return;
  }
  
  const avg = werte.reduce((a, b) => a + b, 0) / werte.length;
  const formatierterWert = (typ === 'leistung') ? formatiereLeistung(avg, filterDisziplin) : avg.toFixed(2);

  // Tabellen-HTML mit der gew√ºnschten Reihenfolge und Schlie√üen-Button
  let html = `
    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: #2a5298; margin: 0;">${typ === 'leistung' ? '√ò Leistung' : '√ò Platzierung'}</h3>
        <button onclick="document.getElementById('analyseAusgabe').innerHTML = ''; enableTableResize();" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">‚úï Schlie√üen</button>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Disziplin</th>
              <th>${typ === 'leistung' ? '√ò Leistung' : '√ò Platzierung'}</th>
              <th>Anzahl Leistungen</th>
              <th>Zeitraum</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${filterDisziplin}</td>
              <td><strong>${formatierterWert}</strong></td>
              <td>${werte.length}</td>
              <td>${zeitraumText}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  document.getElementById("analyseAusgabe").innerHTML = html;
  enableTableResize();
  
  // Zeige Export-Button
  document.getElementById("analyseExportBtn").style.display = "inline-block";
}

/* ================= DATUM FORMATIEREN ================= */
function formatiereDatum(datum) {
  if(!datum) return "";
  const d = new Date(datum);
  const tag = String(d.getDate()).padStart(2, '0');
  const monat = String(d.getMonth() + 1).padStart(2, '0');
  const jahr = d.getFullYear();
  return `${tag}.${monat}.${jahr}`;
}

/* ================= LEISTUNG FORMATIEREN ================= */
function formatiereLeistung(wert, disziplin) {
  if(wert === null || wert === undefined) return "";
  
  const d = disziplin ? disziplin.toLowerCase() : "";
  
  // Mapping f√ºr abgek√ºrzte Disziplin-Namen
  const disziplinMapping = {
    'weit': 'weitsprung',
    'hoch': 'hochsprung',
    'stab': 'stabhochsprung',
    'stabhoch': 'stabhochsprung',
    'drei': 'dreisprung',
    'kugel': 'kugelsto√üen',
    'diskus': 'diskuswurf',
    'hammer': 'hammerwurf',
    'speer': 'speerwurf',
    '100': '100m',
    '200': '200m',
    '400': '400m',
    '800': '800m',
    '1500': '1500m',
    '3000': '3000m',
    '5000': '5000m',
    '10000': '10000m',
    '110': '110m h√ºrden',
    '400h': '400m h√ºrden',
    '400h√º': '400m h√ºrden',
    '400m h√º': '400m h√ºrden',
    '400m h√º.': '400m h√ºrden'
  };
  
  // Normalisiere den Disziplin-Namen
  let normalizedD = d.trim().replace(/\./g, '').replace(/\s+/g, ' ');
  
  // Versuche exaktes Mapping
  if (disziplinMapping[normalizedD]) {
    normalizedD = disziplinMapping[normalizedD];
  }
  
  // Mehrkampf (Punkte) - KEINE Nachkommastellen
  // Erkenne: "5K", "10K", "F√ºnfkampf", "Zehnkampf", etc.
  if(normalizedD.includes("kampf") || normalizedD.match(/^\d+k$/)) {
    return Number(wert).toFixed(0) + " Pkt.";
  }
  
  // Sprung/Wurf (Meter) - 2 Nachkommastellen mit Komma
  // WICHTIG: Diese Pr√ºfung MUSS vor der Lauf-Pr√ºfung kommen
  // Alle Sprungdisziplinen (inkl. Stabhochsprung) und Wurfdisziplinen werden hier mit "m" und 2 Nachkommastellen formatiert
  if(normalizedD.includes("sprung") || normalizedD.includes("wurf") || normalizedD.includes("sto√ü") || normalizedD.includes("ball") || normalizedD.includes("gewicht")) {
    return Number(wert).toFixed(2).replace('.', ',') + " m";
  }
  
  // Lauf/Zeit-Disziplinen (Zeit in Sekunden -> min:sek,hundertstel oder sek,hundertstel)
  // Erkenne: "100m", "400m", "400m h√ºrden", etc.
  if(normalizedD.match(/\d+m/i) || normalizedD.includes("h√ºrd") || normalizedD.includes("h√º") || normalizedD.includes("lauf")) {
    const totalSekunden = Number(wert);
    
    // Validierung: Negative oder unrealistische Werte
    if (totalSekunden < 0 || isNaN(totalSekunden)) {
      return "‚Äî";
    }
    
    const minuten = Math.floor(totalSekunden / 60);
    const sekunden = totalSekunden % 60;
    
    if(minuten > 0) {
      const sek = Math.floor(sekunden);
      const hundertstel = Math.round((sekunden - sek) * 100);
      return `${minuten}:${sek.toString().padStart(2, '0')},${hundertstel.toString().padStart(2, '0')}`;
    } else {
      return sekunden.toFixed(2).replace('.', ',') + " s";
    }
  }
  
  // Fallback: Punkte OHNE Nachkommastellen
  return Number(wert).toFixed(0) + " Pkt.";
}

/* ================= EINHEIT ERMITTELN ================= */
function getEinheit(disziplin) {
  if (!disziplin) return "";
  
  const d = disziplin.toLowerCase().trim().replace(/\./g, '').replace(/\s+/g, ' ');
  
  // Mehrkampf
  if (d.includes("kampf") || d.match(/^\d+k$/)) {
    return "Pkt.";
  }
  
  // Sprung/Wurf
  if (d.includes("sprung") || d.includes("wurf") || d.includes("sto√ü") || d.includes("ball") || d.includes("gewicht")) {
    return "m";
  }
  
  // Lauf/Zeit
  if (d.match(/\d+m/i) || d.includes("h√ºrd") || d.includes("h√º") || d.includes("lauf")) {
    return "s";
  }
  
  // Fallback
  return "Pkt.";
}

/* ================= ZEIGE TABELLE MIT PBS ================= */
function zeigeTabelleMitPBs(angezeigteDaten, vollstaendigeDaten, ziel, sortierbar=false){
  if(!angezeigteDaten || angezeigteDaten.length===0){
    document.getElementById(ziel).innerHTML="<div class='no-data'>üì≠ Keine Daten gefunden</div>";
    return;
  }

  let infoHtml = "";
  if(ziel === "leistungenAusgabe"){
    infoHtml = `<div class="results-info">
                  <div class="results-count">üìã ${angezeigteDaten.length} ${angezeigteDaten.length === 1 ? 'Leistung' : 'Leistungen'} gefunden</div>
                </div>`;
  }

  // Ermittle PBs basierend auf ALLEN Leistungen (nicht nur gefilterten)
  let pbSet = new Set();
  if(ziel === "leistungenAusgabe" && alleLeistungenFuerPBs.length > 0) {
    // Gruppiere nach Athlet + Disziplin (nur nicht-null Leistungen)
    const gruppen = {};
    alleLeistungenFuerPBs.forEach((zeile) => {
      // Ignoriere Eintr√§ge mit null-Leistung
      if(zeile.leistung === null || zeile.leistung === undefined) return;
      
      const key = `${zeile.athlet_id}_${zeile.disziplin}`;
      if(!gruppen[key]) gruppen[key] = [];
      gruppen[key].push({ 
        athlet_id: zeile.athlet_id, 
        disziplin: zeile.disziplin, 
        leistung: zeile.leistung,
        datum: zeile.datum
      });
    });
    
    // Finde beste Leistung pro Gruppe
    Object.values(gruppen).forEach(gruppe => {
      if(gruppe.length === 0) return;
      
      const disziplin = gruppe[0].disziplin.toLowerCase();
      // Zeit-Disziplinen: L√§ufe (mit "m" Angabe), H√ºrden, Staffeln
      const istZeitDisziplin = (disziplin.match(/\d+\s*m/) && !disziplin.includes("kampf")) || 
                                disziplin.includes("lauf") || 
                                disziplin.includes("x");
      
      // Bei Zeitdisziplinen: kleinster Wert = beste Leistung
      // Bei anderen (Sprung/Wurf/Mehrkampf): gr√∂√üter Wert = beste Leistung
      let beste;
      if(istZeitDisziplin) {
        beste = gruppe.reduce((min, current) => 
          (current.leistung < min.leistung) ? current : min
        );
      } else {
        beste = gruppe.reduce((max, current) => 
          (current.leistung > max.leistung) ? current : max
        );
      }
      
      // Erstelle eindeutigen Schl√ºssel f√ºr die PB (athlet + disziplin + leistung)
      const pbKey = `${beste.athlet_id}_${beste.disziplin}_${beste.leistung}`;
      pbSet.add(pbKey);
    });
  }

  const spaltenAnzahl = Object.keys(angezeigteDaten[0]).length;
  
  // Pr√ºfe ob Aktions-Spalte angezeigt wird
  const hatAktionsSpalte = currentAthlete && (!isAdmin || selectedAthleteId === currentAthlete.id);
  const gesamtSpaltenAnzahl = hatAktionsSpalte ? spaltenAnzahl + 1 : spaltenAnzahl;

  let html = infoHtml + '<div class="table-wrapper"><table><tr>';
  Object.keys(angezeigteDaten[0]).forEach(sp=>{
    let name = SPALTEN_ANZEIGE[sp]||sp;
    
    if(sortierbar){
      const pfeil = sortSpalte===sp ? (sortAsc?" ‚ñ≤":" ‚ñº") : "";
      html += `<th onclick="setSort('${sp}')">${name}${pfeil}</th>`;
    } else {
      html += `<th>${name}</th>`;
    }
  });
  
  // Add Actions column if user can edit (not admin viewing others)
  if (hatAktionsSpalte) {
    html += `<th>Aktionen</th>`;
  }
  
  html += "</tr>";

  let letzesJahr = null;
  
  angezeigteDaten.forEach((z, index)=>{
    // Pr√ºfe ob Jahr gewechselt hat (nur wenn Datum-Spalte vorhanden)
    if(vollstaendigeDaten[index].datum) {
      const aktuellesJahr = new Date(vollstaendigeDaten[index].datum).getFullYear();
      if(letzesJahr !== null && aktuellesJahr !== letzesJahr) {
        // F√ºge Trennzeile ein - verwende gesamtSpaltenAnzahl
        html += `<tr class="year-separator"><td colspan="${gesamtSpaltenAnzahl}"></td></tr>`;
      }
      letzesJahr = aktuellesJahr;
    }
    
    // Erstelle Schl√ºssel f√ºr aktuelle Zeile (ohne Datum, da mehrere Eintr√§ge die gleiche PB haben k√∂nnen)
    const currentKey = `${vollstaendigeDaten[index].athlet_id}_${vollstaendigeDaten[index].disziplin}_${vollstaendigeDaten[index].leistung}`;
    const istPB = pbSet.has(currentKey);
    
    html += `<tr${istPB ? ' class="pb-row"' : ''}>`;
    Object.keys(z).forEach(sp=>{
      let wert = z[sp];
      if(sp==="leistung" && wert!==null){
        wert = formatiereLeistung(wert, vollstaendigeDaten[index].disziplin);
      }
      else if(sp==="platzierung" && wert!==null){
        wert = Number(wert).toFixed(0);
      }
      else if(sp==="datum" && wert!==null){
        wert = formatiereDatum(wert);
      }
      else if(sp==="typ" && wert!==null){
        wert = TYP_ANZEIGE[wert] || wert;
      }
      else if(sp==="runde" && wert!==null){
        wert = RUNDEN_ANZEIGE[wert] || wert;
      }
      html+=`<td>${wert??""}</td>`;
    });
    
    // Add Edit button if user can edit
    if (currentAthlete && (!isAdmin || selectedAthleteId === currentAthlete.id)) {
      const leistungId = vollstaendigeDaten[index].id;
      html += `<td><button onclick="openEditLeistungModal(${leistungId})" style="padding: 6px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;">‚úèÔ∏è Bearbeiten</button></td>`;
    }
    
    html+="</tr>";
  });

  html+="</table></div>";
  document.getElementById(ziel).innerHTML = html;
}

/* ================= ZEIGE TABELLE ================= */
/* ================= TABELLE ZEIGEN (KORRIGIERT) ================= */
function zeigeTabelle(data, containerId, isPB = false, isAthleten = false) {
  const container = document.getElementById(containerId);
  if (!data || data.length === 0) {
    container.innerHTML = '<div class="no-data">Keine Daten gefunden.</div>';
    return;
  }

  // Spalten bestimmen
  let cols = [];
  if (isAthleten) {
    // Feste Spalten f√ºr die Athleten-Suche
    cols = ["id", "name", "vorname", "jahrgang"];
  } else {
    // Spalten aus den Checkboxen im Leistungen-Tab (f√ºr Leistungen & Analyse)
    const leistungenTab = document.getElementById("leistungenTab");
    if (leistungenTab) {
      cols = Array.from(leistungenTab.querySelectorAll(".spalte:checked")).map(c => c.value);
    }
    // Falls keine Spalten gew√§hlt wurden, Standard-Leistungsspalten nutzen
    if (cols.length === 0) {
      cols = ["datum", "disziplin", "leistung"];
    }
  }

  let html = '<div class="table-wrapper"><table><thead><tr>';
  
  // Header generieren mit Sortierfunktion
  cols.forEach(c => {
    const label = SPALTEN_ANZEIGE[c] || c;
    const arrow = isAthleten 
      ? (sortSpalteAthleten === c ? (sortAscAthleten ? " ‚ñ≤" : " ‚ñº") : "")
      : (sortSpalte === c ? (sortAsc ? " ‚ñ≤" : " ‚ñº") : "");
    
    html += `<th onclick="${isAthleten ? `sortiereAthleten('${c}')` : `sortiereLeistungen('${c}')` }">${label}${arrow}</th>`;
  });
  html += '</tr></thead><tbody>';

  // Datenzeilen generieren
  data.forEach(row => {
    let classes = "";
    if (!isAthleten && isPB && row.istPB) classes = "pb-row";
    
    html += `<tr class="${classes}">`;
    cols.forEach(c => {
      let val = row[c];
      let style = '';
      
      // Formatierung je nach Spaltentyp
      if (c === "datum" && val) {
        val = new Date(val).toLocaleDateString("de-DE");
      } else if (c === "leistung" && !isAthleten) {
        val = formatiereLeistung(val, row.disziplin);
      } else if (c === "runde") {
        val = RUNDEN_ANZEIGE[val] || val;
      } else if (c === "typ") {
        val = TYP_ANZEIGE[val] || val;
      } else if (c === "score") {
        val = val ? Math.round(val) : '';
        style = ' style="color: #667eea; font-weight: 600;"';
      }
      
      html += `<td${style}>${val ?? ""}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  container.innerHTML = html;
  enableTableResize();
}

// Hilfsfunktion f√ºr die Sortierung der Athletentabelle
function sortiereAthleten(spalte) {
  if (sortSpalteAthleten === spalte) {
    sortAscAthleten = !sortAscAthleten;
  } else {
    sortSpalteAthleten = spalte;
    sortAscAthleten = true;
  }
  ladeAthleten(); // L√§dt die Daten neu mit der gew√§hlten Sortierung
}

/* ================= SORT ================= */
function setSort(spalte){
  if(sortSpalte===spalte) sortAsc=!sortAsc;
  else { sortSpalte=spalte; sortAsc=true; }
  ladeLeistungen();
}

function setSortAthleten(spalte){
  if(sortSpalteAthleten===spalte) sortAscAthleten=!sortAscAthleten;
  else { sortSpalteAthleten=spalte; sortAscAthleten=true; }
  ladeAthleten();
}

/* ================= CSV EXPORT ================= */
function exportiereCSV() {
  if(!aktuelleLeistungsdaten || aktuelleLeistungsdaten.length === 0) {
    alert("Keine Daten zum Exportieren vorhanden!");
    return;
  }

  const daten = aktuelleLeistungsdaten;
  const spalten = Object.keys(daten[0]);
  
  let csv = spalten.map(sp => SPALTEN_ANZEIGE[sp] || sp).join(";") + "\n";
  
  daten.forEach(zeile => {
    const row = spalten.map(sp => {
      let wert = zeile[sp];
      
      if(sp === "leistung" && wert !== null) {
        wert = formatiereLeistung(wert, zeile.disziplin);
      }
      else if(sp === "platzierung" && wert !== null) {
        wert = Number(wert).toFixed(0);
      }
      
      if(wert !== null && wert !== undefined) {
        wert = String(wert).replace(/"/g, '""');
        if(wert.includes(";") || wert.includes("\n") || wert.includes('"')) {
          wert = `"${wert}"`;
        }
      } else {
        wert = "";
      }
      
      return wert;
    });
    csv += row.join(";") + "\n";
  });
  
  const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  
  const datum = new Date().toISOString().split('T')[0];
  link.setAttribute("href", url);
  link.setAttribute("download", `leistungen_${datum}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* ================= ANALYSE CSV EXPORT ================= */
function exportiereAnalyseCSV() {
  // Hole die aktuelle Tabelle aus dem analyseAusgabe Bereich
  const analyseAusgabe = document.getElementById('analyseAusgabe');
  const tabelle = analyseAusgabe.querySelector('table');
  
  if(!tabelle) {
    alert("Keine Tabelle zum Exportieren vorhanden!");
    return;
  }
  
  let csv = "";
  const rows = tabelle.querySelectorAll('tr');
  
  rows.forEach((row, rowIndex) => {
    const cells = row.querySelectorAll('th, td');
    const rowData = [];
    
    cells.forEach(cell => {
      let text = cell.textContent.trim();
      // Escape Anf√ºhrungszeichen
      text = text.replace(/"/g, '""');
      // Wenn Semikolon, Zeilenumbruch oder Anf√ºhrungszeichen enthalten, in Anf√ºhrungszeichen setzen
      if(text.includes(";") || text.includes("\n") || text.includes('"')) {
        text = `"${text}"`;
      }
      rowData.push(text);
    });
    
    csv += rowData.join(";") + "\n";
  });
  
  // CSV-Datei erstellen und herunterladen
  const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  
  const datum = new Date().toISOString().split('T')[0];
  link.setAttribute("href", url);
  link.setAttribute("download", `analyse_${datum}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* ================= BESTLEISTUNGEN CSV EXPORT ================= */
function exportiereBestleistungenCSV() {
  // Hole die aktuelle Tabelle aus dem bestleistungenAusgabe Bereich
  const bestleistungenAusgabe = document.getElementById('bestleistungenAusgabe');
  const tabelle = bestleistungenAusgabe.querySelector('table');
  
  if(!tabelle) {
    alert("Keine Tabelle zum Exportieren vorhanden!");
    return;
  }
  
  let csv = "";
  const rows = tabelle.querySelectorAll('tr');
  
  rows.forEach((row, rowIndex) => {
    const cells = row.querySelectorAll('th, td');
    const rowData = [];
    
    cells.forEach(cell => {
      let text = cell.textContent.trim();
      // Escape Anf√ºhrungszeichen
      text = text.replace(/"/g, '""');
      // Wenn Semikolon, Zeilenumbruch oder Anf√ºhrungszeichen enthalten, in Anf√ºhrungszeichen setzen
      if(text.includes(";") || text.includes("\n") || text.includes('"')) {
        text = `"${text}"`;
      }
      rowData.push(text);
    });
    
    csv += rowData.join(";") + "\n";
  });
  
  // CSV-Datei erstellen und herunterladen
  const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  
  const datum = new Date().toISOString().split('T')[0];
  link.setAttribute("href", url);
  link.setAttribute("download", `bestleistungen_${datum}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* ================= DISZIPLIN KATEGORISIERUNG UND SORTIERUNG ================= */
function getDisziplinKategorie(disziplin) {
  const d = disziplin.toLowerCase();
  
  // Staffel (z.B. 4x50m, 4x100m)
  if(d.includes("x") && d.match(/\d+x\d+/)) {
    const distanz = parseInt(d.match(/\d+x(\d+)/)?.[1] || 0);
    return { kategorie: 3, distanz: distanz, name: disziplin };
  }
  // H√ºrdenlauf (muss vor normalen L√§ufen gepr√ºft werden)
  if(d.includes("h√ºrden") || d.includes("huerden") || d.includes("h√º")) {
    const distanz = parseInt(d.match(/(\d+)\s*m/)?.[1] || 0);
    return { kategorie: 2, distanz: distanz, name: disziplin };
  }
  // Lauf (aber nicht H√ºrden oder Staffeln)
  if(d.match(/\d+\s*m/) && !d.includes("x")) {
    const distanz = parseInt(d.match(/(\d+)\s*m/)?.[1] || 0);
    return { kategorie: 1, distanz: distanz, name: disziplin };
  }
  // Sprung
  if(d.includes("sprung") || d.includes("hoch") || d.includes("weit") || d.includes("stab")) {
    return { kategorie: 4, name: disziplin };
  }
  // Wurf
  if(d.includes("wurf") || d.includes("kugel") || d.includes("diskus") || d.includes("speer") || d.includes("hammer") || d.includes("ball") || d.includes("sto√ü")) {
    return { kategorie: 5, name: disziplin };
  }
  // Mehrkampf
  if(d.includes("kampf") || d.match(/\dk\b/)) {
    return { kategorie: 6, name: disziplin };
  }
  
  // Sonstige
  return { kategorie: 7, name: disziplin };
}

function sortiereNachDisziplinTyp(a, b) {
  const katA = getDisziplinKategorie(a.disziplin);
  const katB = getDisziplinKategorie(b.disziplin);
  
  // Erst nach Kategorie sortieren
  if(katA.kategorie !== katB.kategorie) {
    return katA.kategorie - katB.kategorie;
  }
  
  // Innerhalb der Kategorie
  if(katA.kategorie === 1 || katA.kategorie === 2 || katA.kategorie === 3) {
    // L√§ufe, H√ºrden, Staffeln: nach Distanz (kurz nach lang)
    return (katA.distanz || 0) - (katB.distanz || 0);
  } else {
    // Alle anderen: alphabetisch
    return katA.name.localeCompare(katB.name);
  }
}

/* ================= PBS ANZEIGEN ================= */
async function zeigePBs() {
  // Verstecke Export-Buttons zun√§chst
  document.getElementById("analyseExportBtn").style.display = "none";
  document.getElementById("bestleistungenExportBtn").style.display = "none";
  
  if (!selectedAthleteId) {
    alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!');
    return;
  }

  // Pr√ºfe welcher Tab aktiv ist
  const istAnalyseTabAktiv = document.getElementById('analyseTab').classList.contains('active');
  const athletId = istAnalyseTabAktiv ? 
    selectedAthleteId : 
    selectedAthleteId;
  
  if(!athletId) {
    alert('‚ö†Ô∏è Bitte geben Sie eine Athlet-ID ein, um die pers√∂nlichen Bestleistungen anzuzeigen!');
    return;
  }
  
  // Lade alle Leistungen des Athleten
  let query = supabaseClient
    .schema("la").from("leistung")
    .select("*")
    .eq("athlet_id", athletId)
    .not("leistung", "is", null); // Nur Eintr√§ge mit Leistung
  
  // Hole erweiterte Filter (nur wenn im Analyse-Tab)
  if (istAnalyseTabAktiv) {
    const ort = document.getElementById("bestleistungenFilterOrt").value;
    const disziplin = document.getElementById("bestleistungenFilterDisziplin").value;
    const wk = document.getElementById("bestleistungenFilterWK").value;
    const ak = document.getElementById("bestleistungenFilterAK").value;
    const filterTyp = document.getElementById("bestleistungenFilterTyp").value;
    const ms = document.getElementById("bestleistungenFilterMS").value;
    const filterZeitraum = document.getElementById("bestleistungenFilterZeitraum").value;

    
    // Erweiterte Filter anwenden
    if (ort) query = query.ilike("ort", `%${ort}%`);
    if (disziplin) query = query.ilike("disziplin", `%${disziplin}%`);
    if (wk) query = query.ilike("wk_bz", `%${wk}%`);
    if (ak) query = query.ilike("ak", `%${ak}%`);
    if (filterTyp) query = query.eq("typ", filterTyp);
    if (ms) query = query.eq("ms", ms);
    
    if (filterZeitraum === 'custom') {
      const von = document.getElementById("bestleistungenFilterVon").value;
      const bis = document.getElementById("bestleistungenFilterBis").value;
      if (von) query = query.gte("datum", von);
      if (bis) query = query.lte("datum", bis);
    } else if (filterZeitraum) {
      query = query.gte("datum", `${filterZeitraum}-01-01`).lte("datum", `${filterZeitraum}-12-31`);
    }

  }
  
  const { data, error } = await query;
  
  if(error) {
    alert(`‚ùå Fehler: ${error.message}`);
    return;
  }
  
  if(!data || data.length === 0) {
    alert('üì≠ Keine Leistungen f√ºr diesen Athleten gefunden');
    return;
  }
  
  // Gruppiere nach Disziplin und finde jeweils die beste Leistung
  const pbMap = {};
  
  data.forEach(zeile => {
    const disziplin = zeile.disziplin;
    if(!disziplin) return;
    
    
    // Normalisiere Leistungswert (konvertiert cm zu m bei Wurfdisziplinen)
    zeile.leistung = normalizeLeistung(zeile.leistung, disziplin);
    const disziplinLower = disziplin.toLowerCase();
    // Zeit-Disziplinen: L√§ufe (mit "m" Angabe), H√ºrden, Staffeln
    const istZeitDisziplin = (disziplinLower.match(/\d+\s*m/) && !disziplinLower.includes("kampf")) || 
                              disziplinLower.includes("lauf") || 
                              disziplinLower.includes("x");
    
    if(!pbMap[disziplin]) {
      pbMap[disziplin] = zeile;
    } else {
      // Vergleiche mit aktueller Bestleistung
      if(istZeitDisziplin) {
        // Bei Zeit: kleinerer Wert ist besser
        if(zeile.leistung < pbMap[disziplin].leistung) {
          pbMap[disziplin] = zeile;
        }
      } else {
        // Bei Sprung/Wurf/Mehrkampf: gr√∂√üerer Wert ist besser
        if(zeile.leistung > pbMap[disziplin].leistung) {
          pbMap[disziplin] = zeile;
        }
      }
    }
  });
  
  // Erstelle Array mit PBs
  const pbs = Object.values(pbMap);
  
  // Sortiere nach Disziplintyp (Standard)
  pbs.sort(sortiereNachDisziplinTyp);
  
  // Speichere f√ºr Sortierung
  window.aktuellePBsDaten = pbs;
  window.istPBsTabelle = true;
  
  zeigePBsSBsTabelle(pbs, "üèÜ", "Pers√∂nliche Bestleistungen");
}

/* ================= PBS/SBS TABELLE ANZEIGEN (KORRIGIERT) ================= */
function zeigePBsSBsTabelle(daten, icon, titel, jahr = null, mitJahrTrennung = false) {
  // Pr√ºfe welcher Tab aktiv ist
  const istAnalyseTabAktiv = document.getElementById('analyseTab').classList.contains('active');
  
  let cols;
  if(istAnalyseTabAktiv) {
    // KORREKTUR: 'platzierung' aus der Liste entfernt
    // Reihenfolge: Datum, Disziplin, Leistung, Ort
    cols = ['datum', 'disziplin', 'leistung', 'ort'];
  } else {
    // Im Leistungen-Tab: Bleibt alles wie gehabt (Benutzereinstellungen)
    const leistungenTab = document.getElementById("leistungenTab");
    if(!leistungenTab) {
      console.error("leistungenTab nicht gefunden!");
      return;
    }
    cols = Array.from(leistungenTab.querySelectorAll(".spalte:checked")).map(c => c.value);
  }
  
  // Falls keine Daten vorhanden sind, abbrechen um Fehler bei Object.keys zu vermeiden
  if (!daten || daten.length === 0) return;

  // Filtere auf ausgew√§hlte Spalten
  const angezeigteDaten = daten.map(row => {
    const filtered = {};
    cols.forEach(col => {
      // Wir pr√ºfen row, da die Originaldaten (daten) alle Felder enthalten
      if(row.hasOwnProperty(col)) {
        filtered[col] = row[col];
      }
    });
    return filtered;
  });
  
  aktuelleLeistungsdaten = angezeigteDaten;
  
  // Zeige Tabelle
  const titelText = jahr ? `${icon} ${daten.length} ${titel} ${jahr} gefunden` : `${icon} ${daten.length} ${titel} gefunden`;
  const infoHtml = `<div class="results-info">
                      <div class="results-count">${titelText}</div>
                    </div>`;
  
  const istSB = icon === "‚≠ê";
  const rowClass = istSB ? 'style="background: linear-gradient(90deg, #e6f7ff 0%, #ffffff 100%); border-left: 4px solid #4facfe;"' : 'class="pb-row"';
  
  // Anzahl der Spalten f√ºr die Trennzeile (colspan) ermitteln
  const tatsaechlicheSpalten = Object.keys(angezeigteDaten[0]);
  const spaltenAnzahl = tatsaechlicheSpalten.length;
  
  let html = infoHtml + '<div class="table-wrapper"><table><tr>';
  tatsaechlicheSpalten.forEach(sp=>{
    let name = SPALTEN_ANZEIGE[sp]||sp;
    const pfeil = sortSpalte===sp ? (sortAsc?" ‚ñ≤":" ‚ñº") : "";
    html += `<th onclick="setSortPBsSBs('${sp}')" style="cursor: pointer;">${name}${pfeil}</th>`;
  });
  html += "</tr>";

  let letzesJahr = null;

  angezeigteDaten.forEach((z, index)=>{
    // Jahr-Trennung Logik
    if(mitJahrTrennung && daten[index].datum) {
      const aktuellesJahr = new Date(daten[index].datum).getFullYear();
      if(letzesJahr !== null && aktuellesJahr !== letzesJahr) {
        html += `<tr class="year-separator"><td colspan="${spaltenAnzahl}" style="text-align: center; color: #667eea; font-weight: bold; padding: 4px; font-size: 0.9em;">‚îÄ‚îÄ‚îÄ ${aktuellesJahr} ‚îÄ‚îÄ‚îÄ</td></tr>`;
      }
      letzesJahr = aktuellesJahr;
    }
    
    html += `<tr ${rowClass}>`;
    tatsaechlicheSpalten.forEach(sp=>{
      let wert = z[sp];
      // Nutze die Originaldaten (daten[index]) f√ºr die Disziplin-Info beim Formatieren
      if(sp==="leistung" && wert!==null){
        wert = formatiereLeistung(wert, daten[index].disziplin);
      }
      else if(sp==="datum" && wert!==null){
        wert = formatiereDatum(wert);
      }
      else if(sp==="typ" && wert!==null){
        wert = TYP_ANZEIGE[wert] || wert;
      }
      else if(sp==="runde" && wert!==null){
        wert = RUNDEN_ANZEIGE[wert] || wert;
      }
      html+=`<td>${wert??""}</td>`;
    });
    html+="</tr>";
  });

  html+="</table></div>";
  
  if(istAnalyseTabAktiv) {
    document.getElementById("bestleistungenAusgabe").innerHTML = html;
    document.getElementById("bestleistungenExportBtn").style.display = "inline-block";
  } else {
    document.getElementById("leistungenAusgabe").innerHTML = html;
  }
  
  document.getElementById("exportBtn").style.display = "inline-block";
}

/* ================= SORTIERUNG F√úR PBS/SBS ================= */
function setSortPBsSBs(spalte) {
  if(sortSpalte===spalte) {
    sortAsc=!sortAsc;
  } else { 
    sortSpalte=spalte; 
    sortAsc=true; 
  }
  
  // Hole die gespeicherten Daten
  let daten = window.aktuellePBsDaten || [];
  if(daten.length === 0) return;
  
  const istPBs = window.istPBsTabelle || false;
  const jahr = window.aktuelleSBsJahr || null;
  
  // Sortiere die Daten
  daten.sort((a, b) => {
    let valA = a[spalte];
    let valB = b[spalte];
    
    // Spezialbehandlung f√ºr null-Werte bei Leistung
    if(spalte === "leistung") {
      if(valA === null && valB === null) return 0;
      if(valA === null) return 1;
      if(valB === null) return -1;
    }
    
    // Vergleich
    if(valA === valB) return 0;
    if(valA === null) return 1;
    if(valB === null) return -1;
    
    let vergleich;
    if(typeof valA === 'number' && typeof valB === 'number') {
      vergleich = valA - valB;
    } else {
      vergleich = String(valA).localeCompare(String(valB));
    }
    
    return sortAsc ? vergleich : -vergleich;
  });
  
  // Zeige neu sortierte Tabelle
  if(istPBs) {
    zeigePBsSBsTabelle(daten, "üèÜ", "Pers√∂nliche Bestleistungen", null, false);
  } else if(jahr === "alle") {
    zeigePBsSBsTabelle(daten, "‚≠ê", "Saisonbestleistungen (alle Jahre)", null, true);
  } else {
    zeigePBsSBsTabelle(daten, "‚≠ê", "Saisonbestleistungen", jahr, false);
  }
}

/* ================= SBS DIALOG ================= */
function zeigeSBMenu() {
  // Pr√ºfe welcher Tab aktiv ist
  const istAnalyseTabAktiv = document.getElementById('analyseTab').classList.contains('active');
  const athletId = istAnalyseTabAktiv ? 
    selectedAthleteId : 
    selectedAthleteId;
  
  if(!athletId) {
    alert('‚ö†Ô∏è Bitte geben Sie eine Athlet-ID ein, um die Saisonbestleistungen anzuzeigen!');
    return;
  }
  
  zeigeSBDialog();
}

function zeigeSBDialog() {
  // Bef√ºlle Jahr-Dropdown
  const jahrSelect = document.getElementById('sbJahr');
  jahrSelect.innerHTML = verfuegbareJahre.map(j => `<option value="${j}">${j}</option>`).join("");
  
  // Setze auf "Bestimmtes Jahr" zur√ºck
  document.querySelector('input[name="sbOption"][value="single"]').checked = true;
  toggleSBJahrAuswahl();
  
  // Zeige Dialog
  document.getElementById('sbDialog').classList.add('show');
}

function toggleSBJahrAuswahl() {
  const option = document.querySelector('input[name="sbOption"]:checked').value;
  const container = document.getElementById('sbJahrContainer');
  
  if(option === 'single') {
    container.style.display = 'block';
  } else {
    container.style.display = 'none';
  }
}

function schliesseSBDialog() {
  document.getElementById('sbDialog').classList.remove('show');
}

function zeigeSBsAuswahl() {
  const option = document.querySelector('input[name="sbOption"]:checked').value;
  
  if(option === 'single') {
    zeigeSBs();
  } else {
    zeigeAlleSBs();
  }
}

/* ================= SBS ANZEIGEN ================= */
async function zeigeSBs() {
  // Verstecke Export-Buttons zun√§chst
  document.getElementById("analyseExportBtn").style.display = "none";
  document.getElementById("bestleistungenExportBtn").style.display = "none";
  
  if (!selectedAthleteId) {
    alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!');
    return;
  }

  // Pr√ºfe welcher Tab aktiv ist
  const istAnalyseTabAktiv = document.getElementById('analyseTab').classList.contains('active');
  const athletId = istAnalyseTabAktiv ? 
    selectedAthleteId : 
    selectedAthleteId;
  const jahr = document.getElementById('sbJahr').value;
  
  if(!athletId) {
    alert('‚ö†Ô∏è Bitte geben Sie eine Athlet-ID ein!');
    return;
  }
  
  if(!jahr) {
    alert('‚ö†Ô∏è Bitte w√§hlen Sie ein Jahr aus!');
    return;
  }
  
  // Schlie√üe Dialog
  schliesseSBDialog();
  
  // Lade alle Leistungen des Athleten aus dem gew√§hlten Jahr
  let query = supabaseClient
    .schema("la").from("leistung")
    .select("*")
    .eq("athlet_id", athletId)
    .gte("datum", `${jahr}-01-01`)
    .lte("datum", `${jahr}-12-31`)
    .not("leistung", "is", null); // Nur Eintr√§ge mit Leistung
  
  // Hole erweiterte Filter (nur wenn im Analyse-Tab)
  if (istAnalyseTabAktiv) {
    const ort = document.getElementById("bestleistungenFilterOrt").value;
    const wk = document.getElementById("bestleistungenFilterWK").value;
    const ak = document.getElementById("bestleistungenFilterAK").value;
    const filterTyp = document.getElementById("bestleistungenFilterTyp").value;
    const ms = document.getElementById("bestleistungenFilterMS").value;

    
    // Erweiterte Filter anwenden
    if (ort) query = query.ilike("ort", `%${ort}%`);
    if (wk) query = query.ilike("wk_bz", `%${wk}%`);
    if (ak) query = query.ilike("ak", `%${ak}%`);
    if (filterTyp) query = query.eq("typ", filterTyp);
    if (ms) query = query.eq("ms", ms);

  }
  
  const { data, error } = await query;
  
  if(error) {
    alert(`‚ùå Fehler: ${error.message}`);
    return;
  }
  
  if(!data || data.length === 0) {
    alert(`üì≠ Keine Leistungen f√ºr diesen Athleten im Jahr ${jahr} gefunden`);
    return;
  }
  
  // Gruppiere nach Disziplin und finde jeweils die beste Leistung
  const sbMap = {};
  
  data.forEach(zeile => {
    const disziplin = zeile.disziplin;
    if(!disziplin) return;
    
    
    // Normalisiere Leistungswert (konvertiert cm zu m bei Wurfdisziplinen)
    zeile.leistung = normalizeLeistung(zeile.leistung, disziplin);
    const disziplinLower = disziplin.toLowerCase();
    // Zeit-Disziplinen: L√§ufe (mit "m" Angabe), H√ºrden, Staffeln
    const istZeitDisziplin = (disziplinLower.match(/\d+\s*m/) && !disziplinLower.includes("kampf")) || 
                              disziplinLower.includes("lauf") || 
                              disziplinLower.includes("x");
    
    if(!sbMap[disziplin]) {
      sbMap[disziplin] = zeile;
    } else {
      // Vergleiche mit aktueller Bestleistung
      if(istZeitDisziplin) {
        // Bei Zeit: kleinerer Wert ist besser
        if(zeile.leistung < sbMap[disziplin].leistung) {
          sbMap[disziplin] = zeile;
        }
      } else {
        // Bei Sprung/Wurf/Mehrkampf: gr√∂√üerer Wert ist besser
        if(zeile.leistung > sbMap[disziplin].leistung) {
          sbMap[disziplin] = zeile;
        }
      }
    }
  });
  
  // Erstelle Array mit SBs
  const sbs = Object.values(sbMap);
  
  // Sortiere nach Disziplintyp (Standard)
  sbs.sort(sortiereNachDisziplinTyp);
  
  // Speichere f√ºr Sortierung
  window.aktuellePBsDaten = sbs;
  window.istPBsTabelle = false;
  window.aktuelleSBsJahr = jahr;
  
  zeigePBsSBsTabelle(sbs, "‚≠ê", "Saisonbestleistungen", jahr);
}

/* ================= ALLE SBS ANZEIGEN ================= */
async function zeigeAlleSBs() {
  // Pr√ºfe welcher Tab aktiv ist
  const istAnalyseTabAktiv = document.getElementById('analyseTab').classList.contains('active');
  const athletId = istAnalyseTabAktiv ? 
    selectedAthleteId : 
    selectedAthleteId;
  
  if(!athletId) {
    alert('‚ö†Ô∏è Bitte geben Sie eine Athlet-ID ein!');
    return;
  }
  
  // Schlie√üe Dialog
  schliesseSBDialog();
  
  // Lade alle Leistungen des Athleten
  const { data, error } = await supabaseClient
    .schema("la").from("leistung")
    .select("*")
    .eq("athlet_id", athletId)
    .not("leistung", "is", null)
    .order("datum", { ascending: false }); // Neueste zuerst
  
  if(error) {
    alert(`‚ùå Fehler: ${error.message}`);
    return;
  }
  
  if(!data || data.length === 0) {
    alert('üì≠ Keine Leistungen f√ºr diesen Athleten gefunden');
    return;
  }
  
  // Gruppiere nach Jahr + Disziplin
  const jahrDisziplinMap = {};
  
  data.forEach(zeile => {
    if(!zeile.datum || !zeile.disziplin) return;
    
    
    // Normalisiere Leistungswert (konvertiert cm zu m bei Wurfdisziplinen)
    zeile.leistung = normalizeLeistung(zeile.leistung, zeile.disziplin);
    const jahr = new Date(zeile.datum).getFullYear();
    const key = `${jahr}_${zeile.disziplin}`;
    
    const disziplinLower = zeile.disziplin.toLowerCase();
    const istZeitDisziplin = (disziplinLower.match(/\d+\s*m/) && !disziplinLower.includes("kampf")) || 
                              disziplinLower.includes("lauf") || 
                              disziplinLower.includes("x");
    
    if(!jahrDisziplinMap[key]) {
      jahrDisziplinMap[key] = zeile;
    } else {
      // Vergleiche mit aktueller Bestleistung f√ºr dieses Jahr
      if(istZeitDisziplin) {
        if(zeile.leistung < jahrDisziplinMap[key].leistung) {
          jahrDisziplinMap[key] = zeile;
        }
      } else {
        if(zeile.leistung > jahrDisziplinMap[key].leistung) {
          jahrDisziplinMap[key] = zeile;
        }
      }
    }
  });
  
  // Erstelle Array mit allen SBs
  const alleSBs = Object.values(jahrDisziplinMap);
  
  // Sortiere: Erst nach Jahr (neueste zuerst), dann nach Disziplintyp
  alleSBs.sort((a, b) => {
    const jahrA = new Date(a.datum).getFullYear();
    const jahrB = new Date(b.datum).getFullYear();
    
    if(jahrA !== jahrB) {
      return jahrB - jahrA; // Neueste Jahre zuerst
    }
    
    // Innerhalb desselben Jahres: nach Disziplintyp sortieren
    return sortiereNachDisziplinTyp(a, b);
  });
  
  // Speichere f√ºr Sortierung
  window.aktuellePBsDaten = alleSBs;
  window.istPBsTabelle = false;
  window.aktuelleSBsJahr = "alle";
  
  zeigePBsSBsTabelle(alleSBs, "‚≠ê", "Saisonbestleistungen (alle Jahre)", null, true);
}

/* ================= INIT ================= */
async function initializeApp() {
  console.log('=== APP INIT START ===');
  
  await ladeDisziplinen();
  console.log('‚úÖ Disziplinen geladen:', disziplinenListe.length);
  
  await ladeFilterOptionen();
  console.log('‚úÖ Filter-Optionen geladen');
  
  // Baue Filter
  baueFilter();
  console.log('‚úÖ Filter gebaut');
  
  // Event Listener f√ºr Spalten-Checkboxen
  const spaltenCheckboxen = document.querySelectorAll("#leistungenTab .spalte");
  console.log('‚úÖ Spalten-Checkboxen gefunden:', spaltenCheckboxen.length);
  spaltenCheckboxen.forEach(cb => {
    cb.addEventListener("change", baueFilter);
  });
  
  // Bef√ºlle Analyse-Disziplin Dropdown
  const analyseDisziplinSelect = document.getElementById('analyseDisziplin');
  if(analyseDisziplinSelect && disziplinenListe.length > 0) {
    analyseDisziplinSelect.innerHTML = '<option value="">‚Äì Disziplin w√§hlen ‚Äì</option>' + 
      disziplinenListe.map(d => `<option value="${d}">${d}</option>`).join('');
    console.log('‚úÖ Analyse-Dropdown bef√ºllt');
  }
  
  // Bef√ºlle Vergleichs-Disziplin Dropdown
  const vergleichsDisziplinSelect = document.getElementById('vergleichsDisziplin');
  if(vergleichsDisziplinSelect && disziplinenListe.length > 0) {
    vergleichsDisziplinSelect.innerHTML = '<option value="">‚Äì Disziplin w√§hlen ‚Äì</option>' + 
      disziplinenListe.map(d => `<option value="${d}">${d}</option>`).join('');
  }
  
  // Bef√ºlle SB-Disziplin Dropdown
  const sbDisziplinSelect = document.getElementById('sbDisziplin');
  if(sbDisziplinSelect && disziplinenListe.length > 0) {
    sbDisziplinSelect.innerHTML = '<option value="">‚Äì Disziplin w√§hlen ‚Äì</option>' + 
      disziplinenListe.map(d => `<option value="${d}">${d}</option>`).join('');
  }
  
  // Bef√ºlle SB-Vergleichs-Disziplin Dropdown
  const sbVergleichsDisziplinSelect = document.getElementById('sbVergleichsDisziplin');
  if(sbVergleichsDisziplinSelect && disziplinenListe.length > 0) {
    sbVergleichsDisziplinSelect.innerHTML = '<option value="">‚Äì Disziplin w√§hlen ‚Äì</option>' + 
      disziplinenListe.map(d => `<option value="${d}">${d}</option>`).join('');
  }
  
  
  // Bef√ºlle Prognose-Disziplin Dropdown
  const prognoseDisziplinSelect = document.getElementById('prognoseDisziplin');
  if(prognoseDisziplinSelect && disziplinenListe.length > 0) {
    prognoseDisziplinSelect.innerHTML = '<option value="">‚Äì Disziplin w√§hlen ‚Äì</option>' + 
      disziplinenListe.map(d => `<option value="${d}">${d}</option>`).join('');
  }
  // Bef√ºlle Statistik-Filter-Disziplin Dropdown
  const statistikFilterDisziplinSelect = document.getElementById('statistikFilterDisziplin');
  if(statistikFilterDisziplinSelect && disziplinenListe.length > 0) {
    statistikFilterDisziplinSelect.innerHTML = '<option value="">‚Äì Alle ‚Äì</option>' + 
      disziplinenListe.map(d => `<option value="${d}">${d}</option>`).join('');
  }
  
  // Bef√ºlle Bestleistungen-Filter-Disziplin Dropdown
  const bestleistungenFilterDisziplinSelect = document.getElementById('bestleistungenFilterDisziplin');
  if(bestleistungenFilterDisziplinSelect && disziplinenListe.length > 0) {
    bestleistungenFilterDisziplinSelect.innerHTML = '<option value="">‚Äì Alle ‚Äì</option>' + 
      disziplinenListe.map(d => `<option value="${d}">${d}</option>`).join('');
  }
  
  console.log('=== ‚úÖ APP INIT COMPLETE ===');
}

window.addEventListener('DOMContentLoaded', async function() {
  // Only check authentication on page load, don't initialize app yet
  checkSession();
});

/* ================= TAB SWITCHING ================= */

/* ================= DASHBOARD LADEN ================= */
async function ladeDashboardDaten() {
  if(!selectedAthleteId) {
    console.log('Kein Athlet ausgew√§hlt');
    return;
  }

  console.log('========================================');
  console.log('üöÄ VERSION 3.1.0 - WETTKAMPFORTE-KARTE');
  console.log('========================================');
  console.log('Lade Dashboard f√ºr Athlet:', selectedAthleteId);

  // Zeige Welcome Message
  const welcomeDiv = document.getElementById('dashboardWelcome');
  const nameSpan = document.getElementById('dashboardAthletName');
  if(welcomeDiv && nameSpan) {
    nameSpan.textContent = selectedAthleteName || 'Athlet';
    welcomeDiv.style.display = 'block';
  }

  // Lade Athleten-Daten f√ºr zus√§tzliche Infos
  const { data: athletData, error: athletError } = await supabaseClient
    .schema('la').from('athlet')
    .select('*')
    .eq('id', selectedAthleteId)
    .single();
  
  console.log('Athleten-Daten geladen:', athletData);
  console.log('Fehler beim Laden:', athletError);

  if(!athletError && athletData) {
    // Athletendaten sind jetzt verf√ºgbar und werden sp√§ter gesetzt
  }

  // Lade alle Leistungen des Athleten
  const { data, error } = await supabaseClient
    .schema('la').from('leistung')
    .select('*, score')
    .eq('athlet_id', selectedAthleteId)
    .not('leistung', 'is', null);

  if(error) {
    console.error('Fehler beim Laden der Dashboard-Daten:', error);
    return;
  }

  if(!data || data.length === 0) {
    console.log('Keine Daten gefunden');
    document.getElementById('topBestleistungenGrid').innerHTML = 
      '<div class="no-data-message">Keine Leistungen f√ºr diesen Athleten gefunden</div>';
    return;
  }

  // Statistiken berechnen
  document.getElementById('statTotalLeistungen').textContent = data.length;
  
  // Unique Disziplinen z√§hlen
  const uniqueDisziplinen = [...new Set(data.map(d => d.disziplin))];
  document.getElementById('statTotalDisziplinen').textContent = uniqueDisziplinen.length;

  // Aktiv seit (fr√ºhestes Datum finden)
  const allDates = data.map(d => new Date(d.datum));
  const earliestDate = new Date(Math.min(...allDates));
  const latestDate = new Date(Math.max(...allDates));
  const firstYear = earliestDate.getFullYear();
  document.getElementById('statCurrentYear').textContent = firstYear;

  // Zeige erste und letzte Leistung in Athleten-Infos
  const athletInfoDiv = document.getElementById('athletenInfos');
  if(athletInfoDiv && athletData) {
    // Voller Name (name statt nachname in der DB!)
    document.getElementById('athletVollerName').textContent = 
      `${athletData.vorname} ${athletData.name}`;
    
    // Jahrgang direkt aus dem jahrgang-Feld nehmen
    const jahrgang = athletData.jahrgang || athletData.geburtsdatum;
    console.log('Jahrgang/Geburtsdatum aus DB:', jahrgang);
    
    if (jahrgang) {
      // Wenn es ein Datum ist, extrahiere das Jahr
      const jahrgangZahl = typeof jahrgang === 'number' ? jahrgang : new Date(jahrgang).getFullYear();
      console.log('Angezeigter Jahrgang:', jahrgangZahl);
      document.getElementById('athletJahrgang').textContent = jahrgangZahl;
    } else {
      console.warn('Kein Jahrgang vorhanden!');
      document.getElementById('athletJahrgang').textContent = '-';
    }
    
    // Erste und letzte Leistung
    document.getElementById('athletErsteLeistung').textContent = 
      earliestDate.toLocaleDateString('de-DE');
    document.getElementById('athletLetzteLeistung').textContent = 
      latestDate.toLocaleDateString('de-DE');
    
    // WICHTIG: Zeige die Infos an!
    athletInfoDiv.style.display = 'block';
  }


  // Bestleistungen berechnen (gruppiert nach Disziplin)
  const pbMap = {};
  
  // Berechne Alter des Athleten
  let athletIst18Plus = false;
  if (athletData) {
    const jahrgang = athletData.jahrgang || (athletData.geburtsdatum ? new Date(athletData.geburtsdatum).getFullYear() : null);
    
    if (jahrgang) {
      const heute = new Date();
      const alter = heute.getFullYear() - jahrgang;
      athletIst18Plus = alter >= 18;
      console.log(`üéÇ Athlet Jahrgang: ${jahrgang}, Alter: ${alter} Jahre (18+: ${athletIst18Plus})`);
    } else {
      console.log('‚ö†Ô∏è Kein Jahrgang vorhanden - Filter deaktiviert');
    }
  }
  
  data.forEach(zeile => {
    const disziplin = zeile.disziplin;
    if(!disziplin) return;
    
    
    // Normalisiere Leistungswert (konvertiert cm zu m bei Wurfdisziplinen)
    zeile.leistung = normalizeLeistung(zeile.leistung, disziplin);
    const disziplinLower = disziplin.toLowerCase().replace(/\./g, '').trim();
    
    // WICHTIG: Pr√ºfe ZUERST ob Disziplin einen Weltrekord hat (in referenzWerte)
    // Dies geschieht sp√§ter in berechneVergleichsScore
    // Wenn 18+: Nur Disziplinen MIT Weltrekord-Referenz werden ber√ºcksichtigt
    
    const istZeitDisziplin = (disziplinLower.match(/\d+\s*m/) && !disziplinLower.includes("kampf")) || 
                              disziplinLower.includes("lauf") || 
                              disziplinLower.includes("h√ºrd") ||
                              disziplinLower.includes("x");
    
    if(!pbMap[disziplin]) {
      pbMap[disziplin] = zeile;
    } else {
      if(istZeitDisziplin) {
        if(zeile.leistung < pbMap[disziplin].leistung) {
          pbMap[disziplin] = zeile;
        }
      } else {
        if(zeile.leistung > pbMap[disziplin].leistung) {
          pbMap[disziplin] = zeile;
        }
      }
    }
  });

  // Array mit PBs erstellen
  let pbs = Object.values(pbMap);

  // Wettk√§mpfe z√§hlen (gleiche wk_bz im selben Jahr)
  document.getElementById('statTotalWettkaempfe').textContent = z√§hleWettk√§mpfe(data);

  // Aktualisiere Wettkampforte-Karte
  updateWettkampforteMap(data);

  // Filter out entries without score
  pbs = pbs.filter(pb => pb.score !== null && pb.score !== undefined);

  // Sortiere nach Database Score (absteigend)
  pbs.sort((a, b) => (b.score || 0) - (a.score || 0));
  
  // Debug: Zeige die Top 8 nach Sortierung
  console.log('=== TOP 8 NACH SCORE (aus Datenbank) ===');
  pbs.slice(0, 8).forEach((pb, i) => {
    console.log(`${i+1}. ${pb.disziplin}: ${formatiereLeistung(pb.leistung, pb.disziplin)} ‚Üí Score=${pb.score?.toFixed(1)}`);
  });

  // Zeige nur Top 8
  const topPBs = pbs.slice(0, 8);

  // Zeige Bestleistungen
  const grid = document.getElementById('topBestleistungenGrid');
  if(topPBs.length === 0) {
    grid.innerHTML = '<div class="no-data-message">Keine Bestleistungen gefunden</div>';
    return;
  }

  grid.innerHTML = topPBs.map((pb, index) => `
    <div class="pb-card-dashboard" onclick="switchTabToBestleistungen()">
      <div class="rank">${index + 1}</div>
      <div class="discipline">${pb.disziplin}</div>
      <div class="performance">${formatiereLeistung(pb.leistung, pb.disziplin)}</div>
      <div class="date">${new Date(pb.datum).toLocaleDateString('de-DE')}${pb.ort ? ' ‚Ä¢ ' + pb.ort : ''}</div>
    </div>
  `).join('');

  // Berechne und zeige Top 3 h√§ufigste Disziplinen
  const disziplinenCount = {};
  data.forEach(zeile => {
    const disziplin = zeile.disziplin;
    if(disziplin) {
      disziplinenCount[disziplin] = (disziplinenCount[disziplin] || 0) + 1;
    }
  });
  
  // Sortiere nach H√§ufigkeit und nehme Top 3
  const topDisziplinen = Object.entries(disziplinenCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);
  
  const topDisziplinenHTML = topDisziplinen.map(([ disziplin, count], index) => {
    const medals = ['ü•á', 'ü•à', 'ü•â'];
    // Platz 1 nimmt volle Breite, Platz 2 und 3 jeweils halbe Breite
    const style = index === 0 
      ? "width: 100%; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 15px;"
      : "flex: 1; min-width: 0; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; border-left: 4px solid #667eea;";
    
    return `
      ${index === 1 ? '<div style="display: flex; gap: 15px; width: 100%;">' : ''}
      <div class="dashboard-top3-item" style="${style}" onclick="switchTab('leistungen')">
        <div style="font-size: 2em; margin-bottom: 5px;">${medals[index]}</div>
        <div style="font-weight: 600; color: #2a5298; font-size: 1.1em; margin-bottom: 5px;">${disziplin}</div>
        <div style="color: #666; font-size: 0.95em;">${count} ${count === 1 ? 'Leistung' : 'Leistungen'}</div>
      </div>
      ${index === 2 ? '</div>' : ''}
    `;
  }).join('');
  
  document.getElementById('topDisziplinen').innerHTML = topDisziplinenHTML || '<div class="no-data-message">Keine Disziplinen gefunden</div>';

  // Zeige Ziele auf Dashboard
  displayDashboardGoals(selectedAthleteId, data);

  console.log('Dashboard geladen mit', topPBs.length, 'Bestleistungen');
}


// Funktion zum Wechseln zum Analyse Tab und Anzeige der Bestleistungen
function switchTabToBestleistungen() {
  // Wechsle zum Analyse Tab
  switchTab('analyse');
  
  // Kurze Verz√∂gerung, dann scrolle zu den Bestleistungen
  setTimeout(() => {
    const pbsSection = document.getElementById('pbsAusgabe');
    if (pbsSection) {
      pbsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 100);
}


function switchTab(tabName) {
  console.log('=== SWITCH TAB:', tabName, '===');
  
  // Verstecke alle Tabs
  const allTabs = document.querySelectorAll('.tab-content');
  allTabs.forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Entferne active von allen Buttons
  const allButtons = document.querySelectorAll('.tab-btn');
  allButtons.forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Orte-Tabelle und Top-Disziplinen nur im Dashboard anzeigen
  const topDisziplinenSection = document.getElementById('topDisziplinenSection');
  const ortLeistungenTable = document.getElementById('ortLeistungenTable');
  const ortTableMobileContainer = document.getElementById('ortTableMobileContainer');
  const bottomSection = document.getElementById('bottomSection');
  
  if (topDisziplinenSection) {
    topDisziplinenSection.style.display = (tabName === 'dashboard') ? 'block' : 'none';
  }
  
  if (ortLeistungenTable) {
    ortLeistungenTable.style.display = (tabName === 'dashboard') ? 'block' : 'none';
  }
  
  if (ortTableMobileContainer) {
    ortTableMobileContainer.style.display = (tabName === 'dashboard' && ortTableMobileContainer.children.length > 0) ? 'block' : 'none';
  }
  
  if (bottomSection) {
    bottomSection.style.display = (tabName === 'dashboard') ? 'grid' : 'none';
  }
  
  // Zeige gew√§hlten Tab
  if(tabName === 'dashboard') {
    const tab = document.getElementById('dashboardTab');
    const btn = allButtons[0];
    if(tab) {
      tab.classList.add('active');
      console.log('Activated dashboardTab');
    }
    if(btn) {
      btn.classList.add('active');
    }
    // Lade Dashboard-Daten wenn Athlet ausgew√§hlt
    if(selectedAthleteId) {
      ladeDashboardDaten();
    }
  } else if(tabName === 'ziele') {
    const tab = document.getElementById('zieleTab');
    const btn = allButtons[3];
    if(tab) {
      tab.classList.add('active');
      console.log('Activated zieleTab');
    }
    if(btn) {
      btn.classList.add('active');
    }
    // Aktualisiere Ziele-Tab
    updateGoalsTab();
  } else if(tabName === 'leistungen') {
    const tab = document.getElementById('leistungenTab');
    const btn = allButtons[1];
    if(tab) {
      tab.classList.add('active');
      console.log('Activated leistungenTab');
    }
    if(btn) {
      btn.classList.add('active');
    }
    // Scrolle automatisch nach oben
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  } else if(tabName === 'analyse') {
    const tab = document.getElementById('analyseTab');
    const btn = allButtons[2];
    if(tab) {
      tab.classList.add('active');
      console.log('Activated analyseTab');
    }
    if(btn) {
      btn.classList.add('active');
    }
  }
  
  console.log('=== TAB SWITCH COMPLETE ===');
}

// Hilfsfunktion: Pr√ºft, ob eine Disziplin in Zeit (Sekunden/Minuten) gemessen wird
function checkIstZeitDisziplin(disziplin) {
    if (!disziplin) return false;
    const d = disziplin.toLowerCase().replace(/\./g, '').replace(/\s+/g, ' ');
    
    // WICHTIG: Mehrk√§mpfe sind KEINE Zeitdisziplinen!
    if (d.includes("kampf") || d.match(/^\d+k$/)) {
        return false;
    }
    
    // Mapping f√ºr abgek√ºrzte Namen
    const zeitDisziplinMapping = {
        '50': true,
        '60': true,
        '75': true,
        '100': true,
        '200': true,
        '300': true,
        '400': true,
        '800': true,
        '1500': true,
        '3000': true,
        '5000': true,
        '10000': true,
        '110': true,
        '400h': true,
        '400h√º': true
    };
    
    // Exaktes Mapping zuerst pr√ºfen
    if (zeitDisziplinMapping[d]) return true;
    
    // Liste der Disziplinen, bei denen "weniger = besser" gilt (Zeit-Disziplinen)
    return d.includes("lauf") || 
           d.includes("sprint") || 
           d.includes("h√ºrden") || 
           d.includes("h√ºrd") ||
           d.includes("h√º") ||
           d.includes("hindernis") ||
           d.match(/\d+m(?:\s|$)/) || // L√§ufe wie "100m", "800m"
           d.includes("50m") ||
           d.includes("60m") ||
           d.includes("75m") ||
           d.includes("80m") || 
           d.includes("100m") || 
           d.includes("200m") ||
           d.includes("300m") ||
           d.includes("400m") || 
           d.includes("800m") || 
           d.includes("1500m") || 
           d.includes("2000m") ||
           d.includes("3000m") ||
           d.includes("5000m") ||
           d.includes("10000m") ||
           d.includes("meile");
}

// Funktion zum Generieren sch√∂ner runder Leistungswerte f√ºr Y-Achsen
function generiereSchoeneLeistungen(min, max, disziplin, anzahlTicks = 8) {
    if (!min || !max || min === max) {
        return [min || 0];
    }
    
    const istZeit = checkIstZeitDisziplin(disziplin);
    const bereich = max - min;
    
    // Bestimme passende Schrittgr√∂√üe basierend auf dem Bereich
    let schrittgroesse;
    
    if (istZeit) {
        // Zeitdisziplinen - feinere Abstufungen
        if (bereich < 0.5) schrittgroesse = 0.05;
        else if (bereich < 1) schrittgroesse = 0.1;
        else if (bereich < 2) schrittgroesse = 0.2;
        else if (bereich < 5) schrittgroesse = 0.5;
        else if (bereich < 10) schrittgroesse = 1;
        else if (bereich < 20) schrittgroesse = 2;
        else if (bereich < 60) schrittgroesse = 5;
        else if (bereich < 120) schrittgroesse = 10;
        else if (bereich < 300) schrittgroesse = 30;
        else schrittgroesse = 60;
    } else {
        // Felddisziplinen (Sprung, Wurf, Mehrkampf)
        if (bereich < 0.5) schrittgroesse = 0.05;
        else if (bereich < 1) schrittgroesse = 0.1;
        else if (bereich < 2) schrittgroesse = 0.2;
        else if (bereich < 5) schrittgroesse = 0.5;
        else if (bereich < 10) schrittgroesse = 1;
        else if (bereich < 20) schrittgroesse = 2;
        else if (bereich < 50) schrittgroesse = 5;
        else if (bereich < 100) schrittgroesse = 10;
        else if (bereich < 500) schrittgroesse = 50;
        else if (bereich < 1000) schrittgroesse = 100;
        else schrittgroesse = 200;
    }
    
    // Runde Min/Max auf sch√∂ne Werte
    const rundeAb = (wert) => Math.floor(wert / schrittgroesse) * schrittgroesse;
    const rundeAuf = (wert) => Math.ceil(wert / schrittgroesse) * schrittgroesse;
    
    const startWert = rundeAb(min);
    const endWert = rundeAuf(max);
    
    // Generiere Ticks
    const ticks = [];
    let aktuellerWert = startWert;
    
    while (aktuellerWert <= endWert && ticks.length < 15) { // Max 15 Ticks
        ticks.push(Number(aktuellerWert.toFixed(3))); // Runde auf 3 Dezimalen um Floating-Point-Fehler zu vermeiden
        aktuellerWert += schrittgroesse;
    }
    
    // Stelle sicher, dass mindestens 3 Ticks vorhanden sind
    if (ticks.length < 3) {
        schrittgroesse = bereich / 4;
        ticks.length = 0;
        aktuellerWert = min;
        while (aktuellerWert <= max && ticks.length < 5) {
            ticks.push(Number(aktuellerWert.toFixed(3)));
            aktuellerWert += schrittgroesse;
        }
    }
    
    return ticks;
}

// Hilfsfunktion: Normalisiert Leistungswerte (konvertiert cm zu m bei Wurfdisziplinen)
function normalizeLeistung(leistung, disziplin) {
    if (!leistung || !disziplin || leistung === 0) return leistung;
    
    const d = disziplin.toLowerCase();
    
    // Pr√ºfe auf Sprung- und Wurfdisziplinen (werden in Metern gemessen)
    const istMeterDisziplin = d.includes('diskus') || 
                              d.includes('hammer') || 
                              d.includes('speer') || 
                              d.includes('kugel') ||
                              d.includes('sprung') ||  // Weitsprung, Hochsprung, Dreisprung, Stabhochsprung
                              d.includes('sto√ü') ||
                              d.includes('gewicht') ||
                              d.includes('wurf');
    
    // Konvertiere von cm zu m wenn Wert > 100 (typisch f√ºr cm-Speicherung)
    // Bei Hochsprung und Stabhochsprung sind auch Werte zwischen 10-100 m√∂glich
    if (istMeterDisziplin && leistung > 100) {
        console.log(`üîÑ Normalisiere ${disziplin}: ${leistung} cm ‚Üí ${leistung/100} m`);
        return leistung / 100;
    }
    
    return leistung;
}


async function befuelleAnalyseJahre() {
    // Holt alle Daten, um die Jahre zu extrahieren
    const { data, error } = await supabaseClient
        .schema("la").from("leistung")
        .select("datum");

    if (error) {
        console.error("Fehler beim Laden der Jahre:", error);
        return;
    }

    // Einzigartige Jahre filtern und sortieren (absteigend)
    const jahre = [...new Set(data.map(d => new Date(d.datum).getFullYear()))];
    jahre.sort((a, b) => b - a);

    const select = document.getElementById("analyseFilterJahr");
    if (!select) return;

    select.innerHTML = '<option value="">‚Äì Jahr w√§hlen ‚Äì</option>';
    jahre.forEach(jahr => {
        const option = document.createElement("option");
        option.value = jahr;
        option.textContent = jahr;
        select.appendChild(option);
    });
}
// Diese Funktion startet alles, sobald die Seite geladen ist
window.onload = function() {
    befuelleAnalyseJahre();
    ladeAlleAthleten(); // Lade Athleten f√ºr Ziele-Tab
    // Hier kannst du sp√§ter weitere Start-Funktionen erg√§nzen
};

/* ================= WELTREKORD-BASIERTE SCORE-BERECHNUNG ================= */

// Score calculations removed - using database score field






/* ================= DIAGRAMM ANZEIGEN ================= */
async function zeigeDiagramm() {
    if (!selectedAthleteId) {
        alert("‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!");
        return;
    }
    
    const athletId = selectedAthleteId;
    const disziplin = document.getElementById("analyseDisziplin").value;
    
    if (!disziplin) {
        alert("‚ö†Ô∏è Bitte Disziplin angeben");
        return;
    }

    const from = document.getElementById("analyseFilterFrom").value;
    const to = document.getElementById("analyseFilterTo").value;
    const jahr = document.getElementById("analyseFilterJahr").value;
    
    // Pr√ºfe ob Vergleichsmodus aktiv ist
    const vergleichsModus = document.getElementById("vergleichsModus").checked;
    const vergleichsDisziplin = document.getElementById("vergleichsDisziplin").value;
    
    // Entscheide ob Vergleichsscores (basierend auf Weltrekorden) verwendet werden
    const useVergleichsScores = vergleichsModus && vergleichsDisziplin && vergleichsDisziplin !== disziplin;

    // Query f√ºr erste Disziplin  
    let query1 = supabaseClient.schema("la").from("leistung")
        .select("datum, leistung, score")
        .eq("athlet_id", athletId)
        .eq("disziplin", disziplin)
        .order("datum", { ascending: true });

    if (jahr) {
        query1 = query1.gte("datum", `${jahr}-01-01`).lte("datum", `${jahr}-12-31`);
    } else {
        if (from) query1 = query1.gte("datum", from);
        if (to) query1 = query1.lte("datum", to);
    }

    const { data: data1, error: error1 } = await query1;

    if (error1 || !data1 || data1.length === 0) {
        alert("Keine Daten f√ºr " + disziplin + " im gew√§hlten Zeitraum gefunden.");
        return;
    }

    // Datasets f√ºr Chart
    const datasets = [];
    const istZeitDisziplin1 = checkIstZeitDisziplin(disziplin);
    
    // Konvertiere Daten
    let chartData1, minScore1, maxScore1, minLeistung1, maxLeistung1;
    
    if (useVergleichsScores) {
        // Verwende DB-Scores f√ºr Skalierung
        const dataWithScores = data1.map(d => {
            return {
                datum: d.datum,
                leistung: d.leistung,
                score: d.score || 0
            };
        }).filter(d => d.score !== null && d.score > 0);
        
        console.log(`Vergleichsscores f√ºr ${disziplin}:`, dataWithScores.slice(0, 3).map(d => 
            `Leistung: ${d.leistung} ‚Üí Score: ${d.score.toFixed(2)}%`
        ));
        
        if (dataWithScores.length === 0) {
            console.warn('Keine g√ºltigen Vergleichsscores f√ºr', disziplin);
            chartData1 = data1.map(d => ({ x: d.datum, y: d.leistung }));
        } else {
            // Verwende Vergleichsscores f√ºr Y-Position
            chartData1 = dataWithScores.map(d => ({ 
                x: d.datum, 
                y: d.score,
                original: d.leistung
            }));
            
            // Finde Min/Max f√ºr Mapping
            const scores = dataWithScores.map(d => d.score);
            const leistungen = dataWithScores.map(d => d.leistung);
            minScore1 = Math.min(...scores);
            maxScore1 = Math.max(...scores);
            minLeistung1 = Math.min(...leistungen);
            maxLeistung1 = Math.max(...leistungen);
        }
    } else {
        chartData1 = data1.map(d => ({ x: d.datum, y: d.leistung }));
    }
    
    // Speichere Original-Leistungen f√ºr Tooltip (wenn Vergleichsscores verwendet werden)
    const originalLeistungen1 = useVergleichsScores && chartData1[0]?.original !== undefined
        ? chartData1.map(d => d.original)
        : null;
    
    datasets.push({
        label: `${disziplin}`,
        data: chartData1,
        originalLeistungen: originalLeistungen1,  // Speichere f√ºr Tooltip
        disziplin: disziplin,  // Speichere Disziplin f√ºr korrekte Einheitenformatierung
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        fill: false,
        tension: 0.3,
        spanGaps: true,
        pointRadius: 3,
        pointBackgroundColor: '#ffffff',
        pointBorderWidth: 2,
        yAxisID: 'y1'
    });

    // Wenn Vergleichsmodus aktiv und zweite Disziplin gew√§hlt
    let data2 = null;
    let istZeitDisziplin2 = false;
    let minScore2, maxScore2, minLeistung2, maxLeistung2;
    
    if (vergleichsModus && vergleichsDisziplin) {
        let query2 = supabaseClient.schema("la").from("leistung")
            .select("datum, leistung, score")
            .eq("athlet_id", athletId)
            .eq("disziplin", vergleichsDisziplin)
            .order("datum", { ascending: true });

        if (jahr) {
            query2 = query2.gte("datum", `${jahr}-01-01`).lte("datum", `${jahr}-12-31`);
        } else {
            if (from) query2 = query2.gte("datum", from);
            if (to) query2 = query2.lte("datum", to);
        }

        const result2 = await query2;
        data2 = result2.data;
        
        if (data2 && data2.length > 0) {
            istZeitDisziplin2 = checkIstZeitDisziplin(vergleichsDisziplin);
            
            let chartData2;
            if (useVergleichsScores) {
                const dataWithScores = data2.map(d => {
                    return {
                        datum: d.datum,
                        leistung: d.leistung,
                        score: d.score || 0
                    };
                }).filter(d => d.score !== null && d.score > 0);
                
                console.log(`Vergleichsscores f√ºr ${vergleichsDisziplin}:`, dataWithScores.slice(0, 3).map(d => 
                    `Leistung: ${d.leistung} ‚Üí Score: ${d.score.toFixed(2)}%`
                ));
                
                if (dataWithScores.length === 0) {
                    console.warn('Keine g√ºltigen Vergleichsscores f√ºr', vergleichsDisziplin);
                    chartData2 = data2.map(d => ({ x: d.datum, y: d.leistung }));
                } else {
                    // Verwende Vergleichsscores f√ºr Y-Position
                    chartData2 = dataWithScores.map(d => ({ 
                        x: d.datum, 
                        y: d.score,
                        original: d.leistung
                    }));
                    
                    // Finde Min/Max f√ºr Mapping
                    const scores = dataWithScores.map(d => d.score);
                    const leistungen = dataWithScores.map(d => d.leistung);
                    minScore2 = Math.min(...scores);
                    maxScore2 = Math.max(...scores);
                    minLeistung2 = Math.min(...leistungen);
                    maxLeistung2 = Math.max(...leistungen);
                }
            } else {
                chartData2 = data2.map(d => ({ x: d.datum, y: d.leistung }));
            }
            
            // Speichere Original-Leistungen f√ºr Tooltip (wenn Vergleichsscores verwendet werden)
            const originalLeistungen2 = useVergleichsScores && chartData2[0]?.original !== undefined
                ? chartData2.map(d => d.original)
                : null;
            
            // Bestimme die korrekte yAxisID basierend darauf, ob Vergleichsscores verwendet werden
            let yAxisID2 = 'y2';
            
            // Wenn Vergleichsscores verwendet werden, aber eine Disziplin keine Parameter hat,
            // verwende die y1-Achse f√ºr beide (Fallback)
            if (useVergleichsScores && (!minScore2 || !maxScore2)) {
                console.warn(`Keine Vergleichsscores f√ºr ${vergleichsDisziplin} verf√ºgbar, verwende normale Skalierung`);
                yAxisID2 = 'y2'; // Trotzdem y2 verwenden, aber ohne Vergleichsscores
            }
            
            datasets.push({
                label: `${vergleichsDisziplin}`,
                data: chartData2,
                originalLeistungen: originalLeistungen2,  // Speichere f√ºr Tooltip
                borderColor: '#f093fb',
                disziplin: vergleichsDisziplin,  // Speichere Disziplin f√ºr korrekte Einheitenformatierung
                backgroundColor: 'rgba(240, 147, 251, 0.1)',
                fill: false,
                tension: 0.3,
                spanGaps: true,
                pointRadius: 3,
                pointBackgroundColor: '#ffffff',
                pointBorderWidth: 2,
                yAxisID: yAxisID2
            });
        }
    }

    // Container und Schlie√üen-Button anzeigen, Button-Text √§ndern
    document.getElementById("diagrammContainer").style.display = "block";
    document.getElementById("diagrammSchlie√üenBtn").style.display = "inline-block";
    document.getElementById("diagrammAusklappenBtn").style.display = "none";
    document.getElementById("diagrammAnzeigenBtn").textContent = "üîÑ Diagramm aktualisieren";
    
    const canvas = document.getElementById('leistungsChart');
    const ctx = canvas.getContext('2d');

    // WICHTIG: Altes Chart komplett zerst√∂ren
    if (window.myChart instanceof Chart) {
        window.myChart.destroy();
    }

    // Y-Achsen Konfiguration
    let yAxes;
    
    console.log('=== Y-ACHSEN KONFIGURATION ===');
    console.log('useVergleichsScores:', useVergleichsScores);
    console.log('Disziplin 1:', disziplin, '‚Üí minScore1:', minScore1, 'maxScore1:', maxScore1);
    console.log('Disziplin 2:', vergleichsDisziplin, '‚Üí minScore2:', minScore2, 'maxScore2:', maxScore2);
    console.log('istZeitDisziplin1:', istZeitDisziplin1);
    console.log('istZeitDisziplin2:', istZeitDisziplin2);
    
    if (useVergleichsScores && minScore1 && maxScore1) {
        // WICHTIG: Beide Achsen verwenden den GEMEINSAMEN Score-Bereich f√ºr echten Vergleich!
        // Das erm√∂glicht, dass gleiche Vergleichsscores auf gleicher H√∂he erscheinen
        
        // Finde gemeinsamen Score-Bereich √ºber beide Disziplinen
        let globalMinScore = minScore1;
        let globalMaxScore = maxScore1;
        
        if (minScore2 && maxScore2) {
            globalMinScore = Math.min(minScore1, minScore2);
            globalMaxScore = Math.max(maxScore1, maxScore2);
        }
        
        const scoreRange = globalMaxScore - globalMinScore;
        // Erh√∂he Puffer auf 10% f√ºr bessere Sichtbarkeit
        const padding = Math.max(scoreRange * 0.10, 3);
        const displayMin = globalMinScore - padding;
        const displayMax = globalMaxScore + padding;
        
        console.log('Score-Bereiche (gemeinsam f√ºr beide Achsen):', {
            gemeinsamerBereich: [displayMin, displayMax],
            disziplin1: {
                name: disziplin,
                eigenScores: [minScore1, maxScore1],
                eigenLeistungen: [minLeistung1, maxLeistung1]
            },
            disziplin2: minScore2 ? {
                name: vergleichsDisziplin,
                eigenScores: [minScore2, maxScore2],
                eigenLeistungen: [minLeistung2, maxLeistung2]
            } : 'N/A'
        });
        
        yAxes = {
            y1: {
                type: 'linear',
                position: 'left',
                min: displayMin,
                max: displayMax,
                afterBuildTicks: function(axis) {
                    // Generiere sch√∂ne Leistungswerte f√ºr Disziplin 1
                    const schoeneLeistungen = generiereSchoeneLeistungen(minLeistung1, maxLeistung1, disziplin, 8);
                    
                    // Mappe jede Leistung zu ihrem Score-Wert
                    axis.ticks = schoeneLeistungen.map(leistung => {
                        // Berechne den Score f√ºr diese Leistung
                        let score;
                        if (istZeitDisziplin1) {
                            // Bei Zeit: niedrigere Zeit = h√∂herer Score
                            // Normalisiere Leistung im Bereich [minLeistung1, maxLeistung1] zu [0, 1]
                            const leistungNormalized = (maxLeistung1 - leistung) / (maxLeistung1 - minLeistung1);
                            // Mappe auf Score-Bereich
                            score = displayMin + (leistungNormalized * (displayMax - displayMin));
                        } else {
                            // Bei Feld: h√∂here Leistung = h√∂herer Score
                            const leistungNormalized = (leistung - minLeistung1) / (maxLeistung1 - minLeistung1);
                            score = displayMin + (leistungNormalized * (displayMax - displayMin));
                        }
                        
                        return {
                            value: score,
                            label: leistung // Speichere Leistung f√ºr Anzeige
                        };
                    });
                },
                ticks: {
                    color: '#000',
                    callback: function(scoreValue, index, ticks) {
                        // Zeige die gespeicherte Leistung statt Score
                        const tick = ticks[index];
                        if (tick && tick.label !== undefined) {
                            return formatiereLeistung(tick.label, disziplin);
                        }
                        // Fallback auf alte Methode
                        if (!minLeistung1 || !maxLeistung1) return scoreValue.toFixed(1);
                        const normalized = (scoreValue - displayMin) / (displayMax - displayMin);
                        let leistung;
                        if (istZeitDisziplin1) {
                            leistung = maxLeistung1 - (normalized * (maxLeistung1 - minLeistung1));
                        } else {
                            leistung = minLeistung1 + (normalized * (maxLeistung1 - minLeistung1));
                        }
                        return formatiereLeistung(leistung, disziplin);
                    }
                },
                title: {
                    display: true,
                    text: disziplin,
                    color: '#667eea',
                    font: {
                        weight: 'bold'
                    }
                }
            }
        };
        
        // Erstelle y2-Achse immer wenn Vergleichsmodus aktiv und zweite Disziplin gew√§hlt
        if (vergleichsModus && vergleichsDisziplin && data2 && data2.length > 0) {
            // Wenn zweite Disziplin Vergleichsscores hat
            if (minScore2 && maxScore2) {
                // Verwende den GEMEINSAMEN Score-Bereich (displayMin/Max) - gleich wie erste Achse!
                // Das stellt sicher, dass gleiche Vergleichsscores auf beiden Achsen auf gleicher H√∂he sind
                
                console.log(`Zweite Achse (${vergleichsDisziplin}) mit Score-Bereich:`, [displayMin, displayMax]);
                
                yAxes.y2 = {
                    type: 'linear',
                    position: 'right',
                    min: displayMin,
                    max: displayMax,
                    afterBuildTicks: function(axis) {
                        // Generiere sch√∂ne Leistungswerte f√ºr Disziplin 2
                        const schoeneLeistungen = generiereSchoeneLeistungen(minLeistung2, maxLeistung2, vergleichsDisziplin, 8);
                        
                        // Mappe jede Leistung zu ihrem Score-Wert
                        axis.ticks = schoeneLeistungen.map(leistung => {
                            // Berechne den Score f√ºr diese Leistung
                            let score;
                            if (istZeitDisziplin2) {
                                // Bei Zeit: niedrigere Zeit = h√∂herer Score
                                const leistungNormalized = (maxLeistung2 - leistung) / (maxLeistung2 - minLeistung2);
                                score = displayMin + (leistungNormalized * (displayMax - displayMin));
                            } else {
                                // Bei Feld: h√∂here Leistung = h√∂herer Score
                                const leistungNormalized = (leistung - minLeistung2) / (maxLeistung2 - minLeistung2);
                                score = displayMin + (leistungNormalized * (displayMax - displayMin));
                            }
                            
                            return {
                                value: score,
                                label: leistung // Speichere Leistung f√ºr Anzeige
                            };
                        });
                    },
                    ticks: {
                        color: '#000',
                        callback: function(scoreValue, index, ticks) {
                            // Zeige die gespeicherte Leistung statt Score
                            const tick = ticks[index];
                            if (tick && tick.label !== undefined) {
                                return formatiereLeistung(tick.label, vergleichsDisziplin);
                            }
                            // Fallback auf alte Methode
                            if (!minLeistung2 || !maxLeistung2) return scoreValue.toFixed(1);
                            const normalized = (scoreValue - displayMin) / (displayMax - displayMin);
                            let leistung;
                            if (istZeitDisziplin2) {
                                leistung = maxLeistung2 - (normalized * (maxLeistung2 - minLeistung2));
                            } else {
                                leistung = minLeistung2 + (normalized * (maxLeistung2 - minLeistung2));
                            }
                            return formatiereLeistung(leistung, vergleichsDisziplin);
                        }
                    },
                    title: {
                        display: true,
                        text: vergleichsDisziplin,
                        color: '#f093fb',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                };
            } else {
                // Zweite Disziplin hat keine Vergleichsscores, verwende normale Skalierung
                console.log(`Verwende normale Skalierung f√ºr ${vergleichsDisziplin} (keine IAAF-Parameter)`);
                const istZeitDisziplin2 = checkIstZeitDisziplin(vergleichsDisziplin);
                
                // Berechne Min/Max f√ºr zweite Disziplin
                const alleLeistungen2 = data2.map(d => d.y);
                const minLeistung2 = Math.min(...alleLeistungen2);
                const maxLeistung2 = Math.max(...alleLeistungen2);
                
                yAxes.y2 = {
                    type: 'linear',
                    position: 'right',
                    reverse: istZeitDisziplin2,
                    afterBuildTicks: function(axis) {
                        // Generiere sch√∂ne Leistungswerte f√ºr die zweite Disziplin
                        const schoeneLeistungen = generiereSchoeneLeistungen(minLeistung2, maxLeistung2, vergleichsDisziplin, 8);
                        axis.ticks = schoeneLeistungen.map(leistung => ({
                            value: leistung
                        }));
                    },
                    title: {
                        display: true,
                        text: vergleichsDisziplin,
                        color: '#f093fb',
                        font: {
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        color: '#000',
                        callback: function(value) {
                            return formatiereLeistung(value, vergleichsDisziplin);
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                };
            }
        }
    } else {
        // Normale Skalierung ohne Vergleichsscores
        // Berechne Min/Max f√ºr erste Disziplin - verwende chartData1 statt data1
        const alleLeistungen1 = chartData1.map(d => d.y);
        const minLeistung1 = Math.min(...alleLeistungen1);
        const maxLeistung1 = Math.max(...alleLeistungen1);
        
        yAxes = {
            y1: {
                type: 'linear',
                position: 'left',
                reverse: istZeitDisziplin1,
                afterBuildTicks: function(axis) {
                    // Generiere sch√∂ne Leistungswerte f√ºr die erste Disziplin
                    const schoeneLeistungen = generiereSchoeneLeistungen(minLeistung1, maxLeistung1, disziplin, 8);
                    axis.ticks = schoeneLeistungen.map(leistung => ({
                        value: leistung
                    }));
                },
                title: {
                    display: true,
                    text: disziplin,
                    color: '#667eea',
                    font: {
                        weight: 'bold',
                        size: 14
                    }
                },
                ticks: {
                    color: '#000',
                    callback: function(value) {
                        return formatiereLeistung(value, disziplin);
                    }
                }
            }
        };

        // Zweite Y-Achse nur wenn Vergleichsmodus aktiv
        if (vergleichsModus && vergleichsDisziplin && data2 && data2.length > 0) {
            // Berechne Min/Max f√ºr zweite Disziplin - verwende chartData2 falls vorhanden
            const alleLeistungen2 = chartData2 ? chartData2.map(d => d.y) : data2.map(d => d.y);
            const minLeistung2 = Math.min(...alleLeistungen2);
            const maxLeistung2 = Math.max(...alleLeistungen2);
            
            yAxes.y2 = {
                type: 'linear',
                position: 'right',
                reverse: istZeitDisziplin2,
                afterBuildTicks: function(axis) {
                    // Generiere sch√∂ne Leistungswerte f√ºr die zweite Disziplin
                    const schoeneLeistungen = generiereSchoeneLeistungen(minLeistung2, maxLeistung2, vergleichsDisziplin, 8);
                    axis.ticks = schoeneLeistungen.map(leistung => ({
                        value: leistung
                    }));
                },
                title: {
                    display: true,
                    text: vergleichsDisziplin,
                    color: '#f093fb',
                    font: {
                        weight: 'bold'
                    }
                },
                ticks: {
                    color: '#000',
                    callback: function(value) {
                        return formatiereLeistung(value, vergleichsDisziplin);
                    }
                },
                grid: {
                    drawOnChartArea: false
                }
            };
        }
    }

    window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'nearest',
                intersect: false,
                axis: 'x'
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'month',
                        displayFormats: { month: 'MMM yyyy' },
                        tooltipFormat: 'dd.MM.yyyy'
                    },
                    title: { display: true, text: 'Datum' }
                },
                ...yAxes
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const disziplinName = context.dataset.label;
                            const disziplin = context.dataset.disziplin || disziplinName;  // Verwende gespeicherte Disziplin
                            
                            // Versuche Original-Leistung aus verschiedenen Quellen
                            let leistung;
                            if (context.dataset.originalLeistungen && context.dataset.originalLeistungen[context.dataIndex] !== undefined) {
                                // Verwende gespeicherte Original-Leistung
                                leistung = context.dataset.originalLeistungen[context.dataIndex];
                            } else if (context.raw?.original !== undefined) {
                                // Fallback: Verwende original aus raw
                                leistung = context.raw.original;
                            } else {
                                // Verwende parsed Y-Wert (wenn keine Scores verwendet werden)
                                leistung = context.parsed.y;
                            }
                            
                            return ` ${disziplinName}: ${formatiereLeistung(leistung, disziplin)}`;
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
    
    // Zeige Diagramm-Container und passe Buttons an
    document.getElementById('diagrammContainer').style.display = 'block';
    document.getElementById('diagrammAnzeigenBtn').style.display = 'none';
    document.getElementById('diagrammAktualisierenBtn').style.display = 'inline-block';
    document.getElementById('diagrammSchlie√üenBtn').style.display = 'inline-block';
    document.getElementById('diagrammAusklappenBtn').style.display = 'none';
}

/* ================= VERGLEICHSMODUS TOGGLE ================= */
function toggleVergleichsModus() {
    const checkbox = document.getElementById('vergleichsModus');
    const container = document.getElementById('vergleichsDisziplinContainer');
    const diagrammBtn = document.getElementById('diagrammAnzeigenBtn');
    const diagrammSichtbar = document.getElementById('diagrammContainer').style.display === 'block';
    
    if (checkbox.checked) {
        container.style.display = 'block';
        // Wenn Diagramm bereits sichtbar, Button-Text auf "aktualisieren" √§ndern
        if (diagrammSichtbar) {
            diagrammBtn.textContent = 'üîÑ Diagramm aktualisieren';
        }
    } else {
        container.style.display = 'none';
        document.getElementById('vergleichsDisziplin').value = '';
        // Button-Text zur√ºcksetzen wenn Diagramm sichtbar
        if (diagrammSichtbar) {
            diagrammBtn.textContent = 'üîÑ Diagramm aktualisieren';
        }
    }
}

/* ================= DIAGRAMM SCHLIESSEN ================= */
function schlie√üeDiagramm() {
    document.getElementById('diagrammContainer').style.display = 'none';
    document.getElementById('diagrammAktualisierenBtn').style.display = 'none';
    document.getElementById('diagrammSchlie√üenBtn').style.display = 'none';
    document.getElementById('diagrammAusklappenBtn').style.display = 'inline-block';
}

function klappeAusDiagramm() {
    document.getElementById('diagrammContainer').style.display = 'block';
    document.getElementById('diagrammAktualisierenBtn').style.display = 'inline-block';
    document.getElementById('diagrammSchlie√üenBtn').style.display = 'inline-block';
    document.getElementById('diagrammAusklappenBtn').style.display = 'none';
}

/* ================= SB-DIAGRAMM FUNKTIONEN ================= */
let sbChartInstance = null;


/* ===== SCORE-BASIERTE ACHSEN-SKALIERUNG =====
 * Die Y-Achsen verwenden jetzt direkt die Scores aus der Datenbank (la.leistung.score).
 * F√ºr die Anzeige werden die originalen Leistungswerte in den Tooltips gezeigt.
 * Bei Vergleich zweier Disziplinen werden die Y-Achsen so skaliert, dass
 * Werte mit dem gleichen Score auf der gleichen H√∂he stehen.
 */

async function zeigeSBDiagramm() {
    if (!selectedAthleteId) {
        alert("‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!");
        return;
    }
    
    const athletId = selectedAthleteId;
    const disziplin = document.getElementById("sbDisziplin").value;
    
    if (!disziplin) {
        alert("‚ö†Ô∏è Bitte Disziplin angeben");
        return;
    }

    // Pr√ºfe ob Vergleichsmodus aktiv ist
    const vergleichsModus = document.getElementById("sbVergleichsModus").checked;
    const vergleichsDisziplin = document.getElementById("sbVergleichsDisziplin").value;

    // Hole Checkbox-Werte f√ºr SBs und Durchschnitte
    const showSBs = document.getElementById("sbShowSBs").checked;
    const showAverages = document.getElementById("sbShowAverages").checked;


    // Hole Zeitraum-Filter
    const filterFrom = document.getElementById("sbFilterFrom").value;
    const filterTo = document.getElementById("sbFilterTo").value;
    const filterJahr = document.getElementById("sbFilterJahr").value;

    // Query f√ºr erste Disziplin (alle Leistungen) 
    let query = supabaseClient.schema("la").from("leistung")
        .select("datum, leistung, score")
        .eq("athlet_id", athletId)
        .eq("disziplin", disziplin)
        .order("datum", { ascending: true });

    // Wende Zeitraum-Filter an
    if (filterJahr) {
        const jahrStart = `${filterJahr}-01-01`;
        const jahrEnde = `${filterJahr}-12-31`;
        query = query.gte("datum", jahrStart).lte("datum", jahrEnde);
    } else {
        if (filterFrom) {
            query = query.gte("datum", filterFrom);
        }
        if (filterTo) {
            query = query.lte("datum", filterTo);
        }
    }

    const { data, error } = await query;

    if (error || !data || data.length === 0) {
        alert("Keine Daten f√ºr " + disziplin + " gefunden.");
        return;
    }


    // Funktion zum Gruppieren und Berechnen von SBs und Durchschnitten
    function berechneSaisonWerte(daten, disziplinName) {
        const istZeitDisziplin = checkIstZeitDisziplin(disziplinName);
        const saisonDaten = {};
        const saisonScores = {}; // Scores parallel zu Leistungen speichern
        
        daten.forEach(d => {
            // Normalisiere Leistung (konvertiert cm zu m bei Wurf-/Sprungdisziplinen)
            let leistung = normalizeLeistung(d.leistung, disziplinName);
            leistung = parseFloat(leistung);
            const score = d.score || 0;
            
            // Filtere null, undefined, NaN und 0 Werte
            if (leistung && !isNaN(leistung) && leistung > 0) {
                const jahr = new Date(d.datum).getFullYear();
                if (!saisonDaten[jahr]) {
                    saisonDaten[jahr] = [];
                    saisonScores[jahr] = [];
                }
                saisonDaten[jahr].push(leistung);
                saisonScores[jahr].push(score);
            }
        });

        
        console.log(`üìä berechneSaisonWerte f√ºr ${disziplinName}:`, {
            anzahlDaten: daten.length,
            beispielWert: daten[0]?.leistung,
            istZeitDisziplin
        });
        // Berechne SBs und Durchschnitte pro Saison
        const jahre = Object.keys(saisonDaten).sort();
        const sbWerte = [];
        const durchschnittsWerte = [];
        
        jahre.forEach(jahr => {
            const leistungen = saisonDaten[jahr];
            const scores = saisonScores[jahr];
            
            // √úberspringe Jahre ohne g√ºltige Leistungen
            if (!leistungen || leistungen.length === 0) {
                return;
            }
            
            // SB (Saisonbestleistung) - finde Index der besten Leistung
            let sbIndex;
            if (istZeitDisziplin) {
                sbIndex = leistungen.indexOf(Math.min(...leistungen));
            } else {
                sbIndex = leistungen.indexOf(Math.max(...leistungen));
            }
            const sb = leistungen[sbIndex];
            const sbScore = scores[sbIndex];
            
            // Durchschnitt
            const durchschnitt = leistungen.reduce((sum, val) => sum + val, 0) / leistungen.length;
            const durchschnittScore = scores.reduce((sum, val) => sum + val, 0) / scores.length;
            
            // Nur hinzuf√ºgen wenn Werte g√ºltig sind
            if (!isNaN(sb) && !isNaN(durchschnitt)) {
                sbWerte.push({ x: parseInt(jahr), y: sb, score: sbScore });
                durchschnittsWerte.push({ x: parseInt(jahr), y: durchschnitt, score: durchschnittScore });
            }
        });
        
        return { sbWerte, durchschnittsWerte, istZeitDisziplin };
    }

    // Berechne Werte f√ºr erste Disziplin
    const werte1 = berechneSaisonWerte(data, disziplin);
    const istZeitDisziplin1 = werte1.istZeitDisziplin;

    // Zweite Disziplin laden wenn Vergleichsmodus aktiv
    let werte2 = null;
    let data2 = null;
    let istZeitDisziplin2 = false;
    
    if (vergleichsModus && vergleichsDisziplin && vergleichsDisziplin !== disziplin) {
        let query2 = supabaseClient.schema("la").from("leistung")
            .select("datum, leistung, score")
            .eq("athlet_id", athletId)
            .eq("disziplin", vergleichsDisziplin)
            .order("datum", { ascending: true });

        // Wende dieselben Zeitraum-Filter an
        if (filterJahr) {
            const jahrStart = `${filterJahr}-01-01`;
            const jahrEnde = `${filterJahr}-12-31`;
            query2 = query2.gte("datum", jahrStart).lte("datum", jahrEnde);
        } else {
            if (filterFrom) {
                query2 = query2.gte("datum", filterFrom);
            }
            if (filterTo) {
                query2 = query2.lte("datum", filterTo);
            }
        }

        const result2 = await query2;
        data2 = result2.data;

        if (data2 && data2.length > 0) {
            werte2 = berechneSaisonWerte(data2, vergleichsDisziplin);
            istZeitDisziplin2 = werte2.istZeitDisziplin;
        }
    }

    // Berechne Score-Bereiche f√ºr beide Disziplinen (aus Datenbank)
    let minScore1 = null, maxScore1 = null, minScore2 = null, maxScore2 = null;
    let displayMin = null, displayMax = null;
    let useScoreScaling = false;

    if (werte2) {
        // Verwende Scores aus Datenbank
        const scores1 = [...werte1.sbWerte.map(d => d.score), ...werte1.durchschnittsWerte.map(d => d.score)].filter(s => s !== null && s !== undefined);
        const scores2 = [...werte2.sbWerte.map(d => d.score), ...werte2.durchschnittsWerte.map(d => d.score)].filter(s => s !== null && s !== undefined);
        
        console.log('üìä Verwende DB-Scores f√ºr SB-Diagramm:', {
            disziplin1: disziplin,
            scores1: scores1,
            disziplin2: vergleichsDisziplin,
            scores2: scores2
        });
        
        if (scores1.length > 0) {
            minScore1 = Math.min(...scores1);
            maxScore1 = Math.max(...scores1);
        }
        
        if (scores2.length > 0) {
            minScore2 = Math.min(...scores2);
            maxScore2 = Math.max(...scores2);
        }
        
        // Verwende Score-Skalierung nur wenn BEIDE Disziplinen g√ºltige Scores haben
        useScoreScaling = minScore1 !== null && maxScore1 !== null && minScore2 !== null && maxScore2 !== null;
        
        // Gemeinsamer Score-Bereich
        if (useScoreScaling) {
            displayMin = Math.min(minScore1, minScore2);
            displayMax = Math.max(maxScore1, maxScore2);
            
            const scoreSpanne = displayMax - displayMin;
            // Erh√∂he Puffer auf 15% f√ºr bessere Sichtbarkeit
            const puffer = Math.max(scoreSpanne * 0.15, 5); // Mindestens 5% Puffer
            displayMin = Math.max(0, displayMin - puffer);
            displayMax = displayMax + puffer;
        }
    }

    // Datasets f√ºr Chart
    const datasets = [];
    
    if (useScoreScaling) {
        // Bei Score-Skalierung: Speichere SCORES als Y-Werte, aber behalte Original-Leistungen f√ºr Tooltips
        if (showSBs) {
            datasets.push({
                label: `${disziplin} - SB`,
            data: werte1.sbWerte.map(d => ({ 
                x: d.x, 
                y: d.score,  // DB-Score f√ºr Y-Achse
                original: d.y  // Original-Leistung f√ºr Tooltip
            })),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            fill: false,
            tension: 0.1,
            spanGaps: false,
            yAxisID: 'y1',
            disziplin: disziplin
            });
        }
        
        if (showAverages) {
            datasets.push({
                label: `${disziplin} - √ò`,
            data: werte1.durchschnittsWerte.map(d => ({ 
                x: d.x, 
                y: d.score,  // DB-Score f√ºr Y-Achse
                original: d.y  // Original-Leistung f√ºr Tooltip
            })),
            borderColor: 'rgba(102, 126, 234, 0.65)',
            backgroundColor: 'rgba(102, 126, 234, 0.05)',
            borderWidth: 1.5,
            borderDash: [5, 5],
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: false,
            tension: 0.1,
            spanGaps: false,
            yAxisID: 'y1',
            disziplin: disziplin
            });
        }
        
        if (showSBs) {
            datasets.push({
                label: `${vergleichsDisziplin} - SB`,
            data: werte2.sbWerte.map(d => ({ 
                x: d.x, 
                y: d.score,  // DB-Score f√ºr Y-Achse
                original: d.y  // Original-Leistung f√ºr Tooltip
            })),
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            fill: false,
            tension: 0.1,
            spanGaps: false,
            yAxisID: 'y2',
            disziplin: vergleichsDisziplin
            });
        }
        
        if (showAverages) {
            datasets.push({
                label: `${vergleichsDisziplin} - √ò`,
            data: werte2.durchschnittsWerte.map(d => ({ 
                x: d.x, 
                y: d.score,  // DB-Score f√ºr Y-Achse
                original: d.y  // Original-Leistung f√ºr Tooltip
            })),
            borderColor: 'rgba(118, 75, 162, 0.65)',
            backgroundColor: 'rgba(118, 75, 162, 0.05)',
            borderWidth: 1.5,
            borderDash: [5, 5],
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: false,
            tension: 0.1,
            spanGaps: false,
            yAxisID: 'y2',
            disziplin: vergleichsDisziplin
            });
        }
    } else {
        // Normale Skalierung
        if (showSBs) {
            datasets.push({
                label: `${disziplin} - SB`,
            data: werte1.sbWerte,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            fill: false,
            tension: 0.1,
            spanGaps: false,
            yAxisID: 'y1',
            disziplin: disziplin
            });
        }
        
        if (showAverages) {
            datasets.push({
                label: `${disziplin} - √ò`,
            data: werte1.durchschnittsWerte,
            borderColor: 'rgba(102, 126, 234, 0.65)',
            backgroundColor: 'rgba(102, 126, 234, 0.05)',
            borderWidth: 1.5,
            borderDash: [5, 5],
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: false,
            tension: 0.1,
            spanGaps: false,
            yAxisID: 'y1',
            disziplin: disziplin
            });
        }
        
        if (werte2) {
            if (showSBs) {
                datasets.push({
                    label: `${vergleichsDisziplin} - SB`,
                data: werte2.sbWerte,
                borderColor: '#764ba2',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                borderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8,
                fill: false,
                tension: 0.1,
                spanGaps: false,
                yAxisID: 'y2',
                disziplin: vergleichsDisziplin
                });
            }
            
            if (showAverages) {
                datasets.push({
                    label: `${vergleichsDisziplin} - √ò`,
                data: werte2.durchschnittsWerte,
                borderColor: 'rgba(118, 75, 162, 0.65)',
                backgroundColor: 'rgba(118, 75, 162, 0.05)',
                borderWidth: 1.5,
                borderDash: [5, 5],
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false,
                tension: 0.1,
                spanGaps: false,
                yAxisID: 'y2',
                disziplin: vergleichsDisziplin
                });
            }
        }
    }

    // Chart-Konfiguration
    let scales = {};
    
    if (useScoreScaling) {
        // Score-basierte Skalierung
        // Datenpunkte sind jetzt Scores, also m√ºssen die Achsen auch Score-Bereiche verwenden
        console.log(`Score-Bereich f√ºr beide Disziplinen:`, [displayMin, displayMax]);
        
        scales = {
            x: {
                type: 'linear',
                title: {
                    display: true,
                    text: 'Saison',
                    font: { size: 14, weight: 'bold' }
                },
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Math.round(value);
                    }
                }
            },
            y1: {
                type: 'linear',
                position: 'left',
                min: displayMin,
                max: displayMax,
                ticks: {
                    callback: function(scoreValue) {
                        return scoreValue.toFixed(1);
                    },
                    color: '#000'
                },
                title: {
                    display: true,
                    text: disziplin,
                    font: { size: 14, weight: 'bold' },
                    color: '#667eea'
                }
            },
            y2: {
                type: 'linear',
                position: 'right',
                min: displayMin,
                max: displayMax,
                ticks: {
                    callback: function(scoreValue) {
                        return scoreValue.toFixed(1);
                    },
                    color: '#000'
                },
                title: {
                    display: true,
                    text: vergleichsDisziplin,
                    font: { size: 14, weight: 'bold' },
                    color: '#764ba2'
                },
                grid: {
                    drawOnChartArea: false
                }
            }
        };
    } else {
        // Normale Skalierung
        // Berechne Min/Max f√ºr erste Disziplin
        const alleLeistungen1 = [...werte1.sbWerte.map(d => d.y), ...werte1.durchschnittsWerte.map(d => d.y)];
        const minLeistung1 = Math.min(...alleLeistungen1);
        const maxLeistung1 = Math.max(...alleLeistungen1);
        
        scales = {
            x: {
                type: 'linear',
                title: {
                    display: true,
                    text: 'Saison',
                    font: { size: 14, weight: 'bold' }
                },
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Math.round(value);
                    }
                }
            },
            y1: {
                type: 'linear',
                position: 'left',
                reverse: istZeitDisziplin1,
                afterBuildTicks: function(axis) {
                    // Generiere sch√∂ne Leistungswerte f√ºr die erste Disziplin
                    const schoeneLeistungen = generiereSchoeneLeistungen(minLeistung1, maxLeistung1, disziplin, 8);
                    axis.ticks = schoeneLeistungen.map(leistung => ({
                        value: leistung
                    }));
                },
                title: {
                    display: true,
                    text: disziplin,
                    font: { size: 14, weight: 'bold' },
                    color: '#667eea'
                },
                ticks: {
                    color: '#000',
                    callback: function(value) {
                        return formatiereLeistung(value, disziplin);
                    }
                }
            }
        };

        if (werte2) {
            // Berechne Min/Max f√ºr zweite Disziplin
            const alleLeistungen2 = [...werte2.sbWerte.map(d => d.y), ...werte2.durchschnittsWerte.map(d => d.y)];
            const minLeistung2 = Math.min(...alleLeistungen2);
            const maxLeistung2 = Math.max(...alleLeistungen2);
            
            scales.y2 = {
                type: 'linear',
                position: 'right',
                reverse: istZeitDisziplin2,
                afterBuildTicks: function(axis) {
                    // Generiere sch√∂ne Leistungswerte f√ºr die zweite Disziplin
                    const schoeneLeistungen = generiereSchoeneLeistungen(minLeistung2, maxLeistung2, vergleichsDisziplin, 8);
                    axis.ticks = schoeneLeistungen.map(leistung => ({
                        value: leistung
                    }));
                },
                title: {
                    display: true,
                    text: vergleichsDisziplin,
                    font: { size: 14, weight: 'bold' },
                    color: '#764ba2'
                },
                ticks: {
                    color: '#000',
                    callback: function(value) {
                        return formatiereLeistung(value, vergleichsDisziplin);
                    }
                },
                grid: {
                    drawOnChartArea: false
                }
            };
        }
    }

    // Erstelle Chart
    const ctx = document.getElementById("sbChart").getContext("2d");
    
    if (sbChartInstance) {
        sbChartInstance.destroy();
    }

    sbChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: scales,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].parsed.x.toString();
                        },
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const disziplinName = context.dataset.disziplin || disziplin;
                            
                            // Wenn Score-Skalierung verwendet wird, nutze das gespeicherte Original
                            let value;
                            if (useScoreScaling && context.raw?.original !== undefined) {
                                value = context.raw.original;
                            } else {
                                value = context.parsed.y;
                            }
                            
                            return `${label}: ${formatiereLeistung(value, disziplinName)}`;
                        }
                    }
                }
            }
        }
    });

    // Zeige Container und passe Buttons an
    document.getElementById('sbDiagrammContainer').style.display = 'block';
    document.getElementById('sbDiagrammOptionsContainer').style.display = 'block';
    document.getElementById('sbDiagrammAnzeigenBtn').style.display = 'none';
    document.getElementById('sbDiagrammAktualisierenBtn').style.display = 'inline-block';
    document.getElementById('sbDiagrammSchlie√üenBtn').style.display = 'inline-block';
}

function schlie√üeSBDiagramm() {
    document.getElementById('sbDiagrammContainer').style.display = 'none';
    document.getElementById('sbDiagrammOptionsContainer').style.display = 'none';
    document.getElementById('sbDiagrammAktualisierenBtn').style.display = 'none';
    document.getElementById('sbDiagrammSchlie√üenBtn').style.display = 'none';
    document.getElementById('sbDiagrammAusklappenBtn').style.display = 'inline-block';
}

function klappeAusSBDiagramm() {
    document.getElementById('sbDiagrammContainer').style.display = 'block';
    document.getElementById('sbDiagrammOptionsContainer').style.display = 'block';
    document.getElementById('sbDiagrammAktualisierenBtn').style.display = 'inline-block';
    document.getElementById('sbDiagrammSchlie√üenBtn').style.display = 'inline-block';
    document.getElementById('sbDiagrammAusklappenBtn').style.display = 'none';
}

function toggleSBVergleichsModus() {
    const checkbox = document.getElementById('sbVergleichsModus');
    const container = document.getElementById('sbVergleichsDisziplinContainer');
    const diagrammBtn = document.getElementById('sbDiagrammAnzeigenBtn');
    const diagrammSichtbar = document.getElementById('sbDiagrammContainer').style.display === 'block';
    
    if (checkbox.checked) {
        container.style.display = 'block';
        // Wenn Diagramm bereits sichtbar, Button-Text auf "aktualisieren" √§ndern
        if (diagrammSichtbar) {
            diagrammBtn.textContent = 'üîÑ SB-Diagramm aktualisieren';
        }
    } else {
        container.style.display = 'none';
        document.getElementById('sbVergleichsDisziplin').value = '';
        // Button-Text zur√ºcksetzen wenn Diagramm sichtbar
        if (diagrammSichtbar) {
            diagrammBtn.textContent = 'üîÑ SB-Diagramm aktualisieren';
        }
    }
}

/* ================= ERWEITERTE FILTER ZUR√úCKSETZEN ================= */

/* ================= PROGNOSE-DIAGRAMM FUNKTIONEN ================= */
let prognoseChartInstance = null;

async function zeigePrognoseDiagramm() {
    if (!selectedAthleteId) {
        alert("‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!");
        return;
    }
    
    const disziplin = document.getElementById("prognoseDisziplin").value;
    
    if (!disziplin) {
        alert("‚ö†Ô∏è Bitte Disziplin angeben");
        return;
    }
    
    // Zeige Buttons
    document.getElementById('prognoseDiagrammContainer').style.display = 'block';
    document.getElementById('prognoseDiagrammAnzeigenBtn').style.display = 'none';
    document.getElementById('prognoseDiagrammAktualisierenBtn').style.display = 'inline-block';
    document.getElementById('prognoseDiagrammSchlie√üenBtn').style.display = 'inline-block';
    
    // Hole Prognosezeitraum
    const zeitraumRadios = document.getElementsByName('prognoseZeitraum');
    let monate = 12;
    for (const radio of zeitraumRadios) {
        if (radio.checked) {
            monate = parseInt(radio.value);
            break;
        }
    }
    
    const istJahresPrognose = monate === 60; // 5 Jahre
    
    // Lade alle Leistungen der Disziplin
    const { data: allData, error } = await supabaseClient
        .schema("la").from("leistung")
        .select("datum, leistung, disziplin")
        .eq("athlet_id", selectedAthleteId)
        .eq("disziplin", disziplin)
        .not("leistung", "is", null)
        .order("datum", { ascending: true });
    
    if (error || !allData || allData.length === 0) {
        alert("Keine Daten f√ºr " + disziplin + " gefunden.");
        return;
    }
    
    // Hole Athleten-Jahrgang
    const { data: athletData, error: athletError } = await supabaseClient
        .schema('la').from('athlet')
        .select('jahrgang')
        .eq('id', selectedAthleteId)
        .single();
    
    if (athletError || !athletData) {
        alert("Fehler beim Laden der Athletendaten");
        return;
    }
    
    const jahrgang = athletData.jahrgang;
    const istZeitDisziplin = checkIstZeitDisziplin(disziplin);
    
    // Normalisiere alle Leistungen
    const alleLeistungen = [];
    allData.forEach(d => {
        let leistung = normalizeLeistung(d.leistung, disziplin);
        leistung = parseFloat(leistung);
        
        if (leistung && !isNaN(leistung) && leistung > 0) {
            const datum = new Date(d.datum);
            alleLeistungen.push({
                datum: datum,
                leistung: leistung
            });
        }
    });
    
    if (alleLeistungen.length < 2) {
        alert("‚ö†Ô∏è Mindestens 2 Leistungen erforderlich f√ºr eine Prognose");
        return;
    }
    
    // Filtere Leistungen f√ºr den gew√ºnschten Zeitraum
    const heute = new Date();
    const startDatum = new Date(heute);
    startDatum.setMonth(heute.getMonth() - monate);
    
    const relevanteLeistungen = alleLeistungen.filter(l => l.datum >= startDatum);
    
    if (relevanteLeistungen.length < 2) {
        alert(`‚ö†Ô∏è Nicht genug Leistungen in den letzten ${istJahresPrognose ? '5 Jahren' : '12 Monaten'} gefunden`);
        return;
    }
    
    console.log('üìä Prognose-Berechnung:', {
        disziplin,
        zeitraum: istJahresPrognose ? '5 Jahre' : '12 Monate',
        anzahlLeistungen: relevanteLeistungen.length,
        von: startDatum.toLocaleDateString('de-DE'),
        bis: heute.toLocaleDateString('de-DE')
    });
    
    // Berechne Trendlinie (lineare Regression)
    const regression = berechneZeitbasiertenTrend(relevanteLeistungen, istZeitDisziplin);
    
    // Erstelle historische Datenpunkte
    const historischeDaten = relevanteLeistungen.map(d => ({
        x: d.datum,
        y: d.leistung
    }));
    
    // Berechne Trendlinie f√ºr historische Daten
    const trendlinieDaten = [];
    const ersterTag = relevanteLeistungen[0].datum.getTime();
    const letzterTag = relevanteLeistungen[relevanteLeistungen.length - 1].datum.getTime();
    
    for (let i = 0; i <= 10; i++) {
        const timestamp = ersterTag + (letzterTag - ersterTag) * (i / 10);
        const datum = new Date(timestamp);
        const tageVomStart = (timestamp - ersterTag) / (1000 * 60 * 60 * 24);
        const trendWert = regression.steigung * tageVomStart + regression.achsenabschnitt;
        
        trendlinieDaten.push({
            x: datum,
            y: trendWert
        });
    }
    
    // Berechne Prognosepunkte
    let prognoseDaten = [];
    
    if (istJahresPrognose) {
        // 5 Jahre: Ein Punkt pro Jahr am 1. Januar
        for (let jahr = 1; jahr <= 5; jahr++) {
            const prognoseDatum = new Date(heute.getFullYear() + jahr, 0, 1); // 1. Januar
            
            const tageVomStart = (prognoseDatum.getTime() - ersterTag) / (1000 * 60 * 60 * 24);
            let prognoseLeistung = regression.steigung * tageVomStart + regression.achsenabschnitt;
            
            // Validierung: F√ºr Feld-Disziplinen keine negativen Werte erlauben
            if (!istZeitDisziplin && prognoseLeistung < 0) {
                prognoseLeistung = 0.01; // Minimal-Wert statt negativ
            }
            
            prognoseDaten.push({
                x: prognoseDatum,
                y: prognoseLeistung
            });
        }
    } else {
        // 12 Monate: Ein Punkt pro Monat
        for (let monat = 1; monat <= 12; monat++) {
            const prognoseDatum = new Date(heute);
            prognoseDatum.setMonth(prognoseDatum.getMonth() + monat);
            
            const tageVomStart = (prognoseDatum.getTime() - ersterTag) / (1000 * 60 * 60 * 24);
            let prognoseLeistung = regression.steigung * tageVomStart + regression.achsenabschnitt;
            
            // Validierung: F√ºr Feld-Disziplinen keine negativen Werte erlauben
            if (!istZeitDisziplin && prognoseLeistung < 0) {
                prognoseLeistung = 0.01; // Minimal-Wert statt negativ
            }
            
            prognoseDaten.push({
                x: prognoseDatum,
                y: prognoseLeistung
            });
        }
    }
    
    // NICHT MEHR VERWENDET: Verbinde Trendlinie mit Prognose
    // const trendUndPrognose = [...trendlinieDaten, ...prognoseDaten];
    
    // Berechne Trend-Info
    const tageProJahr = 365.25;
    const verbesserungProJahr = Math.abs(regression.steigung * tageProJahr);
    const trendRichtung = istZeitDisziplin ? 
        (regression.steigung < 0 ? "Verbesserung" : "Verschlechterung") :
        (regression.steigung > 0 ? "Verbesserung" : "Verschlechterung");
    
    // Formatiere die Trend-Verbesserung mit korrekter Einheit
    const trendText = formatiereLeistung(verbesserungProJahr, disziplin);
    
    // Zeige Prognose-Werte
    let prognoseText = '';
    if (istJahresPrognose) {
        prognoseText = '<strong>Prognose pro Jahr:</strong><br>';
        prognoseDaten.forEach((p, i) => {
            prognoseText += `Jahr ${i+1} (${p.x.getFullYear()}): ${formatiereLeistung(p.y, disziplin)}<br>`;
        });
    } else {
        const letztePrognose = prognoseDaten[prognoseDaten.length - 1];
        prognoseText = `<strong>Prognose in 12 Monaten:</strong> ${formatiereLeistung(letztePrognose.y, disziplin)}`;
    }
    
    const infoDiv = document.getElementById('prognoseInfo');
    infoDiv.innerHTML = `
        üìà <strong>Trend:</strong> ${trendRichtung} um ${trendText} pro Jahr<br>
        üìä <strong>Basis:</strong> ${relevanteLeistungen.length} Leistungen (${startDatum.toLocaleDateString('de-DE')} - ${heute.toLocaleDateString('de-DE')})<br>
        ${prognoseText}
    `;
    
    // Zeige Container
    document.getElementById('prognoseDiagrammContainer').style.display = 'block';
    
    // Erstelle Chart - mit Fehlerbehandlung
    const canvasElement = document.getElementById("prognoseChart");
    if (!canvasElement) {
        console.error("‚ùå prognoseChart Canvas-Element nicht gefunden!");
        alert("Fehler: Chart-Element konnte nicht gefunden werden. Bitte Seite neu laden.");
        return;
    }
    
    const ctx = canvasElement.getContext("2d");
    
    if (prognoseChartInstance) {
        prognoseChartInstance.destroy();
    }
    
    const datasets = [
        {
            label: 'Historische Leistungen',
            data: historischeDaten,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.3)',
            borderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#667eea',
            fill: false,
            showLine: true,  // Verbinde die historischen Punkte
            tension: 0.1
        },
        {
            label: 'Prognose',
            data: prognoseDaten,
            borderColor: '#f093fb',
            backgroundColor: '#f093fb',
            borderWidth: 2,
            pointRadius: 7,
            pointHoverRadius: 9,
            pointStyle: 'circle',
            fill: false,
            showLine: true,  // Verbinde auch die Prognose-Punkte
            tension: 0.1,
            borderDash: [5, 5]  // Gestrichelte Linie f√ºr Prognose
        }
    ];
    
    // Berechne Min/Max f√ºr Achse mit Puffer
    const alleWerte = [...historischeDaten, ...prognoseDaten].map(d => d.y);
    let minWert = Math.min(...alleWerte);
    let maxWert = Math.max(...alleWerte);
    
    // F√ºge Puffer hinzu f√ºr bessere Visualisierung
    const range = maxWert - minWert;
    const puffer = range * 0.1; // 10% Puffer
    
    // Stelle sicher, dass es einen Mindestbereich gibt
    if (range < 0.01) {
        minWert = minWert - 0.05;
        maxWert = maxWert + 0.05;
    } else {
        minWert = minWert - puffer;
        maxWert = maxWert + puffer;
    }
    
    // F√ºr Feld-Disziplinen: Minimum nicht unter 0
    if (!istZeitDisziplin && minWert < 0) {
        minWert = 0;
    }
    
    console.log('üìä Prognose-Achsen:', {
        alleWerte,
        minWert,
        maxWert,
        istZeitDisziplin
    });
    
    prognoseChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: istJahresPrognose ? 'year' : 'month',
                        displayFormats: { 
                            month: 'MMM yyyy',
                            year: 'yyyy'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Datum',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                y: {
                    type: 'linear',
                    reverse: istZeitDisziplin,
                    min: minWert,
                    max: maxWert,
                    afterBuildTicks: function(axis) {
                        const schoeneLeistungen = generiereSchoeneLeistungen(minWert, maxWert, disziplin, 8);
                        axis.ticks = schoeneLeistungen.map(leistung => ({
                            value: leistung
                        }));
                    },
                    title: {
                        display: true,
                        text: disziplin,
                        font: { size: 14, weight: 'bold' },
                        color: '#667eea'
                    },
                    ticks: {
                        color: '#000',
                        callback: function(value) {
                            return formatiereLeistung(value, disziplin);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].parsed.x ? new Date(context[0].parsed.x).toLocaleDateString('de-DE') : '';
                        },
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const leistung = context.parsed.y;
                            return label + ': ' + formatiereLeistung(leistung, disziplin);
                        }
                    }
                }
            }
        }
    });
    
    // Button-Sichtbarkeit aktualisieren
    document.getElementById('prognoseDiagrammAnzeigenBtn').style.display = 'none';
    document.getElementById('prognoseDiagrammAktualisierenBtn').style.display = 'inline-block';
    document.getElementById('prognoseDiagrammSchlie√üenBtn').style.display = 'inline-block';
    document.getElementById('prognoseDiagrammAusklappenBtn').style.display = 'none';
}

function berechneZeitbasiertenTrend(daten, istZeitDisziplin) {
    // Lineare Regression: y = mx + b
    // x = Tage seit erstem Datenpunkt, y = Leistung
    const erstesDatum = daten[0].datum.getTime();
    const n = daten.length;
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    
    daten.forEach(d => {
        const x = (d.datum.getTime() - erstesDatum) / (1000 * 60 * 60 * 24); // Tage
        const y = d.leistung;
        
        sumX += x;
        sumY += y;
        sumXY += x * y;
        sumX2 += x * x;
    });
    
    // Berechne Steigung und Achsenabschnitt
    const steigung = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const achsenabschnitt = (sumY - steigung * sumX) / n;
    
    return { steigung, achsenabschnitt };
}



function getEinheit(disziplin) {
    const disziplinLower = disziplin.toLowerCase();
    if (disziplinLower.includes('sprung') || disziplinLower.includes('wurf') || disziplinLower.includes('sto√ü')) {
        return 'm';
    } else if (disziplinLower.includes('kampf')) {
        return 'Pkt.';
    } else {
        return 's';
    }
}

function schlie√üePrognoseDiagramm() {
    document.getElementById('prognoseDiagrammContainer').style.display = 'none';
    document.getElementById('prognoseDiagrammAnzeigenBtn').style.display = 'none';
    document.getElementById('prognoseDiagrammAktualisierenBtn').style.display = 'none';
    document.getElementById('prognoseDiagrammSchlie√üenBtn').style.display = 'none';
    document.getElementById('prognoseDiagrammAusklappenBtn').style.display = 'inline-block';
}

function klappeAusPrognoseDiagramm() {
    document.getElementById('prognoseDiagrammContainer').style.display = 'block';
    document.getElementById('prognoseDiagrammAktualisierenBtn').style.display = 'inline-block';
    document.getElementById('prognoseDiagrammSchlie√üenBtn').style.display = 'inline-block';
    document.getElementById('prognoseDiagrammAusklappenBtn').style.display = 'none';
}


function statistikFilterZuruecksetzen() {
    document.getElementById('statistikFilterDisziplin').value = '';
    document.getElementById('statistikFilterZeitraum').value = '';
    document.getElementById('statistikFilterOrt').value = '';
    document.getElementById('statistikFilterWK').value = '';
    document.getElementById('statistikFilterAK').value = '';
    document.getElementById('statistikFilterTyp').value = '';
    document.getElementById('statistikFilterMS').value = '';
    document.getElementById('statistikFilterVon').value = '';
    document.getElementById('statistikFilterBis').value = '';
    document.getElementById('statistikCustomDateRange').style.display = 'none';
}

function bestleistungenFilterZuruecksetzen() {
    document.getElementById('bestleistungenFilterOrt').value = '';
    document.getElementById('bestleistungenFilterDisziplin').value = '';
    document.getElementById('bestleistungenFilterWK').value = '';
    document.getElementById('bestleistungenFilterAK').value = '';
    document.getElementById('bestleistungenFilterTyp').value = '';
    document.getElementById('bestleistungenFilterMS').value = '';
    document.getElementById('bestleistungenFilterZeitraum').value = '';
    document.getElementById('bestleistungenFilterVon').value = '';
    document.getElementById('bestleistungenFilterBis').value = '';
    document.getElementById('bestleistungenCustomDateRange').style.display = 'none';
}

/* ================= WETTKAMPFORTE KARTE ================= */

// Koordinaten deutscher St√§dte in Lon/Lat (werden durch lonLatToSVG konvertiert)
// Format: { stadtname: { lon: L√§ngengrad, lat: Breitengrad } }
const stadtKoordinaten = {
  'Aachen': { lon: 6.0838, lat: 50.7753 },
  'Annaberg-Buchholz': { lon: 13.0050, lat: 50.5814 },
  'Aue': { lon: 12.7000, lat: 50.5833 },
  'Augsburg': { lon: 10.8978, lat: 48.3705 },
  'Bad Blankenburg': { lon: 11.2667, lat: 50.6833 },
  'Bad D√ºben': { lon: 12.5833, lat: 51.5833 },
  'Bad Lausick': { lon: 12.6500, lat: 51.1500 },
  'Bad Salzungen': { lon: 10.2333, lat: 50.8167 },
  'Bamberg': { lon: 10.8900, lat: 49.8917 },
  'Bautzen': { lon: 14.4242, lat: 51.1806 },
  'Bayreuth': { lon: 11.5781, lat: 49.9480 },
  'Bergisch Gladbach': { lon: 7.1394, lat: 50.9918 },
  'Berlin': { lon: 13.4050, lat: 52.5200 },
  'Bielefeld': { lon: 8.5300, lat: 52.0167 },
  'Bischofswerda': { lon: 14.1789, lat: 51.1283 },
  'Bochum': { lon: 7.2167, lat: 51.4819 },
  'Bonn': { lon: 7.0982, lat: 50.7374 },
  'Borna': { lon: 12.4967, lat: 51.1236 },
  'Bottrop': { lon: 6.9289, lat: 51.5244 },
  'Brandenburg': { lon: 12.5500, lat: 52.4125 },
  'Braunschweig': { lon: 10.5267, lat: 52.2689 },
  'Bremen': { lon: 8.8017, lat: 53.0793 },
  'Bremerhaven': { lon: 8.5809, lat: 53.5396 },
  'Burgst√§dt': { lon: 12.8167, lat: 50.9167 },
  'Chemnitz': { lon: 12.9252, lat: 50.8279 },
  'Coburg': { lon: 10.9647, lat: 50.2597 },
  'Coswig': { lon: 13.5750, lat: 51.1286 },
  'Cottbus': { lon: 14.3333, lat: 51.7606 },
  'Crimmitschau': { lon: 12.3892, lat: 50.8186 },
  'Darmstadt': { lon: 8.6511, lat: 49.8728 },
  'Delitzsch': { lon: 12.3333, lat: 51.5167 },
  'Dessau': { lon: 12.2333, lat: 51.8333 },
  'Dippoldiswalde': { lon: 13.6667, lat: 50.8833 },
  'Dortmund': { lon: 7.4653, lat: 51.5136 },
  'Dresden': { lon: 13.7372, lat: 51.0504 },
  'Duisburg': { lon: 6.7623, lat: 51.4344 },
  'D√∂beln': { lon: 13.1167, lat: 51.1167 },
  'D√ºsseldorf': { lon: 6.7735, lat: 51.2277 },
  'Ebersbach': { lon: 14.6000, lat: 51.0167 },
  'Ebersbach-Neugersdorf': { lon: 14.6000, lat: 51.0167 },
  'Eilenburg': { lon: 12.6333, lat: 51.4600 },
  'Eisenach': { lon: 10.3200, lat: 50.9806 },
  'Eisleben': { lon: 11.5500, lat: 51.5167 },
  'Erfurt': { lon: 11.0297, lat: 50.9848 },
  'Erlangen': { lon: 11.0046, lat: 49.5897 },
  'Essen': { lon: 7.0116, lat: 51.4556 },
  'Fl√∂ha': { lon: 13.0667, lat: 50.8500 },
  'Frankfurt': { lon: 8.6821, lat: 50.1109 },
  'Frankfurt (Oder)': { lon: 14.5500, lat: 52.3406 },
  'Freiberg': { lon: 13.3414, lat: 50.9147 },
  'Freiburg': { lon: 7.8421, lat: 47.9990 },
  'Freital': { lon: 13.6500, lat: 51.0167 },
  'Frohburg': { lon: 12.5500, lat: 51.0500 },
  'F√ºrth': { lon: 10.9889, lat: 49.4778 },
  'Gera': { lon: 12.0833, lat: 50.8833 },
  'Geringswalde': { lon: 12.9667, lat: 51.0667 },
  'Gelsenkirchen': { lon: 7.0857, lat: 51.5103 },
  'Glauchau': { lon: 12.5333, lat: 50.8167 },
  'Gotha': { lon: 10.7017, lat: 50.9478 },
  'Grimma': { lon: 12.7247, lat: 51.2344 },
  'Gro√üenhain': { lon: 13.5500, lat: 51.2833 },
  'Grossenhain': { lon: 13.5500, lat: 51.2833 },
  'Gro√ür√∂hrsdorf': { lon: 14.0167, lat: 51.1333 },
  'Grossroehrsdorf': { lon: 14.0167, lat: 51.1333 },
  'G√∂rlitz': { lon: 14.9872, lat: 51.1514 },
  'G√∂ttingen': { lon: 9.9167, lat: 51.5350 },
  'Hagen': { lon: 7.4639, lat: 51.3578 },
  'Halle': { lon: 11.9689, lat: 51.4826 },
  'Haldensleben': { lon: 11.4167, lat: 52.2833 },
  'Hamburg': { lon: 9.9937, lat: 53.5511 },
  'Hamm': { lon: 7.8203, lat: 51.6739 },
  'Hannover': { lon: 9.7320, lat: 52.3759 },
  'Heidenau': { lon: 13.8667, lat: 50.9833 },
  'Heidelberg': { lon: 8.6942, lat: 49.3988 },
  'Heilbronn': { lon: 9.2200, lat: 49.1427 },
  'Herne': { lon: 7.2261, lat: 51.5386 },
  'Hildburghausen': { lon: 10.7333, lat: 50.4167 },
  'Hildesheim': { lon: 9.9514, lat: 52.1500 },
  'Hohenstein-Ernstthal': { lon: 12.7167, lat: 50.8000 },
  'Hoyerswerda': { lon: 14.2539, lat: 51.4381 },
  'Jena': { lon: 11.5892, lat: 50.9278 },
  'Ingolstadt': { lon: 11.4250, lat: 48.7633 },
  'Ilmenau': { lon: 10.9167, lat: 50.6833 },
  'Kamenz': { lon: 14.0994, lat: 51.2689 },
  'Karlsruhe': { lon: 8.4037, lat: 49.0069 },
  'Kassel': { lon: 9.4797, lat: 51.3127 },
  'Kiel': { lon: 10.1228, lat: 54.3233 },
  'Klingenthal': { lon: 12.4667, lat: 50.3667 },
  'Koblenz': { lon: 7.5886, lat: 50.3569 },
  'Krefeld': { lon: 6.5853, lat: 51.3388 },
  'K√∂ln': { lon: 6.9603, lat: 50.9375 },
  'Langenfeld': { lon: 6.9500, lat: 51.1167 },
  'Langenwetzendorf': { lon: 12.1833, lat: 50.7333 },
  'Leipzig': { lon: 12.3731, lat: 51.3397 },
  'Leverkusen': { lon: 6.9887, lat: 51.0458 },
  'Lichtenstein': { lon: 12.6167, lat: 50.7500 },
  'Limbach-Oberfrohna': { lon: 12.7667, lat: 50.8583 },
  'Ludwigshafen': { lon: 8.4411, lat: 49.4775 },
  'Lugau': { lon: 12.7500, lat: 50.7667 },
  'L√∂bau': { lon: 14.6683, lat: 51.1003 },
  'L√ºbeck': { lon: 10.6865, lat: 53.8655 },
  'Magdeburg': { lon: 11.6276, lat: 52.1205 },
  'Mainz': { lon: 8.2473, lat: 50.0000 },
  'Mannheim': { lon: 8.4660, lat: 49.4875 },
  'Marienberg': { lon: 13.1650, lat: 50.6500 },
  'Markkleeberg': { lon: 12.3833, lat: 51.2833 },
  'Meerane': { lon: 12.4667, lat: 50.8500 },
  'Meiningen': { lon: 10.4167, lat: 50.5667 },
  'Mei√üen': { lon: 13.4717, lat: 51.1636 },
  'Meuselwitz': { lon: 12.3000, lat: 51.0667 },
  'Mittweida': { lon: 12.9833, lat: 50.9833 },
  'Moers': { lon: 6.6267, lat: 51.4511 },
  'Muelsen': { lon: 12.5167, lat: 50.7333 },
  'M√ºlheim': { lon: 6.8825, lat: 51.4272 },
  'M√ºnchen': { lon: 11.5820, lat: 48.1351 },
  'M√ºnster': { lon: 7.6261, lat: 51.9607 },
  'Neugersdorf': { lon: 14.6167, lat: 51.0167 },
  'Neuss': { lon: 6.6850, lat: 51.1986 },
  'Niesky': { lon: 14.8167, lat: 51.2936 },
  'Nordhausen': { lon: 10.7917, lat: 51.5042 },
  'N√ºrnberg': { lon: 11.0767, lat: 49.4521 },
  'Oberhausen': { lon: 6.8515, lat: 51.4697 },
  'Oberlungwitz': { lon: 12.7500, lat: 50.8167 },
  'Offenbach': { lon: 8.7667, lat: 50.1000 },
  'Oldenburg': { lon: 8.2144, lat: 53.1435 },
  'Oschatz': { lon: 13.1000, lat: 51.3000 },
  'Osnabr√ºck': { lon: 8.0472, lat: 52.2799 },
  'Paderborn': { lon: 8.7544, lat: 51.7189 },
  'Penig': { lon: 12.7000, lat: 50.9333 },
  'Pforzheim': { lon: 8.7044, lat: 48.8922 },
  'Pirna': { lon: 13.9389, lat: 50.9606 },
  'Plauen': { lon: 12.1372, lat: 50.4950 },
  'Potsdam': { lon: 13.0591, lat: 52.3906 },
  'Pulsnitz': { lon: 14.0167, lat: 51.1833 },
  'Radebeul': { lon: 13.6500, lat: 51.1000 },
  'Radeberg': { lon: 13.9167, lat: 51.1167 },
  'Recklinghausen': { lon: 7.1972, lat: 51.6136 },
  'Regensburg': { lon: 12.0974, lat: 49.0134 },
  'Reichenbach': { lon: 12.3036, lat: 50.6214 },
  'Remscheid': { lon: 7.1897, lat: 51.1789 },
  'Reutlingen': { lon: 9.2044, lat: 48.4914 },
  'Riesa': { lon: 13.2944, lat: 51.3069 },
  'Rochlitz': { lon: 12.7833, lat: 51.0500 },
  'Rostock': { lon: 12.1404, lat: 54.0887 },
  'Saalfeld': { lon: 11.3667, lat: 50.6500 },
  'Sangerhausen': { lon: 11.3000, lat: 51.4667 },
  'Schkeuditz': { lon: 12.2167, lat: 51.4000 },
  'Schwarzenberg': { lon: 12.7833, lat: 50.5333 },
  'Schwerin': { lon: 11.4017, lat: 53.6355 },
  'Senftenberg': { lon: 14.0167, lat: 51.5167 },
  'Solingen': { lon: 7.0833, lat: 51.1700 },
  'Stollberg': { lon: 12.7667, lat: 50.7000 },
  'Stuttgart': { lon: 9.1829, lat: 48.7758 },
  'Suhl': { lon: 10.6931, lat: 50.6086 },
  'Torgau': { lon: 13.0056, lat: 51.5600 },
  'Treuen': { lon: 12.3000, lat: 50.5333 },
  'Ulm': { lon: 9.9917, lat: 48.3984 },
  'Weimar': { lon: 11.3297, lat: 50.9794 },
  'Wei√üwasser': { lon: 14.6333, lat: 51.5000 },
  'Werdau': { lon: 12.3833, lat: 50.7333 },
  'Wiesbaden': { lon: 8.2397, lat: 50.0782 },
  'Wilkau-Ha√ülau': { lon: 12.5000, lat: 50.6833 },
  'Wolfsburg': { lon: 10.7875, lat: 52.4227 },
  'Wuppertal': { lon: 7.1846, lat: 51.2562 },
  'Wurzen': { lon: 12.7333, lat: 51.3667 },
  'W√ºrzburg': { lon: 9.9533, lat: 49.7913 },
  'Zeitz': { lon: 12.1333, lat: 51.0500 },
  'Zittau': { lon: 14.8089, lat: 50.8994 },
  'Zschopau': { lon: 13.0667, lat: 50.7500 },
  'Zwickau': { lon: 12.4958, lat: 50.7178 },
  'Markleeberg': { lon: 12.3833, lat: 51.2833 },
  'Neukieritzsch': { lon: 12.4167, lat: 51.1667 },
  'Leinefelde': { lon: 10.3167, lat: 51.3833 },
  'Regis-Breitingen': { lon: 12.3833, lat: 51.1167 },
  'Jueterbog': { lon: 13.0667, lat: 51.9833 },
  'Erding': { lon: 11.9067, lat: 48.3061 },
  'Moenchengladbach': { lon: 6.4333, lat: 51.1833 },
  'Baunatal': { lon: 9.4167, lat: 51.2500 },
  'Torun': { lon: 18.5983, lat: 53.0138 },
  'Lovosice': { lon: 14.0500, lat: 50.5167 },
  'Braga': { lon: -8.4265, lat: 41.5518 },
  'Madrid': { lon: -3.7038, lat: 40.4168 },
  'Tampere': { lon: 23.7610, lat: 61.4978 },
  'Pescara': { lon: 14.2158, lat: 42.4584 }
};

const borderData = {"DE-BW": {"name": "Baden-W√ºrttemberg", "parts": [[{"lon": 9.65046024322521, "lat": 49.7763404846192}, {"lon": 9.63746929168707, "lat": 49.6904220581056}, {"lon": 9.67188930511497, "lat": 49.6831817626954}, {"lon": 9.71578884124762, "lat": 49.7244491577148}, {"lon": 9.73471069335966, "lat": 49.6836013793946}, {"lon": 9.79583930969233, "lat": 49.7249794006348}, {"lon": 9.83686828613281, "lat": 49.6992492675781}, {"lon": 9.83308029174799, "lat": 49.6509017944338}, {"lon": 9.88053894042969, "lat": 49.6030616760254}, {"lon": 9.8255796432498, "lat": 49.5506591796876}, {"lon": 9.86581993103027, "lat": 49.5399398803712}, {"lon": 9.92124938964872, "lat": 49.5811805725098}, {"lon": 9.90511894226097, "lat": 49.5551109313966}, {"lon": 9.93358993530285, "lat": 49.5553703308105}, {"lon": 9.94201946258545, "lat": 49.4778099060061}, {"lon": 10.0216703414918, "lat": 49.4785690307617}, {"lon": 10.0708284378052, "lat": 49.5417518615724}, {"lon": 10.0891504287721, "lat": 49.5049896240237}, {"lon": 10.1290397644044, "lat": 49.5053100585938}, {"lon": 10.1025485992431, "lat": 49.442440032959}, {"lon": 10.1724386215213, "lat": 49.391529083252}, {"lon": 10.11593914032, "lat": 49.3762817382814}, {"lon": 10.1338491439822, "lat": 49.3470115661622}, {"lon": 10.111349105835, "lat": 49.335762023926}, {"lon": 10.1515302658082, "lat": 49.3251190185547}, {"lon": 10.1626691818239, "lat": 49.2792892456055}, {"lon": 10.1190185546876, "lat": 49.254951477051}, {"lon": 10.1419305801392, "lat": 49.2515106201174}, {"lon": 10.1315994262696, "lat": 49.1999702453614}, {"lon": 10.2642698287967, "lat": 49.1426200866699}, {"lon": 10.2135591506959, "lat": 49.0980720520022}, {"lon": 10.2595386505129, "lat": 49.0912094116211}, {"lon": 10.2603797912598, "lat": 49.0398902893069}, {"lon": 10.3639802932739, "lat": 49.0299911499023}, {"lon": 10.4669809341434, "lat": 48.9382896423341}, {"lon": 10.4387702941895, "lat": 48.9089889526368}, {"lon": 10.4667186737063, "lat": 48.8939704895022}, {"lon": 10.4383983612061, "lat": 48.8498992919923}, {"lon": 10.4606504440308, "lat": 48.8127593994141}, {"lon": 10.4211196899416, "lat": 48.776191711426}, {"lon": 10.5050697326662, "lat": 48.6903915405274}, {"lon": 10.4205894470215, "lat": 48.6653518676758}, {"lon": 10.448868751526, "lat": 48.6983299255372}, {"lon": 10.4151191711426, "lat": 48.7023620605469}, {"lon": 10.3586006164551, "lat": 48.6585922241212}, {"lon": 10.3474788665772, "lat": 48.6956214904787}, {"lon": 10.2791891098025, "lat": 48.7103996276855}, {"lon": 10.2620086669922, "lat": 48.6699485778808}, {"lon": 10.3301782608033, "lat": 48.6145591735842}, {"lon": 10.3019104003909, "lat": 48.6111488342286}, {"lon": 10.3185195922852, "lat": 48.5297012329102}, {"lon": 10.233570098877, "lat": 48.5194587707519}, {"lon": 10.2449407577516, "lat": 48.5008888244629}, {"lon": 10.1780185699463, "lat": 48.4662704467774}, {"lon": 10.0377902984621, "lat": 48.4633598327638}, {"lon": 10.0438003540039, "lat": 48.4338302612307}, {"lon": 9.97167015075684, "lat": 48.3842201232911}, {"lon": 10.0683403015139, "lat": 48.2855606079102}, {"lon": 10.0863485336306, "lat": 48.1851501464845}, {"lon": 10.1427507400515, "lat": 48.1035804748537}, {"lon": 10.1379194259644, "lat": 48.0213203430176}, {"lon": 10.083058357239, "lat": 47.961009979248}, {"lon": 10.1108999252321, "lat": 47.9388694763183}, {"lon": 10.105770111084, "lat": 47.8827590942383}, {"lon": 10.0782289505007, "lat": 47.8712921142578}, {"lon": 10.1336984634402, "lat": 47.8194389343263}, {"lon": 10.0676698684695, "lat": 47.7889099121094}, {"lon": 10.1172885894775, "lat": 47.7631111145022}, {"lon": 10.1285381317142, "lat": 47.6770401000978}, {"lon": 10.0841302871705, "lat": 47.6763191223147}, {"lon": 10.0730514526368, "lat": 47.638500213623}, {"lon": 10.0240516662598, "lat": 47.6911621093751}, {"lon": 9.96449089050299, "lat": 47.6538085937499}, {"lon": 9.84401988983177, "lat": 47.6790313720703}, {"lon": 9.74668979644798, "lat": 47.6074790954592}, {"lon": 9.56746578216547, "lat": 47.5864715576173}, {"lon": 9.49927425384544, "lat": 47.6525230407716}, {"lon": 9.3151683807373, "lat": 47.6769676208499}, {"lon": 9.0440149307251, "lat": 47.8236885070801}, {"lon": 9.17700290679937, "lat": 47.7377548217775}, {"lon": 9.22113990783703, "lat": 47.6681518554688}, {"lon": 9.16409492492704, "lat": 47.6535835266113}, {"lon": 8.99164009094244, "lat": 47.747985839844}, {"lon": 9.01010417938232, "lat": 47.7301635742188}, {"lon": 8.94136524200445, "lat": 47.7318229675295}, {"lon": 9.00636959075928, "lat": 47.6950912475588}, {"lon": 8.89183425903354, "lat": 47.6552238464358}, {"lon": 8.85385227203369, "lat": 47.6837692260744}, {"lon": 8.87410640716581, "lat": 47.7076416015625}, {"lon": 8.80821609497116, "lat": 47.7416801452637}, {"lon": 8.77115821838385, "lat": 47.7197685241699}, {"lon": 8.79814815521246, "lat": 47.6799087524415}, {"lon": 8.72789001464878, "lat": 47.6968421936037}, {"lon": 8.73044586181663, "lat": 47.7661094665529}, {"lon": 8.69027328491211, "lat": 47.7629127502444}, {"lon": 8.65626907348667, "lat": 47.8057861328126}, {"lon": 8.62976264953613, "lat": 47.7659721374514}, {"lon": 8.61983776092529, "lat": 47.8040428161621}, {"lon": 8.56867599487316, "lat": 47.8143997192384}, {"lon": 8.57622814178472, "lat": 47.7890777587891}, {"lon": 8.47270584106451, "lat": 47.7700996398926}, {"lon": 8.40448093414307, "lat": 47.6793937683106}, {"lon": 8.47172641754162, "lat": 47.6434631347657}, {"lon": 8.60148429870611, "lat": 47.6770133972168}, {"lon": 8.62895870208746, "lat": 47.6513519287109}, {"lon": 8.59684658050554, "lat": 47.6471939086914}, {"lon": 8.58468627929688, "lat": 47.6003112792971}, {"lon": 8.52091407775885, "lat": 47.6380958557129}, {"lon": 8.45824337005638, "lat": 47.6053199768068}, {"lon": 8.49561595916759, "lat": 47.5851631164553}, {"lon": 8.43740367889433, "lat": 47.5714073181153}, {"lon": 8.32952022552496, "lat": 47.5749244689944}, {"lon": 8.2908353805542, "lat": 47.6139068603517}, {"lon": 8.20481967926031, "lat": 47.6262741088868}, {"lon": 8.08783435821562, "lat": 47.5628852844239}, {"lon": 7.94407176971435, "lat": 47.5497016906739}, {"lon": 7.89072084426891, "lat": 47.5936355590823}, {"lon": 7.82077217102062, "lat": 47.5946998596194}, {"lon": 7.66949319839506, "lat": 47.5371170043945}, {"lon": 7.63238382339495, "lat": 47.5624237060548}, {"lon": 7.67984914779669, "lat": 47.5709114074708}, {"lon": 7.67056083679211, "lat": 47.5932617187502}, {"lon": 7.60777091979986, "lat": 47.5809593200686}, {"lon": 7.52467393875122, "lat": 47.6601943969727}, {"lon": 7.55772924423229, "lat": 47.8809471130371}, {"lon": 7.62215709686302, "lat": 47.9736595153809}, {"lon": 7.56859016418486, "lat": 48.0363388061526}, {"lon": 7.577859401703, "lat": 48.1213912963868}, {"lon": 7.66615104675321, "lat": 48.2210998535156}, {"lon": 7.69393682479853, "lat": 48.3021202087405}, {"lon": 7.74523162841814, "lat": 48.3298263549806}, {"lon": 7.73354673385631, "lat": 48.3986854553224}, {"lon": 7.80516195297247, "lat": 48.5135002136232}, {"lon": 7.8050093650819, "lat": 48.5931930541992}, {"lon": 7.97024869918835, "lat": 48.7562294006348}, {"lon": 8.08701515197782, "lat": 48.8020133972169}, {"lon": 8.1973962783814, "lat": 48.9571037292483}, {"lon": 8.29529953002935, "lat": 49.0041503906251}, {"lon": 8.36223983764654, "lat": 49.0996894836427}, {"lon": 8.38765907287592, "lat": 49.2344818115236}, {"lon": 8.49136924743652, "lat": 49.3012886047363}, {"lon": 8.4504289627078, "lat": 49.3328514099123}, {"lon": 8.49458980560297, "lat": 49.3602485656738}, {"lon": 8.49897861480741, "lat": 49.3934288024902}, {"lon": 8.46494865417509, "lat": 49.3922004699708}, {"lon": 8.5085897445681, "lat": 49.441478729248}, {"lon": 8.44558811187756, "lat": 49.4502601623535}, {"lon": 8.46752929687494, "lat": 49.4730415344241}, {"lon": 8.41882896423334, "lat": 49.5521888732911}, {"lon": 8.42903900146484, "lat": 49.5856208801271}, {"lon": 8.59151935577415, "lat": 49.524971008301}, {"lon": 8.62510871887201, "lat": 49.5517120361329}, {"lon": 8.60035991668718, "lat": 49.6132316589358}, {"lon": 8.69777870178217, "lat": 49.6272010803224}, {"lon": 8.68175888061552, "lat": 49.5791397094728}, {"lon": 8.7291202545166, "lat": 49.522029876709}, {"lon": 8.90207862854021, "lat": 49.5113410949707}, {"lon": 8.8796501159668, "lat": 49.4744987487793}, {"lon": 8.82772922515892, "lat": 49.4771308898927}, {"lon": 8.83992004394554, "lat": 49.4409599304199}, {"lon": 8.80016899108887, "lat": 49.4182319641113}, {"lon": 8.85784053802496, "lat": 49.4049110412598}, {"lon": 8.95515060424822, "lat": 49.4608688354492}, {"lon": 8.95417976379395, "lat": 49.5120506286621}, {"lon": 9.13329029083263, "lat": 49.5204010009766}, {"lon": 9.09233856201183, "lat": 49.5461387634278}, {"lon": 9.10894870758085, "lat": 49.5830001831057}, {"lon": 9.25874996185325, "lat": 49.5864486694338}, {"lon": 9.31462955474871, "lat": 49.6565589904786}, {"lon": 9.41805934906012, "lat": 49.6452293395998}, {"lon": 9.42761993408209, "lat": 49.7119598388672}, {"lon": 9.39859962463379, "lat": 49.7304916381837}, {"lon": 9.36501026153593, "lat": 49.7045822143556}, {"lon": 9.38728809356695, "lat": 49.726791381836}, {"lon": 9.30702877044683, "lat": 49.7379608154298}, {"lon": 9.33554077148449, "lat": 49.7416305541992}, {"lon": 9.32351970672613, "lat": 49.7675399780273}, {"lon": 9.5102796554566, "lat": 49.7863998413089}, {"lon": 9.57377910614019, "lat": 49.7420997619629}, {"lon": 9.57227897644043, "lat": 49.7793502807618}, {"lon": 9.65046024322521, "lat": 49.7763404846192}], [{"lon": 8.7083730697633, "lat": 47.7155570983887}, {"lon": 8.72245121002237, "lat": 47.6965293884278}, {"lon": 8.66130828857416, "lat": 47.6952133178713}, {"lon": 8.7083730697633, "lat": 47.7155570983887}]]}, "DE-BY": {"name": "Bayern", "parts": [[{"lon": 10.0749607086182, "lat": 50.5423011779787}, {"lon": 10.2043199539185, "lat": 50.5537986755372}, {"lon": 10.2340097427368, "lat": 50.5126991271973}, {"lon": 10.3339891433715, "lat": 50.4940490722656}, {"lon": 10.4050197601318, "lat": 50.4232292175293}, {"lon": 10.3935203552246, "lat": 50.3933410644531}, {"lon": 10.4580583572388, "lat": 50.4009094238282}, {"lon": 10.4936704635622, "lat": 50.3524398803713}, {"lon": 10.6054887771609, "lat": 50.3302421569825}, {"lon": 10.6120214462283, "lat": 50.2255516052247}, {"lon": 10.7230186462405, "lat": 50.1997985839844}, {"lon": 10.734558105469, "lat": 50.2483520507814}, {"lon": 10.8553800582887, "lat": 50.2489891052247}, {"lon": 10.7172508239747, "lat": 50.3229408264161}, {"lon": 10.7222986221316, "lat": 50.3600921630861}, {"lon": 10.8313302993774, "lat": 50.3899612426758}, {"lon": 10.9404602050781, "lat": 50.3902511596681}, {"lon": 10.998330116272, "lat": 50.3422508239747}, {"lon": 10.9981107711792, "lat": 50.3644790649415}, {"lon": 11.044249534607, "lat": 50.3423805236816}, {"lon": 11.1132392883301, "lat": 50.3648986816409}, {"lon": 11.1594104766845, "lat": 50.3279418945312}, {"lon": 11.1423797607421, "lat": 50.287109375}, {"lon": 11.2516689300537, "lat": 50.2651901245117}, {"lon": 11.2819471359253, "lat": 50.3655090332031}, {"lon": 11.2481184005737, "lat": 50.4768905639648}, {"lon": 11.3242597579958, "lat": 50.4883308410647}, {"lon": 11.3480606079102, "lat": 50.5218696594239}, {"lon": 11.4300909042359, "lat": 50.5147209167483}, {"lon": 11.4175081253055, "lat": 50.4514503479004}, {"lon": 11.446418762207, "lat": 50.421760559082}, {"lon": 11.4817886352541, "lat": 50.4330215454102}, {"lon": 11.5220499038699, "lat": 50.3735389709474}, {"lon": 11.5929584503173, "lat": 50.4035301208497}, {"lon": 11.7870292663574, "lat": 50.4226417541504}, {"lon": 11.8271007537844, "lat": 50.3929100036623}, {"lon": 11.9392709732057, "lat": 50.4268798828126}, {"lon": 11.9838867187501, "lat": 50.3934936523439}, {"lon": 11.9813232421877, "lat": 50.3524780273439}, {"lon": 12.1250181198122, "lat": 50.3131561279297}, {"lon": 12.1371698379519, "lat": 50.2821121215821}, {"lon": 12.0858602523804, "lat": 50.2553520202637}, {"lon": 12.1989192962647, "lat": 50.1956214904788}, {"lon": 12.1990604400638, "lat": 50.1118202209475}, {"lon": 12.2612371444704, "lat": 50.0921211242677}, {"lon": 12.2560300827026, "lat": 50.0622787475586}, {"lon": 12.4891490936281, "lat": 49.9863815307618}, {"lon": 12.475679397583, "lat": 49.9400939941407}, {"lon": 12.5477361679077, "lat": 49.9271430969238}, {"lon": 12.5015106201175, "lat": 49.8388404846191}, {"lon": 12.4725999832154, "lat": 49.835819244385}, {"lon": 12.4720726013185, "lat": 49.7902717590333}, {"lon": 12.4028902053832, "lat": 49.7551612854004}, {"lon": 12.4437732696536, "lat": 49.7069473266602}, {"lon": 12.5278596878052, "lat": 49.6877593994142}, {"lon": 12.5253705978396, "lat": 49.632350921631}, {"lon": 12.5648183822635, "lat": 49.6244888305663}, {"lon": 12.5880517959595, "lat": 49.5439987182617}, {"lon": 12.6458301544191, "lat": 49.5310592651367}, {"lon": 12.6328067779542, "lat": 49.4800148010254}, {"lon": 12.6610746383668, "lat": 49.4321670532228}, {"lon": 12.7597303390505, "lat": 49.4002990722657}, {"lon": 12.7841053009035, "lat": 49.3519058227542}, {"lon": 12.952889442444, "lat": 49.3482704162598}, {"lon": 13.0335893630984, "lat": 49.3086395263672}, {"lon": 13.0379295349122, "lat": 49.2677307128909}, {"lon": 13.1804609298705, "lat": 49.1743087768556}, {"lon": 13.1802101135254, "lat": 49.1444396972656}, {"lon": 13.295909881592, "lat": 49.1201820373537}, {"lon": 13.4037294387817, "lat": 49.0517807006837}, {"lon": 13.4238376617433, "lat": 48.971752166748}, {"lon": 13.4965877532958, "lat": 48.9401626586914}, {"lon": 13.5101985931399, "lat": 48.9682006835938}, {"lon": 13.5885057449343, "lat": 48.9686012268068}, {"lon": 13.6713304519653, "lat": 48.8830909729004}, {"lon": 13.7513427734377, "lat": 48.8745155334475}, {"lon": 13.8358602523804, "lat": 48.7714614868165}, {"lon": 13.7870588302612, "lat": 48.7215118408204}, {"lon": 13.8257198333741, "lat": 48.6412200927736}, {"lon": 13.8099441528321, "lat": 48.5909042358398}, {"lon": 13.7400226593019, "lat": 48.5289688110352}, {"lon": 13.5031585693359, "lat": 48.5965118408204}, {"lon": 13.4357490539551, "lat": 48.5646820068362}, {"lon": 13.4545402526857, "lat": 48.5163002014161}, {"lon": 13.4106187820437, "lat": 48.3777389526368}, {"lon": 13.285719871521, "lat": 48.305171966553}, {"lon": 13.0905942916871, "lat": 48.2814445495605}, {"lon": 12.8682146072388, "lat": 48.2036666870118}, {"lon": 12.7530288696291, "lat": 48.1172904968262}, {"lon": 13.0011472702028, "lat": 47.8522300720216}, {"lon": 12.9112672805788, "lat": 47.731243133545}, {"lon": 13.015259742737, "lat": 47.7296791076662}, {"lon": 13.0815553665161, "lat": 47.6913681030276}, {"lon": 13.105588912964, "lat": 47.6392021179202}, {"lon": 13.0478792190552, "lat": 47.5847892761231}, {"lon": 13.0537500381471, "lat": 47.4948616027832}, {"lon": 13.0134639739992, "lat": 47.4657669067383}, {"lon": 12.9698638916016, "lat": 47.4770851135255}, {"lon": 12.7998180389404, "lat": 47.5614624023439}, {"lon": 12.7813129425051, "lat": 47.5815467834473}, {"lon": 12.8266773223877, "lat": 47.6162605285645}, {"lon": 12.7710886001586, "lat": 47.6450500488281}, {"lon": 12.7827720642091, "lat": 47.6759223937989}, {"lon": 12.6053342819214, "lat": 47.6792488098146}, {"lon": 12.5773468017578, "lat": 47.6344757080079}, {"lon": 12.5060644149783, "lat": 47.6288528442383}, {"lon": 12.435962677002, "lat": 47.7007331848147}, {"lon": 12.2587795257568, "lat": 47.6762199401855}, {"lon": 12.2542791366578, "lat": 47.7399902343751}, {"lon": 12.1743516921998, "lat": 47.6988754272463}, {"lon": 12.2092800140382, "lat": 47.6012001037598}, {"lon": 12.016809463501, "lat": 47.6217803955078}, {"lon": 11.8568687438967, "lat": 47.5790519714358}, {"lon": 11.6363439559938, "lat": 47.5982704162598}, {"lon": 11.5810203552246, "lat": 47.5118217468262}, {"lon": 11.4373798370361, "lat": 47.5132598876953}, {"lon": 11.388031959534, "lat": 47.4719238281251}, {"lon": 11.4240808486941, "lat": 47.4456214904785}, {"lon": 11.3416061401369, "lat": 47.4518241882326}, {"lon": 11.2739000320436, "lat": 47.3910102844239}, {"lon": 11.224139213562, "lat": 47.3912696838378}, {"lon": 11.2460584640505, "lat": 47.4347801208496}, {"lon": 10.9775209426879, "lat": 47.3961105346683}, {"lon": 10.9265089035037, "lat": 47.4780807495118}, {"lon": 10.8629989624023, "lat": 47.4780311584475}, {"lon": 10.9185943603516, "lat": 47.5160942077637}, {"lon": 10.8831329345706, "lat": 47.5381050109864}, {"lon": 10.7720251083374, "lat": 47.5161437988281}, {"lon": 10.6000604629517, "lat": 47.5736503601074}, {"lon": 10.5613813400271, "lat": 47.535930633545}, {"lon": 10.4322452545167, "lat": 47.5855598449708}, {"lon": 10.4332342147831, "lat": 47.4976539611818}, {"lon": 10.462830543518, "lat": 47.4872207641604}, {"lon": 10.4715690612795, "lat": 47.4330635070801}, {"lon": 10.4335803985596, "lat": 47.378719329834}, {"lon": 10.3899993896484, "lat": 47.3754386901855}, {"lon": 10.323238372803, "lat": 47.3025894165041}, {"lon": 10.1701688766483, "lat": 47.269901275635}, {"lon": 10.2268695831302, "lat": 47.3929176330567}, {"lon": 10.0959606170654, "lat": 47.3548698425293}, {"lon": 10.0688323974612, "lat": 47.4116592407229}, {"lon": 10.0948190689087, "lat": 47.4184799194336}, {"lon": 10.0907554626466, "lat": 47.4565925598147}, {"lon": 9.99733829498297, "lat": 47.4862251281739}, {"lon": 9.97118663787859, "lat": 47.5504837036135}, {"lon": 9.87366962432867, "lat": 47.5307197570801}, {"lon": 9.81312942504883, "lat": 47.5507469177246}, {"lon": 9.801539421082, "lat": 47.5971603393554}, {"lon": 9.7356328964234, "lat": 47.5413589477541}, {"lon": 9.61636924743658, "lat": 47.5745582580566}, {"lon": 9.65905857086176, "lat": 47.6134719848635}, {"lon": 9.75757026672363, "lat": 47.6113319396974}, {"lon": 9.84401988983194, "lat": 47.6790313720703}, {"lon": 9.96449089050299, "lat": 47.6538085937499}, {"lon": 10.0240516662598, "lat": 47.6911621093751}, {"lon": 10.0730514526368, "lat": 47.638500213623}, {"lon": 10.0841302871705, "lat": 47.6763191223147}, {"lon": 10.1285381317143, "lat": 47.6770401000978}, {"lon": 10.1172885894775, "lat": 47.7631111145022}, {"lon": 10.0676698684697, "lat": 47.7889099121094}, {"lon": 10.1336984634403, "lat": 47.8194389343263}, {"lon": 10.0782289505007, "lat": 47.8712921142578}, {"lon": 10.105770111084, "lat": 47.8827590942383}, {"lon": 10.1108999252321, "lat": 47.9388694763183}, {"lon": 10.083058357239, "lat": 47.961009979248}, {"lon": 10.1379194259644, "lat": 48.0213203430176}, {"lon": 10.1427507400515, "lat": 48.1035804748537}, {"lon": 10.0863485336306, "lat": 48.1851501464845}, {"lon": 10.0683403015139, "lat": 48.2855606079102}, {"lon": 9.97167015075684, "lat": 48.3842201232911}, {"lon": 10.0438003540039, "lat": 48.4338302612307}, {"lon": 10.0377902984621, "lat": 48.4633598327638}, {"lon": 10.1780185699463, "lat": 48.4662704467774}, {"lon": 10.2449407577516, "lat": 48.5008888244629}, {"lon": 10.233570098877, "lat": 48.5194587707519}, {"lon": 10.3185195922852, "lat": 48.5297012329102}, {"lon": 10.3019104003909, "lat": 48.6111488342286}, {"lon": 10.3301782608033, "lat": 48.6145591735842}, {"lon": 10.2620086669922, "lat": 48.6699485778808}, {"lon": 10.2791891098025, "lat": 48.7103996276855}, {"lon": 10.3474788665772, "lat": 48.6956214904787}, {"lon": 10.3586006164551, "lat": 48.6585922241212}, {"lon": 10.4151191711426, "lat": 48.7023620605469}, {"lon": 10.448868751526, "lat": 48.6983299255372}, {"lon": 10.4205894470215, "lat": 48.6653518676758}, {"lon": 10.5050697326662, "lat": 48.6903915405274}, {"lon": 10.4211196899416, "lat": 48.776191711426}, {"lon": 10.4606504440308, "lat": 48.8127593994141}, {"lon": 10.4383983612061, "lat": 48.8498992919923}, {"lon": 10.4667186737063, "lat": 48.8939704895022}, {"lon": 10.4387702941895, "lat": 48.9089889526368}, {"lon": 10.4669809341434, "lat": 48.9382896423341}, {"lon": 10.3639802932739, "lat": 49.0299911499023}, {"lon": 10.2603797912598, "lat": 49.0398902893069}, {"lon": 10.2595386505129, "lat": 49.0912094116211}, {"lon": 10.2135591506959, "lat": 49.0980720520022}, {"lon": 10.2642698287967, "lat": 49.1426200866699}, {"lon": 10.1315994262696, "lat": 49.1999702453614}, {"lon": 10.1419305801392, "lat": 49.2515106201174}, {"lon": 10.1190185546876, "lat": 49.254951477051}, {"lon": 10.1626691818239, "lat": 49.2792892456055}, {"lon": 10.1515302658082, "lat": 49.3251190185547}, {"lon": 10.111349105835, "lat": 49.335762023926}, {"lon": 10.1338491439822, "lat": 49.3470115661622}, {"lon": 10.11593914032, "lat": 49.3762817382814}, {"lon": 10.1724386215213, "lat": 49.391529083252}, {"lon": 10.1025485992431, "lat": 49.442440032959}, {"lon": 10.1290397644044, "lat": 49.5053100585938}, {"lon": 10.0891504287721, "lat": 49.5049896240237}, {"lon": 10.0708284378052, "lat": 49.5417518615724}, {"lon": 10.0216703414918, "lat": 49.4785690307617}, {"lon": 9.95921039581316, "lat": 49.4742813110354}, {"lon": 9.9245786666873, "lat": 49.4887199401857}, {"lon": 9.92124938964872, "lat": 49.5811805725098}, {"lon": 9.86581993103027, "lat": 49.5399398803712}, {"lon": 9.8255796432498, "lat": 49.5506591796876}, {"lon": 9.88039970397978, "lat": 49.6067695617676}, {"lon": 9.8072690963748, "lat": 49.725078582764}, {"lon": 9.74041080474876, "lat": 49.6836318969727}, {"lon": 9.71578884124762, "lat": 49.7244491577148}, {"lon": 9.66048812866228, "lat": 49.6831092834474}, {"lon": 9.63150024414068, "lat": 49.6978416442871}, {"lon": 9.65565872192411, "lat": 49.7875595092773}, {"lon": 9.57227897644043, "lat": 49.7793502807618}, {"lon": 9.57377910614019, "lat": 49.7420997619629}, {"lon": 9.5102796554566, "lat": 49.7863998413089}, {"lon": 9.38025856018083, "lat": 49.7786407470703}, {"lon": 9.30702877044683, "lat": 49.7379608154298}, {"lon": 9.38728809356695, "lat": 49.726791381836}, {"lon": 9.3531990051269, "lat": 49.719409942627}, {"lon": 9.37654018402094, "lat": 49.700870513916}, {"lon": 9.41009998321533, "lat": 49.7267799377443}, {"lon": 9.43382835388206, "lat": 49.6934204101563}, {"lon": 9.41805934906012, "lat": 49.6452293395998}, {"lon": 9.31462955474871, "lat": 49.6565589904786}, {"lon": 9.23588085174555, "lat": 49.5791511535646}, {"lon": 9.12640857696545, "lat": 49.5756912231445}, {"lon": 9.07387065887457, "lat": 49.604850769043}, {"lon": 9.11350917816156, "lat": 49.6455917358399}, {"lon": 9.09529018402122, "lat": 49.6932792663574}, {"lon": 9.16348934173578, "lat": 49.7453804016113}, {"lon": 9.11713981628435, "lat": 49.7597503662109}, {"lon": 9.1452903747558, "lat": 49.7968597412111}, {"lon": 9.10502910614008, "lat": 49.792751312256}, {"lon": 9.10413074493403, "lat": 49.8442993164063}, {"lon": 9.04627990722656, "lat": 49.8471603393555}, {"lon": 9.03188896179216, "lat": 49.9905395507812}, {"lon": 9.06672954559326, "lat": 49.9948387145996}, {"lon": 9.04808044433622, "lat": 50.0424118041992}, {"lon": 8.99512004852323, "lat": 50.0524711608887}, {"lon": 9.03384017944342, "lat": 50.1121101379395}, {"lon": 9.13838768005377, "lat": 50.1251716613772}, {"lon": 9.17316818237322, "lat": 50.1184997558594}, {"lon": 9.16954040527349, "lat": 50.0887718200685}, {"lon": 9.23793029785173, "lat": 50.1492805480958}, {"lon": 9.37734031677246, "lat": 50.1322097778321}, {"lon": 9.41923713684105, "lat": 50.080291748047}, {"lon": 9.51941871643095, "lat": 50.0925102233887}, {"lon": 9.53254032135015, "lat": 50.1673889160157}, {"lon": 9.50391864776628, "lat": 50.1745986938477}, {"lon": 9.50008964538586, "lat": 50.2418785095215}, {"lon": 9.66039943695068, "lat": 50.2319908142092}, {"lon": 9.63669013977056, "lat": 50.246768951416}, {"lon": 9.65283966064476, "lat": 50.2693099975587}, {"lon": 9.74408912658697, "lat": 50.3110504150393}, {"lon": 9.74628925323515, "lat": 50.4164199829101}, {"lon": 9.88270854949951, "lat": 50.398551940918}, {"lon": 9.95875930786144, "lat": 50.4215621948242}, {"lon": 10.0749607086182, "lat": 50.5423011779787}]]}, "DE-BE": {"name": "Berlin", "parts": [[{"lon": 13.1618099212648, "lat": 52.5944213867187}, {"lon": 13.2162094116212, "lat": 52.5825195312501}, {"lon": 13.2302389144898, "lat": 52.6268119812012}, {"lon": 13.2727384567262, "lat": 52.6224899291992}, {"lon": 13.2863397598267, "lat": 52.6556587219239}, {"lon": 13.3701992034913, "lat": 52.6210594177246}, {"lon": 13.474988937378, "lat": 52.649169921875}, {"lon": 13.4572296142579, "lat": 52.6605491638184}, {"lon": 13.482250213623, "lat": 52.6750221252441}, {"lon": 13.5293893814087, "lat": 52.6409492492676}, {"lon": 13.5148601531984, "lat": 52.5892715454101}, {"lon": 13.6638107299805, "lat": 52.5277099609375}, {"lon": 13.6186199188234, "lat": 52.4690895080567}, {"lon": 13.7684087753295, "lat": 52.4371109008789}, {"lon": 13.6609592437744, "lat": 52.338722229004}, {"lon": 13.6506099700928, "lat": 52.3759422302246}, {"lon": 13.4878196716309, "lat": 52.3932418823242}, {"lon": 13.476848602295, "lat": 52.4193496704102}, {"lon": 13.4278287887574, "lat": 52.4089622497559}, {"lon": 13.4324283599854, "lat": 52.3755416870118}, {"lon": 13.2520475387573, "lat": 52.4189109802246}, {"lon": 13.1412887573242, "lat": 52.3871307373047}, {"lon": 13.0938186645508, "lat": 52.4174385070801}, {"lon": 13.1764793395996, "lat": 52.505241394043}, {"lon": 13.1222696304321, "lat": 52.5208320617677}, {"lon": 13.1618099212648, "lat": 52.5944213867187}]]}, "DE-BB": {"name": "Brandenburg", "parts": [[{"lon": 13.8795080184937, "lat": 53.5010681152344}, {"lon": 13.917368888855, "lat": 53.4205398559572}, {"lon": 14.2404088974, "lat": 53.4284515380861}, {"lon": 14.2356176376343, "lat": 53.3694801330566}, {"lon": 14.1000900268556, "lat": 53.2614212036132}, {"lon": 14.2583303451539, "lat": 53.2582511901858}, {"lon": 14.3198795318603, "lat": 53.3126220703126}, {"lon": 14.4202489852906, "lat": 53.3256301879883}, {"lon": 14.4489297866822, "lat": 53.2616386413575}, {"lon": 14.3671407699587, "lat": 53.1803321838379}, {"lon": 14.3881216049196, "lat": 53.1362915039062}, {"lon": 14.3660898208618, "lat": 53.0764770507813}, {"lon": 14.1424522399905, "lat": 52.9611129760744}, {"lon": 14.1558904647828, "lat": 52.8795585632325}, {"lon": 14.1212701797488, "lat": 52.8402709960937}, {"lon": 14.3413839340212, "lat": 52.7592697143555}, {"lon": 14.4662046432495, "lat": 52.6572570800782}, {"lon": 14.6390619277955, "lat": 52.580032348633}, {"lon": 14.6006040573121, "lat": 52.5330238342286}, {"lon": 14.6312494277955, "lat": 52.4991302490235}, {"lon": 14.5289087295532, "lat": 52.396411895752}, {"lon": 14.5843505859378, "lat": 52.3110580444337}, {"lon": 14.5708999633789, "lat": 52.2895622253418}, {"lon": 14.699570655823, "lat": 52.2410888671877}, {"lon": 14.6693487167359, "lat": 52.121551513672}, {"lon": 14.7412786483765, "lat": 52.0733909606935}, {"lon": 14.6805400848389, "lat": 51.9052009582519}, {"lon": 14.5850334167482, "lat": 51.8370666503906}, {"lon": 14.7387285232545, "lat": 51.6668701171874}, {"lon": 14.7398290634157, "lat": 51.6035003662111}, {"lon": 14.6850299835207, "lat": 51.5994300842288}, {"lon": 14.6653785705568, "lat": 51.5507888793946}, {"lon": 14.570050239563, "lat": 51.5724220275879}, {"lon": 14.3419990539551, "lat": 51.5008201599124}, {"lon": 14.1536397933963, "lat": 51.545051574707}, {"lon": 14.0916795730593, "lat": 51.4964790344238}, {"lon": 14.1072797775269, "lat": 51.4802513122559}, {"lon": 14.049810409546, "lat": 51.4803619384766}, {"lon": 14.0804586410524, "lat": 51.4477386474609}, {"lon": 14.0152101516724, "lat": 51.3743019104006}, {"lon": 13.9715986251832, "lat": 51.3989105224609}, {"lon": 13.7792806625366, "lat": 51.3617820739747}, {"lon": 13.5601491928102, "lat": 51.3698806762698}, {"lon": 13.4215087890627, "lat": 51.4539604187012}, {"lon": 13.3961191177369, "lat": 51.4247398376464}, {"lon": 13.3370780944824, "lat": 51.4405097961427}, {"lon": 13.2866392135621, "lat": 51.3857917785646}, {"lon": 13.2333593368531, "lat": 51.3977584838867}, {"lon": 13.2228803634646, "lat": 51.4311904907227}, {"lon": 13.1927785873415, "lat": 51.4279518127443}, {"lon": 13.226088523865, "lat": 51.5050621032715}, {"lon": 13.2043209075931, "lat": 51.5571289062501}, {"lon": 13.0637302398683, "lat": 51.6478996276855}, {"lon": 13.1989307403564, "lat": 51.7162094116212}, {"lon": 13.1379089355469, "lat": 51.8465499877929}, {"lon": 13.163080215454, "lat": 51.8721008300781}, {"lon": 13.0482692718506, "lat": 51.8700103759765}, {"lon": 13.0554504394531, "lat": 51.8995094299316}, {"lon": 12.9829692840576, "lat": 51.9005317687991}, {"lon": 12.9721393585206, "lat": 51.9339714050294}, {"lon": 12.8631801605226, "lat": 51.9317588806154}, {"lon": 12.8583297729494, "lat": 51.9651298522949}, {"lon": 12.7975797653199, "lat": 51.9585418701172}, {"lon": 12.6841793060303, "lat": 52.0081214904786}, {"lon": 12.549958229065, "lat": 51.9802322387698}, {"lon": 12.4788084030151, "lat": 52.0328903198242}, {"lon": 12.4358282089236, "lat": 52.0149116516113}, {"lon": 12.2213087081909, "lat": 52.1652984619141}, {"lon": 12.3018703460693, "lat": 52.2199516296387}, {"lon": 12.2539691925049, "lat": 52.2500801086426}, {"lon": 12.3174085617067, "lat": 52.3419609069827}, {"lon": 12.2934303283691, "lat": 52.3570404052735}, {"lon": 12.312949180603, "lat": 52.4012794494632}, {"lon": 12.2827301025391, "lat": 52.4127197265626}, {"lon": 12.3394298553467, "lat": 52.4751014709474}, {"lon": 12.2428398132324, "lat": 52.5206108093264}, {"lon": 12.2053689956664, "lat": 52.4913520812988}, {"lon": 12.1750793457031, "lat": 52.5027809143066}, {"lon": 12.1940994262695, "lat": 52.5285415649415}, {"lon": 12.1510887145996, "lat": 52.5215606689453}, {"lon": 12.189039230347, "lat": 52.5693702697754}, {"lon": 12.178129196167, "lat": 52.6213989257813}, {"lon": 12.2456092834473, "lat": 52.6244087219239}, {"lon": 12.241068840027, "lat": 52.6838111877441}, {"lon": 12.2049608230591, "lat": 52.7101593017579}, {"lon": 12.2187995910644, "lat": 52.769401550293}, {"lon": 12.2623786926272, "lat": 52.7912216186525}, {"lon": 12.2395200729373, "lat": 52.8545913696289}, {"lon": 11.8466596603393, "lat": 52.9029808044435}, {"lon": 11.8285388946535, "lat": 52.9217300415039}, {"lon": 11.8537302017212, "lat": 52.9475288391114}, {"lon": 11.6936893463136, "lat": 52.9749603271484}, {"lon": 11.6880102157596, "lat": 53.0047798156738}, {"lon": 11.6323900222781, "lat": 53.0089721679688}, {"lon": 11.6390380859376, "lat": 53.0386886596681}, {"lon": 11.5213708877565, "lat": 53.0433692932129}, {"lon": 11.4596996307374, "lat": 53.0773620605468}, {"lon": 11.3476686477662, "lat": 53.0521621704104}, {"lon": 11.273380279541, "lat": 53.1011505126954}, {"lon": 11.3978481292725, "lat": 53.1076316833496}, {"lon": 11.3981103897095, "lat": 53.1374320983887}, {"lon": 11.5409507751467, "lat": 53.1213912963868}, {"lon": 11.5787391662598, "lat": 53.1620521545412}, {"lon": 11.5669193267823, "lat": 53.2105712890626}, {"lon": 11.6357698440553, "lat": 53.2398109436035}, {"lon": 11.8343992233279, "lat": 53.2231216430664}, {"lon": 11.8038291931152, "lat": 53.2494888305665}, {"lon": 12.0284099578858, "lat": 53.2994995117188}, {"lon": 12.0548000335694, "lat": 53.3663520812989}, {"lon": 12.1719999313357, "lat": 53.3352813720705}, {"lon": 12.2345104217531, "lat": 53.3532485961915}, {"lon": 12.2645902633667, "lat": 53.3193588256837}, {"lon": 12.4002895355225, "lat": 53.2991600036622}, {"lon": 12.4481792449951, "lat": 53.2464408874511}, {"lon": 12.6708602905274, "lat": 53.2510719299318}, {"lon": 12.6761198043826, "lat": 53.2249488830566}, {"lon": 12.762390136719, "lat": 53.2200813293458}, {"lon": 12.7429485321048, "lat": 53.1943016052247}, {"lon": 12.7672080993652, "lat": 53.1828117370606}, {"lon": 12.9773807525637, "lat": 53.1947402954102}, {"lon": 12.9455394744872, "lat": 53.1691818237305}, {"lon": 12.9820508956912, "lat": 53.1575012207031}, {"lon": 13.1210393905639, "lat": 53.2372016906741}, {"lon": 13.1831893920899, "lat": 53.2473907470704}, {"lon": 13.2310209274294, "lat": 53.2132110595705}, {"lon": 13.3018789291384, "lat": 53.2753295898439}, {"lon": 13.4052715301514, "lat": 53.243896484375}, {"lon": 13.4387207031252, "lat": 53.2952880859377}, {"lon": 13.5263061523438, "lat": 53.3161010742189}, {"lon": 13.54931640625, "lat": 53.3972778320312}, {"lon": 13.6240854263307, "lat": 53.4072875976564}, {"lon": 13.7094182968142, "lat": 53.479850769043}, {"lon": 13.8290748596194, "lat": 53.4962615966799}, {"lon": 13.7802743911743, "lat": 53.5120849609375}, {"lon": 13.789619445801, "lat": 53.5562896728515}, {"lon": 13.8180761337283, "lat": 53.5150718688965}, {"lon": 13.8795080184937, "lat": 53.5010681152344}], [{"lon": 13.4822502136232, "lat": 52.6750221252441}, {"lon": 13.457229614258, "lat": 52.6605491638184}, {"lon": 13.4749889373782, "lat": 52.649169921875}, {"lon": 13.3701992034914, "lat": 52.6210594177246}, {"lon": 13.2863397598267, "lat": 52.6556587219241}, {"lon": 13.2727384567264, "lat": 52.6224899291992}, {"lon": 13.23023891449, "lat": 52.6268119812012}, {"lon": 13.2162094116214, "lat": 52.5825195312501}, {"lon": 13.1369905471803, "lat": 52.5836486816409}, {"lon": 13.1606092453004, "lat": 52.5647811889649}, {"lon": 13.1222696304323, "lat": 52.5208320617677}, {"lon": 13.1764793395996, "lat": 52.505241394043}, {"lon": 13.0994596481323, "lat": 52.40625}, {"lon": 13.1412887573242, "lat": 52.3871307373047}, {"lon": 13.3065700531009, "lat": 52.414421081543}, {"lon": 13.4324283599855, "lat": 52.3755416870118}, {"lon": 13.4278287887574, "lat": 52.4089622497559}, {"lon": 13.4768486022952, "lat": 52.4193496704102}, {"lon": 13.4878196716309, "lat": 52.3932418823244}, {"lon": 13.6506099700928, "lat": 52.3759422302246}, {"lon": 13.6609592437744, "lat": 52.338722229004}, {"lon": 13.7424697875978, "lat": 52.4004402160647}, {"lon": 13.7629098892211, "lat": 52.4483184814453}, {"lon": 13.6186199188234, "lat": 52.4690895080567}, {"lon": 13.6638107299805, "lat": 52.5277099609377}, {"lon": 13.5148601531984, "lat": 52.5892715454101}, {"lon": 13.5293893814087, "lat": 52.6409492492676}, {"lon": 13.4822502136232, "lat": 52.6750221252441}]]}, "DE-HB": {"name": "Bremen", "parts": [[{"lon": 8.98544883728033, "lat": 53.1282196044922}, {"lon": 8.94873905181896, "lat": 53.1238021850587}, {"lon": 8.99298858642572, "lat": 53.0984802246095}, {"lon": 8.96262836456299, "lat": 53.0904502868652}, {"lon": 8.98299026489252, "lat": 53.0497398376466}, {"lon": 8.93546962738043, "lat": 53.0152397155763}, {"lon": 8.86642837524425, "lat": 53.0437622070314}, {"lon": 8.81818962097179, "lat": 53.0241203308106}, {"lon": 8.7734308242799, "lat": 53.0567588806153}, {"lon": 8.73129844665527, "lat": 53.037208557129}, {"lon": 8.62583827972412, "lat": 53.1652908325195}, {"lon": 8.48689079284679, "lat": 53.2286415100098}, {"lon": 8.59833812713629, "lat": 53.2168006896973}, {"lon": 8.59381866455078, "lat": 53.1868591308594}, {"lon": 8.82959079742432, "lat": 53.1661987304689}, {"lon": 8.86186981201178, "lat": 53.1370086669923}, {"lon": 8.94713878631592, "lat": 53.1573791503907}, {"lon": 8.98544883728033, "lat": 53.1282196044922}]]}, "DE-HH": {"name": "Hamburg", "parts": [[{"lon": 10.0716171264648, "lat": 53.7182312011718}, {"lon": 10.1985492706299, "lat": 53.7407913208008}, {"lon": 10.1430501937867, "lat": 53.6889610290527}, {"lon": 10.2280588150024, "lat": 53.6338920593262}, {"lon": 10.1545000076293, "lat": 53.556179046631}, {"lon": 10.3312196731568, "lat": 53.4462203979493}, {"lon": 10.2480907440186, "lat": 53.4047203063966}, {"lon": 10.1772603988647, "lat": 53.4079513549805}, {"lon": 10.0536890029907, "lat": 53.4741592407227}, {"lon": 9.9960498809815, "lat": 53.4291000366211}, {"lon": 9.90592765808111, "lat": 53.4247207641602}, {"lon": 9.91827011108404, "lat": 53.4584197998048}, {"lon": 9.8609504699707, "lat": 53.4392890930176}, {"lon": 9.76345062255865, "lat": 53.5169410705566}, {"lon": 9.76863956451422, "lat": 53.5655403137206}, {"lon": 9.7236585617066, "lat": 53.5690002441407}, {"lon": 9.7601890563966, "lat": 53.6391220092773}, {"lon": 9.82556819915771, "lat": 53.5953521728517}, {"lon": 9.90689945220947, "lat": 53.6621818542481}, {"lon": 10.0726785659791, "lat": 53.6887092590333}, {"lon": 10.0716171264648, "lat": 53.7182312011718}]]}, "DE-HE": {"name": "Hessen", "parts": [[{"lon": 9.49876976013178, "lat": 51.631519317627}, {"lon": 9.62797927856451, "lat": 51.6373405456544}, {"lon": 9.68900871276855, "lat": 51.5831222534183}, {"lon": 9.59042072296148, "lat": 51.5228004455566}, {"lon": 9.64471912384033, "lat": 51.4722785949709}, {"lon": 9.64620971679716, "lat": 51.4207687377931}, {"lon": 9.57165908813477, "lat": 51.3931617736817}, {"lon": 9.56183815002458, "lat": 51.3483505249023}, {"lon": 9.73115062713629, "lat": 51.3008193969728}, {"lon": 9.77073860168457, "lat": 51.3425292968752}, {"lon": 9.7361488342288, "lat": 51.323299407959}, {"lon": 9.70588016510033, "lat": 51.3705215454103}, {"lon": 9.81936931610107, "lat": 51.4156112670899}, {"lon": 9.86927986145014, "lat": 51.3754501342773}, {"lon": 9.85617923736595, "lat": 51.4157791137698}, {"lon": 9.9112300872805, "lat": 51.4197502136232}, {"lon": 9.97350883483881, "lat": 51.286190032959}, {"lon": 10.0573406219485, "lat": 51.2782516479494}, {"lon": 10.0758895874026, "lat": 51.2261810302737}, {"lon": 10.2369890213015, "lat": 51.1881484985352}, {"lon": 10.2141771316529, "lat": 51.1178092956544}, {"lon": 10.1721696853638, "lat": 51.1514205932619}, {"lon": 10.1247186660767, "lat": 51.1405715942383}, {"lon": 10.1785497665406, "lat": 51.1180114746094}, {"lon": 10.1496887207034, "lat": 51.0551300048829}, {"lon": 10.2213401794434, "lat": 51.0250701904297}, {"lon": 10.1564807891849, "lat": 50.9957504272462}, {"lon": 10.0429182052612, "lat": 51.0149421691897}, {"lon": 10.0195388793945, "lat": 50.9816589355471}, {"lon": 10.0678701400757, "lat": 50.9480285644531}, {"lon": 9.94838905334501, "lat": 50.9484214782716}, {"lon": 9.94874858856207, "lat": 50.9261589050292}, {"lon": 9.99036979675293, "lat": 50.937240600586}, {"lon": 9.97887897491455, "lat": 50.907600402832}, {"lon": 10.0145292282107, "lat": 50.9223213195804}, {"lon": 10.0629396438598, "lat": 50.8850021362306}, {"lon": 10.0214099884034, "lat": 50.8666801452637}, {"lon": 10.0219593048098, "lat": 50.833309173584}, {"lon": 9.95022964477556, "lat": 50.8223991394042}, {"lon": 9.95666027069086, "lat": 50.7817115783693}, {"lon": 9.92091846466064, "lat": 50.7631988525391}, {"lon": 9.93896007537842, "lat": 50.7374191284179}, {"lon": 9.87310886383057, "lat": 50.6418418884278}, {"lon": 9.94609832763666, "lat": 50.6301002502443}, {"lon": 9.95147037506098, "lat": 50.6709213256836}, {"lon": 10.0489807128909, "lat": 50.6772613525393}, {"lon": 10.0860595703128, "lat": 50.6323814392091}, {"lon": 10.0381708145142, "lat": 50.6139602661134}, {"lon": 10.0630292892457, "lat": 50.5573120117189}, {"lon": 10.0400190353393, "lat": 50.4933319091799}, {"lon": 9.9645681381225, "lat": 50.425350189209}, {"lon": 9.84730911254888, "lat": 50.3982887268067}, {"lon": 9.75783920288109, "lat": 50.4240913391114}, {"lon": 9.7386493682863, "lat": 50.2998008728027}, {"lon": 9.65283966064476, "lat": 50.2693099975587}, {"lon": 9.63669013977056, "lat": 50.246768951416}, {"lon": 9.66039943695068, "lat": 50.2319908142092}, {"lon": 9.50008964538586, "lat": 50.2418785095215}, {"lon": 9.50391864776628, "lat": 50.1745986938477}, {"lon": 9.53254032135015, "lat": 50.1673889160157}, {"lon": 9.51941871643095, "lat": 50.0925102233887}, {"lon": 9.41923713684105, "lat": 50.080291748047}, {"lon": 9.37734031677246, "lat": 50.1322097778321}, {"lon": 9.23793029785173, "lat": 50.1492805480958}, {"lon": 9.16954040527349, "lat": 50.0887718200685}, {"lon": 9.17316818237322, "lat": 50.1184997558594}, {"lon": 9.13838768005377, "lat": 50.1251716613772}, {"lon": 9.01706981658947, "lat": 50.0933685302734}, {"lon": 8.99534988403332, "lat": 50.0451011657716}, {"lon": 9.04808044433622, "lat": 50.0424118041992}, {"lon": 9.06672954559326, "lat": 49.9948387145996}, {"lon": 9.03188896179216, "lat": 49.9905395507812}, {"lon": 9.04627990722656, "lat": 49.8471603393555}, {"lon": 9.10413074493403, "lat": 49.8442993164063}, {"lon": 9.10502910614008, "lat": 49.792751312256}, {"lon": 9.1452903747558, "lat": 49.7968597412111}, {"lon": 9.11713981628435, "lat": 49.7597503662109}, {"lon": 9.16348934173578, "lat": 49.7453804016113}, {"lon": 9.09529018402122, "lat": 49.6932792663574}, {"lon": 9.11350917816156, "lat": 49.6455917358399}, {"lon": 9.07351970672636, "lat": 49.6232299804688}, {"lon": 9.10894870758085, "lat": 49.5830001831057}, {"lon": 9.09233856201183, "lat": 49.5461387634278}, {"lon": 9.13329029083263, "lat": 49.5204010009766}, {"lon": 8.95417976379395, "lat": 49.5120506286621}, {"lon": 8.95515060424839, "lat": 49.4608688354492}, {"lon": 8.81763935089106, "lat": 49.4040908813479}, {"lon": 8.82772922515909, "lat": 49.4771308898927}, {"lon": 8.8796501159668, "lat": 49.4744987487793}, {"lon": 8.90207862854021, "lat": 49.5113410949707}, {"lon": 8.7291202545166, "lat": 49.522029876709}, {"lon": 8.68175888061569, "lat": 49.5791397094728}, {"lon": 8.69777870178217, "lat": 49.6272010803225}, {"lon": 8.60035991668735, "lat": 49.6132316589358}, {"lon": 8.62510871887201, "lat": 49.5517120361329}, {"lon": 8.55720901489303, "lat": 49.523811340332}, {"lon": 8.39341926574707, "lat": 49.6175498962402}, {"lon": 8.36192989349371, "lat": 49.6901702880862}, {"lon": 8.48609066009544, "lat": 49.7677688598633}, {"lon": 8.42842006683367, "lat": 49.7659988403321}, {"lon": 8.38613891601562, "lat": 49.8200302124023}, {"lon": 8.39670085906982, "lat": 49.8498916625978}, {"lon": 8.34934043884283, "lat": 49.8816986083987}, {"lon": 8.34678077697782, "lat": 49.9592895507812}, {"lon": 8.27541923522966, "lat": 50.0164604187014}, {"lon": 8.1879682540893, "lat": 50.0324592590333}, {"lon": 7.88771104812628, "lat": 49.9706687927248}, {"lon": 7.78512001037592, "lat": 50.0531120300294}, {"lon": 7.86995792388927, "lat": 50.1285705566407}, {"lon": 7.94112014770513, "lat": 50.1025085449219}, {"lon": 7.94554996490479, "lat": 50.1401519775393}, {"lon": 7.89757013320917, "lat": 50.1698799133302}, {"lon": 7.91955900192278, "lat": 50.2037086486816}, {"lon": 8.00625991821306, "lat": 50.2345504760744}, {"lon": 8.04792022705095, "lat": 50.2125396728516}, {"lon": 8.07635879516607, "lat": 50.2317314147949}, {"lon": 8.05168056488048, "lat": 50.2688293457031}, {"lon": 8.13891029357922, "lat": 50.2740592956543}, {"lon": 8.08279991149902, "lat": 50.3741607666016}, {"lon": 7.98417997360224, "lat": 50.413600921631}, {"lon": 8.03000831604015, "lat": 50.448181152344}, {"lon": 7.99656009674078, "lat": 50.4847412109375}, {"lon": 8.01100921630865, "lat": 50.5261192321778}, {"lon": 8.05648136138927, "lat": 50.5571784973147}, {"lon": 8.16199970245367, "lat": 50.551280975342}, {"lon": 8.17358875274658, "lat": 50.6002616882325}, {"lon": 8.11874866485624, "lat": 50.6757087707521}, {"lon": 8.17990875244158, "lat": 50.7357597351075}, {"lon": 8.13190937042265, "lat": 50.7918510437013}, {"lon": 8.27567005157476, "lat": 50.8812408447265}, {"lon": 8.38051033020025, "lat": 50.8589515686036}, {"lon": 8.47149085998541, "lat": 50.9115219116212}, {"lon": 8.46796894073515, "lat": 50.963260650635}, {"lon": 8.55467891693132, "lat": 51.0132293701171}, {"lon": 8.51747035980219, "lat": 51.0386619567872}, {"lon": 8.5381507873538, "lat": 51.0951194763185}, {"lon": 8.73456859588651, "lat": 51.1064910888671}, {"lon": 8.70979022979742, "lat": 51.1321296691897}, {"lon": 8.78438186645536, "lat": 51.2045822143556}, {"lon": 8.75220870971697, "lat": 51.259979248047}, {"lon": 8.60167884826677, "lat": 51.2458114624024}, {"lon": 8.5743589401248, "lat": 51.2863807678223}, {"lon": 8.70376014709473, "lat": 51.3748893737794}, {"lon": 8.95757961273216, "lat": 51.3872718811037}, {"lon": 8.96854972839373, "lat": 51.4285392761232}, {"lon": 8.93867015838651, "lat": 51.4279289245607}, {"lon": 8.91246032714872, "lat": 51.4797210693361}, {"lon": 8.99053859710693, "lat": 51.5072898864747}, {"lon": 9.10620021820074, "lat": 51.4982185363771}, {"lon": 9.11385822296137, "lat": 51.4426002502442}, {"lon": 9.22869014740002, "lat": 51.459732055664}, {"lon": 9.37895965576178, "lat": 51.5923614501953}, {"lon": 9.34346961975098, "lat": 51.6137619018557}, {"lon": 9.48608016967779, "lat": 51.657051086426}, {"lon": 9.49876976013178, "lat": 51.631519317627}]]}, "DE-MV": {"name": "Mecklenburg-Vorpommern", "parts": [[{"lon": 12.519721031189, "lat": 54.4843063354494}, {"lon": 12.6552772521977, "lat": 54.442638397217}, {"lon": 12.9624996185304, "lat": 54.4376373291017}, {"lon": 12.8024997711182, "lat": 54.4081954956057}, {"lon": 12.6369438171387, "lat": 54.424861907959}, {"lon": 12.5769433975223, "lat": 54.4034729003907}, {"lon": 12.593056678772, "lat": 54.383472442627}, {"lon": 12.435832977295, "lat": 54.3787498474123}, {"lon": 12.3602771759033, "lat": 54.306251525879}, {"lon": 12.3830547332765, "lat": 54.2793045043946}, {"lon": 12.3636121749878, "lat": 54.2659721374512}, {"lon": 12.4602766036989, "lat": 54.2484741210937}, {"lon": 12.4091672897339, "lat": 54.2798614501955}, {"lon": 12.535278320313, "lat": 54.3387489318849}, {"lon": 12.5530557632447, "lat": 54.3795814514161}, {"lon": 12.5919446945193, "lat": 54.3573608398439}, {"lon": 12.6697216033937, "lat": 54.3906936645508}, {"lon": 12.6574993133548, "lat": 54.4081954956057}, {"lon": 12.715277671814, "lat": 54.4043045043945}, {"lon": 12.7047958504563, "lat": 54.3946839266917}, {"lon": 12.7347230911258, "lat": 54.3706932067871}, {"lon": 12.786945343018, "lat": 54.3962516784668}, {"lon": 12.8102788925171, "lat": 54.3451385498048}, {"lon": 13.0197219848633, "lat": 54.4390258789064}, {"lon": 13.0252790451054, "lat": 54.3965263366704}, {"lon": 13.0936098098759, "lat": 54.3668060302737}, {"lon": 13.0758323669434, "lat": 54.3454170227052}, {"lon": 13.1058330535889, "lat": 54.2818069458009}, {"lon": 13.2863883972168, "lat": 54.2351379394535}, {"lon": 13.3463888168339, "lat": 54.180416107178}, {"lon": 13.3180541992192, "lat": 54.1598625183107}, {"lon": 13.4158344268801, "lat": 54.1751403808596}, {"lon": 13.3824987411504, "lat": 54.1423606872559}, {"lon": 13.4113903045654, "lat": 54.1565284729006}, {"lon": 13.4569454193115, "lat": 54.0906944274902}, {"lon": 13.5008344650269, "lat": 54.0851402282715}, {"lon": 13.4891672134404, "lat": 54.1237487792972}, {"lon": 13.6963891983032, "lat": 54.1718063354494}, {"lon": 13.8069448471073, "lat": 54.1031951904297}, {"lon": 13.7441663742069, "lat": 54.0293045043946}, {"lon": 13.9141674041748, "lat": 53.9223594665532}, {"lon": 13.8247222900392, "lat": 53.8662490844728}, {"lon": 13.9375009536743, "lat": 53.908473968506}, {"lon": 13.9058341979982, "lat": 53.989860534668}, {"lon": 13.9652786254886, "lat": 53.9901390075687}, {"lon": 13.9597215652466, "lat": 53.9340286254885}, {"lon": 13.9836120605469, "lat": 53.9626388549807}, {"lon": 14.0424995422367, "lat": 53.942081451416}, {"lon": 14.0469446182254, "lat": 53.9965286254886}, {"lon": 13.9741668701172, "lat": 54.0637512207034}, {"lon": 13.9108324050903, "lat": 54.0643043518068}, {"lon": 13.9241676330566, "lat": 54.035415649414}, {"lon": 13.8625011444094, "lat": 53.9993057250977}, {"lon": 13.8791656494141, "lat": 54.0401382446294}, {"lon": 13.8580551147462, "lat": 54.0484733581544}, {"lon": 13.7691659927373, "lat": 54.0190277099611}, {"lon": 13.8124990463257, "lat": 54.0990295410159}, {"lon": 13.7491674423219, "lat": 54.1590270996095}, {"lon": 13.8036108016968, "lat": 54.1784706115725}, {"lon": 13.8708343505861, "lat": 54.101528167725}, {"lon": 14.014165878296, "lat": 54.0543060302734}, {"lon": 14.2213897705079, "lat": 53.9301376342773}, {"lon": 14.1863298416142, "lat": 53.915580749512}, {"lon": 14.2173366546632, "lat": 53.865417480469}, {"lon": 14.0386123657227, "lat": 53.8734741210939}, {"lon": 13.8986120224, "lat": 53.8395843505861}, {"lon": 13.8063888549804, "lat": 53.8581962585449}, {"lon": 14.0386123657227, "lat": 53.7551383972167}, {"lon": 14.2825002670288, "lat": 53.7395820617676}, {"lon": 14.2152767181396, "lat": 53.7026405334474}, {"lon": 14.2731628417969, "lat": 53.6993064880371}, {"lon": 14.289348602295, "lat": 53.6337814331056}, {"lon": 14.3249082565308, "lat": 53.618648529053}, {"lon": 14.3027086257935, "lat": 53.5426101684572}, {"lon": 14.3756189346313, "lat": 53.4594497680666}, {"lon": 14.4157657623292, "lat": 53.3297958374026}, {"lon": 14.3198795318603, "lat": 53.3126220703126}, {"lon": 14.2583303451539, "lat": 53.2582511901858}, {"lon": 14.1000900268556, "lat": 53.2614212036132}, {"lon": 14.2356176376343, "lat": 53.3694801330568}, {"lon": 14.2404088974, "lat": 53.4284515380862}, {"lon": 13.917368888855, "lat": 53.4205398559572}, {"lon": 13.8796291351318, "lat": 53.5027313232422}, {"lon": 13.8180761337284, "lat": 53.5150718688967}, {"lon": 13.7896194458011, "lat": 53.5562896728515}, {"lon": 13.7802743911743, "lat": 53.5120849609375}, {"lon": 13.8290748596194, "lat": 53.4962615966799}, {"lon": 13.7094182968142, "lat": 53.479850769043}, {"lon": 13.6240854263307, "lat": 53.4072875976564}, {"lon": 13.54931640625, "lat": 53.3972778320312}, {"lon": 13.5263061523438, "lat": 53.3161010742189}, {"lon": 13.4387207031252, "lat": 53.2952880859377}, {"lon": 13.4052715301514, "lat": 53.243896484375}, {"lon": 13.3018789291384, "lat": 53.2753295898439}, {"lon": 13.2310209274294, "lat": 53.2132110595705}, {"lon": 13.1831893920899, "lat": 53.2473907470704}, {"lon": 13.1210393905639, "lat": 53.2372016906741}, {"lon": 12.9820508956912, "lat": 53.1575012207031}, {"lon": 12.9455394744872, "lat": 53.1691818237305}, {"lon": 12.9773807525637, "lat": 53.1947402954102}, {"lon": 12.7672080993652, "lat": 53.1828117370606}, {"lon": 12.7429485321048, "lat": 53.1943016052247}, {"lon": 12.762390136719, "lat": 53.2200813293458}, {"lon": 12.6761198043826, "lat": 53.2249488830566}, {"lon": 12.6708602905274, "lat": 53.2510719299318}, {"lon": 12.4481792449951, "lat": 53.2464408874511}, {"lon": 12.4002895355225, "lat": 53.2991600036622}, {"lon": 12.2645902633667, "lat": 53.3193588256837}, {"lon": 12.2345104217531, "lat": 53.3532485961915}, {"lon": 12.1719999313357, "lat": 53.3352813720705}, {"lon": 12.0548000335694, "lat": 53.3663520812989}, {"lon": 12.0284099578858, "lat": 53.2994995117188}, {"lon": 11.9532098770143, "lat": 53.266700744629}, {"lon": 11.8974990844726, "lat": 53.2746887207034}, {"lon": 11.8720703125001, "lat": 53.2451210021973}, {"lon": 11.8038291931152, "lat": 53.2494888305665}, {"lon": 11.8343992233279, "lat": 53.2231216430664}, {"lon": 11.7472791671752, "lat": 53.2127494812012}, {"lon": 11.6357698440553, "lat": 53.2398109436035}, {"lon": 11.554379463196, "lat": 53.2032318115236}, {"lon": 11.5787391662598, "lat": 53.1620521545412}, {"lon": 11.5409507751467, "lat": 53.1213912963868}, {"lon": 11.3981103897095, "lat": 53.1374320983887}, {"lon": 11.3854198455813, "lat": 53.1077308654786}, {"lon": 11.1863098144531, "lat": 53.1354217529297}, {"lon": 11.198998451233, "lat": 53.1800422668458}, {"lon": 11.0686893463135, "lat": 53.2298889160157}, {"lon": 10.9940395355227, "lat": 53.3347702026369}, {"lon": 10.9192495346069, "lat": 53.3512115478517}, {"lon": 10.8387489318848, "lat": 53.309181213379}, {"lon": 10.7082586288452, "lat": 53.3793106079102}, {"lon": 10.5974197387698, "lat": 53.373649597168}, {"lon": 10.6393785476686, "lat": 53.4650993347169}, {"lon": 10.8243703842166, "lat": 53.5172805786133}, {"lon": 10.823429107666, "lat": 53.5802803039552}, {"lon": 10.9234104156495, "lat": 53.5853004455569}, {"lon": 10.9469194412232, "lat": 53.6775703430176}, {"lon": 10.7577295303346, "lat": 53.7515792846681}, {"lon": 10.7442083358765, "lat": 53.8405609130862}, {"lon": 10.7679090499878, "lat": 53.8810691833496}, {"lon": 10.8752794265747, "lat": 53.9278411865234}, {"lon": 10.9011287689209, "lat": 53.9012794494629}, {"lon": 10.9637098312379, "lat": 53.9109992980957}, {"lon": 10.8877601623536, "lat": 53.92387008667}, {"lon": 10.894718170166, "lat": 53.9559707641604}, {"lon": 11.1791677474975, "lat": 54.015693664551}, {"lon": 11.2586107254033, "lat": 53.984859466553}, {"lon": 11.2586107254033, "lat": 53.9340286254885}, {"lon": 11.3352766036988, "lat": 53.9584732055666}, {"lon": 11.4547224044802, "lat": 53.900417327881}, {"lon": 11.4836101531982, "lat": 53.9684715270998}, {"lon": 11.4436111450195, "lat": 53.9604148864746}, {"lon": 11.4447212219239, "lat": 53.997081756592}, {"lon": 11.4280557632447, "lat": 53.9609718322754}, {"lon": 11.3880548477174, "lat": 53.9654159545898}, {"lon": 11.3780555725101, "lat": 53.9973602294924}, {"lon": 11.4925012588503, "lat": 54.0229148864747}, {"lon": 11.4674987792969, "lat": 53.9740295410156}, {"lon": 11.4902791976932, "lat": 53.9681930541994}, {"lon": 11.5191669464113, "lat": 54.0320816040041}, {"lon": 11.5725011825563, "lat": 54.0326385498049}, {"lon": 11.6258325576783, "lat": 54.0895843505859}, {"lon": 11.6036090850831, "lat": 54.1026382446291}, {"lon": 11.5325002670292, "lat": 54.0490264892578}, {"lon": 11.5252771377563, "lat": 54.0718040466309}, {"lon": 11.6824989318848, "lat": 54.1531944274902}, {"lon": 11.8536090850831, "lat": 54.1451377868657}, {"lon": 12.0874986648562, "lat": 54.1831932067871}, {"lon": 12.091944694519, "lat": 54.152084350586}, {"lon": 12.1247215271001, "lat": 54.1501388549807}, {"lon": 12.1424989700319, "lat": 54.172359466553}, {"lon": 12.0952777862549, "lat": 54.1809730529786}, {"lon": 12.3391656875614, "lat": 54.297916412354}, {"lon": 12.519721031189, "lat": 54.4843063354494}], [{"lon": 13.4291667938233, "lat": 54.6845817565917}, {"lon": 13.3758325576783, "lat": 54.635139465332}, {"lon": 13.4208335876468, "lat": 54.5779151916508}, {"lon": 13.6797208786011, "lat": 54.5626373291016}, {"lon": 13.6686096191407, "lat": 54.5206947326665}, {"lon": 13.5697212219243, "lat": 54.4618072509768}, {"lon": 13.6097221374516, "lat": 54.4048614501954}, {"lon": 13.6736106872563, "lat": 54.4006958007816}, {"lon": 13.7669439315796, "lat": 54.3415260314944}, {"lon": 13.7169437408448, "lat": 54.3101387023927}, {"lon": 13.7252788543701, "lat": 54.2734718322756}, {"lon": 13.6463890075684, "lat": 54.2965278625491}, {"lon": 13.7041673660281, "lat": 54.3262481689454}, {"lon": 13.6108322143559, "lat": 54.3162498474122}, {"lon": 13.6830558776857, "lat": 54.3493041992188}, {"lon": 13.6136102676392, "lat": 54.3306961059574}, {"lon": 13.5808343887329, "lat": 54.3529167175296}, {"lon": 13.4547233581546, "lat": 54.335693359375}, {"lon": 13.3947219848637, "lat": 54.2712516784669}, {"lon": 13.3524990081788, "lat": 54.269584655762}, {"lon": 13.4180555343628, "lat": 54.2548599243166}, {"lon": 13.3936100006104, "lat": 54.2209739685059}, {"lon": 13.2902793884278, "lat": 54.2512512207034}, {"lon": 13.3213891983036, "lat": 54.2451400756838}, {"lon": 13.3352775573731, "lat": 54.2781944274902}, {"lon": 13.2697229385376, "lat": 54.2537498474121}, {"lon": 13.1997222900391, "lat": 54.2701377868656}, {"lon": 13.1941652297974, "lat": 54.2968063354494}, {"lon": 13.1391668319702, "lat": 54.2823600769043}, {"lon": 13.1847229003911, "lat": 54.3009719848633}, {"lon": 13.1147212982177, "lat": 54.3318061828616}, {"lon": 13.1274995803836, "lat": 54.3712501525879}, {"lon": 13.261943817139, "lat": 54.3829154968264}, {"lon": 13.2113885879521, "lat": 54.4298629760742}, {"lon": 13.1497220993043, "lat": 54.429027557373}, {"lon": 13.2680568695069, "lat": 54.4793052673344}, {"lon": 13.2274999618534, "lat": 54.4859733581546}, {"lon": 13.2302780151368, "lat": 54.5109710693359}, {"lon": 13.1586112976074, "lat": 54.5040283203126}, {"lon": 13.143611907959, "lat": 54.5468063354492}, {"lon": 13.2552776336671, "lat": 54.5520820617676}, {"lon": 13.3052778244023, "lat": 54.5140266418458}, {"lon": 13.2974987030029, "lat": 54.552360534668}, {"lon": 13.3686122894291, "lat": 54.579303741455}, {"lon": 13.3380556106567, "lat": 54.5487518310547}, {"lon": 13.3774986267091, "lat": 54.5590286254883}, {"lon": 13.4130563735966, "lat": 54.4937515258788}, {"lon": 13.5063877105714, "lat": 54.480972290039}, {"lon": 13.5019435882572, "lat": 54.5484733581545}, {"lon": 13.3958320617675, "lat": 54.5729179382326}, {"lon": 13.3702783584599, "lat": 54.6145820617675}, {"lon": 13.2430553436282, "lat": 54.5587501525879}, {"lon": 13.2830562591553, "lat": 54.6462516784667}, {"lon": 13.1608333587651, "lat": 54.5590286254883}, {"lon": 13.2497243881226, "lat": 54.6598625183108}, {"lon": 13.4291667938233, "lat": 54.6845817565917}], [{"lon": 13.1841669082642, "lat": 54.4943046569826}, {"lon": 13.2269439697269, "lat": 54.4687500000001}, {"lon": 13.1208343505864, "lat": 54.4423599243166}, {"lon": 13.1841669082642, "lat": 54.4943046569826}], [{"lon": 13.1363887786866, "lat": 54.6051406860351}, {"lon": 13.158054351807, "lat": 54.579303741455}, {"lon": 13.1108331680298, "lat": 54.5837516784668}, {"lon": 13.116943359375, "lat": 54.5376396179201}, {"lon": 13.06360912323, "lat": 54.4576377868652}, {"lon": 13.0974998474122, "lat": 54.59041595459}, {"lon": 13.1363887786866, "lat": 54.6051406860351}]]}, "DE-NI": {"name": "Niedersachsen", "parts": [[{"lon": 8.68083381652866, "lat": 53.8920822143557}, {"lon": 8.75694561004633, "lat": 53.8426399230958}, {"lon": 8.88361072540295, "lat": 53.8279151916506}, {"lon": 9.0163888931275, "lat": 53.8359718322755}, {"lon": 9.0963888168335, "lat": 53.8839836120608}, {"lon": 9.28820991516119, "lat": 53.8694114685059}, {"lon": 9.50700855255127, "lat": 53.70085144043}, {"lon": 9.54716968536388, "lat": 53.6243095397949}, {"lon": 9.76863956451439, "lat": 53.5655403137206}, {"lon": 9.76345062255882, "lat": 53.5169410705566}, {"lon": 9.86095046997087, "lat": 53.4392890930176}, {"lon": 9.89880752563482, "lat": 53.4694786071777}, {"lon": 9.92484092712431, "lat": 53.4472694396975}, {"lon": 9.90592765808111, "lat": 53.4247207641602}, {"lon": 9.98313903808594, "lat": 53.4252815246583}, {"lon": 10.0536890029907, "lat": 53.4741592407227}, {"lon": 10.1772603988649, "lat": 53.4079513549806}, {"lon": 10.3312702178957, "lat": 53.4425315856934}, {"lon": 10.5793790817262, "lat": 53.3698501586916}, {"lon": 10.7082586288452, "lat": 53.3793106079102}, {"lon": 10.8387489318848, "lat": 53.309181213379}, {"lon": 10.9316902160646, "lat": 53.3508300781251}, {"lon": 10.9940395355227, "lat": 53.3347702026369}, {"lon": 11.0686893463135, "lat": 53.2298889160157}, {"lon": 11.198998451233, "lat": 53.1800422668458}, {"lon": 11.1863098144531, "lat": 53.1354217529297}, {"lon": 11.2672986984253, "lat": 53.127281188965}, {"lon": 11.3290891647341, "lat": 53.0597496032715}, {"lon": 11.4596996307374, "lat": 53.0773620605468}, {"lon": 11.6017694473267, "lat": 53.031551361084}, {"lon": 11.5641002655029, "lat": 52.9946517944337}, {"lon": 11.5146093368531, "lat": 52.9987716674804}, {"lon": 11.5076894760132, "lat": 52.9393005371094}, {"lon": 11.3214397430419, "lat": 52.8736991882325}, {"lon": 11.0419292449952, "lat": 52.9130897521974}, {"lon": 10.9922599792483, "lat": 52.906349182129}, {"lon": 10.9425086975098, "lat": 52.8513793945312}, {"lon": 10.7662000656128, "lat": 52.8512420654299}, {"lon": 10.7957687377933, "lat": 52.7205085754397}, {"lon": 10.8320894241334, "lat": 52.7234115600586}, {"lon": 10.9211101531984, "lat": 52.6066818237305}, {"lon": 10.9780197143555, "lat": 52.6218299865723}, {"lon": 10.9340686798096, "lat": 52.5658187866211}, {"lon": 11.0100898742677, "lat": 52.4918708801271}, {"lon": 10.9478282928467, "lat": 52.4920310974122}, {"lon": 10.9362087249756, "lat": 52.4590110778811}, {"lon": 11.0787401199341, "lat": 52.3734512329104}, {"lon": 10.9875793457031, "lat": 52.3370018005374}, {"lon": 11.0916805267336, "lat": 52.2257003784181}, {"lon": 11.0199899673464, "lat": 52.1967887878419}, {"lon": 11.0680885314941, "lat": 52.166919708252}, {"lon": 11.0505399703981, "lat": 52.1339416503907}, {"lon": 10.9492797851563, "lat": 52.1054000854492}, {"lon": 10.9748086929321, "lat": 52.0572509765626}, {"lon": 10.6917581558228, "lat": 52.0527687072757}, {"lon": 10.5633697509766, "lat": 52.0099296569826}, {"lon": 10.6555500030518, "lat": 51.9605598449709}, {"lon": 10.6126785278323, "lat": 51.9422187805176}, {"lon": 10.6556797027587, "lat": 51.9046096801758}, {"lon": 10.5768718719482, "lat": 51.8511695861818}, {"lon": 10.5775508880616, "lat": 51.7827110290528}, {"lon": 10.6321802139283, "lat": 51.7574195861816}, {"lon": 10.7051296234134, "lat": 51.6435508728027}, {"lon": 10.639940261841, "lat": 51.6192588806153}, {"lon": 10.6647891998294, "lat": 51.5578689575198}, {"lon": 10.6050100326541, "lat": 51.5763587951661}, {"lon": 10.5221290588379, "lat": 51.5505218505859}, {"lon": 10.3783092498779, "lat": 51.5851898193361}, {"lon": 10.3499794006347, "lat": 51.5217895507812}, {"lon": 10.2380599975589, "lat": 51.4704208374023}, {"lon": 10.1961793899537, "lat": 51.4818801879883}, {"lon": 10.1436195373537, "lat": 51.4412803649903}, {"lon": 10.1616907119751, "lat": 51.4299888610842}, {"lon": 10.0546102523803, "lat": 51.4380989074707}, {"lon": 9.94322872161882, "lat": 51.3791694641113}, {"lon": 9.9112300872805, "lat": 51.4197502136232}, {"lon": 9.85617923736595, "lat": 51.4157791137698}, {"lon": 9.86927986145014, "lat": 51.3754501342773}, {"lon": 9.81936931610107, "lat": 51.4156112670899}, {"lon": 9.70588016510033, "lat": 51.3705215454103}, {"lon": 9.7361488342288, "lat": 51.323299407959}, {"lon": 9.77073860168457, "lat": 51.3425292968752}, {"lon": 9.73115062713629, "lat": 51.3008193969728}, {"lon": 9.56183815002458, "lat": 51.3483505249023}, {"lon": 9.57165908813477, "lat": 51.3931617736817}, {"lon": 9.64620971679716, "lat": 51.4207687377931}, {"lon": 9.64471912384033, "lat": 51.4722785949709}, {"lon": 9.59042072296148, "lat": 51.5228004455566}, {"lon": 9.68900871276855, "lat": 51.5831222534183}, {"lon": 9.62797927856451, "lat": 51.6373405456544}, {"lon": 9.38236808776861, "lat": 51.647689819336}, {"lon": 9.40897941589355, "lat": 51.69974899292}, {"lon": 9.38899993896484, "lat": 51.7582397460937}, {"lon": 9.45115852355968, "lat": 51.7925910949708}, {"lon": 9.43709945678722, "lat": 51.8402214050293}, {"lon": 9.46591854095465, "lat": 51.8554687500001}, {"lon": 9.34115028381365, "lat": 51.8537406921387}, {"lon": 9.35097885131836, "lat": 51.894889831543}, {"lon": 9.27766036987299, "lat": 51.9273910522462}, {"lon": 9.28176879882807, "lat": 51.9684715270997}, {"lon": 9.17910957336431, "lat": 51.9781188964845}, {"lon": 9.20224952697765, "lat": 51.9971084594727}, {"lon": 9.17640018463158, "lat": 52.0340118408204}, {"lon": 9.19272994995123, "lat": 52.0715599060059}, {"lon": 9.13736057281523, "lat": 52.0930709838869}, {"lon": 9.16010856628441, "lat": 52.1232719421387}, {"lon": 9.02053928375244, "lat": 52.1322402954103}, {"lon": 8.98710918426542, "lat": 52.1950988769532}, {"lon": 9.04839038848905, "lat": 52.1811714172366}, {"lon": 9.04034042358427, "lat": 52.2220687866212}, {"lon": 9.07633018493669, "lat": 52.230110168457}, {"lon": 8.96466827392601, "lat": 52.2805099487305}, {"lon": 9.12292861938505, "lat": 52.4025001525879}, {"lon": 9.09672832489036, "lat": 52.4431190490724}, {"lon": 9.1377801895141, "lat": 52.4773902893068}, {"lon": 9.09414958953852, "lat": 52.4990692138672}, {"lon": 9.05136871337885, "lat": 52.5020904541017}, {"lon": 8.94041824340832, "lat": 52.4032096862792}, {"lon": 8.85589027404797, "lat": 52.3906021118165}, {"lon": 8.70964908599854, "lat": 52.3955688476563}, {"lon": 8.70400810241716, "lat": 52.5036010742189}, {"lon": 8.65368938446051, "lat": 52.5325088500977}, {"lon": 8.50821876525896, "lat": 52.514888763428}, {"lon": 8.43264961242687, "lat": 52.4501991271973}, {"lon": 8.3041200637818, "lat": 52.4625396728518}, {"lon": 8.31338882446312, "lat": 52.407039642334}, {"lon": 8.4436988830567, "lat": 52.3647804260256}, {"lon": 8.47075939178472, "lat": 52.3168411254884}, {"lon": 8.44647884368925, "lat": 52.2120895385744}, {"lon": 8.52066993713402, "lat": 52.1872787475587}, {"lon": 8.40422916412348, "lat": 52.1108207702637}, {"lon": 8.2698097229005, "lat": 52.1346092224122}, {"lon": 8.19600868225098, "lat": 52.0739097595217}, {"lon": 8.03252887725858, "lat": 52.0682907104494}, {"lon": 7.97406005859386, "lat": 52.0363807678224}, {"lon": 7.88575983047502, "lat": 52.0861816406251}, {"lon": 8.00920009613037, "lat": 52.1151695251466}, {"lon": 8.01777935028082, "lat": 52.1728706359864}, {"lon": 7.90038919448853, "lat": 52.1991920471192}, {"lon": 7.95477008819597, "lat": 52.2765197753906}, {"lon": 7.92867994308494, "lat": 52.3056106567384}, {"lon": 7.98840999603271, "lat": 52.3116607666018}, {"lon": 7.93776893615723, "lat": 52.3687286376954}, {"lon": 7.71935987472528, "lat": 52.4019889831544}, {"lon": 7.693008899689, "lat": 52.4562911987306}, {"lon": 7.6133389472962, "lat": 52.4760398864747}, {"lon": 7.57814884185785, "lat": 52.4311904907227}, {"lon": 7.60909986495966, "lat": 52.420970916748}, {"lon": 7.58655881881714, "lat": 52.3762512207031}, {"lon": 7.29863786697405, "lat": 52.2642021179199}, {"lon": 7.07018899917608, "lat": 52.2434616088867}, {"lon": 7.02971887588495, "lat": 52.2943191528321}, {"lon": 7.07911586761486, "lat": 52.3827247619629}, {"lon": 7.00627994537382, "lat": 52.4695014953616}, {"lon": 6.95053911209123, "lat": 52.43696975708}, {"lon": 6.71362686157221, "lat": 52.4844131469728}, {"lon": 6.6837911605835, "lat": 52.5560646057129}, {"lon": 6.76826095581077, "lat": 52.5651664733887}, {"lon": 6.72429800033598, "lat": 52.5906105041506}, {"lon": 6.74381017684942, "lat": 52.6470909118653}, {"lon": 7.05185985565208, "lat": 52.6358489990234}, {"lon": 7.09427690505987, "lat": 52.8464508056641}, {"lon": 7.2614879608156, "lat": 52.9975395202636}, {"lon": 7.25657892227173, "lat": 53.0984115600587}, {"lon": 7.22696876525885, "lat": 53.1244621276856}, {"lon": 7.29270982742304, "lat": 53.162940979004}, {"lon": 7.28456020355219, "lat": 53.1995697021486}, {"lon": 7.27235078811674, "lat": 53.2337837219239}, {"lon": 7.20527791976934, "lat": 53.2388076782227}, {"lon": 7.24916696548456, "lat": 53.3298606872559}, {"lon": 7.02694511413597, "lat": 53.3362503051758}, {"lon": 6.99861097335815, "lat": 53.3612518310549}, {"lon": 7.04972219467157, "lat": 53.5076370239261}, {"lon": 7.03416681289673, "lat": 53.5331954956058}, {"lon": 7.13361120223999, "lat": 53.5323600769042}, {"lon": 7.09027719497675, "lat": 53.5765266418459}, {"lon": 7.15805387496954, "lat": 53.6279182434081}, {"lon": 7.31694412231462, "lat": 53.6834716796876}, {"lon": 7.53027820587164, "lat": 53.6715278625489}, {"lon": 8.01583194732711, "lat": 53.7106933593752}, {"lon": 8.04472160339361, "lat": 53.6418037414552}, {"lon": 8.1102771759036, "lat": 53.642360687256}, {"lon": 8.17249965667725, "lat": 53.5545845031741}, {"lon": 8.15527629852301, "lat": 53.5137481689454}, {"lon": 8.06472206115734, "lat": 53.505973815918}, {"lon": 8.07361125946085, "lat": 53.4648628234863}, {"lon": 8.25249958038324, "lat": 53.3990287780761}, {"lon": 8.31638908386242, "lat": 53.4662513732912}, {"lon": 8.31638908386242, "lat": 53.5220832824707}, {"lon": 8.23083209991495, "lat": 53.5204162597659}, {"lon": 8.27194309234642, "lat": 53.6098594665527}, {"lon": 8.5163898468017, "lat": 53.556251525879}, {"lon": 8.55694484710688, "lat": 53.5256958007815}, {"lon": 8.51972198486334, "lat": 53.5009727478028}, {"lon": 8.57083415985107, "lat": 53.5181961059572}, {"lon": 8.48361110687279, "lat": 53.6943054199221}, {"lon": 8.55805683135981, "lat": 53.83402633667}, {"lon": 8.68083381652866, "lat": 53.8920822143557}], [{"lon": 8.51947975158708, "lat": 53.196041107178}, {"lon": 8.62583827972429, "lat": 53.1652908325195}, {"lon": 8.73129844665527, "lat": 53.0372085571291}, {"lon": 8.77343082428007, "lat": 53.0567588806155}, {"lon": 8.81818962097196, "lat": 53.0241203308106}, {"lon": 8.86642837524425, "lat": 53.0437622070314}, {"lon": 8.93546962738043, "lat": 53.0152397155763}, {"lon": 8.98299026489252, "lat": 53.0497398376466}, {"lon": 8.96262836456316, "lat": 53.0904502868652}, {"lon": 8.99298858642572, "lat": 53.0984802246095}, {"lon": 8.94873905181896, "lat": 53.1238021850588}, {"lon": 8.98544883728033, "lat": 53.1282196044922}, {"lon": 8.94713878631592, "lat": 53.1573791503909}, {"lon": 8.86186981201178, "lat": 53.1370086669923}, {"lon": 8.82959079742449, "lat": 53.1661987304689}, {"lon": 8.59381866455095, "lat": 53.1868591308594}, {"lon": 8.59833812713646, "lat": 53.2168006896975}, {"lon": 8.48689079284696, "lat": 53.2286415100098}, {"lon": 8.51947975158708, "lat": 53.196041107178}], [{"lon": 8.49861240386974, "lat": 53.931251525879}, {"lon": 8.51527690887445, "lat": 53.9170837402346}, {"lon": 8.48749923706055, "lat": 53.9140281677248}, {"lon": 8.49861240386974, "lat": 53.931251525879}], [{"lon": 8.00916576385504, "lat": 53.7856941223145}, {"lon": 8.02249908447294, "lat": 53.7448616027832}, {"lon": 7.98750019073492, "lat": 53.7701377868653}, {"lon": 8.00916576385504, "lat": 53.7856941223145}], [{"lon": 7.89583301544224, "lat": 53.7940292358401}, {"lon": 7.96805477142357, "lat": 53.7748603820803}, {"lon": 7.84638786315963, "lat": 53.786804199219}, {"lon": 7.89583301544224, "lat": 53.7940292358401}], [{"lon": 7.70638895034807, "lat": 53.7795829772949}, {"lon": 7.80583286285446, "lat": 53.7745819091797}, {"lon": 7.66694402694725, "lat": 53.7587509155274}, {"lon": 7.70638895034807, "lat": 53.7795829772949}], [{"lon": 7.48472309112555, "lat": 53.7548599243166}, {"lon": 7.62749910354643, "lat": 53.748474121094}, {"lon": 7.46750211715732, "lat": 53.7270851135255}, {"lon": 7.48472309112555, "lat": 53.7548599243166}], [{"lon": 7.39416599273721, "lat": 53.7345848083498}, {"lon": 7.42972278594971, "lat": 53.7251396179202}, {"lon": 7.36027812957786, "lat": 53.7268066406249}, {"lon": 7.39416599273721, "lat": 53.7345848083498}], [{"lon": 7.31639003753673, "lat": 53.7234725952151}, {"lon": 7.34250020980829, "lat": 53.7206954956056}, {"lon": 7.13805484771734, "lat": 53.7051391601565}, {"lon": 7.31639003753673, "lat": 53.7234725952151}], [{"lon": 7.05861091613764, "lat": 53.684581756592}, {"lon": 7.09583377838135, "lat": 53.6806945800781}, {"lon": 6.85472202301042, "lat": 53.6612510681153}, {"lon": 7.05861091613764, "lat": 53.684581756592}], [{"lon": 6.90139007568354, "lat": 53.6537513732911}, {"lon": 6.89749908447271, "lat": 53.6262512207032}, {"lon": 6.86472320556686, "lat": 53.6390266418459}, {"lon": 6.90139007568354, "lat": 53.6537513732911}], [{"lon": 6.76194477081299, "lat": 53.618751525879}, {"lon": 6.81138896942184, "lat": 53.6026382446288}, {"lon": 6.72138786315941, "lat": 53.5837516784669}, {"lon": 6.74972200393722, "lat": 53.5568046569824}, {"lon": 6.6308331489567, "lat": 53.5979156494141}, {"lon": 6.76194477081299, "lat": 53.618751525879}]]}, "DE-NW": {"name": "Nordrhein-Westfalen", "parts": [[{"lon": 8.66627883911138, "lat": 52.5252799987792}, {"lon": 8.70400810241716, "lat": 52.5036010742189}, {"lon": 8.70964908599854, "lat": 52.3955688476563}, {"lon": 8.74042034149193, "lat": 52.3886413574219}, {"lon": 8.94041824340832, "lat": 52.4032096862792}, {"lon": 9.05136871337885, "lat": 52.5020904541017}, {"lon": 9.13135147094738, "lat": 52.484748840332}, {"lon": 9.08855056762718, "lat": 52.3571586608889}, {"lon": 9.02834987640404, "lat": 52.3449821472169}, {"lon": 8.96466827392601, "lat": 52.2805099487305}, {"lon": 9.07633018493669, "lat": 52.230110168457}, {"lon": 9.04034042358427, "lat": 52.2220687866212}, {"lon": 9.04839038848905, "lat": 52.1811714172366}, {"lon": 8.98710918426542, "lat": 52.1950988769532}, {"lon": 9.02053928375244, "lat": 52.1322402954103}, {"lon": 9.16010856628441, "lat": 52.1232719421387}, {"lon": 9.13736057281523, "lat": 52.0930709838869}, {"lon": 9.19272994995123, "lat": 52.0715599060059}, {"lon": 9.17640018463158, "lat": 52.0340118408204}, {"lon": 9.20224952697765, "lat": 51.9971084594727}, {"lon": 9.17910957336431, "lat": 51.9781188964845}, {"lon": 9.28176879882807, "lat": 51.9684715270997}, {"lon": 9.27766036987299, "lat": 51.9273910522462}, {"lon": 9.35097885131836, "lat": 51.894889831543}, {"lon": 9.34115028381365, "lat": 51.8537406921387}, {"lon": 9.46591854095465, "lat": 51.8554687500001}, {"lon": 9.43709945678722, "lat": 51.8402214050293}, {"lon": 9.45115852355968, "lat": 51.7925910949708}, {"lon": 9.38393974304211, "lat": 51.7434196472169}, {"lon": 9.40897941589355, "lat": 51.69974899292}, {"lon": 9.38236808776861, "lat": 51.647689819336}, {"lon": 9.45174026489263, "lat": 51.6453819274903}, {"lon": 9.34346961975098, "lat": 51.6137619018557}, {"lon": 9.37895965576178, "lat": 51.5923614501953}, {"lon": 9.22869014740002, "lat": 51.459732055664}, {"lon": 9.11385822296137, "lat": 51.4426002502442}, {"lon": 9.11209869384788, "lat": 51.4946212768558}, {"lon": 9.04188060760509, "lat": 51.5192985534669}, {"lon": 8.91246032714872, "lat": 51.4797210693361}, {"lon": 8.93867015838651, "lat": 51.4279289245607}, {"lon": 8.96854972839373, "lat": 51.4285392761232}, {"lon": 8.95757961273216, "lat": 51.3872718811037}, {"lon": 8.70376014709473, "lat": 51.3748893737794}, {"lon": 8.63252067565918, "lat": 51.336120605469}, {"lon": 8.56899929046648, "lat": 51.2750701904298}, {"lon": 8.60167884826677, "lat": 51.2458114624024}, {"lon": 8.73969936370867, "lat": 51.2709388732911}, {"lon": 8.78438186645536, "lat": 51.2045822143556}, {"lon": 8.70979022979742, "lat": 51.1321296691897}, {"lon": 8.73456859588651, "lat": 51.1064910888671}, {"lon": 8.5381507873538, "lat": 51.0951194763185}, {"lon": 8.51747035980219, "lat": 51.0386619567872}, {"lon": 8.55467891693132, "lat": 51.0132293701171}, {"lon": 8.46796894073515, "lat": 50.963260650635}, {"lon": 8.47149085998541, "lat": 50.9115219116212}, {"lon": 8.38051033020025, "lat": 50.8589515686036}, {"lon": 8.27567005157476, "lat": 50.8812408447265}, {"lon": 8.13190937042265, "lat": 50.7918510437013}, {"lon": 8.17941856384306, "lat": 50.7395210266116}, {"lon": 8.15311813354509, "lat": 50.6947898864746}, {"lon": 8.05282020568853, "lat": 50.699131011963}, {"lon": 7.97431993484503, "lat": 50.7746696472169}, {"lon": 7.97396898269682, "lat": 50.8452491760255}, {"lon": 7.83456993103056, "lat": 50.8811492919924}, {"lon": 7.85448980331449, "lat": 50.9263610839846}, {"lon": 7.79962921142578, "lat": 50.9430198669434}, {"lon": 7.73638010025047, "lat": 50.9185218811035}, {"lon": 7.76646089553833, "lat": 50.8452796936035}, {"lon": 7.66198921203636, "lat": 50.8191795349121}, {"lon": 7.68827915191673, "lat": 50.7904090881348}, {"lon": 7.66074991226208, "lat": 50.7670593261719}, {"lon": 7.38140106201178, "lat": 50.7154998779297}, {"lon": 7.34122800827021, "lat": 50.6357917785645}, {"lon": 7.21906900405884, "lat": 50.6197319030762}, {"lon": 7.21093893051147, "lat": 50.6454811096192}, {"lon": 7.15080881118774, "lat": 50.5946197509766}, {"lon": 7.05668115615845, "lat": 50.5983810424804}, {"lon": 6.9320011138916, "lat": 50.5527496337892}, {"lon": 6.93436908721924, "lat": 50.5266113281251}, {"lon": 6.88817977905273, "lat": 50.5213317871094}, {"lon": 6.90525007247953, "lat": 50.4619407653809}, {"lon": 6.8660101890564, "lat": 50.4455490112306}, {"lon": 6.8039999008181, "lat": 50.484802246094}, {"lon": 6.75292015075712, "lat": 50.468200683594}, {"lon": 6.80925989151018, "lat": 50.3498115539551}, {"lon": 6.70684909820568, "lat": 50.3297805786134}, {"lon": 6.67490005493158, "lat": 50.3639106750488}, {"lon": 6.64143800735468, "lat": 50.3373718261721}, {"lon": 6.60708904266363, "lat": 50.3816184997559}, {"lon": 6.45010900497465, "lat": 50.3339309692385}, {"lon": 6.4596700668335, "lat": 50.360019683838}, {"lon": 6.39171791076666, "lat": 50.3844299316406}, {"lon": 6.40333890914945, "lat": 50.3219299316407}, {"lon": 6.33975791931158, "lat": 50.3798942565917}, {"lon": 6.37467193603538, "lat": 50.4459495544434}, {"lon": 6.33002805709862, "lat": 50.4936447143558}, {"lon": 6.22384786605829, "lat": 50.5022811889648}, {"lon": 6.17219400405889, "lat": 50.5505142211914}, {"lon": 6.27837896347069, "lat": 50.616397857666}, {"lon": 6.17308712005621, "lat": 50.6214332580567}, {"lon": 6.17378711700445, "lat": 50.6584053039551}, {"lon": 6.11873197555548, "lat": 50.7087364196777}, {"lon": 6.0286169052124, "lat": 50.7252159118655}, {"lon": 6.01187896728516, "lat": 50.7752494812013}, {"lon": 5.96319913864136, "lat": 50.795051574707}, {"lon": 6.02710199356079, "lat": 50.814765930176}, {"lon": 6.01968479156511, "lat": 50.8452339172364}, {"lon": 6.0738401412965, "lat": 50.8468589782717}, {"lon": 6.08294010162382, "lat": 50.9217987060547}, {"lon": 6.01517009735107, "lat": 50.9331588745117}, {"lon": 6.03000116348272, "lat": 50.9833641052247}, {"lon": 5.90369081497209, "lat": 50.9782714843751}, {"lon": 5.87161922454851, "lat": 51.0508308410645}, {"lon": 5.96954393386852, "lat": 51.0344696044922}, {"lon": 6.01526784896873, "lat": 51.0940513610842}, {"lon": 6.17179918289185, "lat": 51.152931213379}, {"lon": 6.14478015899664, "lat": 51.1737174987794}, {"lon": 6.19313907623297, "lat": 51.1916618347167}, {"lon": 6.0918340682984, "lat": 51.1752929687501}, {"lon": 6.07818603515619, "lat": 51.2447128295899}, {"lon": 6.23196887969976, "lat": 51.3659820556641}, {"lon": 6.23350000381492, "lat": 51.4029197692872}, {"lon": 6.21552896499662, "lat": 51.516971588135}, {"lon": 6.09095811843895, "lat": 51.6052207946779}, {"lon": 6.1187691688537, "lat": 51.6604576110841}, {"lon": 6.03901481628429, "lat": 51.6777343750001}, {"lon": 6.05058097839361, "lat": 51.7167739868165}, {"lon": 5.9640078544619, "lat": 51.7416114807129}, {"lon": 6.00477790832531, "lat": 51.7681694030764}, {"lon": 5.97211790084833, "lat": 51.8318557739257}, {"lon": 6.06824922561657, "lat": 51.864902496338}, {"lon": 6.16898202896147, "lat": 51.8450317382812}, {"lon": 6.10714912414556, "lat": 51.888988494873}, {"lon": 6.15888977050798, "lat": 51.9053840637206}, {"lon": 6.41746711730963, "lat": 51.8256340026857}, {"lon": 6.40229988098139, "lat": 51.8748016357422}, {"lon": 6.48034000396729, "lat": 51.854621887207}, {"lon": 6.69244098663341, "lat": 51.9201622009278}, {"lon": 6.74270915985113, "lat": 51.8990516662599}, {"lon": 6.83838081359863, "lat": 51.9655990600586}, {"lon": 6.83536100387585, "lat": 51.9955291748047}, {"lon": 6.69817876815796, "lat": 52.0401191711426}, {"lon": 6.7006888389588, "lat": 52.0737915039063}, {"lon": 6.74281883239757, "lat": 52.0751190185547}, {"lon": 6.7684521675111, "lat": 52.1207656860353}, {"lon": 6.87628889083874, "lat": 52.128002166748}, {"lon": 6.99578714370733, "lat": 52.2287712097169}, {"lon": 7.15920114517212, "lat": 52.2681694030761}, {"lon": 7.29863786697405, "lat": 52.2642021179199}, {"lon": 7.58655881881714, "lat": 52.3762512207031}, {"lon": 7.60909986495966, "lat": 52.420970916748}, {"lon": 7.57814884185785, "lat": 52.4311904907227}, {"lon": 7.6133389472962, "lat": 52.4760398864747}, {"lon": 7.693008899689, "lat": 52.4562911987306}, {"lon": 7.71935987472528, "lat": 52.4019889831544}, {"lon": 7.93776893615723, "lat": 52.3687286376954}, {"lon": 7.98840999603271, "lat": 52.3116607666018}, {"lon": 7.92867994308494, "lat": 52.3056106567384}, {"lon": 7.95477008819597, "lat": 52.2765197753906}, {"lon": 7.90038919448853, "lat": 52.1991920471192}, {"lon": 8.02509021759062, "lat": 52.1620101928712}, {"lon": 7.99996900558472, "lat": 52.1565513610841}, {"lon": 8.00920009613037, "lat": 52.1151695251466}, {"lon": 7.88575983047502, "lat": 52.0861816406251}, {"lon": 7.91875886917126, "lat": 52.0497207641602}, {"lon": 8.19600868225098, "lat": 52.0739097595217}, {"lon": 8.2698097229005, "lat": 52.1346092224122}, {"lon": 8.40422916412348, "lat": 52.1108207702637}, {"lon": 8.52066993713402, "lat": 52.1872787475587}, {"lon": 8.44647884368925, "lat": 52.2120895385744}, {"lon": 8.47075939178472, "lat": 52.3168411254884}, {"lon": 8.4436988830567, "lat": 52.3647804260256}, {"lon": 8.31338882446312, "lat": 52.407039642334}, {"lon": 8.29825973510759, "lat": 52.4587097167971}, {"lon": 8.43264961242687, "lat": 52.4501991271973}, {"lon": 8.50821876525896, "lat": 52.514888763428}, {"lon": 8.66627883911138, "lat": 52.5252799987792}]]}, "DE-RP": {"name": "Rheinland-Pfalz", "parts": [[{"lon": 7.79962921142578, "lat": 50.9430198669434}, {"lon": 7.85448980331449, "lat": 50.9263610839846}, {"lon": 7.83456993103056, "lat": 50.8811492919924}, {"lon": 7.97396898269682, "lat": 50.8452491760255}, {"lon": 7.97431993484503, "lat": 50.7746696472169}, {"lon": 8.05282020568853, "lat": 50.699131011963}, {"lon": 8.12108898162842, "lat": 50.7022285461425}, {"lon": 8.14078807830816, "lat": 50.6117210388184}, {"lon": 8.1745395660401, "lat": 50.5927505493166}, {"lon": 8.1409702301026, "lat": 50.5358505249023}, {"lon": 8.05648136138927, "lat": 50.5571784973147}, {"lon": 8.01100921630865, "lat": 50.5261192321778}, {"lon": 7.99656009674078, "lat": 50.4847412109375}, {"lon": 8.03000831604015, "lat": 50.448181152344}, {"lon": 7.98417997360224, "lat": 50.413600921631}, {"lon": 8.08279991149902, "lat": 50.3741607666016}, {"lon": 8.13891029357922, "lat": 50.2740592956543}, {"lon": 8.05168056488048, "lat": 50.2688293457031}, {"lon": 8.07635879516607, "lat": 50.2317314147949}, {"lon": 8.04792022705095, "lat": 50.2125396728516}, {"lon": 8.00625991821306, "lat": 50.2345504760744}, {"lon": 7.91955900192278, "lat": 50.2037086486816}, {"lon": 7.89757013320917, "lat": 50.1698799133302}, {"lon": 7.94554996490479, "lat": 50.1401519775393}, {"lon": 7.94112014770513, "lat": 50.1025085449219}, {"lon": 7.86995792388927, "lat": 50.1285705566407}, {"lon": 7.78512001037592, "lat": 50.0531120300294}, {"lon": 7.88771104812628, "lat": 49.9706687927248}, {"lon": 8.25768947601313, "lat": 50.027069091797}, {"lon": 8.34678077697782, "lat": 49.9592895507812}, {"lon": 8.34934043884283, "lat": 49.8816986083987}, {"lon": 8.39670085906982, "lat": 49.8498916625978}, {"lon": 8.38613891601562, "lat": 49.8200302124023}, {"lon": 8.42842006683367, "lat": 49.7659988403321}, {"lon": 8.48609066009544, "lat": 49.7677688598633}, {"lon": 8.36192989349371, "lat": 49.690170288086}, {"lon": 8.42903900146484, "lat": 49.5856208801271}, {"lon": 8.41882896423334, "lat": 49.5521888732911}, {"lon": 8.46752929687494, "lat": 49.4730415344241}, {"lon": 8.44558811187756, "lat": 49.4502601623535}, {"lon": 8.5085897445681, "lat": 49.441478729248}, {"lon": 8.46494865417509, "lat": 49.3922004699708}, {"lon": 8.49897861480741, "lat": 49.3934288024902}, {"lon": 8.49458980560297, "lat": 49.3602485656738}, {"lon": 8.4504289627078, "lat": 49.3328514099123}, {"lon": 8.49136924743652, "lat": 49.3012886047363}, {"lon": 8.39286041259771, "lat": 49.2420921325684}, {"lon": 8.36223983764654, "lat": 49.0996894836426}, {"lon": 8.24143028259289, "lat": 48.9688415527346}, {"lon": 8.09137630462641, "lat": 48.9892578125002}, {"lon": 7.93704032897944, "lat": 49.0562324523926}, {"lon": 7.86740779876737, "lat": 49.0334930419924}, {"lon": 7.7999339103701, "lat": 49.0641632080078}, {"lon": 7.6710839271546, "lat": 49.0459709167481}, {"lon": 7.53117895126348, "lat": 49.0971336364747}, {"lon": 7.49134302139282, "lat": 49.1685104370118}, {"lon": 7.35388898849499, "lat": 49.1706085205079}, {"lon": 7.29239988327021, "lat": 49.2457313537599}, {"lon": 7.38636922836298, "lat": 49.292751312256}, {"lon": 7.40964984893816, "lat": 49.3779487609864}, {"lon": 7.29356908798229, "lat": 49.3970985412598}, {"lon": 7.25608921051048, "lat": 49.4402694702148}, {"lon": 7.31066989898687, "lat": 49.4789695739748}, {"lon": 7.28526878356945, "lat": 49.5115509033206}, {"lon": 7.3118300437929, "lat": 49.5419692993165}, {"lon": 7.28281021118164, "lat": 49.5448303222657}, {"lon": 7.27340793609619, "lat": 49.5927696228027}, {"lon": 7.21724987030035, "lat": 49.5723991394044}, {"lon": 7.03186988830595, "lat": 49.6468200683594}, {"lon": 6.60870981216448, "lat": 49.5202102661133}, {"lon": 6.37815904617327, "lat": 49.5480003356936}, {"lon": 6.36364793777483, "lat": 49.574047088623}, {"lon": 6.41741991043085, "lat": 49.6174888610841}, {"lon": 6.42409992218012, "lat": 49.6663322448733}, {"lon": 6.5164852142334, "lat": 49.724178314209}, {"lon": 6.52825212478655, "lat": 49.8085708618164}, {"lon": 6.40521907806425, "lat": 49.8199729919434}, {"lon": 6.36299800872803, "lat": 49.8540306091308}, {"lon": 6.31228113174444, "lat": 49.8354988098146}, {"lon": 6.30923986434937, "lat": 49.8651695251465}, {"lon": 6.23690700531006, "lat": 49.8923721313479}, {"lon": 6.21917104721092, "lat": 49.9516410827638}, {"lon": 6.16320896148687, "lat": 49.9539794921877}, {"lon": 6.09837007522611, "lat": 50.0599098205567}, {"lon": 6.14642620086693, "lat": 50.1738929748535}, {"lon": 6.18963813781755, "lat": 50.1894645690919}, {"lon": 6.17038202285772, "lat": 50.2362556457521}, {"lon": 6.27563905715959, "lat": 50.2654418945313}, {"lon": 6.30117893218988, "lat": 50.318531036377}, {"lon": 6.42124891281128, "lat": 50.3222808837891}, {"lon": 6.38016891479521, "lat": 50.3804512023927}, {"lon": 6.4596700668335, "lat": 50.360019683838}, {"lon": 6.45010900497465, "lat": 50.3339309692385}, {"lon": 6.60708904266363, "lat": 50.3816184997559}, {"lon": 6.64143800735468, "lat": 50.3373718261721}, {"lon": 6.67490005493158, "lat": 50.3639106750488}, {"lon": 6.70684909820568, "lat": 50.3297805786134}, {"lon": 6.80925989151018, "lat": 50.3498115539551}, {"lon": 6.75292015075712, "lat": 50.468200683594}, {"lon": 6.8039999008181, "lat": 50.484802246094}, {"lon": 6.8660101890564, "lat": 50.4455490112306}, {"lon": 6.90525007247953, "lat": 50.4619407653809}, {"lon": 6.88817977905273, "lat": 50.5213317871094}, {"lon": 6.93436908721924, "lat": 50.5266113281251}, {"lon": 6.9320011138916, "lat": 50.5527496337892}, {"lon": 7.05668115615845, "lat": 50.5983810424804}, {"lon": 7.15080881118774, "lat": 50.5946197509766}, {"lon": 7.21093893051147, "lat": 50.6454811096192}, {"lon": 7.21906900405884, "lat": 50.6197319030762}, {"lon": 7.34122800827021, "lat": 50.6357917785645}, {"lon": 7.38140106201178, "lat": 50.7154998779297}, {"lon": 7.66074991226208, "lat": 50.7670593261719}, {"lon": 7.68827915191673, "lat": 50.7904090881348}, {"lon": 7.66198921203636, "lat": 50.8191795349121}, {"lon": 7.76646089553833, "lat": 50.8452796936035}, {"lon": 7.73638010025047, "lat": 50.9185218811035}, {"lon": 7.79962921142578, "lat": 50.9430198669434}]]}, "DE-SL": {"name": "Saarland", "parts": [[{"lon": 7.03796005249046, "lat": 49.6433792114258}, {"lon": 7.21724987030035, "lat": 49.5723991394044}, {"lon": 7.27340793609619, "lat": 49.5927696228027}, {"lon": 7.28281021118164, "lat": 49.5448303222657}, {"lon": 7.3118300437929, "lat": 49.5419692993165}, {"lon": 7.28526878356945, "lat": 49.5115509033206}, {"lon": 7.31066989898687, "lat": 49.4789695739748}, {"lon": 7.25608921051048, "lat": 49.4402694702148}, {"lon": 7.29356908798229, "lat": 49.3970985412598}, {"lon": 7.40964984893816, "lat": 49.3779487609864}, {"lon": 7.38636922836298, "lat": 49.292751312256}, {"lon": 7.29239988327021, "lat": 49.2457313537599}, {"lon": 7.36277437210094, "lat": 49.1451759338381}, {"lon": 7.19833183288569, "lat": 49.1151771545412}, {"lon": 7.09815073013306, "lat": 49.1543312072756}, {"lon": 7.05802440643339, "lat": 49.1125869750977}, {"lon": 7.0337061882019, "lat": 49.1882629394532}, {"lon": 6.92429542541532, "lat": 49.2230758666993}, {"lon": 6.84044408798218, "lat": 49.2142333984377}, {"lon": 6.86093521118164, "lat": 49.1786270141604}, {"lon": 6.83446264266979, "lat": 49.151378631592}, {"lon": 6.737987518311, "lat": 49.1645698547363}, {"lon": 6.66784572601324, "lat": 49.2804374694825}, {"lon": 6.56538057327271, "lat": 49.3492889404297}, {"lon": 6.59932947158836, "lat": 49.3666191101076}, {"lon": 6.53541898727417, "lat": 49.4341621398926}, {"lon": 6.43184280395513, "lat": 49.4744606018068}, {"lon": 6.35482120513916, "lat": 49.464984893799}, {"lon": 6.37141990661627, "lat": 49.5480117797852}, {"lon": 6.60870981216448, "lat": 49.5202102661133}, {"lon": 6.93981981277477, "lat": 49.6391220092775}, {"lon": 7.03796005249046, "lat": 49.6433792114258}]]}, "DE-ST": {"name": "Sachsen-Anhalt", "parts": [[{"lon": 11.6325082778931, "lat": 53.0164108276368}, {"lon": 11.6880102157596, "lat": 53.0047798156738}, {"lon": 11.6936893463136, "lat": 52.9749603271484}, {"lon": 11.8537302017212, "lat": 52.9475288391114}, {"lon": 11.8285388946535, "lat": 52.9217300415039}, {"lon": 11.8466596603393, "lat": 52.9029808044435}, {"lon": 12.2395200729373, "lat": 52.8545913696289}, {"lon": 12.2623786926272, "lat": 52.7912216186525}, {"lon": 12.2187995910644, "lat": 52.769401550293}, {"lon": 12.2049608230591, "lat": 52.7101593017579}, {"lon": 12.241068840027, "lat": 52.6838111877441}, {"lon": 12.2456092834473, "lat": 52.6244087219239}, {"lon": 12.178129196167, "lat": 52.6213989257813}, {"lon": 12.189039230347, "lat": 52.5693702697754}, {"lon": 12.1510887145996, "lat": 52.5215606689453}, {"lon": 12.1940994262695, "lat": 52.5285415649415}, {"lon": 12.1750793457031, "lat": 52.5027809143066}, {"lon": 12.2053689956664, "lat": 52.4913520812988}, {"lon": 12.2428398132324, "lat": 52.5206108093264}, {"lon": 12.3394298553467, "lat": 52.4751014709474}, {"lon": 12.2827301025391, "lat": 52.4127197265626}, {"lon": 12.312949180603, "lat": 52.4012794494632}, {"lon": 12.2934303283691, "lat": 52.3570404052735}, {"lon": 12.3174085617067, "lat": 52.3419609069827}, {"lon": 12.2539691925049, "lat": 52.2500801086426}, {"lon": 12.3018703460693, "lat": 52.2199516296387}, {"lon": 12.2213087081909, "lat": 52.1652984619141}, {"lon": 12.2804298400881, "lat": 52.1017684936523}, {"lon": 12.4358282089236, "lat": 52.0149116516113}, {"lon": 12.4908275604247, "lat": 52.0290412902832}, {"lon": 12.549958229065, "lat": 51.9802322387698}, {"lon": 12.6841793060303, "lat": 52.0081214904786}, {"lon": 12.7975797653199, "lat": 51.9585418701172}, {"lon": 12.8583297729494, "lat": 51.9651298522949}, {"lon": 12.8631801605226, "lat": 51.9317588806154}, {"lon": 12.9721393585206, "lat": 51.9339714050294}, {"lon": 12.9829692840576, "lat": 51.9005317687991}, {"lon": 13.0554504394531, "lat": 51.8995094299316}, {"lon": 13.0482692718506, "lat": 51.8700103759765}, {"lon": 13.163080215454, "lat": 51.8721008300781}, {"lon": 13.1379089355469, "lat": 51.8465499877929}, {"lon": 13.1989307403564, "lat": 51.7162094116212}, {"lon": 13.0392408370972, "lat": 51.6371612548828}, {"lon": 13.0163202285767, "lat": 51.6670608520507}, {"lon": 12.9550199508666, "lat": 51.6383590698244}, {"lon": 12.8421182632446, "lat": 51.680591583252}, {"lon": 12.7866401672365, "lat": 51.6444091796875}, {"lon": 12.6968193054199, "lat": 51.6604194641114}, {"lon": 12.6471996307376, "lat": 51.6167716979982}, {"lon": 12.2483491897586, "lat": 51.5664405822755}, {"lon": 12.2053508758545, "lat": 51.5300407409668}, {"lon": 12.2103099822998, "lat": 51.4857521057132}, {"lon": 12.1557407379151, "lat": 51.4642219543456}, {"lon": 12.202850341797, "lat": 51.4231910705569}, {"lon": 12.2007608413699, "lat": 51.33118057251}, {"lon": 12.1585988998413, "lat": 51.3205909729003}, {"lon": 12.2162399291994, "lat": 51.2169990539552}, {"lon": 12.1856594085693, "lat": 51.1842422485352}, {"lon": 12.2214975357056, "lat": 51.1838607788087}, {"lon": 12.2086992263795, "lat": 51.1435699462891}, {"lon": 12.2502384185793, "lat": 51.1320991516114}, {"lon": 12.231939315796, "lat": 51.1139297485351}, {"lon": 12.2971200942993, "lat": 51.0948410034183}, {"lon": 12.2602596282961, "lat": 51.0438499450684}, {"lon": 12.3077287673952, "lat": 51.0359687805177}, {"lon": 12.2343893051147, "lat": 50.9450492858887}, {"lon": 12.193419456482, "lat": 50.9821205139161}, {"lon": 12.0197896957397, "lat": 50.9723014831544}, {"lon": 11.9783897399903, "lat": 50.9982719421387}, {"lon": 11.9907789230347, "lat": 51.0166320800782}, {"lon": 11.8837814331054, "lat": 51.0613288879396}, {"lon": 11.7635698318483, "lat": 51.0432510375977}, {"lon": 11.6690883636475, "lat": 51.1137008666993}, {"lon": 11.4719591140747, "lat": 51.1099510192872}, {"lon": 11.4729604721069, "lat": 51.1916503906251}, {"lon": 11.3659381866458, "lat": 51.2212104797364}, {"lon": 11.4804782867432, "lat": 51.2991485595703}, {"lon": 11.4032497406007, "lat": 51.3437614440919}, {"lon": 11.3977804183962, "lat": 51.3845405578615}, {"lon": 11.3262395858764, "lat": 51.4106101989747}, {"lon": 10.9922895431519, "lat": 51.4169807434082}, {"lon": 11.0101985931396, "lat": 51.4282608032226}, {"lon": 10.9685182571414, "lat": 51.4317703247071}, {"lon": 10.9746608734132, "lat": 51.4802894592287}, {"lon": 10.9389486312867, "lat": 51.4987716674805}, {"lon": 10.9510488510131, "lat": 51.5361785888673}, {"lon": 10.885531425476, "lat": 51.5807609558105}, {"lon": 10.9394302368165, "lat": 51.5959205627444}, {"lon": 10.9276103973389, "lat": 51.6183395385744}, {"lon": 10.7051296234134, "lat": 51.6435508728027}, {"lon": 10.6321802139283, "lat": 51.7574195861816}, {"lon": 10.5775508880616, "lat": 51.7827110290528}, {"lon": 10.5768718719482, "lat": 51.8511695861818}, {"lon": 10.6556797027587, "lat": 51.9046096801758}, {"lon": 10.6126785278323, "lat": 51.9422187805176}, {"lon": 10.6555500030518, "lat": 51.9605598449709}, {"lon": 10.5880098342897, "lat": 51.9798698425295}, {"lon": 10.5694303512574, "lat": 52.0172615051272}, {"lon": 10.6307802200319, "lat": 52.0128593444825}, {"lon": 10.6917581558228, "lat": 52.0527687072755}, {"lon": 10.9748086929321, "lat": 52.0572509765626}, {"lon": 10.9492797851563, "lat": 52.1054000854492}, {"lon": 11.0505399703981, "lat": 52.1339416503907}, {"lon": 11.0680885314941, "lat": 52.166919708252}, {"lon": 11.0199899673464, "lat": 52.1967887878419}, {"lon": 11.0916805267336, "lat": 52.2257003784181}, {"lon": 10.9875793457031, "lat": 52.3370018005374}, {"lon": 11.0787401199341, "lat": 52.3734512329104}, {"lon": 10.9362087249756, "lat": 52.4590110778811}, {"lon": 10.9478282928467, "lat": 52.4920310974122}, {"lon": 11.0100898742677, "lat": 52.4918708801271}, {"lon": 10.9340686798096, "lat": 52.5658187866211}, {"lon": 10.9780197143555, "lat": 52.6218299865723}, {"lon": 10.9211101531984, "lat": 52.6066818237305}, {"lon": 10.8320894241334, "lat": 52.7234115600586}, {"lon": 10.7957687377933, "lat": 52.7205085754397}, {"lon": 10.7662000656128, "lat": 52.8512420654299}, {"lon": 10.9425086975098, "lat": 52.8513793945312}, {"lon": 10.9922599792483, "lat": 52.906349182129}, {"lon": 11.0419292449952, "lat": 52.9130897521974}, {"lon": 11.3214397430419, "lat": 52.8736991882325}, {"lon": 11.5076894760132, "lat": 52.9393005371094}, {"lon": 11.5208597183229, "lat": 53.00244140625}, {"lon": 11.651300430298, "lat": 53.0311393737793}, {"lon": 11.6325082778931, "lat": 53.0164108276368}]]}, "DE-SN": {"name": "Sachsen", "parts": [[{"lon": 12.8779993057253, "lat": 51.6726989746096}, {"lon": 12.9550199508666, "lat": 51.6383590698244}, {"lon": 13.0163202285767, "lat": 51.6670608520507}, {"lon": 13.0981884002686, "lat": 51.6067390441895}, {"lon": 13.1699895858765, "lat": 51.5983009338378}, {"lon": 13.1624507904053, "lat": 51.5614395141602}, {"lon": 13.2268886566162, "lat": 51.5235290527344}, {"lon": 13.1927785873415, "lat": 51.4279518127443}, {"lon": 13.2228803634646, "lat": 51.4311904907227}, {"lon": 13.2333593368531, "lat": 51.3977584838867}, {"lon": 13.2866392135621, "lat": 51.3857917785646}, {"lon": 13.3370780944824, "lat": 51.4405097961427}, {"lon": 13.3961191177369, "lat": 51.4247398376464}, {"lon": 13.4215087890627, "lat": 51.4539604187012}, {"lon": 13.5601491928102, "lat": 51.3698806762698}, {"lon": 13.7792806625366, "lat": 51.3617820739747}, {"lon": 13.9715986251832, "lat": 51.3989105224609}, {"lon": 14.0152101516724, "lat": 51.3743019104006}, {"lon": 14.0804586410524, "lat": 51.4477386474609}, {"lon": 14.049810409546, "lat": 51.4803619384766}, {"lon": 14.1072797775269, "lat": 51.4802513122559}, {"lon": 14.0916795730593, "lat": 51.4964790344238}, {"lon": 14.1536397933963, "lat": 51.545051574707}, {"lon": 14.3419990539551, "lat": 51.5008201599124}, {"lon": 14.570050239563, "lat": 51.5724220275879}, {"lon": 14.6653785705568, "lat": 51.5507888793946}, {"lon": 14.6903991699222, "lat": 51.5994720458985}, {"lon": 14.7390661239626, "lat": 51.524082183838}, {"lon": 14.9103593826296, "lat": 51.4931907653811}, {"lon": 14.9637537002565, "lat": 51.4535446166994}, {"lon": 14.9678182601931, "lat": 51.3544158935548}, {"lon": 15.0284795761111, "lat": 51.3097991943362}, {"lon": 15.0381126403809, "lat": 51.2402992248535}, {"lon": 14.9301118850707, "lat": 50.9914054870605}, {"lon": 14.8203687667848, "lat": 50.8919715881349}, {"lon": 14.8050794601441, "lat": 50.8289184570314}, {"lon": 14.6119289398194, "lat": 50.8547821044922}, {"lon": 14.6516723632815, "lat": 50.9326400756838}, {"lon": 14.5601129531861, "lat": 50.9234848022463}, {"lon": 14.5950555801394, "lat": 50.988510131836}, {"lon": 14.5024299621585, "lat": 51.0168190002441}, {"lon": 14.5016803741457, "lat": 51.0515060424806}, {"lon": 14.4906606674197, "lat": 51.0203590393069}, {"lon": 14.3974103927612, "lat": 51.0082817077639}, {"lon": 14.2940168380737, "lat": 51.0541648864746}, {"lon": 14.246868133545, "lat": 50.973201751709}, {"lon": 14.4009466171265, "lat": 50.9423484802249}, {"lon": 14.3722686767579, "lat": 50.8885803222659}, {"lon": 14.2545194625856, "lat": 50.8863792419434}, {"lon": 14.0585498809816, "lat": 50.8004722595215}, {"lon": 13.9546098709107, "lat": 50.8037109375002}, {"lon": 13.895468711853, "lat": 50.7834663391116}, {"lon": 13.8987188339233, "lat": 50.7429618835451}, {"lon": 13.8508090972901, "lat": 50.7182006835938}, {"lon": 13.5489759445192, "lat": 50.7132148742678}, {"lon": 13.5259685516359, "lat": 50.6355400085449}, {"lon": 13.4651908874512, "lat": 50.5964889526367}, {"lon": 13.3749103546143, "lat": 50.6436614990235}, {"lon": 13.3267879486087, "lat": 50.5818138122559}, {"lon": 13.2486181259156, "lat": 50.5922698974609}, {"lon": 13.1959905624391, "lat": 50.5005912780763}, {"lon": 13.0332670211792, "lat": 50.5085487365725}, {"lon": 13.0281867980958, "lat": 50.4493598937988}, {"lon": 12.9770460128785, "lat": 50.4142723083498}, {"lon": 12.8287696838378, "lat": 50.4586219787599}, {"lon": 12.7051286697388, "lat": 50.3977584838867}, {"lon": 12.6150598526002, "lat": 50.4192314147951}, {"lon": 12.51611328125, "lat": 50.4000854492188}, {"lon": 12.4930915832521, "lat": 50.3491592407227}, {"lon": 12.3640880584719, "lat": 50.2764244079592}, {"lon": 12.3275899887084, "lat": 50.1797294616701}, {"lon": 12.2827157974245, "lat": 50.1826782226565}, {"lon": 12.2844142913821, "lat": 50.2274322509766}, {"lon": 12.2341642379761, "lat": 50.2532844543457}, {"lon": 12.2529296875002, "lat": 50.2756958007812}, {"lon": 12.1948852539064, "lat": 50.2791137695312}, {"lon": 12.1940917968749, "lat": 50.3228759765627}, {"lon": 12.1196804046633, "lat": 50.3127517700198}, {"lon": 11.9758920669557, "lat": 50.3560791015626}, {"lon": 11.9838867187501, "lat": 50.3934936523439}, {"lon": 11.8933277130128, "lat": 50.4453010559083}, {"lon": 11.9581308364871, "lat": 50.4567260742188}, {"lon": 11.9713134765624, "lat": 50.4902954101562}, {"lon": 11.8787231445313, "lat": 50.5458297729494}, {"lon": 12.017918586731, "lat": 50.6391601562501}, {"lon": 12.0388803482057, "lat": 50.5574951171876}, {"lon": 12.1646728515628, "lat": 50.580078125}, {"lon": 12.1550912857056, "lat": 50.6320800781251}, {"lon": 12.2811269760134, "lat": 50.6397094726564}, {"lon": 12.3374786376956, "lat": 50.6880912780763}, {"lon": 12.2425689697267, "lat": 50.7471084594728}, {"lon": 12.3028593063356, "lat": 50.7832603454591}, {"lon": 12.261869430542, "lat": 50.8238792419435}, {"lon": 12.4515495300293, "lat": 50.8468284606934}, {"lon": 12.4941492080688, "lat": 50.8974189758301}, {"lon": 12.6663103103639, "lat": 50.9273300170899}, {"lon": 12.6215505599976, "lat": 51.0017814636233}, {"lon": 12.5385808944702, "lat": 51.0032119750979}, {"lon": 12.5512104034423, "lat": 51.0287399291992}, {"lon": 12.5213193893433, "lat": 51.0218887329102}, {"lon": 12.5166282653811, "lat": 51.0660820007325}, {"lon": 12.469669342041, "lat": 51.0888786315918}, {"lon": 12.231939315796, "lat": 51.1139297485351}, {"lon": 12.2502384185793, "lat": 51.1320991516114}, {"lon": 12.2086992263795, "lat": 51.1435699462891}, {"lon": 12.2214975357056, "lat": 51.1838607788087}, {"lon": 12.1856594085693, "lat": 51.1842422485352}, {"lon": 12.2162399291994, "lat": 51.2169990539552}, {"lon": 12.1585988998413, "lat": 51.3205909729003}, {"lon": 12.2007608413699, "lat": 51.33118057251}, {"lon": 12.202850341797, "lat": 51.4231910705569}, {"lon": 12.1557407379151, "lat": 51.4642219543456}, {"lon": 12.2103099822998, "lat": 51.4857521057132}, {"lon": 12.1991605758669, "lat": 51.522731781006}, {"lon": 12.2483491897586, "lat": 51.5664405822755}, {"lon": 12.8779993057253, "lat": 51.6726989746096}]]}, "DE-SH": {"name": "Schleswig-Holstein", "parts": [[{"lon": 11.0697212219239, "lat": 54.5347023010254}, {"lon": 11.2341680526733, "lat": 54.5068054199221}, {"lon": 11.31360912323, "lat": 54.4020843505862}, {"lon": 11.1186113357548, "lat": 54.4026374816896}, {"lon": 11.0947208404542, "lat": 54.4456939697265}, {"lon": 11.0091667175292, "lat": 54.4412498474121}, {"lon": 11.0174989700318, "lat": 54.4945831298828}, {"lon": 11.0697212219239, "lat": 54.5347023010254}], [{"lon": 8.40729793219114, "lat": 55.0439522865366}, {"lon": 8.44250011444132, "lat": 55.0159721374514}, {"lon": 8.35360908508306, "lat": 54.9673614501955}, {"lon": 8.36694431304937, "lat": 54.9023628234864}, {"lon": 8.42972087860147, "lat": 54.8776397705079}, {"lon": 8.81203937530523, "lat": 54.9167366027832}, {"lon": 9.22477912902826, "lat": 54.855953216553}, {"lon": 9.28259181976358, "lat": 54.8022346496583}, {"lon": 9.40867996215832, "lat": 54.8411712646487}, {"lon": 9.43527793884294, "lat": 54.7884712219239}, {"lon": 9.61361122131353, "lat": 54.875972747803}, {"lon": 9.60305595397995, "lat": 54.8315277099611}, {"lon": 9.79194355011003, "lat": 54.7973594665527}, {"lon": 9.84305572509811, "lat": 54.7562484741211}, {"lon": 9.90583324432379, "lat": 54.7637481689455}, {"lon": 9.90750122070318, "lat": 54.7973594665527}, {"lon": 9.95527935028122, "lat": 54.7801399230956}, {"lon": 10.0347223281861, "lat": 54.6723594665528}, {"lon": 9.98305416107189, "lat": 54.7012481689454}, {"lon": 9.93805503845249, "lat": 54.6729164123536}, {"lon": 9.93305683135981, "lat": 54.6276397705079}, {"lon": 9.77027893066406, "lat": 54.5806961059571}, {"lon": 9.72065998766068, "lat": 54.5282156341047}, {"lon": 9.93805503845249, "lat": 54.6234741210941}, {"lon": 9.94805622100836, "lat": 54.673751831055}, {"lon": 10.0341663360598, "lat": 54.6698608398438}, {"lon": 10.0275001525879, "lat": 54.5504150390627}, {"lon": 9.84027767181396, "lat": 54.4673614501954}, {"lon": 9.86861228942865, "lat": 54.4473609924316}, {"lon": 10.127498626709, "lat": 54.4851379394532}, {"lon": 10.199167251587, "lat": 54.4559707641603}, {"lon": 10.1686134338381, "lat": 54.4340286254884}, {"lon": 10.1919441223147, "lat": 54.3898620605469}, {"lon": 10.148056983948, "lat": 54.3693046569824}, {"lon": 10.1319456100463, "lat": 54.3112487792969}, {"lon": 10.1841678619386, "lat": 54.3279151916503}, {"lon": 10.1780548095705, "lat": 54.3609733581543}, {"lon": 10.228056907654, "lat": 54.4134712219241}, {"lon": 10.318612098694, "lat": 54.4356956481934}, {"lon": 10.6036109924319, "lat": 54.3626403808596}, {"lon": 10.7047224044799, "lat": 54.3048629760743}, {"lon": 10.7886104583744, "lat": 54.3115272521976}, {"lon": 10.9286108016968, "lat": 54.381805419922}, {"lon": 11.1280555725098, "lat": 54.3906936645508}, {"lon": 11.0586099624634, "lat": 54.3543052673342}, {"lon": 11.0936107635499, "lat": 54.1979179382326}, {"lon": 10.8791666030885, "lat": 54.0884704589844}, {"lon": 10.8047218322756, "lat": 54.0959739685058}, {"lon": 10.7508344650273, "lat": 54.0487518310548}, {"lon": 10.7869443893436, "lat": 53.9965286254886}, {"lon": 10.8780546188357, "lat": 53.9859733581543}, {"lon": 10.8877601623536, "lat": 53.92387008667}, {"lon": 10.9637098312379, "lat": 53.9109992980957}, {"lon": 10.9011287689209, "lat": 53.9012794494629}, {"lon": 10.8752794265747, "lat": 53.9278411865234}, {"lon": 10.7679090499878, "lat": 53.8810691833496}, {"lon": 10.7442083358765, "lat": 53.840560913086}, {"lon": 10.7577295303346, "lat": 53.7515792846681}, {"lon": 10.9469194412232, "lat": 53.6775703430176}, {"lon": 10.9234104156495, "lat": 53.5853004455569}, {"lon": 10.823429107666, "lat": 53.5802803039552}, {"lon": 10.8243703842166, "lat": 53.5172805786133}, {"lon": 10.6393785476686, "lat": 53.4650993347169}, {"lon": 10.6217708587649, "lat": 53.3917388916017}, {"lon": 10.5793790817262, "lat": 53.3698501586916}, {"lon": 10.3191785812378, "lat": 53.4424896240234}, {"lon": 10.3367691040039, "lat": 53.46097946167}, {"lon": 10.168158531189, "lat": 53.5340919494629}, {"lon": 10.15961933136, "lat": 53.5894012451174}, {"lon": 10.2106218338013, "lat": 53.5932617187501}, {"lon": 10.1966886520388, "lat": 53.6227302551271}, {"lon": 10.2280588150026, "lat": 53.6338920593262}, {"lon": 10.1430501937869, "lat": 53.6889610290527}, {"lon": 10.1989593505862, "lat": 53.7297210693361}, {"lon": 10.1791687011718, "lat": 53.748119354248}, {"lon": 10.0840196609499, "lat": 53.7293510437013}, {"lon": 10.0726785659791, "lat": 53.6887092590333}, {"lon": 10.0021095275881, "lat": 53.6921195983887}, {"lon": 9.99042987823515, "lat": 53.6588592529298}, {"lon": 9.90689945220947, "lat": 53.6621818542481}, {"lon": 9.82556819915771, "lat": 53.5953521728517}, {"lon": 9.76018905639677, "lat": 53.6391220092775}, {"lon": 9.72365856170694, "lat": 53.5690002441407}, {"lon": 9.67358016967819, "lat": 53.5752601623536}, {"lon": 9.54716968536388, "lat": 53.6243095397951}, {"lon": 9.50700855255127, "lat": 53.70085144043}, {"lon": 9.28820991516119, "lat": 53.8694114685059}, {"lon": 8.9502782821657, "lat": 53.9023628234864}, {"lon": 8.81972217559826, "lat": 54.024307250977}, {"lon": 8.96416664123541, "lat": 54.0351371765136}, {"lon": 8.98583221435587, "lat": 54.0612487792971}, {"lon": 8.92749977111816, "lat": 54.1318054199219}, {"lon": 8.85916709899908, "lat": 54.1226387023927}, {"lon": 8.80749893188471, "lat": 54.1751403808596}, {"lon": 8.83583259582565, "lat": 54.2518043518066}, {"lon": 8.90305423736572, "lat": 54.260139465332}, {"lon": 8.95194435119635, "lat": 54.3128929138184}, {"lon": 8.86194515228266, "lat": 54.2687492370607}, {"lon": 8.84360980987566, "lat": 54.2884712219238}, {"lon": 8.84638786315924, "lat": 54.2629165649419}, {"lon": 8.8230562210087, "lat": 54.291526794434}, {"lon": 8.64527702331543, "lat": 54.2726402282715}, {"lon": 8.57972240448009, "lat": 54.3095817565919}, {"lon": 8.60472202301025, "lat": 54.358196258545}, {"lon": 8.68583202362061, "lat": 54.3570823669435}, {"lon": 8.60916614532465, "lat": 54.3865280151368}, {"lon": 8.86639022827194, "lat": 54.4043045043945}, {"lon": 9.02361106872604, "lat": 54.4734725952149}, {"lon": 8.98138809204107, "lat": 54.5209732055667}, {"lon": 8.90861129760776, "lat": 54.4620819091798}, {"lon": 8.80638885498053, "lat": 54.4704170227051}, {"lon": 8.8052768707276, "lat": 54.4979171752931}, {"lon": 8.87194442749035, "lat": 54.5281944274904}, {"lon": 8.89027690887485, "lat": 54.5926399230958}, {"lon": 8.81305599212692, "lat": 54.5973625183108}, {"lon": 8.84194374084501, "lat": 54.6148605346681}, {"lon": 8.82250022888184, "lat": 54.6459732055666}, {"lon": 8.68749809265142, "lat": 54.729862213135}, {"lon": 8.69305515289307, "lat": 54.7698593139651}, {"lon": 8.59027671813976, "lat": 54.885139465332}, {"lon": 8.41638755798357, "lat": 54.8470840454104}, {"lon": 8.31027793884289, "lat": 54.8743057250977}, {"lon": 8.33250045776373, "lat": 54.8631935119631}, {"lon": 8.30027675628662, "lat": 54.8506927490237}, {"lon": 8.29861068725597, "lat": 54.7420845031741}, {"lon": 8.27972221374517, "lat": 54.7518043518069}, {"lon": 8.29805469512951, "lat": 54.9093055725098}, {"lon": 8.40729793219114, "lat": 55.0439522865366}], [{"lon": 9.70696659473014, "lat": 54.5192444921042}, {"lon": 9.54527759552013, "lat": 54.5093040466308}, {"lon": 9.57416629791271, "lat": 54.47513961792}, {"lon": 9.6241655349732, "lat": 54.5115280151367}, {"lon": 9.7147226333621, "lat": 54.4912490844728}, {"lon": 9.70696659473014, "lat": 54.5192444921042}], [{"lon": 8.41178523287261, "lat": 55.0494830663621}, {"lon": 8.41749954223633, "lat": 55.0565261840823}, {"lon": 8.46305561065668, "lat": 55.0456962585449}, {"lon": 8.41178523287261, "lat": 55.0494830663621}], [{"lon": 8.69194507598871, "lat": 54.5570831298828}, {"lon": 8.67194461822515, "lat": 54.4945831298828}, {"lon": 8.58916664123541, "lat": 54.5118064880371}, {"lon": 8.69194507598871, "lat": 54.5570831298828}], [{"lon": 8.53972339630138, "lat": 54.7556953430177}, {"lon": 8.59527683258062, "lat": 54.7195816040038}, {"lon": 8.56694316864025, "lat": 54.6798629760747}, {"lon": 8.39694499969488, "lat": 54.705696105957}, {"lon": 8.42138767242426, "lat": 54.7431945800782}, {"lon": 8.53972339630138, "lat": 54.7556953430177}], [{"lon": 8.55138778686523, "lat": 54.5795822143554}, {"lon": 8.57305622100836, "lat": 54.5587501525879}, {"lon": 8.50916671752941, "lat": 54.5740280151368}, {"lon": 8.55138778686523, "lat": 54.5795822143554}], [{"lon": 8.4763879776001, "lat": 54.4765281677246}, {"lon": 8.52583217620861, "lat": 54.4334716796876}, {"lon": 8.47027778625488, "lat": 54.4218063354493}, {"lon": 8.44972324371344, "lat": 54.4526405334474}, {"lon": 8.4763879776001, "lat": 54.4765281677246}], [{"lon": 8.47750091552734, "lat": 54.5462493896484}, {"lon": 8.50472259521479, "lat": 54.5309715270997}, {"lon": 8.4719438552857, "lat": 54.4959716796876}, {"lon": 8.47750091552734, "lat": 54.5462493896484}], [{"lon": 8.48305511474649, "lat": 54.584583282471}, {"lon": 8.50138759613043, "lat": 54.5581932067871}, {"lon": 8.45527744293219, "lat": 54.5587501525879}, {"lon": 8.48305511474649, "lat": 54.584583282471}], [{"lon": 8.35694408416759, "lat": 54.7115287780762}, {"lon": 8.33916568756115, "lat": 54.6893043518071}, {"lon": 8.39527893066406, "lat": 54.6120834350588}, {"lon": 8.29249858856195, "lat": 54.6670837402348}, {"lon": 8.35694408416759, "lat": 54.7115287780762}]]}, "DE-TH": {"name": "Th√ºringen", "parts": [[{"lon": 10.7718906402588, "lat": 51.6449089050293}, {"lon": 10.9395008087158, "lat": 51.6071395874025}, {"lon": 10.885531425476, "lat": 51.5807609558105}, {"lon": 10.9510488510131, "lat": 51.5361785888673}, {"lon": 10.9389486312867, "lat": 51.4987716674805}, {"lon": 10.9746608734132, "lat": 51.4802894592287}, {"lon": 10.9685182571414, "lat": 51.4317703247071}, {"lon": 11.0101985931396, "lat": 51.4282608032226}, {"lon": 10.9922895431519, "lat": 51.4169807434082}, {"lon": 11.3262395858764, "lat": 51.4106101989747}, {"lon": 11.3977804183962, "lat": 51.3845405578615}, {"lon": 11.4032497406007, "lat": 51.3437614440919}, {"lon": 11.4804782867432, "lat": 51.2991485595703}, {"lon": 11.3659381866458, "lat": 51.2212104797364}, {"lon": 11.4729604721069, "lat": 51.1916503906251}, {"lon": 11.4905195236207, "lat": 51.1656913757325}, {"lon": 11.454468727112, "lat": 51.1433486938477}, {"lon": 11.4897289276123, "lat": 51.1025619506837}, {"lon": 11.6690883636475, "lat": 51.1137008666993}, {"lon": 11.7635698318483, "lat": 51.0432510375977}, {"lon": 11.8837814331054, "lat": 51.0613288879396}, {"lon": 11.9907789230347, "lat": 51.0166320800782}, {"lon": 11.9783897399903, "lat": 50.9982719421387}, {"lon": 12.0197896957397, "lat": 50.9723014831544}, {"lon": 12.193419456482, "lat": 50.9821205139161}, {"lon": 12.2284288406372, "lat": 50.9450988769532}, {"lon": 12.3074903488161, "lat": 51.0249595642089}, {"lon": 12.2602596282961, "lat": 51.0438499450684}, {"lon": 12.2971200942993, "lat": 51.0948410034183}, {"lon": 12.469669342041, "lat": 51.0888786315918}, {"lon": 12.5166282653811, "lat": 51.0660820007325}, {"lon": 12.5213193893433, "lat": 51.0218887329102}, {"lon": 12.5512104034423, "lat": 51.0287399291992}, {"lon": 12.5385808944702, "lat": 51.0032119750979}, {"lon": 12.6215505599976, "lat": 51.0017814636233}, {"lon": 12.6661691665651, "lat": 50.9236488342286}, {"lon": 12.4941492080688, "lat": 50.8974189758301}, {"lon": 12.4515495300293, "lat": 50.8468284606934}, {"lon": 12.261869430542, "lat": 50.8238792419435}, {"lon": 12.3028593063356, "lat": 50.7832603454591}, {"lon": 12.2425689697267, "lat": 50.7471084594728}, {"lon": 12.2785587310792, "lat": 50.7469520568848}, {"lon": 12.2775897979739, "lat": 50.7028999328616}, {"lon": 12.330454826355, "lat": 50.6732788085939}, {"lon": 12.2811269760134, "lat": 50.6397094726564}, {"lon": 12.209620475769, "lat": 50.6469993591309}, {"lon": 12.2024288177491, "lat": 50.6209487915039}, {"lon": 12.1610717773439, "lat": 50.635681152344}, {"lon": 12.1473436355591, "lat": 50.5873603820802}, {"lon": 12.1708993911743, "lat": 50.5836791992189}, {"lon": 12.0626840591432, "lat": 50.5574951171876}, {"lon": 12.0275278091431, "lat": 50.5684814453127}, {"lon": 12.0296201705933, "lat": 50.6317520141601}, {"lon": 11.9879140853884, "lat": 50.6279296875001}, {"lon": 11.9324951171877, "lat": 50.5609130859377}, {"lon": 11.8787231445313, "lat": 50.5458297729494}, {"lon": 11.9711313247682, "lat": 50.486511230469}, {"lon": 11.9475097656252, "lat": 50.4827270507813}, {"lon": 11.9581308364871, "lat": 50.4567260742188}, {"lon": 11.8933277130128, "lat": 50.4453010559083}, {"lon": 11.9335393905639, "lat": 50.4305000305176}, {"lon": 11.8683385848999, "lat": 50.4042091369631}, {"lon": 11.821249961853, "lat": 50.3928985595704}, {"lon": 11.7811689376832, "lat": 50.4226303100588}, {"lon": 11.5220499038699, "lat": 50.3735389709474}, {"lon": 11.4817886352541, "lat": 50.4330215454102}, {"lon": 11.446418762207, "lat": 50.421760559082}, {"lon": 11.4175081253055, "lat": 50.4514503479004}, {"lon": 11.4300909042359, "lat": 50.5147209167483}, {"lon": 11.3480606079102, "lat": 50.5218696594239}, {"lon": 11.3242597579958, "lat": 50.4883308410647}, {"lon": 11.2481184005737, "lat": 50.4768905639648}, {"lon": 11.2819471359253, "lat": 50.3655090332031}, {"lon": 11.2516689300537, "lat": 50.2651901245117}, {"lon": 11.1423797607421, "lat": 50.287109375}, {"lon": 11.1594104766845, "lat": 50.3279418945312}, {"lon": 11.1132392883301, "lat": 50.3648986816409}, {"lon": 11.044249534607, "lat": 50.3423805236816}, {"lon": 10.9981107711792, "lat": 50.3644790649415}, {"lon": 10.998330116272, "lat": 50.3422508239747}, {"lon": 10.9404602050781, "lat": 50.3902511596681}, {"lon": 10.8772802352905, "lat": 50.3937797546388}, {"lon": 10.7166595458984, "lat": 50.3526611328126}, {"lon": 10.7287902832032, "lat": 50.3155097961426}, {"lon": 10.8495588302612, "lat": 50.2712707519531}, {"lon": 10.8496503829957, "lat": 50.2415199279787}, {"lon": 10.734558105469, "lat": 50.2483520507814}, {"lon": 10.7288103103637, "lat": 50.1998405456542}, {"lon": 10.6179103851321, "lat": 50.221820831299}, {"lon": 10.6054887771609, "lat": 50.3302421569825}, {"lon": 10.4936704635622, "lat": 50.3524398803713}, {"lon": 10.4580583572388, "lat": 50.4009094238282}, {"lon": 10.3935203552246, "lat": 50.3933410644531}, {"lon": 10.4050197601318, "lat": 50.4232292175293}, {"lon": 10.3339891433715, "lat": 50.4940490722656}, {"lon": 10.1278800964356, "lat": 50.5650100708008}, {"lon": 10.0397586822513, "lat": 50.5158805847167}, {"lon": 10.0630292892457, "lat": 50.5573120117189}, {"lon": 10.0381708145142, "lat": 50.6139602661134}, {"lon": 10.0863294601442, "lat": 50.6212196350099}, {"lon": 10.0489807128909, "lat": 50.6772613525393}, {"lon": 9.95147037506098, "lat": 50.6709213256836}, {"lon": 9.94609832763666, "lat": 50.6301002502443}, {"lon": 9.87310886383057, "lat": 50.6418418884278}, {"lon": 9.93896007537842, "lat": 50.7374191284179}, {"lon": 9.92091846466064, "lat": 50.7631988525391}, {"lon": 9.95666027069086, "lat": 50.7817115783693}, {"lon": 9.95022964477556, "lat": 50.8223991394042}, {"lon": 10.0219593048098, "lat": 50.833309173584}, {"lon": 10.0214099884034, "lat": 50.8666801452637}, {"lon": 10.0629396438598, "lat": 50.8850021362306}, {"lon": 10.0145292282107, "lat": 50.9223213195804}, {"lon": 9.97887897491455, "lat": 50.907600402832}, {"lon": 9.99036979675293, "lat": 50.937240600586}, {"lon": 9.94874858856207, "lat": 50.9261589050292}, {"lon": 9.94838905334501, "lat": 50.9484214782716}, {"lon": 10.0678701400757, "lat": 50.9480285644531}, {"lon": 10.0195388793945, "lat": 50.9816589355471}, {"lon": 10.0429182052612, "lat": 51.0149421691897}, {"lon": 10.2038593292238, "lat": 51.0029106140137}, {"lon": 10.2032985687259, "lat": 51.0437088012696}, {"lon": 10.1496887207034, "lat": 51.0551300048829}, {"lon": 10.1785497665406, "lat": 51.1180114746094}, {"lon": 10.1247186660767, "lat": 51.1405715942383}, {"lon": 10.1721696853638, "lat": 51.1514205932619}, {"lon": 10.2141771316529, "lat": 51.1178092956544}, {"lon": 10.2370891571046, "lat": 51.1807289123536}, {"lon": 10.0758895874026, "lat": 51.2261810302737}, {"lon": 10.0573406219485, "lat": 51.2782516479494}, {"lon": 9.97350883483881, "lat": 51.286190032959}, {"lon": 9.92485904693609, "lat": 51.3718414306641}, {"lon": 10.0546102523803, "lat": 51.4380989074707}, {"lon": 10.1616907119751, "lat": 51.4299888610842}, {"lon": 10.1436195373537, "lat": 51.4412803649903}, {"lon": 10.1961793899537, "lat": 51.4818801879883}, {"lon": 10.3029985427857, "lat": 51.4923019409181}, {"lon": 10.3675203323365, "lat": 51.53662109375}, {"lon": 10.3783092498779, "lat": 51.5851898193361}, {"lon": 10.6590003967287, "lat": 51.5534019470217}, {"lon": 10.639940261841, "lat": 51.6192588806153}, {"lon": 10.7718906402588, "lat": 51.6449089050293}]]}};

// Funktion zum Konvertieren von Lon/Lat zu SVG-Koordinaten
// Angepasst an viewBox: -100 0 600 650
function lonLatToSVG(lon, lat) {
  const lonMin = 5.8, lonMax = 15.0;
  const latMin = 47.3, latMax = 55.0;
  
  // ViewBox: x=-100, y=0, width=600, height=650
  const viewBoxX = -100;
  const viewBoxWidth = 600;
  const viewBoxHeight = 650;
  const padding = 30;
  
  // Mercator-Projektion f√ºr Y-Koordinate
  const mercatorY = (latitude) => {
    const latRad = latitude * Math.PI / 180;
    return Math.log(Math.tan(Math.PI / 4 + latRad / 2));
  };
  
  // Berechne Mercator Y-Werte f√ºr Min/Max
  const mercatorYMin = mercatorY(latMin);
  const mercatorYMax = mercatorY(latMax);
  
  // Berechne relative Position (0 bis 1)
  const relX = (lon - lonMin) / (lonMax - lonMin);
  const mercatorYCurrent = mercatorY(lat);
  const relY = (mercatorYCurrent - mercatorYMin) / (mercatorYMax - mercatorYMin);
  
  // Konvertiere zu viewBox-Koordinaten
  const x = viewBoxX + padding + relX * (viewBoxWidth - 2 * padding);
  const y = viewBoxHeight - padding - relY * (viewBoxHeight - 2 * padding);
  
  return { x, y };
}

// Funktion zum Laden der Deutschland-Grenze und Bundesl√§nder
function loadGermanyBorder() {
  const borderGroup = document.getElementById('germanyBorder');
  if (!borderGroup || borderGroup.children.length > 0) return;
  
  // Zeichne jedes Bundesland
  for (const [stateId, stateInfo] of Object.entries(borderData)) {
    // Jedes Bundesland kann aus mehreren Teilen bestehen (z.B. Inseln)
    stateInfo.parts.forEach((partCoords, partIndex) => {
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      
      let pathData = '';
      partCoords.forEach((coord, index) => {
        const svgCoord = lonLatToSVG(coord.lon, coord.lat);
        if (index === 0) {
          pathData += `M ${svgCoord.x.toFixed(2)},${svgCoord.y.toFixed(2)}`;
        } else {
          pathData += ` L ${svgCoord.x.toFixed(2)},${svgCoord.y.toFixed(2)}`;
        }
      });
      pathData += ' Z';
      
      path.setAttribute('d', pathData);
      path.setAttribute('fill', '#e3f2fd');
      path.setAttribute('fill-opacity', '0.3');
      path.setAttribute('stroke', '#9e9e9e');
      path.setAttribute('stroke-width', '1');
      path.setAttribute('stroke-opacity', '0.5');
      path.setAttribute('stroke-linejoin', 'round');
      path.setAttribute('data-state', stateId);
      path.setAttribute('data-state-name', stateInfo.name);
      path.setAttribute('data-part', partIndex);
      
      borderGroup.appendChild(path);
    });
  }
  
  console.log(`${Object.keys(borderData).length} Bundesl√§nder auf der Karte gezeichnet`);
}

function updateWettkampforteMap(leistungen) {
  console.log('Aktualisiere Wettkampforte-Karte mit', leistungen.length, 'Leistungen');
  
  // Lade Deutschland-Grenze als Hintergrund
  loadGermanyBorder();
  
  // Z√§hle Leistungen pro Ort (nicht Wettk√§mpfe!)
  const ortLeistungen = {};
  const ortHasDM = {};
  
  // Gruppiere Leistungen nach Wettk√§mpfen (f√ºr DM-Erkennung)
  const wettk√§mpfe = gruppiereNachWettk√§mpfen(leistungen);
  
  // Z√§hle alle Leistungen pro Ort
  leistungen.forEach(leistung => {
    const ort = leistung.ort;
    if (ort && ort.trim() !== '') {
      const ortNormalized = normalizeOrtName(ort);
      ortLeistungen[ortNormalized] = (ortLeistungen[ortNormalized] || 0) + 1;
    }
  });
  
  // Pr√ºfe welche Orte DM-Wettk√§mpfe haben
  wettk√§mpfe.forEach(wettkampf => {
    const ort = wettkampf.ort;
    if (ort && ort.trim() !== '') {
      const ortNormalized = normalizeOrtName(ort);
      
      // Pr√ºfe ob Wettkampf "DM" oder "Deutsche Meisterschaft" im Namen hat
      const wettkampfName = wettkampf.wk_bz || '';
      if (wettkampfName.toLowerCase().includes('dm') || 
          wettkampfName.toLowerCase().includes('deutsche meisterschaft') ||
          wettkampfName.toLowerCase().includes('deutschen meisterschaft')) {
        ortHasDM[ortNormalized] = true;
      }
    }
  });
  
  console.log('Leistungen pro Ort:', ortLeistungen);
  console.log('Orte mit DM:', ortHasDM);
  
  // L√∂sche alte Marker
  const markersGroup = document.getElementById('locationMarkers');
  markersGroup.innerHTML = '';
  
  // Erstelle Marker f√ºr jeden Ort
  Object.entries(ortLeistungen).forEach(([ort, count]) => {
    const coords = findOrtKoordinaten(ort);
    
    if (coords) {
      // Konvertiere Lon/Lat zu SVG-Koordinaten
      const svgCoords = lonLatToSVG(coords.lon, coords.lat);
      
      // Bestimme Gr√∂√üe und Farbe basierend auf Anzahl
      let radius, fillColor, strokeColor;
      if (count <= 2) {
        radius = 4;
        fillColor = '#b3d9ff';
        strokeColor = '#66a3d2';
      } else if (count <= 5) {
        radius = 5.5;
        fillColor = '#80bfff';
        strokeColor = '#4d94d9';
      } else if (count <= 10) {
        radius = 7;
        fillColor = '#4da6ff';
        strokeColor = '#3385d6';
      } else if (count <= 20) {
        radius = 8.5;
        fillColor = '#1a8cff';
        strokeColor = '#1a75d2';
      } else {
        radius = 10;
        fillColor = '#0066cc';
        strokeColor = '#004d99';
      }
      
      // Erstelle Kreis
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', svgCoords.x);
      circle.setAttribute('cy', svgCoords.y);
      circle.setAttribute('r', radius);
      circle.setAttribute('data-base-radius', radius); // Speichere Basis-Radius f√ºr Zoom-Kompensation
      circle.setAttribute('fill', fillColor);
      circle.setAttribute('stroke', strokeColor);
      circle.setAttribute('stroke-width', '1.5');
      circle.setAttribute('opacity', '0.8');
      circle.setAttribute('class', 'map-marker'); // Klasse f√ºr Zoom-Updates
      circle.style.cursor = 'pointer';
      circle.style.transition = 'all 0.2s';
      
      // Tooltip Events
      circle.addEventListener('mouseenter', (e) => {
        circle.setAttribute('opacity', '1');
        const currentRadius = parseFloat(circle.getAttribute('r'));
        circle.setAttribute('r', currentRadius * 1.3);
        circle.setAttribute('data-hover', 'true');
        showMapTooltip(e, ort, count);
      });
      
      circle.addEventListener('mousemove', (e) => {
        showMapTooltip(e, ort, count);
      });
      
      circle.addEventListener('mouseleave', () => {
        circle.setAttribute('opacity', '0.8');
        circle.removeAttribute('data-hover');
        // Setze Radius basierend auf aktuellem Zoom zur√ºck
        const baseRadius = parseFloat(circle.getAttribute('data-base-radius'));
        circle.setAttribute('r', baseRadius / mapScale);
        hideMapTooltip();
      });
      
      // Click Event - √∂ffne Leistungen-Tabelle
      circle.addEventListener('click', () => {
        showOrtLeistungen(ort, leistungen);
      });
      
      markersGroup.appendChild(circle);
      
      console.log(`Marker f√ºr ${ort} erstellt: ${count} Leistungen, Radius ${radius}, SVG: (${svgCoords.x.toFixed(1)}, ${svgCoords.y.toFixed(1)})`);
    } else {
      console.warn(`Keine Koordinaten gefunden f√ºr: ${ort}`);
    }
  });
}

// Border data embedded from CSV

// Globale Variablen f√ºr die aktuell angezeigte Orts-Tabelle
let currentOrtLeistungen = [];
let currentOrtName = '';
let ortTableSortColumn = 'datum';
let ortTableSortAsc = false;

// Funktion zum Anzeigen von Leistungen eines Ortes
function showOrtLeistungen(ort, leistungen) {
  currentOrtLeistungen = leistungen.filter(l => normalizeOrtName(l.ort) === ort);
  currentOrtName = ort;
  
  if (currentOrtLeistungen.length === 0) {
    return;
  }
  
  // Sortiere initial nach Datum (neueste zuerst)
  ortTableSortColumn = 'datum';
  ortTableSortAsc = false;
  sortOrtTable();
  
  renderOrtTable();
  
  // Scrolle zur Tabelle
  const ortTable = document.getElementById('ortLeistungenTable');
  if (ortTable) {
    ortTable.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// Sortiere Orts-Tabelle
function sortOrtTable() {
  currentOrtLeistungen.sort((a, b) => {
    let valA = a[ortTableSortColumn];
    let valB = b[ortTableSortColumn];
    
    // Behandle null/undefined Werte
    if (valA === null || valA === undefined) return 1;
    if (valB === null || valB === undefined) return -1;
    
    // Datum-Sortierung
    if (ortTableSortColumn === 'datum') {
      valA = new Date(valA);
      valB = new Date(valB);
    }
    
    // Leistungs-Sortierung (numerisch)
    if (ortTableSortColumn === 'leistung') {
      valA = Number(valA);
      valB = Number(valB);
    }
    
    // String-Sortierung (case-insensitive)
    if (typeof valA === 'string') {
      valA = valA.toLowerCase();
      valB = valB.toLowerCase();
    }
    
    if (valA < valB) return ortTableSortAsc ? -1 : 1;
    if (valA > valB) return ortTableSortAsc ? 1 : -1;
    return 0;
  });
}

// Setze Sortierung f√ºr Orts-Tabelle
function setOrtTableSort(spalte) {
  if (ortTableSortColumn === spalte) {
    ortTableSortAsc = !ortTableSortAsc;
  } else {
    ortTableSortColumn = spalte;
    ortTableSortAsc = true;
  }
  sortOrtTable();
  renderOrtTable();
}

// Rendere Orts-Tabelle
function renderOrtTable() {
  const spalten = [
    { key: 'datum', name: 'Datum' },
    { key: 'disziplin', name: 'Disziplin' },
    { key: 'leistung', name: 'Leistung' },
    { key: 'wk_bz', name: 'Wettkampf' }
  ];
  
  let tableHTML = `
    <div style="animation: slideIn 0.3s ease-out;">
      <h3 class="dashboard-section-title">üìç ${currentOrtName}</h3>
      <div id="ortTableWhiteBox" style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <div style="color: #757575; font-size: 0.95em;">${currentOrtLeistungen.length} ${currentOrtLeistungen.length === 1 ? 'Leistung' : 'Leistungen'}</div>
          <button onclick="hideOrtLeistungen()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">‚úï Schlie√üen</button>
        </div>
        <div class="table-wrapper" id="ortTableScrollArea" style="overflow-y: auto;">
          <table>
            <thead>
              <tr>
  `;
  
  // Header mit Sortier-Pfeilen
  spalten.forEach(col => {
    const pfeil = ortTableSortColumn === col.key ? (ortTableSortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    tableHTML += `<th onclick="setOrtTableSort('${col.key}')" style="cursor: pointer;">${col.name}${pfeil}</th>`;
  });
  
  tableHTML += `
              </tr>
            </thead>
            <tbody>
  `;
  
  // Daten-Zeilen
  currentOrtLeistungen.forEach((leistung) => {
    // Formatiere Datum
    let datumFormatiert = '-';
    if (leistung.datum) {
      datumFormatiert = formatiereDatum(leistung.datum);
    }
    
    // Formatiere Leistung
    let leistungFormatiert = '-';
    if (leistung.leistung !== null && leistung.leistung !== undefined) {
      leistungFormatiert = formatiereLeistung(leistung.leistung, leistung.disziplin);
    }
    
    tableHTML += `
      <tr>
        <td>${datumFormatiert}</td>
        <td>${leistung.disziplin || '-'}</td>
        <td>${leistungFormatiert}</td>
        <td>${leistung.wk_bz || '-'}</td>
      </tr>
    `;
  });
  
  tableHTML += `
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <style>
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  `;
  
  
  // √Ñndere Grid-Layout auf 2 Spalten wenn Tabelle ge√∂ffnet ist (au√üer auf Mobile)
  const isMobile = window.innerWidth <= 768;
  const bottomSection = document.getElementById('bottomSection');
  const mobileContainer = document.getElementById('ortTableMobileContainer');
  let ortTable = document.getElementById('ortLeistungenTable');
  
  if (isMobile) {
    // Auf Mobile: Zeige Tabelle im Mobile-Container (unter der Karte)
    if (!ortTable) {
      ortTable = document.createElement('div');
      ortTable.id = 'ortLeistungenTable';
    }
    // Entferne aus bottomSection falls dort
    if (ortTable.parentElement === bottomSection) {
      ortTable.remove();
    }
    // F√ºge in Mobile Container ein
    mobileContainer.appendChild(ortTable);
    mobileContainer.style.display = 'block';
  } else {
    // Auf Desktop: Zeige Tabelle neben Top 3 Disziplinen
    if (!ortTable) {
      ortTable = document.createElement('div');
      ortTable.id = 'ortLeistungenTable';
    }
    // Entferne aus Mobile Container falls dort
    if (ortTable.parentElement === mobileContainer) {
      ortTable.remove();
    }
    // F√ºge in bottomSection ein
    bottomSection.appendChild(ortTable);
    bottomSection.style.gridTemplateColumns = '1fr 1fr';
    bottomSection.style.alignItems = 'start';
  }
  
  ortTable.innerHTML = tableHTML;
  
  // Warte bis DOM aktualisiert ist, dann gleiche H√∂hen an (nur auf Desktop)
  setTimeout(() => {
    if (!isMobile) {
      const topDisziplinenBox = document.querySelector('#topDisziplinenSection > div');
      const ortTableBox = document.getElementById('ortTableWhiteBox');
      const ortScrollArea = document.getElementById('ortTableScrollArea');
      
      if (topDisziplinenBox && ortTableBox && ortScrollArea) {
        // Hole die H√∂he der Top 3 Disziplinen Box
        const targetHeight = topDisziplinenBox.offsetHeight;
        
        // Setze die Orts-Box auf die gleiche H√∂he
        ortTableBox.style.height = targetHeight + 'px';
        
        // Berechne verf√ºgbare H√∂he f√ºr Scroll-Bereich
        // Ziehe padding und Header-Bereich (mit Button) ab
        const boxPadding = 40; // 20px oben + 20px unten
        const headerHeight = ortTableBox.querySelector('div:first-child').offsetHeight + 15; // +15 f√ºr margin-bottom
        
        const scrollHeight = targetHeight - boxPadding - headerHeight;
        ortScrollArea.style.maxHeight = scrollHeight + 'px';
      }
    } else {
      // Auf Mobile: Entferne fixe H√∂hen
      const ortTableBox = document.getElementById('ortTableWhiteBox');
      const ortScrollArea = document.getElementById('ortTableScrollArea');
      
      if (ortTableBox && ortScrollArea) {
        ortTableBox.style.height = 'auto';
        ortScrollArea.style.maxHeight = '400px'; // Max-H√∂he f√ºr Scroll
      }
    }
  }, 50);
}

function hideOrtLeistungen() {
  const ortTable = document.getElementById('ortLeistungenTable');
  const bottomSection = document.getElementById('bottomSection');
  const mobileContainer = document.getElementById('ortTableMobileContainer');
  
  if (ortTable) {
    ortTable.innerHTML = '';
  }
  
  // Verstecke Mobile Container
  if (mobileContainer) {
    mobileContainer.style.display = 'none';
  }
  
  // Setze Grid zur√ºck auf 1 Spalte
  if (bottomSection) {
    bottomSection.style.gridTemplateColumns = '1fr';
  }
}

function normalizeOrtName(ort) {
  // Handle null/undefined values
  if (!ort) return '';
  
  // Entferne f√ºhrende/nachfolgende Leerzeichen
  let normalized = ort.trim();
  
  // Ersetze Umlaute
  normalized = normalized
    .replace(/√§/g, 'ae')
    .replace(/√∂/g, 'oe')
    .replace(/√º/g, 'ue')
    .replace(/√Ñ/g, 'Ae')
    .replace(/√ñ/g, 'Oe')
    .replace(/√ú/g, 'Ue')
    .replace(/√ü/g, 'ss');
  
  // Erster Buchstabe gro√ü, Rest klein
  normalized = normalized.charAt(0).toUpperCase() + normalized.slice(1).toLowerCase();
  
  return normalized;
}

function findOrtKoordinaten(ort) {
  // Direkter Match
  if (stadtKoordinaten[ort]) {
    return stadtKoordinaten[ort];
  }
  
  // Suche nach √§hnlichen Namen (case-insensitive)
  const ortLower = ort.toLowerCase();
  for (const [stadt, coords] of Object.entries(stadtKoordinaten)) {
    if (stadt.toLowerCase() === ortLower) {
      return coords;
    }
  }
  
  // Suche nach Teil√ºbereinstimmungen
  // Bei mehreren Matches: Bevorzuge s√§chsische Orte (lon > 12.0, lat zwischen 50.0 und 51.5)
  const matches = [];
  for (const [stadt, coords] of Object.entries(stadtKoordinaten)) {
    if (ortLower.includes(stadt.toLowerCase()) || stadt.toLowerCase().includes(ortLower)) {
      matches.push({ stadt, coords });
    }
  }
  
  if (matches.length > 0) {
    // Bevorzuge s√§chsische Orte (Sachsen liegt √∂stlich und im mittleren Breitengrad)
    const sachsenMatch = matches.find(m => m.coords.lon > 12.0 && m.coords.lat >= 50.0 && m.coords.lat <= 51.5);
    if (sachsenMatch) {
      console.log(`Mehrere Matches f√ºr "${ort}" gefunden - w√§hle s√§chsischen Ort: ${sachsenMatch.stadt}`);
      return sachsenMatch.coords;
    }
    return matches[0].coords;
  }
  
  return null;
}

function showMapTooltip(event, ort, count) {
  const tooltip = document.getElementById('mapTooltip');
  const mapContainer = document.getElementById('mapContainer');
  
  tooltip.innerHTML = `
    <strong>${ort}</strong><br>
    ${count} Leistung${count > 1 ? 'en' : ''}
  `;
  
  // Zeige Tooltip erstmal an, um Gr√∂√üe zu messen
  tooltip.style.display = 'block';
  
  const rect = mapContainer.getBoundingClientRect();
  const tooltipRect = tooltip.getBoundingClientRect();
  
  // Standardposition: rechts unten vom Cursor
  let left = event.clientX - rect.left + 10;
  let top = event.clientY - rect.top - 10;
  
  // Pr√ºfe ob Tooltip rechts rausragt
  if (left + tooltipRect.width > rect.width) {
    // Zeige links vom Cursor
    left = event.clientX - rect.left - tooltipRect.width - 10;
  }
  
  // Pr√ºfe ob Tooltip unten rausragt
  if (top + tooltipRect.height > rect.height) {
    // Zeige oberhalb vom Cursor
    top = event.clientY - rect.top - tooltipRect.height - 10;
  }
  
  // Pr√ºfe ob Tooltip links rausragt (nach Korrektur)
  if (left < 0) {
    left = 10; // Mindestabstand zum linken Rand
  }
  
  // Pr√ºfe ob Tooltip oben rausragt (nach Korrektur)
  if (top < 0) {
    top = 10; // Mindestabstand zum oberen Rand
  }
  
  tooltip.style.left = left + 'px';
  tooltip.style.top = top + 'px';
}

function hideMapTooltip() {
  const tooltip = document.getElementById('mapTooltip');
  tooltip.style.display = 'none';
}

function resetMapView() {
  // Setze Zoom und Pan auf Ursprungswerte zur√ºck
  mapScale = 1;
  mapTranslateX = 0;
  mapTranslateY = 0;
  
  updateMapTransform();
  updateMarkerSizes();
}

// Vollbild-Funktion f√ºr die Karte
function toggleMapFullscreen() {
  const mapContainer = document.getElementById('mapContainer');
  const fullscreenBtn = document.querySelector('.map-fullscreen-btn');
  
  if (mapContainer.classList.contains('fullscreen')) {
    // Vollbild verlassen
    mapContainer.classList.remove('fullscreen');
    fullscreenBtn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
      </svg>
    `;
    fullscreenBtn.title = "Vollbild";
  } else {
    // Vollbild aktivieren
    mapContainer.classList.add('fullscreen');
    fullscreenBtn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
      </svg>
    `;
    fullscreenBtn.title = "Vollbild verlassen";
  }
}

// ESC-Taste zum Verlassen des Vollbildmodus
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const mapContainer = document.getElementById('mapContainer');
    if (mapContainer && mapContainer.classList.contains('fullscreen')) {
      toggleMapFullscreen();
    }
  }
});

// Zoom und Pan Funktionalit√§t f√ºr die Karte
let mapScale = 1;
let mapTranslateX = 0;
let mapTranslateY = 0;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;

function zoomMap(event) {
  event.preventDefault();
  
  const map = document.getElementById('germanyMap');
  const container = document.getElementById('mapContainer');
  const rect = container.getBoundingClientRect();
  
  // Mausposition relativ zum Container
  const mouseX = event.clientX - rect.left;
  const mouseY = event.clientY - rect.top;
  
  // Zoom-Faktor
  const zoomIntensity = 0.1;
  const delta = event.deltaY > 0 ? -zoomIntensity : zoomIntensity;
  const newScale = Math.min(Math.max(0.5, mapScale + delta), 5);
  
  // Berechne neue Translation um Mausposition herum zu zoomen
  const scaleChange = newScale / mapScale;
  mapTranslateX = mouseX - scaleChange * (mouseX - mapTranslateX);
  mapTranslateY = mouseY - scaleChange * (mouseY - mapTranslateY);
  
  mapScale = newScale;
  updateMapTransform();
  updateMarkerSizes();
}

function startMapDrag(event) {
  // Ignoriere Drag wenn auf einem Marker geklickt wird
  if (event.target.classList.contains('map-marker')) {
    return;
  }
  
  isDragging = true;
  dragStartX = event.clientX - mapTranslateX;
  dragStartY = event.clientY - mapTranslateY;
  
  const container = document.getElementById('mapContainer');
  container.style.cursor = 'grabbing';
  
  // Event-Listener f√ºr Drag
  document.addEventListener('mousemove', dragMap);
  document.addEventListener('mouseup', stopMapDrag);
}

function dragMap(event) {
  if (!isDragging) return;
  
  event.preventDefault();
  mapTranslateX = event.clientX - dragStartX;
  mapTranslateY = event.clientY - dragStartY;
  
  updateMapTransform();
}

function stopMapDrag() {
  isDragging = false;
  const container = document.getElementById('mapContainer');
  container.style.cursor = 'grab';
  
  document.removeEventListener('mousemove', dragMap);
  document.removeEventListener('mouseup', stopMapDrag);
}

function updateMapTransform() {
  const map = document.getElementById('germanyMap');
  map.style.transform = `translate(${mapTranslateX}px, ${mapTranslateY}px) scale(${mapScale})`;
}

function updateMarkerSizes() {
  // Aktualisiere alle Marker-Gr√∂√üen basierend auf dem aktuellen Zoom
  const markers = document.querySelectorAll('.map-marker');
  markers.forEach(marker => {
    const baseRadius = parseFloat(marker.getAttribute('data-base-radius'));
    const isHovered = marker.getAttribute('data-hover') === 'true';
    
    // Kompensiere Zoom, damit Marker scheinbar gleich gro√ü bleiben
    const adjustedRadius = baseRadius / mapScale;
    
    if (isHovered) {
      marker.setAttribute('r', adjustedRadius * 1.3);
    } else {
      marker.setAttribute('r', adjustedRadius);
    }
    
    // Passe auch Stroke-Width an
    marker.setAttribute('stroke-width', 1.5 / mapScale);
  });
}


// ============================================
// DARK MODE FUNCTIONS
// ============================================

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  
  // Icon √§ndern - SVG statt Emoji
  const iconContainer = document.getElementById('darkModeIcon');
  if (isDark) {
    // Sun icon
    iconContainer.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>`;
  } else {
    // Moon icon
    iconContainer.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>`;
  }
  
  // Speichere Pr√§ferenz
  localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
}

// Dark Mode beim Laden √ºberpr√ºfen
document.addEventListener('DOMContentLoaded', function() {
  const darkMode = localStorage.getItem('darkMode');
  if (darkMode === 'enabled') {
    document.body.classList.add('dark-mode');
    const iconContainer = document.getElementById('darkModeIcon');
    if (iconContainer) {
      iconContainer.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>`;
    }
  }
});


// ============================================
// ZIEL-TRACKER FUNCTIONS
// ============================================

let goals = {}; // Format: { athletId: [ {discipline, current, target}, ... ] }

// Hilfsfunktion: Konvertiere M:SS,ZZ Format zu Sekunden
function timeToSeconds(timeStr) {
  if (typeof timeStr !== 'string') return parseFloat(timeStr);
  
  // Pr√ºfe ob Format M:SS,ZZ oder M:SS.ZZ
  if (timeStr.includes(':')) {
    const parts = timeStr.split(':');
    const minutes = parseInt(parts[0]);
    const seconds = parseFloat(parts[1].replace(',', '.'));
    return minutes * 60 + seconds;
  }
  
  // Sonst einfach als Zahl parsen
  return parseFloat(timeStr.replace(',', '.'));
}

// Hilfsfunktion: Konvertiere Sekunden zu M:SS,ZZ Format (wenn >= 60s)
function secondsToTimeFormat(seconds) {
  if (seconds >= 60) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes}:${secs.toFixed(2).padStart(5, '0').replace('.', ',')}`;
  }
  return seconds.toFixed(2).replace('.', ',');
}

// Hilfsfunktion: Pr√ºfe ob Disziplin eine Zeitdisziplin ist
function isTimeDiscipline(discipline) {
  const lowerDiscipline = discipline.toLowerCase();
  
  // Explizite Nicht-Zeit-Disziplinen
  if (lowerDiscipline.includes('hoch') || 
      lowerDiscipline.includes('stab') ||
      lowerDiscipline.includes('weit') || 
      lowerDiscipline.includes('drei') ||
      lowerDiscipline.includes('kugel') || 
      lowerDiscipline.includes('diskus') ||
      lowerDiscipline.includes('hammer') || 
      lowerDiscipline.includes('speer') ||
      lowerDiscipline.includes('wurf') ||
      lowerDiscipline.includes('sto√ü') ||
      lowerDiscipline.includes('sprung')) {
    return false;
  }
  
  // Zeit-Disziplinen: enthalten 'm' oder 'lauf' oder 'h√ºrd' oder 'x' (f√ºr Staffeln)
  if (lowerDiscipline.match(/\d+\s*m/) || 
      lowerDiscipline.includes('lauf') || 
      lowerDiscipline.includes('h√ºrd') ||
      lowerDiscipline.includes('h√º') ||
      lowerDiscipline.match(/\d+x\d+/)) {
    return true;
  }
  
  return false;
}


function loadGoals() {
  const stored = localStorage.getItem('athletGoals');
  if (stored) {
    goals = JSON.parse(stored);
  }
}

function saveGoals() {
  localStorage.setItem('athletGoals', JSON.stringify(goals));
}

async function updateGoalsTab() {
  const athletId = selectedAthleteId;
  
  if (!athletId) {
    document.getElementById('zieleNoAthlete').style.display = 'block';
    document.getElementById('zieleContent').style.display = 'none';
    return;
  }
  
  document.getElementById('zieleNoAthlete').style.display = 'none';
  document.getElementById('zieleContent').style.display = 'block';
  
  // Athletennamen anzeigen
  const athlete = alleAthleten.find(a => a.Athlet_ID === athletId);
  if (athlete) {
    document.getElementById('zieleAthletName').textContent = `${athlete.Vorname} ${athlete.Nachname}`;
  }
  
  // Disziplin-Dropdown f√ºllen
  await fillGoalDisciplineDropdown();
  
  // Ziele anzeigen
  await displayGoals(athletId);
}

async function fillGoalDisciplineDropdown() {
  const select = document.getElementById('goalDisziplin');
  select.innerHTML = '<option value="">-- Disziplin w√§hlen --</option>';
  
  if (!selectedAthleteId) return;
  
  try {
    // Hole alle Disziplinen des Athleten
    const { data, error } = await supabaseClient
      .schema('la').from('leistung')
      .select('disziplin')
      .eq('athlet_id', selectedAthleteId);
    
    if (error) throw error;
    
    // Eindeutige Disziplinen mit gleicher Sortierung wie im Filter
    const uniqueDisziplinen = [...new Set(data.map(d => d.disziplin))].filter(Boolean);
    const disziplinen = uniqueDisziplinen.map(d => ({ disziplin: d })).sort(sortiereNachDisziplinTyp).map(item => item.disziplin);
    
    disziplinen.forEach(disziplin => {
      const option = document.createElement('option');
      option.value = disziplin;
      option.textContent = disziplin;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Fehler beim Laden der Disziplinen:', error);
  }
}

async function addGoal() {
  const athletId = selectedAthleteId;
  if (!athletId) {
    alert('Bitte w√§hle zuerst einen Athleten aus');
    return;
  }
  
  const discipline = document.getElementById('goalDisziplin').value;
  const goalType = document.getElementById('goalType').value;
  const current = null;
  const targetInput = document.getElementById('goalTarget').value;
  
  if (!discipline || !targetInput) {
    alert('Bitte w√§hle eine Disziplin und gib ein Ziel ein');
    return;
  }
  
  // Konvertiere Ziel zu Sekunden (wenn Zeit-Disziplin und M:SS Format)
  const target = timeToSeconds(targetInput);
  
  // Initialisiere Array falls n√∂tig
  if (!goals[athletId]) {
    goals[athletId] = [];
  }
  
  // Pr√ºfe ob Ziel bereits existiert (gleiche Disziplin UND Typ)
  const existingIndex = goals[athletId].findIndex(g => g.discipline === discipline && g.type === goalType);
  if (existingIndex >= 0) {
    if (!confirm(`F√ºr diese Disziplin existiert bereits ein ${goalType === 'season' ? 'Saisonziel' : 'Karriereziel'}. √úberschreiben?`)) {
      return;
    }
    goals[athletId][existingIndex] = { discipline, current: null, target: target, type: goalType };
  } else {
    goals[athletId].push({
      discipline,
      current: null,
      target: target,
      type: goalType || 'career' // Default zu career falls nicht gesetzt
    });
  }
  
  saveGoals();
  
  // Felder leeren
  document.getElementById('goalDisziplin').value = '';
  document.getElementById('goalTarget').value = '';
  
  await displayGoals(athletId);
}

async function displayGoals(athletId) {
  const container = document.getElementById('goalsList');
  
  if (!goals[athletId] || goals[athletId].length === 0) {
    container.innerHTML = '<div class="no-goals-message">Noch keine Ziele definiert. F√ºge oben ein neues Ziel hinzu! üéØ</div>';
    return;
  }
  
  container.innerHTML = '';
  
  // Hole alle Leistungen des Athleten
  try {
    const { data: leistungen, error } = await supabaseClient
      .schema('la').from('leistung')
      .select('*')
      .eq('athlet_id', athletId)
      .order('datum', { ascending: false });
    
    if (error) throw error;
    
    for (const [index, goal] of goals[athletId].entries()) {
      const card = await createGoalCard(goal, athletId, index, leistungen);
      container.appendChild(card);
    }
  } catch (error) {
    console.error('Fehler beim Laden der Leistungen:', error);
    container.innerHTML = '<div class="no-goals-message">Fehler beim Laden der Daten.</div>';
  }
}

async function createGoalCard(goal, athletId, index, leistungen) {
  const card = document.createElement('div');
  card.className = 'goal-card';
  
  const { discipline, current, target, type } = goal;
  const goalType = type || 'career'; // Default zu career falls nicht gesetzt
  
  // Filtere Leistungen f√ºr diese Disziplin
  const disziplinLeistungen = leistungen
    .filter(l => l.disziplin === discipline)
    .sort((a, b) => new Date(b.datum) - new Date(a.datum));
  
  // Bestimme ob Zeit oder Distanz/H√∂he mit neuer Hilfsfunktion
  const isTime = isTimeDiscipline(discipline);
  
  // Berechne Personal Best (PB) - √ºber alle Zeit
  let pb;
  if (isTime) {
    pb = disziplinLeistungen.length > 0 ? 
         Math.min(...disziplinLeistungen.map(l => parseFloat(l.leistung))) : 
         null;
  } else {
    pb = disziplinLeistungen.length > 0 ? 
         Math.max(...disziplinLeistungen.map(l => parseFloat(l.leistung))) : 
         null;
  }
  
  // Berechne Season Best (SB) - nur aktuelle Saison
  const currentYear = new Date().getFullYear();
  const seasonLeistungen = disziplinLeistungen.filter(l => {
    const year = new Date(l.datum).getFullYear();
    return year === currentYear;
  });
  
  let sb;
  if (seasonLeistungen.length > 0) {
    if (isTime) {
      sb = Math.min(...seasonLeistungen.map(l => parseFloat(l.leistung)));
    } else {
      sb = Math.max(...seasonLeistungen.map(l => parseFloat(l.leistung)));
    }
  } else {
    sb = null;
  }
  
  // Hole die letzten 3 Leistungen
  const last3 = disziplinLeistungen.slice(0, 3).map(l => parseFloat(l.leistung));
  
  // Berechne Ausgangswert basierend auf Zieltyp
  let baselineValue;
  let referenceValue; // F√ºr die Anzeige "noch X vom Ziel"
  let referenceLabel; // Label f√ºr die Referenz
  
  if (goalType === 'season') {
    // SAISONZIEL: Baseline = SB (50%) + letzte 3 Leistungen (25%, 16.5%, 8.5%)
    // Referenz: SB
    referenceValue = sb;
    referenceLabel = 'SB';
    
    if (sb !== null && last3.length > 0) {
      let sum = sb * 0.5;
      let weights = 0.5;
      
      if (last3.length >= 1) {
        sum += last3[0] * 0.25;
        weights += 0.25;
      }
      if (last3.length >= 2) {
        sum += last3[1] * 0.165;
        weights += 0.165;
      }
      if (last3.length >= 3) {
        sum += last3[2] * 0.085;
        weights += 0.085;
      }
      
      baselineValue = sum;
    } else if (sb !== null) {
      baselineValue = sb;
    } else {
      baselineValue = null;
    }
  } else {
    // KARRIEREZIEL: Baseline = PB (50%) + letzte 3 Leistungen (25%, 16.5%, 8.5%)
    // Referenz: PB
    referenceValue = pb;
    referenceLabel = 'PB';
    
    if (pb !== null && last3.length > 0) {
      let sum = pb * 0.5;
      let weights = 0.5;
      
      if (last3.length >= 1) {
        sum += last3[0] * 0.25;
        weights += 0.25;
      }
      if (last3.length >= 2) {
        sum += last3[1] * 0.165;
        weights += 0.165;
      }
      if (last3.length >= 3) {
        sum += last3[2] * 0.085;
        weights += 0.085;
      }
      
      baselineValue = sum;
    } else if (pb !== null) {
      baselineValue = pb;
    } else {
      baselineValue = null;
    }
  }
  
  // Berechne Fortschritt basierend auf Prozentsatz zum Ziel
  let progress, remaining;
  
  if (baselineValue === null) {
    // Keine Daten vorhanden
    progress = 0;
    remaining = target;
  } else if (isTime) {
    // Bei Zeit: Je niedriger desto besser
    if (baselineValue <= target) {
      progress = 100;
      remaining = 0;
    } else {
      progress = (target / baselineValue) * 100;
      remaining = baselineValue - target;
    }
  } else {
    // Bei Distanz/H√∂he: Je h√∂her desto besser
    if (baselineValue >= target) {
      progress = 100;
      remaining = 0;
    } else {
      progress = (baselineValue / target) * 100;
      remaining = target - baselineValue;
    }
  }
  
  // Berechne "Noch X vom Ziel" basierend auf Referenzwert (SB oder PB)
  let remainingFromReference;
  if (referenceValue === null) {
    remainingFromReference = target;
  } else if (isTime) {
    if (referenceValue <= target) {
      remainingFromReference = 0;
    } else {
      remainingFromReference = referenceValue - target;
    }
  } else {
    if (referenceValue >= target) {
      remainingFromReference = 0;
    } else {
      remainingFromReference = target - referenceValue;
    }
  }
  
  // Sicherstellen, dass progress und remaining g√ºltige Zahlen sind
  if (isNaN(progress) || !isFinite(progress)) {
    progress = 0;
  }
  if (isNaN(remaining) || !isFinite(remaining)) {
    remaining = 0;
  }
  if (isNaN(remainingFromReference) || !isFinite(remainingFromReference)) {
    remainingFromReference = 0;
  }
  
  const isComplete = progress >= 100;
  
  // Formatiere Werte
  const formatValue = (val) => {
    if (val === null || val === undefined || isNaN(val)) return 'N/A';
    if (isTime) {
      return secondsToTimeFormat(val) + 's';
    } else {
      return val.toFixed(2) + 'm';
    }
  };
  
  const goalTypeLabel = goalType === 'season' ? 'üåü Saisonziel' : 'üèÜ Karriereziel';
  
  card.innerHTML = `
    <div class="goal-header">
      <div>
        <div class="goal-discipline">${discipline}</div>
        <div class="goal-type-label">${goalTypeLabel}</div>
      </div>
      <div>
        <button class="goal-edit-btn" onclick="editGoal(${athletId}, ${index})">‚úèÔ∏è Bearbeiten</button>
        <button class="goal-delete-btn" onclick="deleteGoal(${athletId}, ${index})">üóëÔ∏è L√∂schen</button>
      </div>
    </div>
    
    <div id="goalContent${athletId}_${index}">
      <div class="goal-values">
      <div class="goal-value-item">
        <div class="goal-value-label">Ausgangswert</div>
        <div class="goal-value-number current">${formatValue(baselineValue)}</div>
        <div class="goal-value-explanation">(${referenceLabel}: ${formatValue(referenceValue)})</div>
      </div>
      <div class="goal-value-item">
        <div class="goal-value-label">Ziel</div>
        <div class="goal-value-number target">${formatValue(target)}</div>
      </div>
      <div class="goal-value-item">
        <div class="goal-value-label">${isComplete ? 'Erreicht!' : 'Noch'}</div>
        <div class="goal-value-number remaining">${isComplete ? '‚úì' : formatValue(remainingFromReference)}</div>
        <div class="goal-value-explanation">(von ${referenceLabel})</div>
      </div>
    </div>
    
    <div class="goal-progress-bar">
      <div class="goal-progress-fill ${isComplete ? 'complete' : ''}" style="width: ${Math.min(100, progress)}%">
        ${isComplete ? 'üéâ Ziel erreicht!' : progress.toFixed(1) + '%'}
      </div>
    </div>
    
    <div class="goal-status">
      ${baselineValue === null ? 
        '‚ö†Ô∏è Keine Leistungsdaten vorhanden' :
        isComplete ? 
          'üèÜ Herzlichen Gl√ºckwunsch! Ziel erreicht!' : 
          isTime ? 
            `Dein ${referenceLabel} muss noch ${formatValue(remainingFromReference)} schneller werden` : 
            `Dein ${referenceLabel} muss noch ${formatValue(remainingFromReference)} weiter/h√∂her sein`
      }
    </div>
  `;
  
  return card;
}

// Funktion zum Bearbeiten eines Ziels
function editGoal(athletId, index) {
  const goal = goals[athletId][index];
  const contentDiv = document.getElementById(`goalContent${athletId}_${index}`);
  
  if (!contentDiv) return;
  
  const isTime = isTimeDiscipline(goal.discipline);
  const targetFormatted = isTime ? secondsToTimeFormat(goal.target) : goal.target.toFixed(2);
  
  contentDiv.innerHTML = `
    <div class="goal-edit-form">
      <div class="form-grid">
        <div class="form-group">
          <label>Zielwert f√ºr ${goal.discipline}</label>
          <input type="text" id="editTarget${athletId}_${index}" value="${targetFormatted}" placeholder="z.B. 11.00 oder 7.50">
        </div>
      </div>
      <div class="button-group">
        <button class="goal-save-btn" onclick="saveEditedGoal(${athletId}, ${index})">üíæ Speichern</button>
        <button class="goal-cancel-btn" onclick="cancelEditGoal(${athletId})">‚ùå Abbrechen</button>
      </div>
    </div>
  `;
}

// Funktion zum Speichern des bearbeiteten Ziels
async function saveEditedGoal(athletId, index) {
  const inputValue = document.getElementById(`editTarget${athletId}_${index}`).value.replace(',', '.');
  const newTarget = parseFloat(inputValue);
  
  if (isNaN(newTarget) || newTarget <= 0) {
    alert('Bitte einen g√ºltigen Zielwert eingeben');
    return;
  }
  
  goals[athletId][index].target = newTarget;
  saveGoals();
  await displayGoals(athletId);
  alert('Ziel erfolgreich aktualisiert!');
}

// Funktion zum Abbrechen der Bearbeitung
async function cancelEditGoal(athletId) {
  await displayGoals(athletId);
}
async function deleteGoal(athletId, index) {
  if (!confirm('M√∂chtest du dieses Ziel wirklich l√∂schen?')) {
    return;
  }
  
  goals[athletId].splice(index, 1);
  saveGoals();
  await displayGoals(athletId);
}

// Funktion zum Anzeigen der Ziele auf dem Dashboard
async function displayDashboardGoals(athletId, leistungen) {
  const section = document.getElementById('dashboardGoalsSection');
  const seasonContainer = document.getElementById('dashboardSeasonGoalsList');
  const careerContainer = document.getElementById('dashboardCareerGoalsList');
  
  if (!goals[athletId] || goals[athletId].length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  
  // Separiere Ziele nach Typ
  const seasonGoals = goals[athletId].filter(g => (g.type || 'career') === 'season');
  const careerGoals = goals[athletId].filter(g => (g.type || 'career') === 'career');
  
  // Rendere Saisonziele
  await renderGoalsToContainer(seasonGoals, seasonContainer, leistungen, athletId, 'season');
  
  // Rendere Karriereziele
  await renderGoalsToContainer(careerGoals, careerContainer, leistungen, athletId, 'career');
}

// Hilfsfunktion zum Rendern von Zielen in einen Container
async function renderGoalsToContainer(goalsArray, container, leistungen, athletId, goalType) {
  if (goalsArray.length === 0) {
    container.innerHTML = `<div class="no-data-message">Keine ${goalType === 'season' ? 'Saisonziele' : 'Karriereziele'} definiert</div>`;
    return;
  }
  
  container.innerHTML = '';
  
  // Berechne Progress f√ºr jedes Ziel und speichere in Array
  const goalsWithProgress = goalsArray.map(goal => {
    const { discipline, target, type } = goal;
    const currentGoalType = type || 'career';
    
    // Filtere Leistungen f√ºr diese Disziplin
    const disziplinLeistungen = leistungen
      .filter(l => l.disziplin === discipline)
      .sort((a, b) => new Date(b.datum) - new Date(a.datum));
    
    // Bestimme ob Zeit oder Distanz/H√∂he
    const isTime = isTimeDiscipline(discipline);
    
    // Berechne Personal Best (PB) - √ºber alle Zeit
    let pb;
    if (isTime) {
      pb = disziplinLeistungen.length > 0 ? 
           Math.min(...disziplinLeistungen.map(l => parseFloat(l.leistung))) : 
           null;
    } else {
      pb = disziplinLeistungen.length > 0 ? 
           Math.max(...disziplinLeistungen.map(l => parseFloat(l.leistung))) : 
           null;
    }
    
    // Berechne Season Best (SB) - nur aktuelle Saison
    const currentYear = new Date().getFullYear();
    const seasonLeistungen = disziplinLeistungen.filter(l => {
      const year = new Date(l.datum).getFullYear();
      return year === currentYear;
    });
    
    let sb;
    if (seasonLeistungen.length > 0) {
      if (isTime) {
        sb = Math.min(...seasonLeistungen.map(l => parseFloat(l.leistung)));
      } else {
        sb = Math.max(...seasonLeistungen.map(l => parseFloat(l.leistung)));
      }
    } else {
      sb = null;
    }
    
    // Hole die letzten 3 Leistungen
    const last3 = disziplinLeistungen.slice(0, 3).map(l => parseFloat(l.leistung));
    
    // Berechne Ausgangswert basierend auf Zieltyp
    let baselineValue;
    let referenceValue;
    
    if (currentGoalType === 'season') {
      // SAISONZIEL: Baseline = SB (50%) + letzte 3 Leistungen
      referenceValue = sb;
      
      if (sb !== null && last3.length > 0) {
        let sum = sb * 0.5;
        
        if (last3.length >= 1) {
          sum += last3[0] * 0.25;
        }
        if (last3.length >= 2) {
          sum += last3[1] * 0.165;
        }
        if (last3.length >= 3) {
          sum += last3[2] * 0.085;
        }
        
        baselineValue = sum;
      } else if (sb !== null) {
        baselineValue = sb;
      } else {
        baselineValue = null;
      }
    } else {
      // KARRIEREZIEL: Baseline = PB (50%) + letzte 3 Leistungen
      referenceValue = pb;
      
      if (pb !== null && last3.length > 0) {
        let sum = pb * 0.5;
        
        if (last3.length >= 1) {
          sum += last3[0] * 0.25;
        }
        if (last3.length >= 2) {
          sum += last3[1] * 0.165;
        }
        if (last3.length >= 3) {
          sum += last3[2] * 0.085;
        }
        
        baselineValue = sum;
      } else if (pb !== null) {
        baselineValue = pb;
      } else {
        baselineValue = null;
      }
    }
    
    // Berechne Fortschritt
    let progress = 0;
    if (baselineValue !== null) {
      if (isTime) {
        if (baselineValue <= target) {
          progress = 100;
        } else {
          progress = (target / baselineValue) * 100;
        }
      } else {
        if (baselineValue >= target) {
          progress = 100;
        } else {
          progress = (baselineValue / target) * 100;
        }
      }
    }
    
    // Sicherstellen, dass progress eine g√ºltige Zahl ist
    if (isNaN(progress) || !isFinite(progress)) {
      progress = 0;
    }
    
    return {
      goal,
      discipline,
      target,
      baselineValue,
      referenceValue,
      progress,
      isTime,
      pb,
      sb,
      last3
    };
  });
  
  // Sortiere nach Fortschritt (h√∂chster Prozentsatz zuerst)
  goalsWithProgress.sort((a, b) => b.progress - a.progress);
  
  // Entscheide ob vertikales Layout
  const useVertical = goalsWithProgress.length > 3;
  if (useVertical) {
    container.classList.add('vertical-layout');
  } else {
    container.classList.remove('vertical-layout');
  }
  
  // Rendere die sortierten Ziele
  for (const goalData of goalsWithProgress) {
    const { discipline, target, baselineValue, referenceValue, progress, isTime, goal } = goalData;
    
    const card = document.createElement('div');
    card.className = 'dashboard-goal-card';
    
    const isComplete = progress >= 100;
    
    // Berechne verbleibende Distanz/Zeit von Referenzwert
    let remaining;
    if (referenceValue === null) {
      remaining = target;
    } else if (isTime) {
      remaining = referenceValue > target ? referenceValue - target : 0;
    } else {
      remaining = referenceValue < target ? target - referenceValue : 0;
    }
    
    // Formatiere Werte
    const formatValue = (val) => {
      if (val === null || val === undefined || isNaN(val)) return 'N/A';
      if (isTime) {
        return secondsToTimeFormat(val) + 's';
      } else {
        return val.toFixed(2) + 'm';
      }
    };
    
    // Entscheide ob vertikaler oder horizontaler Fortschrittsbalken
    const progressBarClass = useVertical ? 'dashboard-goal-progress-bar vertical' : 'dashboard-goal-progress-bar';
    const progressFillClass = `dashboard-goal-progress-fill ${useVertical ? 'vertical' : ''} ${isComplete ? 'complete' : ''}`;
    const progressStyle = useVertical ? `height: ${Math.min(100, progress)}%` : `width: ${Math.min(100, progress)}%`;
    
    const referenceLabel = (goal.type || 'career') === 'season' ? 'SB' : 'PB';
    
    card.innerHTML = `
      <div class="dashboard-goal-header">
        <div class="dashboard-goal-discipline">${discipline}</div>
        <div class="dashboard-goal-percentage">${progress.toFixed(1)}%</div>
      </div>
      <div class="${progressBarClass}">
        <div class="${progressFillClass}" style="${progressStyle}"></div>
      </div>
      <div class="dashboard-goal-details">
        <div>Baseline: ${formatValue(baselineValue)}</div>
        <div>Ziel: ${formatValue(target)}</div>
      </div>
      ${!isComplete && referenceValue !== null ? `
        <div style="text-align: center; margin-top: 8px; font-size: 0.85em; color: var(--text-muted); font-style: italic;">
          ${referenceLabel}: ${formatValue(referenceValue)}<br>
          ${isTime ? 
            `Noch ${formatValue(remaining)} schneller` : 
            `Noch ${formatValue(remaining)} weiter`
          }
        </div>
      ` : ''}
    `;
    
    container.appendChild(card);
  }
}


// Initialisiere Goals beim Laden
loadGoals();


// ============================================
// LOGIN SYSTEM
// ============================================




// ========== RESET FUNKTION ==========
function resetAllFiltersAndSettings() {
  console.log('üîÑ Resetze alle Filter und Einstellungen...');
  
  // FILTER ZUR√úCKSETZEN - Leistungen
  const filterElemente = [
    'filterDisziplin', 'filterOrt', 'filterJahr', 'filterMonat',
    'filterWettkampftyp', 'filterWind', 'filterHandgestoppt'
  ];
  
  filterElemente.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.value = '';
    }
  });
  
  // SPALTENAUSWAHL ZUR√úCKSETZEN
  const spaltenCheckboxen = document.querySelectorAll("#leistungenTab .spalte");
  spaltenCheckboxen.forEach(cb => {
    if (cb.value === 'disziplin' || cb.value === 'leistung' || cb.value === 'datum') {
      cb.checked = true; // Standardspalten aktivieren
    } else {
      cb.checked = false;
    }
  });
  
  // ANALYSE-FILTER ZUR√úCKSETZEN
  const analyseDisziplin = document.getElementById('analyseDisziplin');
  if (analyseDisziplin) analyseDisziplin.value = '';
  
  const analyseZeitraum = document.getElementById('analyseZeitraum');
  if (analyseZeitraum) analyseZeitraum.value = '';
  
  const vergleichsModus = document.getElementById('vergleichsModus');
  if (vergleichsModus) vergleichsModus.checked = false;
  
  const vergleichsDisziplin = document.getElementById('vergleichsDisziplin');
  if (vergleichsDisziplin) {
    vergleichsDisziplin.value = '';
    // Nicht verstecken, nur zur√ºcksetzen
  }
  
  // SB-FILTER ZUR√úCKSETZEN
  const sbDisziplin = document.getElementById('sbDisziplin');
  if (sbDisziplin) sbDisziplin.value = '';
  
  const sbVergleichsModus = document.getElementById('sbVergleichsModus');
  if (sbVergleichsModus) sbVergleichsModus.checked = false;
  
  const sbVergleichsDisziplin = document.getElementById('sbVergleichsDisziplin');
  if (sbVergleichsDisziplin) {
    sbVergleichsDisziplin.value = '';
    // Nicht verstecken, nur zur√ºcksetzen
  }
  
  // SB-ZEITRAUM-FILTER ZUR√úCKSETZEN
  const sbFilterFrom = document.getElementById('sbFilterFrom');
  if (sbFilterFrom) sbFilterFrom.value = '';
  
  const sbFilterTo = document.getElementById('sbFilterTo');
  if (sbFilterTo) sbFilterTo.value = '';
  
  const sbFilterJahr = document.getElementById('sbFilterJahr');
  if (sbFilterJahr) sbFilterJahr.value = '';
  
  // STATISTIK-FILTER ZUR√úCKSETZEN
  const statistikFilterDisziplin = document.getElementById('statistikFilterDisziplin');
  if (statistikFilterDisziplin) statistikFilterDisziplin.value = '';
  
  const statistikFilterZeitraum = document.getElementById('statistikFilterZeitraum');
  if (statistikFilterZeitraum) statistikFilterZeitraum.value = 'alle';
  
  const statistikCustomDateRange = document.getElementById('statistikCustomDateRange');
  if (statistikCustomDateRange) statistikCustomDateRange.style.display = 'none';
  
  const statistikVonDatum = document.getElementById('statistikVonDatum');
  if (statistikVonDatum) statistikVonDatum.value = '';
  
  const statistikBisDatum = document.getElementById('statistikBisDatum');
  if (statistikBisDatum) statistikBisDatum.value = '';
  
  // BESTLEISTUNGEN-FILTER ZUR√úCKSETZEN
  const bestleistungenFilterDisziplin = document.getElementById('bestleistungenFilterDisziplin');
  if (bestleistungenFilterDisziplin) bestleistungenFilterDisziplin.value = '';
  
  const bestleistungenFilterZeitraum = document.getElementById('bestleistungenFilterZeitraum');
  if (bestleistungenFilterZeitraum) bestleistungenFilterZeitraum.value = 'alle';
  
  const bestleistungenCustomDateRange = document.getElementById('bestleistungenCustomDateRange');
  if (bestleistungenCustomDateRange) bestleistungenCustomDateRange.style.display = 'none';
  
  const bestleistungenVonDatum = document.getElementById('bestleistungenVonDatum');
  if (bestleistungenVonDatum) bestleistungenVonDatum.value = '';
  
  const bestleistungenBisDatum = document.getElementById('bestleistungenBisDatum');
  if (bestleistungenBisDatum) bestleistungenBisDatum.value = '';
  
  // DIAGRAMME ZERST√ñREN
  if (window.chartInstance) {
    window.chartInstance.destroy();
    window.chartInstance = null;
  }
  
  if (window.sbChartInstance) {
    window.sbChartInstance.destroy();
    window.sbChartInstance = null;
  }
  
  // DIAGRAMM-CONTAINER LEEREN
  const diagrammContainer = document.getElementById('diagrammContainer');
  if (diagrammContainer) diagrammContainer.innerHTML = '<canvas id="leistungsChart"></canvas>';
  
  const sbDiagrammContainer = document.getElementById('sbDiagrammContainer');
  if (sbDiagrammContainer) sbDiagrammContainer.innerHTML = '<canvas id="sbChart"></canvas>';
  
  
  if (window.prognoseChartInstance) {
    window.prognoseChartInstance.destroy();
    window.prognoseChartInstance = null;
  }
  
  const prognoseDiagrammContainer = document.getElementById('prognoseDiagrammContainer');
  if (prognoseDiagrammContainer) {
    prognoseDiagrammContainer.style.display = 'none';
    // Finde den Chart-Container (div mit height: 400px)
    const chartContainerDiv = prognoseDiagrammContainer.querySelector('div[style*="height"]');
    if (chartContainerDiv) {
      chartContainerDiv.innerHTML = '<canvas id="prognoseChart"></canvas>';
    }
  }
  
  // PROGNOSE-FILTER ZUR√úCKSETZEN
  const prognoseDisziplin = document.getElementById('prognoseDisziplin');
  if (prognoseDisziplin) prognoseDisziplin.value = '';
  
  const prognoseZeitraumRadios = document.getElementsByName('prognoseZeitraum');
  if (prognoseZeitraumRadios.length > 0) {
    prognoseZeitraumRadios[0].checked = true;
  }
  
  // PROGNOSE-BUTTONS ZUR√úCKSETZEN
  const prognoseDiagrammAnzeigenBtn = document.getElementById('prognoseDiagrammAnzeigenBtn');
  const prognoseDiagrammAktualisierenBtn = document.getElementById('prognoseDiagrammAktualisierenBtn');
  const prognoseDiagrammSchlie√üenBtn = document.getElementById('prognoseDiagrammSchlie√üenBtn');
  const prognoseDiagrammAusklappenBtn = document.getElementById('prognoseDiagrammAusklappenBtn');
  
  if (prognoseDiagrammAnzeigenBtn) prognoseDiagrammAnzeigenBtn.style.display = 'inline-block';
  if (prognoseDiagrammAktualisierenBtn) prognoseDiagrammAktualisierenBtn.style.display = 'none';
  if (prognoseDiagrammSchlie√üenBtn) prognoseDiagrammSchlie√üenBtn.style.display = 'none';
  if (prognoseDiagrammAusklappenBtn) prognoseDiagrammAusklappenBtn.style.display = 'none';
  
  console.log('‚úÖ Alle Filter und Einstellungen wurden zur√ºckgesetzt');
}

// ========== KOMPAKTE ATHLETENSUCHE (f√ºr Admins) ==========
function initCompactAthleteSearch() {
  console.log('üîç initCompactAthleteSearch aufgerufen');
  const searchInput = document.getElementById('compactAthletSuche');
  const suggestionsDiv = document.getElementById('compactAthletVorschlaege');
  
  if (!searchInput) {
    console.log('‚ö†Ô∏è CompactAthletSuche nicht gefunden - √ºberspringe Initialisierung');
    return;
  }
  
  console.log('‚úÖ Event Listener wird hinzugef√ºgt...');
  
  searchInput.addEventListener('input', async function(e) {
    const query = this.value.trim().toLowerCase();
    console.log('üîé Input Event! Query:', query);
    
    if (query.length < 2) {
      suggestionsDiv.innerHTML = '';
      suggestionsDiv.classList.remove('show');
      return;
    }
    
    try {
      const { data, error } = await supabaseClient
        .schema('la').from('athlet')
        .select('*')
        .or(`vorname.ilike.%${query}%,name.ilike.%${query}%`)
        .order('name');
      
      if (error) {
        console.error('‚ùå Supabase Error:', error);
        throw error;
      }
      
      if (data && data.length > 0) {
        console.log(`‚úÖ ${data.length} Athleten gefunden`);
        suggestionsDiv.innerHTML = data.map(athlete => `
          <div class="suggestion-item" onclick="selectCompactAthlete(${athlete.id}, '${athlete.vorname.replace(/'/g, "\\'")}', '${athlete.name.replace(/'/g, "\\'")}', ${athlete.jahrgang})">
            ${athlete.vorname} ${athlete.name} (${athlete.jahrgang})
          </div>
        `).join('');
        suggestionsDiv.classList.add('show');
      } else {
        suggestionsDiv.innerHTML = '<div class="suggestion-item">Keine Athleten gefunden</div>';
        suggestionsDiv.classList.add('show');
      }
    } catch (err) {
      console.error('‚ùå Fehler beim Laden der Athleten:', err);
      suggestionsDiv.innerHTML = '<div class="suggestion-item">Fehler beim Laden</div>';
      suggestionsDiv.classList.add('show');
    }
  });
  
  // Schlie√üe Vorschl√§ge bei Klick au√üerhalb
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.compact-athlete-search')) {
      suggestionsDiv.classList.remove('show');
    }
  });
  
  console.log('‚úÖ initCompactAthleteSearch abgeschlossen');
}

function selectCompactAthlete(id, vorname, name, jahrgang) {
  // RESET ALLE EINSTELLUNGEN vor dem Wechsel
  resetAllFiltersAndSettings();

  // Setze den ausgew√§hlten Athleten
  selectedAthleteId = id;
  selectedAthleteName = `${vorname} ${name}`;
  
  // Aktualisiere kompakte Anzeige
  const compactSearch = document.getElementById('compactAthleteSearch');
  const searchInput = document.getElementById('compactAthletSuche');
  const suggestionsDiv = document.getElementById('compactAthletVorschlaege');
  const selectedInfo = document.getElementById('compactSelectedInfo');
  const athletName = document.getElementById('compactAthletName');
  
  if (compactSearch) compactSearch.classList.add('has-selection');
  if (searchInput) searchInput.value = '';
  if (suggestionsDiv) suggestionsDiv.classList.remove('show');
  if (selectedInfo) selectedInfo.style.display = 'flex';
  if (athletName) athletName.textContent = `${vorname} ${name} (${jahrgang})`;
  
  // Lade Daten f√ºr den neuen Athleten
  console.log('üìä Lade Daten f√ºr Athlet:', selectedAthleteId);
  ladeLeistungen();
  ladeDashboardDaten();
}

function clearCompactAthlete() {
  // Setze zur√ºck zum eigenen Profil
  if (currentAthlete) {
    selectedAthleteId = currentAthlete.id;
    selectedAthleteName = `${currentAthlete.vorname} ${currentAthlete.name}`;
  }
  
  // Aktualisiere kompakte Anzeige
  const compactSearch = document.getElementById('compactAthleteSearch');
  const searchInput = document.getElementById('compactAthletSuche');
  const selectedInfo = document.getElementById('compactSelectedInfo');
  
  if (compactSearch) compactSearch.classList.remove('has-selection');
  if (searchInput) searchInput.value = '';
  if (selectedInfo) selectedInfo.style.display = 'none';
  
  // Lade eigene Daten
  ladeLeistungen();
  ladeDashboardDaten();
}

// Event-Listener f√ºr benutzerdefinierte Datumsbereiche
document.addEventListener('DOMContentLoaded', function() {
  // Statistik Filter
  const statistikZeitraumSelect = document.getElementById('statistikFilterZeitraum');
  if (statistikZeitraumSelect) {
    statistikZeitraumSelect.addEventListener('change', function() {
      const customDateRange = document.getElementById('statistikCustomDateRange');
      if (this.value === 'custom') {
        customDateRange.style.display = 'block';
      } else {
        customDateRange.style.display = 'none';
      }
    });
  }
  
  // Bestleistungen Filter
  const bestlZeitraumSelect = document.getElementById('bestleistungenFilterZeitraum');
  if (bestlZeitraumSelect) {
    bestlZeitraumSelect.addEventListener('change', function() {
      const customDateRange = document.getElementById('bestleistungenCustomDateRange');
      if (this.value === 'custom') {
        customDateRange.style.display = 'block';
      } else {
        customDateRange.style.display = 'none';
      }
    });
  }
});

/* ================= NEUE STATISTIK-FUNKTIONEN ================= */

// üéØ Erfolgsquote
async function berechneErfolgsquote() {
  if (!selectedAthleteId) {
    alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!');
    return;
  }
  
  // Hole Filter
  const disziplin = document.getElementById("statistikFilterDisziplin").value;
  const ort = document.getElementById("statistikFilterOrt").value;
  const wk = document.getElementById("statistikFilterWK").value;
  const ak = document.getElementById("statistikFilterAK").value;
  const filterTyp = document.getElementById("statistikFilterTyp").value;
  const ms = document.getElementById("statistikFilterMS").value;
  const filterZeitraum = document.getElementById("statistikFilterZeitraum").value;
  
  // Baue Query
  let query = supabaseClient
    .schema("la").from("leistung")
    .select("*")
    .eq("athlet_id", selectedAthleteId)
    .not("platzierung", "is", null);
  
  if (disziplin) query = query.ilike("disziplin", `%${disziplin}%`);
  if (ort) query = query.ilike("ort", `%${ort}%`);
  if (wk) query = query.ilike("wk_bz", `%${wk}%`);
  if (ak) query = query.ilike("ak", `%${ak}%`);
  if (filterTyp) query = query.eq("typ", filterTyp);
  if (ms) query = query.eq("ms", ms);
  
  if (filterZeitraum === 'custom') {
    const von = document.getElementById("statistikFilterVon").value;
    const bis = document.getElementById("statistikFilterBis").value;
    if (von) query = query.gte("datum", von);
    if (bis) query = query.lte("datum", bis);
  } else if (filterZeitraum) {
    query = query.gte("datum", `${filterZeitraum}-01-01`).lte("datum", `${filterZeitraum}-12-31`);
  }
  
  const { data, error } = await query;
  
  if (error) {
    alert(`‚ùå Fehler: ${error.message}`);
    return;
  }
  
  if (!data || data.length === 0) {
    alert('üì≠ Keine Leistungen mit Platzierungen gefunden');
    return;
  }
  
  // Berechne Erfolgsquoten
  const gesamt = data.length;
  const podium = data.filter(l => l.platzierung <= 3).length;
  const top6 = data.filter(l => l.platzierung <= 6).length;
  const siege = data.filter(l => l.platzierung === 1).length;
  
  const podiumProzent = ((podium / gesamt) * 100).toFixed(1);
  const top6Prozent = ((top6 / gesamt) * 100).toFixed(1);
  const siegProzent = ((siege / gesamt) * 100).toFixed(1);
  
  // Erstelle HTML-Ausgabe
  const html = `
    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #2a5298; margin: 0;">Erfolgsquote</h3>
        <button onclick="document.getElementById('analyseAusgabe').innerHTML = ''; enableTableResize();" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">‚úï Schlie√üen</button>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 15px; border-radius: 8px; color: white;">
          <div style="font-size: 2em; font-weight: bold;">${siegProzent}%</div>
          <div style="font-size: 0.9em; margin-top: 5px;">ü•á Siegquote (${siege} Siege)</div>
        </div>
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 8px; color: white;">
          <div style="font-size: 2em; font-weight: bold;">${podiumProzent}%</div>
          <div style="font-size: 0.9em; margin-top: 5px;">üèÜ Podiumspl√§tze (${podium} / ${gesamt})</div>
        </div>
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; color: white;">
          <div style="font-size: 2em; font-weight: bold;">${top6Prozent}%</div>
          <div style="font-size: 0.9em; margin-top: 5px;">‚≠ê Top-6-Platzierungen (${top6} / ${gesamt})</div>
        </div>
      </div>
      <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
        <strong>üìä Gesamt:</strong> ${gesamt} Leistungen mit Platzierungen
      </div>
    </div>
  `;
  
  document.getElementById("analyseAusgabe").innerHTML = html;
  document.getElementById("analyseExportBtn").style.display = "none";
}

// üìÖ Saisonvergleich
async function zeigeSaisonvergleich() {
  if (!selectedAthleteId) {
    alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!');
    return;
  }
  
  // Hole Filter (au√üer Zeitraum)
  const disziplin = document.getElementById("statistikFilterDisziplin").value;
  const ort = document.getElementById("statistikFilterOrt").value;
  const wk = document.getElementById("statistikFilterWK").value;
  const ak = document.getElementById("statistikFilterAK").value;
  const filterTyp = document.getElementById("statistikFilterTyp").value;
  const ms = document.getElementById("statistikFilterMS").value;
  
  // Baue Query
  let query = supabaseClient
    .schema("la").from("leistung")
    .select("*")
    .eq("athlet_id", selectedAthleteId)
    .not("leistung", "is", null);
  
  if (disziplin) query = query.ilike("disziplin", `%${disziplin}%`);
  if (ort) query = query.ilike("ort", `%${ort}%`);
  if (wk) query = query.ilike("wk_bz", `%${wk}%`);
  if (ak) query = query.ilike("ak", `%${ak}%`);
  if (filterTyp) query = query.eq("typ", filterTyp);
  if (ms) query = query.eq("ms", ms);
  
  const { data, error } = await query;
  
  if (error) {
    alert(`‚ùå Fehler: ${error.message}`);
    return;
  }
  
  if (!data || data.length === 0) {
    alert('üì≠ Keine Leistungen gefunden');
    return;
  }
  
  // Gruppiere nach Jahr
  const jahresStats = {};
  
  data.forEach(zeile => {
    if (!zeile.datum) return;
    const jahr = zeile.datum.split('-')[0];
    
    if (!jahresStats[jahr]) {
      jahresStats[jahr] = {
        leistungen: [],
        platzierungen: [],
        alleLeistungen: []
      };
    }
    
    jahresStats[jahr].alleLeistungen.push(zeile);
    
    if (zeile.leistung !== null) {
      const leistungNorm = normalizeLeistung(zeile.leistung, zeile.disziplin);
      jahresStats[jahr].leistungen.push(leistungNorm);
    }
    
    if (zeile.platzierung !== null) {
      jahresStats[jahr].platzierungen.push(parseFloat(zeile.platzierung));
    }
  });
  
  // Berechne Wettkampfanzahl pro Jahr
  Object.keys(jahresStats).forEach(jahr => {
    jahresStats[jahr].wettkampfAnzahl = z√§hleWettk√§mpfe(jahresStats[jahr].alleLeistungen);
  });
  
  // Berechne Durchschnitte pro Jahr
  const jahresArray = Object.keys(jahresStats).sort();
  let html = `
    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #2a5298; margin: 0;">üìÖ Saisonvergleich</h3>
        <button onclick="document.getElementById('analyseAusgabe').innerHTML = ''; enableTableResize();" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">‚úï Schlie√üen</button>
      </div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <th style="padding: 12px; text-align: left;">Jahr</th>
              <th style="padding: 12px; text-align: center;">Wettk√§mpfe</th>
              <th style="padding: 12px; text-align: center;">√ò Platzierung</th>
            </tr>
          </thead>
          <tbody>
  `;
  
  jahresArray.forEach((jahr, index) => {
    const stats = jahresStats[jahr];
    
    const avgPlatzierung = stats.platzierungen.length > 0
      ? (stats.platzierungen.reduce((a, b) => a + b, 0) / stats.platzierungen.length).toFixed(2)
      : 'N/A';
    
    const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
    
    html += `
      <tr style="background: ${bgColor};">
        <td style="padding: 12px;">${jahr}</td>
        <td style="padding: 12px; text-align: center;">${stats.wettkampfAnzahl}</td>
        <td style="padding: 12px; text-align: center;">${avgPlatzierung}</td>
      </tr>
    `;
  });
  
  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  document.getElementById("analyseAusgabe").innerHTML = html;
  document.getElementById("analyseExportBtn").style.display = "none";
}

// üóìÔ∏è Wettkampffrequenz
async function zeigeWettkampffrequenz() {
  if (!selectedAthleteId) {
    alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!');
    return;
  }
  
  // Hole Filter
  const disziplin = document.getElementById("statistikFilterDisziplin").value;
  const ort = document.getElementById("statistikFilterOrt").value;
  const wk = document.getElementById("statistikFilterWK").value;
  const ak = document.getElementById("statistikFilterAK").value;
  const filterTyp = document.getElementById("statistikFilterTyp").value;
  const ms = document.getElementById("statistikFilterMS").value;
  const filterZeitraum = document.getElementById("statistikFilterZeitraum").value;
  
  // Baue Query
  let query = supabaseClient
    .schema("la").from("leistung")
    .select("*")
    .eq("athlet_id", selectedAthleteId)
    .not("datum", "is", null)
    .order("datum", { ascending: true });
  
  if (disziplin) query = query.ilike("disziplin", `%${disziplin}%`);
  if (ort) query = query.ilike("ort", `%${ort}%`);
  if (wk) query = query.ilike("wk_bz", `%${wk}%`);
  if (ak) query = query.ilike("ak", `%${ak}%`);
  if (filterTyp) query = query.eq("typ", filterTyp);
  if (ms) query = query.eq("ms", ms);
  
  if (filterZeitraum === 'custom') {
    const von = document.getElementById("statistikFilterVon").value;
    const bis = document.getElementById("statistikFilterBis").value;
    if (von) query = query.gte("datum", von);
    if (bis) query = query.lte("datum", bis);
  } else if (filterZeitraum) {
    query = query.gte("datum", `${filterZeitraum}-01-01`).lte("datum", `${filterZeitraum}-12-31`);
  }
  
  const { data, error } = await query;
  
  if (error) {
    alert(`‚ùå Fehler: ${error.message}`);
    return;
  }
  
  if (!data || data.length === 0) {
    alert('üì≠ Keine Leistungen gefunden');
    return;
  }
  
  // Gruppiere nach Wettk√§mpfen (gleiche wk_bz im selben Jahr)
  const wettk√§mpfe = gruppiereNachWettk√§mpfen(data);
  
  if (wettk√§mpfe.length === 0) {
    alert('üì≠ Keine Wettk√§mpfe mit wk_bz gefunden');
    return;
  }
  
  // Sortiere Wettk√§mpfe nach Datum
  const wettkampfDaten = wettk√§mpfe.map(wk => wk.datum).sort();
  
  // Berechne Abst√§nde zwischen Wettk√§mpfen
  const abstaende = [];
  for (let i = 1; i < wettkampfDaten.length; i++) {
    const datum1 = new Date(wettkampfDaten[i - 1]);
    const datum2 = new Date(wettkampfDaten[i]);
    const diffTage = Math.round((datum2 - datum1) / (1000 * 60 * 60 * 24));
    abstaende.push(diffTage);
  }
  
  const durchschnittAbstand = abstaende.length > 0 
    ? (abstaende.reduce((a, b) => a + b, 0) / abstaende.length).toFixed(1)
    : 'N/A';
  
  // Gruppiere nach Jahr
  const jahresStats = {};
  
  wettk√§mpfe.forEach(wk => {
    const jahr = wk.jahr;
    jahresStats[jahr] = (jahresStats[jahr] || 0) + 1;
  });
  
  // Finde aktivstes Jahr
  const aktivstesJahr = Object.entries(jahresStats).reduce((max, current) => 
    current[1] > max[1] ? current : max
  );
  
  // Erstelle HTML
  let html = `
    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #2a5298; margin: 0;">üóìÔ∏è Wettkampffrequenz</h3>
        <button onclick="document.getElementById('analyseAusgabe').innerHTML = ''; enableTableResize();" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">‚úï Schlie√üen</button>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; color: white;">
          <div style="font-size: 2em; font-weight: bold;">${wettk√§mpfe.length}</div>
          <div style="font-size: 0.9em; margin-top: 5px;">üìä Gesamt Wettk√§mpfe</div>
        </div>
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 8px; color: white;">
          <div style="font-size: 2em; font-weight: bold;">${durchschnittAbstand}</div>
          <div style="font-size: 0.9em; margin-top: 5px;">‚è±Ô∏è √ò Tage zwischen Wettk√§mpfen</div>
        </div>
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 8px; color: white;">
          <div style="font-size: 2em; font-weight: bold;">${aktivstesJahr[1]}</div>
          <div style="font-size: 0.9em; margin-top: 5px;">üî• Aktivstes Jahr: ${aktivstesJahr[0]}</div>
        </div>
      </div>
      
      <h4 style="color: #2a5298; margin: 20px 0 10px 0;">Wettk√§mpfe pro Jahr:</h4>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
  `;
  
  Object.entries(jahresStats).sort().forEach(([jahr, anzahl]) => {
    const prozent = (anzahl / wettk√§mpfe.length * 100).toFixed(1);
    html += `
      <div style="margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span style="font-weight: bold;">${jahr}</span>
          <span>${anzahl} Wettk√§mpfe (${prozent}%)</span>
        </div>
        <div style="background: #ddd; border-radius: var(--border-radius); height: 20px; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${prozent}%; transition: width 0.3s;"></div>
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  document.getElementById("analyseAusgabe").innerHTML = html;
  document.getElementById("analyseExportBtn").style.display = "none";
}

// üèÖ PB-Timeline
async function zeigePBTimeline() {
  if (!selectedAthleteId) {
    alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst einen Athleten aus!');
    return;
  }
  
  // Hole Filter
  const disziplin = document.getElementById("bestleistungenFilterDisziplin").value;
  const ort = document.getElementById("bestleistungenFilterOrt").value;
  const wk = document.getElementById("bestleistungenFilterWK").value;
  const ak = document.getElementById("bestleistungenFilterAK").value;
  const filterTyp = document.getElementById("bestleistungenFilterTyp").value;
  const ms = document.getElementById("bestleistungenFilterMS").value;
  const filterZeitraum = document.getElementById("bestleistungenFilterZeitraum").value;
  
  // Baue Query
  let query = supabaseClient
    .schema("la").from("leistung")
    .select("*")
    .eq("athlet_id", selectedAthleteId)
    .not("leistung", "is", null);
  
  if (disziplin) query = query.ilike("disziplin", `%${disziplin}%`);
  if (ort) query = query.ilike("ort", `%${ort}%`);
  if (wk) query = query.ilike("wk_bz", `%${wk}%`);
  if (ak) query = query.ilike("ak", `%${ak}%`);
  if (filterTyp) query = query.eq("typ", filterTyp);
  if (ms) query = query.eq("ms", ms);
  
  if (filterZeitraum === 'custom') {
    const von = document.getElementById("bestleistungenFilterVon").value;
    const bis = document.getElementById("bestleistungenFilterBis").value;
    if (von) query = query.gte("datum", von);
    if (bis) query = query.lte("datum", bis);
  } else if (filterZeitraum) {
    query = query.gte("datum", `${filterZeitraum}-01-01`).lte("datum", `${filterZeitraum}-12-31`);
  }
  
  const { data, error } = await query;
  
  if (error) {
    alert(`‚ùå Fehler: ${error.message}`);
    return;
  }
  
  if (!data || data.length === 0) {
    alert('üì≠ Keine Leistungen gefunden');
    return;
  }
  
  // Finde All-Time PB pro Disziplin
  const disziplinPBs = {};
  
  data.forEach(zeile => {
    const disziplin = zeile.disziplin;
    if (!disziplin) return;
    
    zeile.leistung = normalizeLeistung(zeile.leistung, disziplin);
    const disziplinLower = disziplin.toLowerCase();
    const istZeitDisziplin = (disziplinLower.match(/\d+\s*m/) && !disziplinLower.includes("kampf")) || 
                              disziplinLower.includes("lauf") || 
                              disziplinLower.includes("x");
    
    if (!disziplinPBs[disziplin]) {
      disziplinPBs[disziplin] = {
        pb: zeile,
        istZeit: istZeitDisziplin
      };
    } else {
      const aktuellesPB = disziplinPBs[disziplin].pb;
      const istBesser = istZeitDisziplin 
        ? zeile.leistung < aktuellesPB.leistung
        : zeile.leistung > aktuellesPB.leistung;
      
      if (istBesser) {
        disziplinPBs[disziplin].pb = zeile;
      }
    }
  });
  
  // Erstelle Array mit allen PBs und sortiere chronologisch (neueste zuerst)
  const allePBs = Object.entries(disziplinPBs).map(([disziplin, data]) => ({
    ...data.pb,
    disziplin: disziplin
  })).sort((a, b) => new Date(b.datum) - new Date(a.datum));
  
  if (allePBs.length === 0) {
    alert('üì≠ Keine pers√∂nlichen Bestleistungen gefunden');
    return;
  }
  
  // Erstelle HTML
  let html = `
    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #2a5298; margin: 0;">üèÖ Pers√∂nliche Rekorde Timeline</h3>
        <button onclick="document.getElementById('bestleistungenAusgabe').innerHTML = ''; enableTableResize();" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer;">‚úï Schlie√üen</button>
      </div>
      
      <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
        <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${allePBs.length}</div>
        <div style="font-size: 0.9em; color: #666;">Disziplinen mit pers√∂nlichen Bestleistungen</div>
      </div>
      
      <div style="position: relative; padding-left: 30px;">
  `;
  
  allePBs.forEach((pb, index) => {
    const datum = new Date(pb.datum).toLocaleDateString('de-DE');
    const isFirst = index === 0;
    const isLast = index === allePBs.length - 1;
    const bgColor = isFirst ? 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)' : '#667eea';
    
    html += `
      <div style="position: relative; margin-bottom: ${isLast ? '0' : '20px'};">
        <div style="position: absolute; left: -30px; top: 5px; width: 20px; height: 20px; border-radius: 50%; background: ${bgColor}; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
        ${!isLast ? '<div style="position: absolute; left: -21px; top: 25px; width: 2px; height: calc(100% + 20px); background: #ddd;"></div>' : ''}
        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); ${isFirst ? 'border: 2px solid #FFD700;' : 'border: 1px solid #e0e0e0;'}">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
            <div>
              <div style="font-size: 1.2em; font-weight: bold; color: #2a5298; margin-bottom: 4px;">
                ${pb.disziplin}
                ${isFirst ? ' <span style="background: #FFD700; color: white; padding: 2px 10px; border-radius: var(--border-radius); font-size: 0.7em; font-weight: bold; margin-left: 8px;">NEUESTE</span>' : ''}
              </div>
              <div style="font-size: 1.4em; font-weight: bold; color: #667eea;">
                ${formatiereLeistung(pb.leistung, pb.disziplin)}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="color: #666; font-size: 0.95em; font-weight: 500;">${datum}</div>
              ${pb.ort ? `<div style="color: #999; font-size: 0.85em; margin-top: 2px;">${pb.ort}</div>` : ''}
            </div>
          </div>
          ${pb.wk_bz ? `<div style="color: #999; font-size: 0.85em; padding-top: 8px; border-top: 1px solid #f0f0f0;">${pb.wk_bz}</div>` : ''}
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  document.getElementById("bestleistungenAusgabe").innerHTML = html;
  document.getElementById("bestleistungenExportBtn").style.display = "none";
}

/* ================= LEISTUNGEN MODAL FUNCTIONS ================= */

// Open Add Leistung Modal
function openAddLeistungModal() {
  if (!currentAthlete) {
    alert('Fehler: Kein Athlet geladen');
    return;
  }
  
  document.getElementById('modalTitle').textContent = 'Leistung hinzuf√ºgen';
  document.getElementById('editLeistungId').value = '';
  document.getElementById('leistungForm').reset();
  
  // Hide delete button when adding new
  document.getElementById('deleteLeistungBtn').style.display = 'none';
  document.getElementById('leistungModal').style.display = 'flex';
}

// Open Edit Leistung Modal
async function openEditLeistungModal(leistungId) {
  const { data, error } = await supabaseClient
    .schema('la').from('leistung')
    .select('*')
    .eq('id', leistungId)
    .single();
  
  if (error || !data) {
    alert('Fehler beim Laden der Leistung');
    return;
  }
  
  // Check if this is the user's own performance
  if (data.athlet_id !== currentAthlete.id) {
    alert('Du kannst nur deine eigenen Leistungen bearbeiten');
    return;
  }
  
  document.getElementById('modalTitle').textContent = 'Leistung bearbeiten';
  document.getElementById('editLeistungId').value = leistungId;
  document.getElementById('modalDatum').value = data.datum || '';
  document.getElementById('modalDisziplin').value = data.disziplin || '';
  document.getElementById('modalLeistung').value = data.leistung || '';
  document.getElementById('modalOrt').value = data.ort || '';
  document.getElementById('modalWK').value = data.wk_bz || '';
  document.getElementById('modalPlatzierung').value = data.platzierung || '';
  document.getElementById('modalAK').value = data.ak || '';
  
  
  // Show delete button when editing
  document.getElementById('deleteLeistungBtn').style.display = 'block';
  document.getElementById('leistungModal').style.display = 'flex';
}


// Delete Leistung
async function deleteLeistung() {
  const leistungId = document.getElementById('editLeistungId').value;
  
  if (!leistungId) {
    alert('Fehler: Keine Leistung zum L√∂schen ausgew√§hlt');
    return;
  }
  
  // Confirm deletion
  if (!confirm('M√∂chtest du diese Leistung wirklich l√∂schen?')) {
    return;
  }
  
  const { error } = await supabaseClient
    .schema('la').from('leistung')
    .delete()
    .eq('id', leistungId);
  
  if (error) {
    alert('Fehler beim L√∂schen: ' + error.message);
    return;
  }
  
  alert('Leistung erfolgreich gel√∂scht!');
  closeLeistungModal();
  
  // Reload performances
  ladeLeistungen();
}

// Close Leistung Modal
function closeLeistungModal() {
  document.getElementById('leistungModal').style.display = 'none';
}

// Save Leistung
async function saveLeistung(event) {
  event.preventDefault();
  
  if (!currentAthlete) {
    alert('Fehler: Kein Athlet geladen');
    return;
  }
  
  // For non-admins, always use their own athlete_id
  // For admins, use selectedAthleteId if they've selected another athlete
  let athletId;
  if (isAdmin && selectedAthleteId && selectedAthleteId !== currentAthlete.id) {
    athletId = selectedAthleteId;
  } else {
    athletId = currentAthlete.id;
  }
  
  const leistungId = document.getElementById('editLeistungId').value;
  const leistungData = {
    athlet_id: athletId,
    datum: document.getElementById('modalDatum').value,
    disziplin: document.getElementById('modalDisziplin').value,
    leistung: parseFloat(document.getElementById('modalLeistung').value.replace(',', '.')),
    ort: document.getElementById('modalOrt').value || null,
    wk_bz: document.getElementById('modalWK').value || null,
    platzierung: parseInt(document.getElementById('modalPlatzierung').value) || null,
    ak: document.getElementById('modalAK').value || null
  };
  
  let error;
  
  if (leistungId) {
    // Update existing
    const result = await supabaseClient
      .schema('la').from('leistung')
      .update(leistungData)
      .eq('id', leistungId);
    error = result.error;
  } else {
    // Insert new
    const result = await supabaseClient
      .schema('la').from('leistung')
      .insert([leistungData]);
    error = result.error;
  }
  
  if (error) {
    alert('Fehler beim Speichern: ' + error.message);
    return;
  }
  
  alert(leistungId ? 'Leistung aktualisiert!' : 'Leistung hinzugef√ºgt!');
  closeLeistungModal();
  
  // Reload performances
  ladeLeistungen();
}

// Open Import Modal
function openImportModal() {
  document.getElementById('importModal').style.display = 'flex';
}

// Close Import Modal
function closeImportModal() {
  document.getElementById('importModal').style.display = 'none';
}

// Import CSV
async function importCSV() {
  if (!currentAthlete) {
    alert('Fehler: Kein Athlet geladen');
    return;
  }
  
  const fileInput = document.getElementById('importFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert('Bitte w√§hle eine CSV-Datei aus');
    return;
  }
  
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    const text = e.target.result;
    const rows = text.split('\n').map(row => row.split(','));
    
    // Skip header
    const dataRows = rows.slice(1).filter(row => row.length >= 3 && row[0].trim() !== '');
    
    if (dataRows.length === 0) {
      alert('Keine g√ºltigen Daten in der CSV-Datei gefunden');
      return;
    }
    
    const leistungen = dataRows.map(row => ({
      athlet_id: currentAthlete.id,
      datum: row[0]?.trim(),
      disziplin: row[1]?.trim(),
      leistung: parseFloat(row[2]?.trim().replace(',', '.')),
      ort: row[3]?.trim() || null,
      wk_bz: row[4]?.trim() || null,
      platzierung: parseInt(row[5]?.trim()) || null,
      ak: row[6]?.trim() || null
    }));
    
    const { error } = await supabaseClient
      .schema('la').from('leistung')
      .insert(leistungen);
    
    if (error) {
      alert('Fehler beim Import: ' + error.message);
      return;
    }
    
    alert(`${leistungen.length} Leistungen erfolgreich importiert!`);
    closeImportModal();
    fileInput.value = '';
    
    // Reload performances
    ladeLeistungen();
  };
  
  reader.readAsText(file);
}

/* ================= RESIZABLE TABLE COLUMNS ================= */
// Globale Variablen f√ºr Spaltengr√∂√üenanpassung
let resizingColumn = null;
let nextColumn = null;
let startX = 0;
let startWidth = 0;
let startNextWidth = 0;
let isResizing = false;

// Event Listener f√ºr alle Tabellen hinzuf√ºgen
document.addEventListener('DOMContentLoaded', function() {
  enableTableResize();
});

// Event Listener nach jedem Table-Render neu hinzuf√ºgen
function enableTableResize() {
  const tables = document.querySelectorAll('table');
  
  tables.forEach(table => {
    const headers = table.querySelectorAll('th');
    
    headers.forEach((th, index) => {
      // Skip last column
      if (index === headers.length - 1) return;
      
      // Verhindere Default-Click beim Resizing
      th.addEventListener('click', function(e) {
        if (isResizing) {
          e.stopPropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      
      th.addEventListener('mousedown', function(e) {
        // Nur wenn auf den rechten Rand geklickt wurde (resize handle)
        const rect = th.getBoundingClientRect();
        const isRightEdge = e.clientX > rect.right - 10;
        
        if (isRightEdge) {
          e.preventDefault();
          e.stopPropagation();
          isResizing = false; // Wird erst beim Bewegen auf true gesetzt
          resizingColumn = th;
          nextColumn = headers[index + 1];
          startX = e.clientX;
          startWidth = th.offsetWidth;
          startNextWidth = nextColumn ? nextColumn.offsetWidth : 0;
          
          document.addEventListener('mousemove', resizeColumn);
          document.addEventListener('mouseup', stopResize);
          
          // Verhindere Textauswahl w√§hrend des Resizens
          document.body.style.userSelect = 'none';
          document.body.style.cursor = 'col-resize';
        }
      });
    });
  });
}

function resizeColumn(e) {
  if (!resizingColumn) return;
  
  // Markiere als Resizing beim ersten Move
  if (!isResizing) {
    isResizing = true;
  }
  
  const diff = e.clientX - startX;
  const newWidth = Math.max(80, startWidth + diff);
  const newNextWidth = nextColumn ? Math.max(80, startNextWidth - diff) : 0;
  
  // Setze Breiten direkt ohne Verz√∂gerung
  resizingColumn.style.width = newWidth + 'px';
  resizingColumn.style.minWidth = newWidth + 'px';
  resizingColumn.style.maxWidth = newWidth + 'px';
  
  if (nextColumn) {
    nextColumn.style.width = newNextWidth + 'px';
    nextColumn.style.minWidth = newNextWidth + 'px';
    nextColumn.style.maxWidth = newNextWidth + 'px';
  }
}

function stopResize(e) {
  if (resizingColumn) {
    // Verhindere Click-Event wenn wir gerade am Resizing waren
    if (isResizing) {
      e.stopPropagation();
      e.preventDefault();
      
      // Verz√∂gere das Zur√ºcksetzen, damit der Click-Handler es mitbekommt
      setTimeout(() => {
        isResizing = false;
      }, 50);
    }
  }
  
  resizingColumn = null;
  nextColumn = null;
  document.removeEventListener('mousemove', resizeColumn);
  document.removeEventListener('mouseup', stopResize);
  document.body.style.userSelect = '';
  document.body.style.cursor = '';
}

</script>

<script>
// Re-enable table resize nach jedem Table-Update
const originalSetTimeout = window.setTimeout;
window.setTimeout = function(fn, delay) {
  return originalSetTimeout(function() {
    fn();
    // Nach jedem Timeout, der vermutlich eine Tabelle aktualisiert hat
    if (delay > 0) {
      originalSetTimeout(enableTableResize, 100);
    }
  }, delay);
};
</script>

</div> <!-- Close main-app -->


</div> <!-- Close mainApp -->
<!-- Modal: Leistung hinzuf√ºgen/bearbeiten -->
<div id="leistungModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
  <div style="background: white; padding: 30px; border-radius: var(--border-radius); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 id="modalTitle" style="color: #2a5298; margin: 0;">Leistung hinzuf√ºgen</h2>
      <button onclick="closeLeistungModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px;">√ó</button>
    </div>
    <form id="leistungForm" onsubmit="saveLeistung(event)">
      <input type="hidden" id="editLeistungId">
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Datum *</label>
        <input type="date" id="modalDatum" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Disziplin *</label>
        <input type="text" id="modalDisziplin" required placeholder="z.B. 100m" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Leistung *</label>
        <input type="text" id="modalLeistung" required placeholder="z.B. 10.50" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Ort</label>
        <input type="text" id="modalOrt" placeholder="z.B. Berlin" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Wettkampfbezeichnung</label>
        <input type="text" id="modalWK" placeholder="z.B. Deutsche Meisterschaft" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Platzierung</label>
          <input type="number" id="modalPlatzierung" min="1" placeholder="z.B. 1" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 0.95em;">Altersklasse</label>
          <input type="text" id="modalAK" placeholder="z.B. U20" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: space-between;">
        <button type="button" id="deleteLeistungBtn" onclick="deleteLeistung()" style="display: none; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; background: #dc3545; color: white;">üóëÔ∏è L√∂schen</button>
        <div style="display: flex; gap: 10px;">
          <button type="button" onclick="closeLeistungModal()" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; background: #6c757d; color: white;">Abbrechen</button>
          <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">Speichern</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal: CSV Import -->
<div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
  <div style="background: white; padding: 30px; border-radius: var(--border-radius); max-width: 600px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="color: #2a5298; margin: 0;">Leistungen importieren</h2>
      <button onclick="closeImportModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px;">√ó</button>
    </div>
    <p>CSV-Datei mit folgenden Spalten hochladen:</p>
    <p style="background: #f0f0f0; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.85em;">datum,disziplin,leistung,ort,wk_bz,platzierung,ak</p>
    <div style="margin: 20px 0;">
      <input type="file" id="importFile" accept=".csv" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeImportModal()" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: #6c757d; color: white;">Abbrechen</button>
      <button onclick="importCSV()" style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">Importieren</button>
    </div>
  </div>
</div>

</body>
</html>